<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Math | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Math â•</h1>
    <p>Take a quick diagnostic, then pick a fun math game!</p>
  </div>
</section>

<section class="section">
  <div class="container">

    <div class="game-box wide">
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>

      <div class="badge-row" style="justify-content:center;">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>

      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn" id="startDiagBtn">Start 10-Question Diagnostic</button>
        <button class="btn secondary" id="goGamesBtn" disabled style="opacity:.6;">Choose a Game</button>
        <a class="btn secondary" href="progress.html">My Progress</a>
      </div>
    </div>

    <!-- DIAGNOSTIC -->
    <div class="game-box wide" id="diagWrap" style="margin-top:16px; display:none;">
      <div class="kid-big">Math Diagnostic âœ…</div>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="small" id="diagMeta">Question 1 of 10</div>
            <div class="kid-big" id="diagQ">Question loadsâ€¦</div>
          </div>
          <button class="btn secondary" id="diagSoundBtn" title="Read aloud" aria-label="Read aloud">ğŸ”Š</button>
        </div>

        <div class="small" id="diagSupport" style="margin-top:6px;"></div>
        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
        <div class="kid-big" id="diagResult" style="margin-top:14px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:10px;">
          <button class="btn" id="diagNextBtn">Next</button>
          <button class="btn secondary" id="diagSkipBtn">Skip</button>
        </div>
      </div>
    </div>

    <!-- AFTER DIAG -->
    <div class="game-box wide" id="afterDiagWrap" style="margin-top:16px; display:none;">
      <div class="kid-big">Your Plan ğŸŒ¿</div>

      <div class="game-box" style="margin-top:12px;">
        <div class="grid-3">
          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Score</h3>
            <div class="kid-big" id="planScore">â€”</div>
            <div class="small" id="planGrade">â€”</div>
          </div>

          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Recommended Path</h3>
            <div class="small" id="planPath" style="line-height:1.5;">â€”</div>
          </div>

          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Game Length</h3>
            <div class="kid-big" id="planLen">â€”</div>
            <div class="small" id="planLenNote">â€”</div>
          </div>
        </div>

        <div class="quick-strip" style="justify-content:center; margin-top:12px;">
          <button class="btn" id="openGamesBtn">Open Games</button>
          <button class="btn secondary" id="retakeBtn">Retake Diagnostic</button>
        </div>
      </div>
    </div>

    <!-- HUB -->
    <div class="game-box wide" id="hub" style="margin-top:16px; display:none;">
      <div class="kid-big">Choose a Math Game ğŸ®</div>
      <p class="small" id="hubDesc" style="margin-top:6px;"></p>
      <div class="grid-3" id="cards" style="margin-top:14px;"></div>
    </div>

    <!-- PLAYER -->
    <div class="game-box wide" id="playWrap" style="margin-top:16px; display:none;">
      <div class="kid-big" id="gameTitle">Game</div>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="small" id="gameMeta">â€”</div>
            <div class="kid-big" id="prompt">Promptâ€¦</div>
          </div>
          <button class="btn secondary" id="soundBtn" title="Read aloud" aria-label="Read aloud">ğŸ”Š</button>
        </div>

        <div class="small" id="support" style="margin-top:6px;"></div>
        <div id="stage" style="margin-top:14px;"></div>
        <div class="kid-big" id="result" style="margin-top:14px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
          <button class="btn" id="nextBtn">Next</button>
          <button class="btn secondary" id="backBtn">Back to Games</button>
        </div>

        <div class="small" style="margin-top:10px;">Earn â­ for correct answers.</div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
  const PROG_KEY = "bloom_progress";
  const MATH_DIAG_KEY = "bloom_math_diag";

  function load(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function addStar(){
    const p = load(PROG_KEY, { phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0 });
    p.mathStars = (p.mathStars || 0) + 1;
    save(PROG_KEY, p);
  }

  function speak(text){
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1;
    u.pitch = 1.05;
    speechSynthesis.speak(u);
  }

  let grade = new URLSearchParams(location.search).get("grade") || localStorage.getItem("bloom_pref_grade") || "K";
  const gradeButtons = document.querySelectorAll(".pill[data-grade]");
  function setGrade(g){
    grade = g;
    localStorage.setItem("bloom_pref_grade", g);
    gradeButtons.forEach(b => b.classList.toggle("active", b.dataset.grade === grade));
    refreshGoGames();
    refreshHub();
  }
  gradeButtons.forEach(btn => btn.onclick = ()=> setGrade(btn.dataset.grade));
  setGrade(grade);

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // -------- Diagnostic bank (10) --------
  const BANK = {
    "K": [
      {q:"How many? ğŸğŸğŸ", choices:["2","3","4"], correct:"3", focus:"count"},
      {q:"Which number is bigger?", choices:["5","2","1"], correct:"5", focus:"compare"},
      {q:"2 + 1 = ?", choices:["2","3","4"], correct:"3", focus:"add"},
      {q:"5 âˆ’ 2 = ?", choices:["2","3","4"], correct:"3", focus:"sub"},
      {q:"What comes next? 1, 2, 3, __", choices:["4","5","6"], correct:"4", focus:"count"},
      {q:"Which is a circle?", choices:["âšª","â¬›","ğŸ”º"], correct:"âšª", focus:"shapes"},
      {q:"How many? â­â­", choices:["1","2","3"], correct:"2", focus:"count"},
      {q:"3 + 2 = ?", choices:["4","5","6"], correct:"5", focus:"add"},
      {q:"Which is smaller?", choices:["1","9","7"], correct:"1", focus:"compare"},
      {q:"What comes before 6?", choices:["5","7","8"], correct:"5", focus:"count"}
    ],
    "1": [
      {q:"8 + 7 = ?", choices:["14","15","16"], correct:"15", focus:"add"},
      {q:"12 âˆ’ 5 = ?", choices:["6","7","8"], correct:"7", focus:"sub"},
      {q:"Which is greater?", choices:["19","9","10"], correct:"19", focus:"compare"},
      {q:"What comes next? 10, 12, 14, __", choices:["15","16","18"], correct:"16", focus:"patterns"},
      {q:"9 + 6 = ?", choices:["14","15","16"], correct:"15", focus:"add"},
      {q:"Which is an even number?", choices:["7","8","9"], correct:"8", focus:"skills"},
      {q:"15 âˆ’ 9 = ?", choices:["5","6","7"], correct:"6", focus:"sub"},
      {q:"What is 10 + 3?", choices:["12","13","14"], correct:"13", focus:"add"},
      {q:"Which is smaller?", choices:["11","18","20"], correct:"11", focus:"compare"},
      {q:"How many tens in 20?", choices:["1","2","3"], correct:"2", focus:"place"}
    ],
    "2": [
      {q:"34 + 20 = ?", choices:["44","54","64"], correct:"54", focus:"add"},
      {q:"50 âˆ’ 18 = ?", choices:["32","42","28"], correct:"32", focus:"sub"},
      {q:"Which has more tens?", choices:["40","30","20"], correct:"40", focus:"place"},
      {q:"What comes next? 5, 10, 15, __", choices:["18","20","25"], correct:"20", focus:"skip"},
      {q:"Which is bigger?", choices:["67","76","66"], correct:"76", focus:"compare"},
      {q:"What is 3 groups of 2?", choices:["5","6","7"], correct:"6", focus:"foundations"},
      {q:"42 + 9 = ?", choices:["49","51","52"], correct:"51", focus:"add"},
      {q:"Which is closest to 50?", choices:["49","60","40"], correct:"49", focus:"skills"},
      {q:"60 âˆ’ 30 = ?", choices:["20","30","40"], correct:"30", focus:"sub"},
      {q:"Place value: In 58, the 5 meansâ€¦", choices:["5","50","500"], correct:"50", focus:"place"}
    ]
  };

  // -------- Diagnostic state --------
  const diagWrap = document.getElementById("diagWrap");
  const afterWrap = document.getElementById("afterDiagWrap");
  const hub = document.getElementById("hub");
  const playWrap = document.getElementById("playWrap");

  const diagMeta = document.getElementById("diagMeta");
  const diagQ = document.getElementById("diagQ");
  const diagSupport = document.getElementById("diagSupport");
  const diagChoices = document.getElementById("diagChoices");
  const diagResult = document.getElementById("diagResult");

  let diagItems=[], dIndex=0, dScore=0, dWrong=[];
  let lastDiag=null;

  function startDiag(){
    diagItems = shuffle(BANK[grade]).slice(0,10);
    dIndex=0; dScore=0; dWrong=[];
    diagWrap.style.display="block";
    afterWrap.style.display="none";
    hub.style.display="none";
    playWrap.style.display="none";
    renderDiag();
    window.scrollTo({top: diagWrap.offsetTop-10, behavior:"smooth"});
  }

  function renderDiag(){
    const it = diagItems[dIndex];
    lastDiag = it;
    diagMeta.textContent = `Question ${dIndex+1} of 10`;
    diagQ.textContent = it.q;
    diagSupport.textContent = "Tap ğŸ”Š to read aloud.";
    diagResult.textContent = "";

    diagChoices.innerHTML="";
    it.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className="card";
      card.style.textAlign="center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> diagAnswer(c);
      diagChoices.appendChild(card);
    });
  }

  function diagAnswer(choice){
    if (diagResult.textContent) return;
    const it = diagItems[dIndex];
    if (choice === it.correct){
      dScore++;
      diagResult.textContent="Correct! â­";
    } else {
      dWrong.push(it.focus);
      diagResult.textContent=`Try again ğŸ™‚ Answer: ${it.correct}`;
    }
  }

  function diagNext(skipped=false){
    const it = diagItems[dIndex];
    if (!diagResult.textContent || skipped) dWrong.push(it.focus);
    dIndex++;
    if (dIndex>=10) finishDiag();
    else renderDiag();
  }

  function finishDiag(){
    const pct = Math.round((dScore/10)*100);
    const counts = dWrong.reduce((m,k)=>(m[k]=(m[k]||0)+1,m),{});
    const focusOrder = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);

    save(MATH_DIAG_KEY, {date:Date.now(), grade, score:pct, focusOrder});

    document.getElementById("planScore").textContent = `${pct}%`;
    document.getElementById("planGrade").textContent = `Grade: ${grade==="K"?"Kindergarten":"Grade "+grade}`;

    const map = {count:"Counting", add:"Addition", sub:"Subtraction", compare:"Comparing", shapes:"Shapes", patterns:"Patterns", place:"Place Value", skip:"Skip Counting", skills:"Skills", foundations:"Foundations"};
    const path = focusOrder.slice(0,3).map(k=>map[k]).filter(Boolean);
    document.getElementById("planPath").textContent = path.length ? path.join(" â†’ ") : "Mixed Practice";

    let minutes = pct>=90 ? 6 : pct>=70 ? 8 : 10;
    document.getElementById("planLen").textContent = `${minutes} min`;
    document.getElementById("planLenNote").textContent = (pct>=90) ? "Try 2 quick games" : (pct>=70) ? "Try 2â€“3 games" : "Try 3 games";

    diagWrap.style.display="none";
    afterWrap.style.display="block";
    refreshGoGames();
    window.scrollTo({top: afterWrap.offsetTop-10, behavior:"smooth"});
  }

  function refreshGoGames(){
    const saved = load(MATH_DIAG_KEY, null);
    const ok = saved && saved.grade===grade;
    const btn = document.getElementById("goGamesBtn");
    btn.disabled = !ok;
    btn.style.opacity = ok ? "1" : ".6";
  }

  // -------- Games --------
  const GAMES = [
    {id:"quickSolve", name:"âš¡ Quick Solve", desc:"Choose the correct answer fast.", min:4, grades:["K","1","2"]},
    {id:"compareMonster", name:"ğŸ‘¾ Compare Monster", desc:"Pick >, <, or = to help the monster.", min:5, grades:["1","2"]},
    {id:"tenFrame", name:"ğŸŸ© Ten-Frame Builder", desc:"Build numbers using a ten-frame.", min:5, grades:["K","1"]},
    {id:"placeValue", name:"ğŸ§± Place Value Blocks", desc:"Tens and ones practice.", min:6, grades:["2"]},
    {id:"numberLine", name:"ğŸ¦˜ Number Line Hop", desc:"Hop along a number line to solve.", min:5, grades:["K","1","2"]}
  ];

  const hubDesc = document.getElementById("hubDesc");
  const cards = document.getElementById("cards");

  function refreshHub(){
    const saved = load(MATH_DIAG_KEY, null);
    hubDesc.textContent = saved && saved.grade===grade ? "Games are filtered for your grade. â­" : "Take the diagnostic first.";
    const list = GAMES.filter(g=>g.grades.includes(grade));
    cards.innerHTML="";
    list.forEach(g=>{
      const c = document.createElement("div");
      c.className="card";
      c.innerHTML = `
        <h3 style="margin-bottom:6px;">${g.name}</h3>
        <p class="small" style="line-height:1.5;">${g.desc}</p>
        <p class="small" style="margin-top:8px;"><strong>Length:</strong> ${g.min} min</p>
        <div class="quick-strip" style="margin-top:10px; justify-content:flex-start;">
          <button class="btn secondary">Play</button>
        </div>
      `;
      c.querySelector("button").onclick = ()=> startGame(g.id);
      cards.appendChild(c);
    });
  }

  function openHub(){
    afterWrap.style.display="none";
    diagWrap.style.display="none";
    hub.style.display="block";
    playWrap.style.display="none";
    refreshHub();
    window.scrollTo({top: hub.offsetTop-10, behavior:"smooth"});
  }

  // -------- Player --------
  const gameTitle = document.getElementById("gameTitle");
  const gameMeta = document.getElementById("gameMeta");
  const prompt = document.getElementById("prompt");
  const support = document.getElementById("support");
  const stage = document.getElementById("stage");
  const result = document.getElementById("result");

  let activeGame=null, gIndex=0, lastText="";

  function startGame(id){
    activeGame=id;
    gIndex=0;
    hub.style.display="none";
    playWrap.style.display="block";
    renderGame();
    window.scrollTo({top: playWrap.offsetTop-10, behavior:"smooth"});
  }

  function choiceCards(choices, onPick){
    const wrap = document.createElement("div");
    wrap.className="grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className="card";
      card.style.textAlign="center";
      card.innerHTML = `<h3 style="font-size:32px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> onPick(c);
      wrap.appendChild(card);
    });
    return wrap;
  }

  function renderQuickSolve(){
    gameTitle.textContent = "âš¡ Quick Solve";
    gameMeta.textContent = "Solve and choose.";
    result.textContent="";

    const bank = {
      "K": [
        {q:"3 + 2 = ?", correct:"5", choices:["4","5","6"]},
        {q:"How many? â­â­â­â­", correct:"4", choices:["3","4","5"]},
        {q:"5 âˆ’ 1 = ?", correct:"4", choices:["3","4","5"]}
      ],
      "1": [
        {q:"9 + 6 = ?", correct:"15", choices:["14","15","16"]},
        {q:"14 âˆ’ 7 = ?", correct:"7", choices:["6","7","8"]},
        {q:"Which is bigger?", correct:"18", choices:["18","12","15"]}
      ],
      "2": [
        {q:"42 + 9 = ?", correct:"51", choices:["49","51","52"]},
        {q:"60 âˆ’ 30 = ?", correct:"30", choices:["20","30","40"]},
        {q:"34 + 20 = ?", correct:"54", choices:["44","54","64"]}
      ]
    };

    const it = bank[grade][gIndex % bank[grade].length];
    lastText = it.q;

    prompt.textContent = it.q;
    support.textContent = "Pick the right answer.";

    stage.innerHTML="";
    stage.appendChild(choiceCards(it.choices, (pick)=>{
      if (pick === it.correct){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderCompareMonster(){
    gameTitle.textContent = "ğŸ‘¾ Compare Monster";
    gameMeta.textContent = "Choose >, <, or =";
    result.textContent="";

    const bank = [
      {a:7,b:9,correct:"<"},
      {a:12,b:12,correct:"="},
      {a:18,b:15,correct:">"},
      {a:27,b:30,correct:"<"}
    ];
    const it = bank[gIndex % bank.length];
    lastText = `${it.a} compared to ${it.b}`;

    prompt.textContent = `${it.a}  ?  ${it.b}`;
    support.textContent = "Help the monster choose the right sign!";

    stage.innerHTML="";
    stage.appendChild(choiceCards([">","=","<"], (pick)=>{
      if (pick === it.correct){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderTenFrame(){
    gameTitle.textContent = "ğŸŸ© Ten-Frame Builder";
    gameMeta.textContent = "Tap squares to build the number.";
    result.textContent="";

    const targets = grade==="K" ? [3,5,7,9] : [6,8,10];
    const target = targets[gIndex % targets.length];
    lastText = `Make ${target}`;

    prompt.textContent = `Make ${target}`;
    support.textContent = "Tap squares. Count as you go!";

    stage.innerHTML="";
    const frame = document.createElement("div");
    frame.className="game-box";
    frame.style.display="grid";
    frame.style.gridTemplateColumns="repeat(5, 1fr)";
    frame.style.gap="10px";
    frame.style.maxWidth="520px";
    frame.style.margin="0 auto";

    let on=0;
    const cells=[];
    for (let i=0;i<10;i++){
      const cell = document.createElement("div");
      cell.className="card";
      cell.style.height="70px";
      cell.style.display="flex";
      cell.style.alignItems="center";
      cell.style.justifyContent="center";
      cell.style.fontWeight="900";
      cell.style.cursor="pointer";
      cell.textContent="";
      cell.onclick = ()=>{
        if (cell.dataset.on === "1"){
          cell.dataset.on="0";
          cell.textContent="";
          on--;
        } else {
          cell.dataset.on="1";
          cell.textContent="ğŸŸ©";
          on++;
        }
      };
      cell.dataset.on="0";
      cells.push(cell);
      frame.appendChild(cell);
    }

    const row = document.createElement("div");
    row.className="quick-strip";
    row.style.justifyContent="center";
    row.style.marginTop="12px";

    const check = document.createElement("button");
    check.className="btn";
    check.textContent="Check";
    check.onclick = ()=>{
      if (on === target){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = `You made ${on}. Try again ğŸ™‚`;
      }
    };

    const clear = document.createElement("button");
    clear.className="btn secondary";
    clear.textContent="Clear";
    clear.onclick = ()=>{
      on=0; result.textContent="";
      cells.forEach(c=>{ c.dataset.on="0"; c.textContent=""; });
    };

    row.appendChild(check);
    row.appendChild(clear);

    stage.appendChild(frame);
    stage.appendChild(row);
  }

  function renderPlaceValue(){
    gameTitle.textContent = "ğŸ§± Place Value Blocks";
    gameMeta.textContent = "Tens + Ones";
    result.textContent="";

    const items = [
      {n:34, tens:3, ones:4},
      {n:58, tens:5, ones:8},
      {n:41, tens:4, ones:1}
    ];
    const it = items[gIndex % items.length];
    lastText = `How many tens and ones in ${it.n}`;

    prompt.textContent = `How many tens and ones in ${it.n}?`;
    support.textContent = "Choose the best match.";

    const choices = [
      `${it.tens} tens and ${it.ones} ones`,
      `${it.ones} tens and ${it.tens} ones`,
      `${it.tens+1} tens and ${it.ones-1} ones`
    ];

    stage.innerHTML="";
    stage.appendChild(choiceCards(shuffle(choices), (pick)=>{
      if (pick === `${it.tens} tens and ${it.ones} ones`){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderNumberLine(){
    gameTitle.textContent = "ğŸ¦˜ Number Line Hop";
    gameMeta.textContent = "Hop to the answer";
    result.textContent="";

    const bank = {
      "K": [{start:2, hop:3, ans:5},{start:5, hop:2, ans:7}],
      "1": [{start:8, hop:6, ans:14},{start:10, hop:5, ans:15}],
      "2": [{start:20, hop:15, ans:35},{start:30, hop:12, ans:42}]
    };
    const it = bank[grade][gIndex % bank[grade].length];
    lastText = `Start at ${it.start}. Hop ${it.hop}. Where do you land?`;

    prompt.textContent = `Start at ${it.start}. Hop +${it.hop}. Where do you land?`;
    support.textContent = "Pick the landing number.";

    const choices = shuffle([String(it.ans), String(it.ans-1), String(it.ans+2)]);
    stage.innerHTML="";
    stage.appendChild(choiceCards(choices, (pick)=>{
      if (pick === String(it.ans)){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderGame(){
    result.textContent="";
    if (activeGame==="quickSolve") return renderQuickSolve();
    if (activeGame==="compareMonster") return renderCompareMonster();
    if (activeGame==="tenFrame") return renderTenFrame();
    if (activeGame==="placeValue") return renderPlaceValue();
    if (activeGame==="numberLine") return renderNumberLine();
  }

  // -------- Controls --------
  document.getElementById("startDiagBtn").onclick = startDiag;
  document.getElementById("diagNextBtn").onclick = ()=> diagNext(false);
  document.getElementById("diagSkipBtn").onclick = ()=> diagNext(true);
  document.getElementById("diagSoundBtn").onclick = ()=> { if (lastDiag) speak(lastDiag.q); };

  document.getElementById("openGamesBtn").onclick = openHub;
  document.getElementById("goGamesBtn").onclick = openHub;

  document.getElementById("retakeBtn").onclick = ()=>{
    const saved = load(MATH_DIAG_KEY, null);
    if (saved && saved.grade===grade) localStorage.removeItem(MATH_DIAG_KEY);
    afterWrap.style.display="none";
    hub.style.display="none";
    playWrap.style.display="none";
    diagWrap.style.display="none";
    refreshGoGames();
    alert("Diagnostic cleared. Press Start Diagnostic to begin again!");
  };

  document.getElementById("nextBtn").onclick = ()=>{ gIndex++; renderGame(); };
  document.getElementById("backBtn").onclick = openHub;
  document.getElementById("soundBtn").onclick = ()=> { if (lastText) speak(lastText); };

  refreshGoGames();
  refreshHub();
</script>

</body>
</html>
