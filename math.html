<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Math | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Math â•</h1>
    <p>Choose your grade, take a quick math diagnostic, then play fun math games made for you!</p>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Start Here ğŸŒŸ</h2>

    <div class="game-box wide">

      <!-- Grade -->
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>
      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn secondary grade-btn active" data-grade="K" type="button">Kindergarten</button>
        <button class="btn secondary grade-btn" data-grade="1" type="button">Grade 1</button>
        <button class="btn secondary grade-btn" data-grade="2" type="button">Grade 2</button>
      </div>

      <!-- Actions -->
      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn" id="startDiagBtn" type="button">Start Diagnostic</button>
        <button class="btn secondary" id="recommendedBtn" type="button" disabled>Recommended Path</button>
        <button class="btn secondary" id="chooseGameBtn" type="button" disabled>Choose a Game</button>
        <a class="btn secondary" href="progress.html">My Progress</a>
      </div>

      <div class="hero-note" style="text-align:center; margin-top:10px;">
        Tip: Do the diagnostic first so games match your math needs.
      </div>

      <!-- Diagnostic Panel -->
      <div id="diagPanel" class="game-box" style="margin-top:16px; display:none;">
        <div class="kid-big">Math Diagnostic âœ…</div>
        <p class="small">Answer 10 questions. Weâ€™ll recommend what to practice next.</p>

        <div class="game-box" style="margin-top:12px;">
          <div class="small" id="diagProgressText">Question 1 of 10</div>

          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-top:10px;">
            <div class="kid-big" id="diagQuestion" style="margin:0; flex:1;">Press â€œStart Diagnosticâ€.</div>
            <button class="btn secondary" id="diagSpeakBtn" type="button" title="Read aloud">ğŸ”Š</button>
          </div>

          <div class="small" id="diagHint" style="margin-top:6px;"></div>

          <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>

          <div class="quick-strip" style="justify-content:center; margin-top:12px;">
            <button class="btn secondary" id="diagNextBtn" type="button" disabled>Next</button>
            <button class="btn secondary" id="diagRestartBtn" type="button">Restart</button>
          </div>

          <div class="kid-big" id="diagFeedback" style="margin-top:12px;"></div>
        </div>
      </div>

      <!-- Results Panel -->
      <div id="resultsPanel" class="game-box" style="margin-top:16px; display:none;">
        <div class="kid-big">Results ğŸŒ¿</div>
        <p class="small" id="resultsSummary">Nice work!</p>

        <div class="grid-3" style="margin-top:12px;">
          <div class="card" style="text-align:center;">
            <h3 style="font-size:22px; margin-bottom:6px;">Score</h3>
            <div class="kid-big" id="scoreBox">0 / 10</div>
          </div>
          <div class="card" style="text-align:center;">
            <h3 style="font-size:22px; margin-bottom:6px;">Needs Practice</h3>
            <div class="small" id="needsBox">â€”</div>
          </div>
          <div class="card" style="text-align:center;">
            <h3 style="font-size:22px; margin-bottom:6px;">Recommended Next</h3>
            <div class="small" id="readyBox">â€”</div>
          </div>
        </div>

        <!-- Game length (after diagnostic) -->
        <div class="game-box" style="margin-top:14px;">
          <div class="small" style="text-align:center; margin-bottom:10px;">Choose Game Length</div>
          <div class="quick-strip" style="justify-content:center;">
            <button class="btn secondary len-btn active" data-len="5" type="button">5 Rounds</button>
            <button class="btn secondary len-btn" data-len="10" type="button">10 Rounds</button>
            <button class="btn secondary len-btn" data-len="endless" type="button">Endless</button>
          </div>
        </div>

        <div class="quick-strip" style="justify-content:center; margin-top:14px;">
          <button class="btn" id="goRecommendedBtn" type="button">Start Recommended Path</button>
          <button class="btn secondary" id="goChooseGameBtn" type="button">Choose a Game</button>
          <button class="btn secondary" id="retakeBtn" type="button">Retake Diagnostic</button>
        </div>
      </div>

      <!-- Game Hub -->
      <div id="gameHub" class="game-box" style="margin-top:16px; display:none;">
        <div class="kid-big">Pick a Math Game ğŸ®</div>
        <p class="small">Choose what you want to practice. (Games change by grade!)</p>

        <div class="game-box" style="margin-top:12px;">
          <div class="small" style="text-align:center; margin-bottom:10px;">Game Length</div>
          <div class="quick-strip" style="justify-content:center;">
            <button class="btn secondary len-btn" data-len="5" type="button">5 Rounds</button>
            <button class="btn secondary len-btn" data-len="10" type="button">10 Rounds</button>
            <button class="btn secondary len-btn" data-len="endless" type="button">Endless</button>
          </div>
        </div>

        <div class="grid-3" style="margin-top:12px;">
          <div class="card pick" data-game="counting">
            <h3>ğŸ Count & Tap</h3>
            <p class="small">Count objects and choose the number.</p>
            <div class="small tag" id="tagCount"></div>
          </div>

          <div class="card pick" data-game="numberLine">
            <h3>ğŸªœ Number Line Hop</h3>
            <p class="small">Jump forward/back to find the answer.</p>
            <div class="small tag" id="tagLine"></div>
          </div>

          <div class="card pick" data-game="facts">
            <h3>âš¡ Speed Facts</h3>
            <p class="small">Quick add/subtract with instant feedback.</p>
            <div class="small tag" id="tagFacts"></div>
          </div>

          <div class="card pick" data-game="placeValue">
            <h3>ğŸ§± Place Value Builder</h3>
            <p class="small">Build numbers with tens & ones (G2).</p>
            <div class="small tag" id="tagPV"></div>
          </div>

          <div class="card pick" data-game="wordProblems">
            <h3>ğŸ§º Word Problem Picnic</h3>
            <p class="small">Solve mini story problems.</p>
            <div class="small tag" id="tagWP"></div>
          </div>

          <div class="card pick" data-game="shapes">
            <h3>ğŸ”· Shape Safari</h3>
            <p class="small">Pick the shape and its features.</p>
            <div class="small tag" id="tagShapes"></div>
          </div>
        </div>

        <div class="hero-note" style="text-align:center; margin-top:12px;">
          Earn â­ for correct answers. Stars save on this device.
        </div>
      </div>

      <!-- Game Stage -->
      <div id="gameStage" class="game-box" style="margin-top:16px; display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <div class="kid-big" id="gameTitle">Game</div>
            <div class="small" id="gameDesc"></div>
          </div>
          <div class="quick-strip" style="justify-content:flex-end;">
            <button class="btn secondary" id="backToHubBtn" type="button">â† Back</button>
            <button class="btn secondary" id="newRoundBtn" type="button">New Round</button>
            <button class="btn secondary" id="speakBtn" type="button" title="Read aloud">ğŸ”Š</button>
          </div>
        </div>

        <div class="game-box" style="margin-top:12px;">
          <div class="small" id="roundText">Round 1</div>
          <div class="kid-big" id="promptText" style="margin-top:6px;">Prompt</div>
          <div class="small" id="promptHint" style="margin-top:6px;"></div>

          <div id="stageBody" style="margin-top:14px;"></div>

          <div class="kid-big" id="stageFeedback" style="margin-top:12px;"></div>
          <div class="small" id="starsText" style="margin-top:6px;"></div>
        </div>
      </div>

    </div>
  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
  // -----------------------------
  // Storage Keys
  // -----------------------------
  const PREF_GRADE_KEY = "bloom_pref_grade";
  const PREF_LEN_KEY   = "bloom_pref_math_len";
  const MATH_DIAG_KEY  = "bloom_math_diag_v1";
  const PROG_KEY       = "bloom_progress";

  // -----------------------------
  // Helpers
  // -----------------------------
  function load(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function speak(text){
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1;
    u.pitch = 1.05;
    speechSynthesis.speak(u);
  }

  function addMathStar(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.mathStars = (p.mathStars || 0) + 1;
    save(PROG_KEY, p);
    return p.mathStars;
  }
  function getMathStars(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    return (p.mathStars || 0);
  }

  // -----------------------------
  // UI refs
  // -----------------------------
  const startDiagBtn = document.getElementById("startDiagBtn");
  const chooseGameBtn = document.getElementById("chooseGameBtn");
  const recommendedBtn = document.getElementById("recommendedBtn");

  const diagPanel = document.getElementById("diagPanel");
  const resultsPanel = document.getElementById("resultsPanel");
  const gameHub = document.getElementById("gameHub");
  const gameStage = document.getElementById("gameStage");

  const diagQuestion = document.getElementById("diagQuestion");
  const diagHint = document.getElementById("diagHint");
  const diagChoices = document.getElementById("diagChoices");
  const diagProgressText = document.getElementById("diagProgressText");
  const diagNextBtn = document.getElementById("diagNextBtn");
  const diagRestartBtn = document.getElementById("diagRestartBtn");
  const diagFeedback = document.getElementById("diagFeedback");
  const diagSpeakBtn = document.getElementById("diagSpeakBtn");

  const scoreBox = document.getElementById("scoreBox");
  const needsBox = document.getElementById("needsBox");
  const readyBox = document.getElementById("readyBox");
  const resultsSummary = document.getElementById("resultsSummary");
  const goChooseGameBtn = document.getElementById("goChooseGameBtn");
  const goRecommendedBtn = document.getElementById("goRecommendedBtn");
  const retakeBtn = document.getElementById("retakeBtn");

  const tagCount = document.getElementById("tagCount");
  const tagLine = document.getElementById("tagLine");
  const tagFacts = document.getElementById("tagFacts");
  const tagPV = document.getElementById("tagPV");
  const tagWP = document.getElementById("tagWP");
  const tagShapes = document.getElementById("tagShapes");

  const gameTitle = document.getElementById("gameTitle");
  const gameDesc = document.getElementById("gameDesc");
  const roundText = document.getElementById("roundText");
  const promptText = document.getElementById("promptText");
  const promptHint = document.getElementById("promptHint");
  const stageBody = document.getElementById("stageBody");
  const stageFeedback = document.getElementById("stageFeedback");
  const starsText = document.getElementById("starsText");

  const backToHubBtn = document.getElementById("backToHubBtn");
  const newRoundBtn = document.getElementById("newRoundBtn");
  const speakBtn = document.getElementById("speakBtn");

  function showOnly(panel){
    diagPanel.style.display = "none";
    resultsPanel.style.display = "none";
    gameHub.style.display = "none";
    gameStage.style.display = "none";
    panel.style.display = "block";
  }

  // -----------------------------
  // Grade
  // -----------------------------
  let grade = localStorage.getItem(PREF_GRADE_KEY) || "K";
  const gradeBtns = Array.from(document.querySelectorAll(".grade-btn"));
  function setGrade(g){
    grade = g;
    localStorage.setItem(PREF_GRADE_KEY, g);
    gradeBtns.forEach(b => b.classList.toggle("active", b.dataset.grade === grade));
    hydrateButtons();
    if (gameHub.style.display !== "none") renderGameTags(readSavedDiag());
  }
  gradeBtns.forEach(btn=> btn.addEventListener("click", ()=> setGrade(btn.dataset.grade)));
  setGrade(grade);

  // -----------------------------
  // Game length
  // -----------------------------
  let gameLen = localStorage.getItem(PREF_LEN_KEY) || "5";
  function setGameLen(v){
    gameLen = v;
    localStorage.setItem(PREF_LEN_KEY, v);
    document.querySelectorAll(".len-btn").forEach(b=>{
      b.classList.toggle("active", b.dataset.len === gameLen);
    });
  }
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest(".len-btn");
    if (!btn) return;
    setGameLen(btn.dataset.len);
  });
  setGameLen(gameLen);

  function calcRoundsTarget(){
    if (gameLen === "endless") return Infinity;
    const n = parseInt(gameLen, 10);
    return Number.isFinite(n) ? n : 5;
  }

  // -----------------------------
  // Diagnostic bank (Kâ€“2)
  // skills:
  // K: counting, shapes, compare
  // 1: addSub, word, shapes
  // 2: addSub, placeValue, word
  // -----------------------------
  const diagBanks = {
    K: [
      { skill:"count", q:"Count the apples: ğŸğŸğŸğŸ", choices:["3","4","5"], correct:"4", hint:"Count each apple." },
      { skill:"count", q:"How many stars? â­â­â­â­â­", choices:["4","5","6"], correct:"5", hint:"Count the stars." },
      { skill:"compare", q:"Which is MORE?", choices:["ğŸªğŸªğŸª vs ğŸªğŸª","ğŸªğŸª vs ğŸªğŸªğŸª","ğŸªğŸª vs ğŸªğŸª"], correct:"ğŸªğŸªğŸª vs ğŸªğŸª", hint:"More means bigger group." },
      { skill:"compare", q:"Which is LESS?", choices:["ğŸŸğŸŸğŸŸ vs ğŸŸğŸŸ","ğŸŸğŸŸğŸŸ vs ğŸŸğŸŸğŸŸğŸŸ","ğŸŸğŸŸ vs ğŸŸ"], correct:"ğŸŸğŸŸ vs ğŸŸ", hint:"Less means smaller group." },
      { skill:"shapes", q:"Which one is a CIRCLE?", choices:["ğŸ”º","âšª","â¬›"], correct:"âšª", hint:"Circle is round." },
      { skill:"shapes", q:"Which one is a TRIANGLE?", choices:["ğŸ”º","âšª","â¬›"], correct:"ğŸ”º", hint:"Triangle has 3 sides." },
      { skill:"count", q:"Count the frogs: ğŸ¸ğŸ¸ğŸ¸", choices:["2","3","4"], correct:"3", hint:"Count each frog." },
      { skill:"compare", q:"Which number is bigger?", choices:["2","7","5"], correct:"7", hint:"Bigger = more." },
      { skill:"shapes", q:"Which one is a SQUARE?", choices:["â¬›","âšª","ğŸ”º"], correct:"â¬›", hint:"Square has 4 equal sides." },
      { skill:"count", q:"How many balloons? ğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆ", choices:["5","6","7"], correct:"6", hint:"Count them carefully." }
    ],
    1: [
      { skill:"facts", q:"5 + 3 = ?", choices:["7","8","9"], correct:"8", hint:"Count up 3 from 5." },
      { skill:"facts", q:"10 âˆ’ 4 = ?", choices:["5","6","7"], correct:"6", hint:"Count back 4 from 10." },
      { skill:"facts", q:"6 + 6 = ?", choices:["10","12","14"], correct:"12", hint:"Double 6." },
      { skill:"facts", q:"9 âˆ’ 5 = ?", choices:["3","4","5"], correct:"4", hint:"Count back 5." },
      { skill:"word", q:"Lia has 4 shells. She finds 3 more. How many shells now?", choices:["6","7","8"], correct:"7", hint:"Add 4 and 3." },
      { skill:"word", q:"Ben has 8 stickers. He gives away 2. How many left?", choices:["5","6","7"], correct:"6", hint:"Take away 2." },
      { skill:"shapes", q:"How many sides does a triangle have?", choices:["3","4","5"], correct:"3", hint:"Triangle = 3 sides." },
      { skill:"shapes", q:"How many corners does a square have?", choices:["3","4","5"], correct:"4", hint:"Square = 4 corners." },
      { skill:"facts", q:"7 + 2 = ?", choices:["8","9","10"], correct:"9", hint:"Count on 2." },
      { skill:"word", q:"There are 5 ducks in a pond. 2 more swim in. How many ducks?", choices:["6","7","8"], correct:"7", hint:"Add 5 + 2." }
    ],
    2: [
      { skill:"facts", q:"12 âˆ’ 7 = ?", choices:["4","5","6"], correct:"5", hint:"Count up from 7 to 12." },
      { skill:"facts", q:"8 + 9 = ?", choices:["16","17","18"], correct:"17", hint:"Make 10: 8+2=10, then +7." },
      { skill:"place", q:"What is the value of the 3 in 34?", choices:["3","30","300"], correct:"30", hint:"3 tens = 30." },
      { skill:"place", q:"Which number has 4 tens and 2 ones?", choices:["24","42","402"], correct:"42", hint:"4 tens = 40, plus 2." },
      { skill:"word", q:"Maya has 15 marbles. She loses 6. How many marbles now?", choices:["8","9","10"], correct:"9", hint:"15 âˆ’ 6." },
      { skill:"word", q:"A box has 9 crayons. Another box has 8 crayons. How many in all?", choices:["16","17","18"], correct:"17", hint:"9 + 8." },
      { skill:"facts", q:"14 âˆ’ 8 = ?", choices:["5","6","7"], correct:"6", hint:"Count up from 8 to 14." },
      { skill:"place", q:"Which is bigger?", choices:["39","93","30"], correct:"93", hint:"9 tens is big!" },
      { skill:"word", q:"There are 12 birds. 5 fly away. How many birds left?", choices:["6","7","8"], correct:"7", hint:"12 âˆ’ 5." },
      { skill:"facts", q:"7 + 7 = ?", choices:["12","14","16"], correct:"14", hint:"Double 7." }
    ]
  };

  function getTenDiagQuestions(g){
    const pool = (diagBanks[g] || diagBanks.K).slice();
    return shuffle(pool).slice(0, 10);
  }

  // -----------------------------
  // Diagnostic state
  // -----------------------------
  let diagQs = [];
  let diagIndex = 0;
  let diagCorrect = 0;
  let diagAnswered = false;
  let diagMiss = { count:0, compare:0, shapes:0, facts:0, word:0, place:0 };
  let lastDiagSpeakText = "";

  function renderDiagQuestion(){
    diagAnswered = false;
    diagFeedback.textContent = "";
    diagNextBtn.disabled = true;

    const q = diagQs[diagIndex];
    diagProgressText.textContent = `Question ${diagIndex + 1} of 10`;

    diagQuestion.textContent = q.q;
    diagHint.textContent = q.hint || "";
    lastDiagSpeakText = q.q;

    diagChoices.innerHTML = "";
    q.choices.forEach((c)=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.addEventListener("click", ()=> pickDiagAnswer(c));
      diagChoices.appendChild(card);
    });
  }

  function pickDiagAnswer(choice){
    if (diagAnswered) return;
    diagAnswered = true;

    const q = diagQs[diagIndex];
    const correct = (choice === q.correct);

    if (correct){
      diagCorrect++;
      diagFeedback.textContent = "Correct! â­";
      speak("Correct!");
    } else {
      diagFeedback.textContent = `Good try! âœ… Answer: ${q.correct}`;
      if (q.skill && (q.skill in diagMiss)) diagMiss[q.skill] += 1;
      speak("Try again.");
    }

    Array.from(diagChoices.children).forEach((card)=>{
      const val = card.querySelector("h3")?.textContent;
      card.style.opacity = "0.92";
      if (val === q.correct) card.style.outline = "3px solid rgba(46, 125, 80, .35)";
      if (val === choice && val !== q.correct) card.style.outline = "3px solid rgba(180, 60, 60, .22)";
    });

    diagNextBtn.disabled = false;
  }

  function saveDiag(result){ save(MATH_DIAG_KEY, result); }
  function readSavedDiag(){ return load(MATH_DIAG_KEY, null); }

  function recommendGameKey(saved){
    const miss = saved?.misses || {};
    const entries = Object.entries(miss);
    let best = { key:"facts", n:-1 };
    entries.forEach(([k,n])=>{ if ((n||0) > best.n) best = { key:k, n:n||0 }; });

    // map diagnostic skills to game keys
    if (best.n <= 0){
      // no big misses: choose grade-appropriate â€œfun mixâ€
      return (grade === "K") ? "counting" : (grade === "1") ? "facts" : "wordProblems";
    }
    if (best.key === "count") return "counting";
    if (best.key === "compare") return "counting";
    if (best.key === "shapes") return "shapes";
    if (best.key === "place") return "placeValue";
    if (best.key === "word") return "wordProblems";
    return "facts";
  }

  function humanGameName(key){
    const map = {
      counting:"Count & Tap",
      numberLine:"Number Line Hop",
      facts:"Speed Facts",
      placeValue:"Place Value Builder",
      wordProblems:"Word Problem Picnic",
      shapes:"Shape Safari"
    };
    return map[key] || "Speed Facts";
  }

  function finishDiagnostic(){
    const score = diagCorrect;
    const total = 10;

    const missPairs = Object.entries(diagMiss)
      .map(([k,n])=>({k,n}))
      .sort((a,b)=> b.n - a.n);

    const readable = (k)=>{
      const m = { count:"Counting", compare:"Compare", shapes:"Shapes", facts:"Facts", word:"Word Problems", place:"Place Value" };
      return m[k] || k;
    };

    const needs = (missPairs[0].n === 0)
      ? "Nothing big â€” youâ€™re doing great!"
      : missPairs.filter(x=>x.n>0).slice(0,2).map(x=>readable(x.k)).join(", ");

    const next = recommendGameKey({ misses: diagMiss, grade });

    const result = { date: Date.now(), grade, score, total, misses: { ...diagMiss }, recommended: next };
    saveDiag(result);

    scoreBox.textContent = `${score} / ${total}`;
    needsBox.textContent = needs;
    readyBox.textContent = humanGameName(next);
    resultsSummary.textContent = `You scored ${Math.round((score/total)*100)}% for Grade ${grade === "K" ? "K" : grade}!`;

    renderGameTags(result);
    hydrateButtons();

    showOnly(resultsPanel);
  }

  // -----------------------------
  // Tags
  // -----------------------------
  function renderGameTags(saved){
    const s = saved || readSavedDiag();
    const miss = s?.misses || {};

    function mkTag(label, keys){
      const n = keys.reduce((sum,k)=> sum + (miss[k] || 0), 0);
      return n ? `Recommended â­ (missed ${n})` : `Ready âœ…`;
    }

    tagCount.textContent  = mkTag("Count", ["count","compare"]);
    tagLine.textContent   = (grade === "K") ? "Fun practice ğŸ‰" : "Great for strategies âœ…";
    tagFacts.textContent  = mkTag("Facts", ["facts"]);
    tagPV.textContent     = (grade === "2") ? mkTag("Place", ["place"]) : "Unlock in Grade 2 âœ…";
    tagWP.textContent     = mkTag("Word", ["word"]);
    tagShapes.textContent = mkTag("Shapes", ["shapes"]);
  }

  // -----------------------------
  // Enable/disable action buttons
  // -----------------------------
  function hydrateButtons(){
    const saved = readSavedDiag();
    const ok = saved && saved.grade === grade && saved.total === 10;
    chooseGameBtn.disabled = !ok;
    chooseGameBtn.style.opacity = ok ? "1" : ".6";
    recommendedBtn.disabled = !ok;
    recommendedBtn.style.opacity = ok ? "1" : ".6";
  }

  // -----------------------------
  // Game Engine
  // -----------------------------
  let activeGame = null;
  let round = 1;
  let roundsTarget = 5;
  let lastSpeakText = "";

  function setStageHeader(title, desc){
    gameTitle.textContent = title;
    gameDesc.textContent = desc;
    stageFeedback.textContent = "";
    starsText.textContent = `Math â­: ${getMathStars()}`;
  }

  function setPrompt(text, hint, speakText){
    promptText.textContent = text;
    promptHint.textContent = hint || "";
    stageFeedback.textContent = "";
    const maxText = (roundsTarget === Infinity) ? "Endless" : roundsTarget;
    roundText.textContent = `Round ${round} of ${maxText}`;
    stageBody.innerHTML = "";
    lastSpeakText = speakText || text;
  }

  function feedbackOk(msg){
    stageFeedback.textContent = msg || "Correct! â­";
    addMathStar();
    starsText.textContent = `Math â­: ${getMathStars()}`;
  }
  function feedbackNo(msg){ stageFeedback.textContent = msg || "Try again ğŸ™‚"; }

  function openHub(){
    renderGameTags(readSavedDiag());
    setGameLen(gameLen);
    showOnly(gameHub);
  }

  function openStage(gameKey){
    activeGame = gameKey;
    round = 1;
    roundsTarget = calcRoundsTarget();
    showOnly(gameStage);
    runRound();
  }

  function maybeFinish(){
    if (roundsTarget !== Infinity && round > roundsTarget){
      stageFeedback.textContent = "ğŸ‰ Great job! You finished your game!";
      promptText.textContent = "Want to play another game?";
      promptHint.textContent = "Tap â† Back to pick a new one, or press New Round.";
      stageBody.innerHTML = "";
      lastSpeakText = "Great job! You finished your game!";
      return true;
    }
    return false;
  }

  function nextRoundSoon(){
    setTimeout(()=>{
      round++;
      if (maybeFinish()) return;
      runRound();
    }, 650);
  }

  function runRound(){
    stageFeedback.textContent = "";
    starsText.textContent = `Math â­: ${getMathStars()}`;
    if (maybeFinish()) return;

    if (activeGame === "counting") return roundCounting();
    if (activeGame === "numberLine") return roundNumberLine();
    if (activeGame === "facts") return roundFacts();
    if (activeGame === "placeValue") return roundPlaceValue();
    if (activeGame === "wordProblems") return roundWordProblems();
    if (activeGame === "shapes") return roundShapes();
  }

  function cardChoices(choices, correct, onCorrectMsg){
    const grid = document.createElement("div");
    grid.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> {
        if (String(c) === String(correct)){
          feedbackOk(onCorrectMsg || "Correct! â­");
          nextRoundSoon();
        } else {
          feedbackNo("Try again ğŸ™‚");
        }
      };
      grid.appendChild(card);
    });
    stageBody.appendChild(grid);
  }

  // -----------------------------
  // Game Content
  // -----------------------------
  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // ğŸ Count & Tap
  function roundCounting(){
    setStageHeader("ğŸ Count & Tap", "Count objects and choose the number.");
    let n;
    let emoji;
    if (grade === "K"){
      n = randInt(1, 10);
      emoji = pick(["ğŸ","â­","ğŸ¸","ğŸˆ","ğŸª"]);
    } else if (grade === "1"){
      n = randInt(6, 20);
      emoji = pick(["ğŸ","â­","ğŸŸ","ğŸª","ğŸ"]);
    } else {
      n = randInt(10, 30);
      emoji = pick(["â­","ğŸª","ğŸŸ","ğŸ"]);
    }

    const row = Array.from({length:n}, ()=>emoji).join(" ");
    setPrompt(`Count them: ${row}`, "Count carefully, then tap the number.", `Count them. How many are there?`);

    const correct = n;
    const choices = shuffle([correct, correct + randInt(1,3), Math.max(0, correct - randInt(1,3))].map(x=>String(x)));
    cardChoices(choices, String(correct), "Counted it! â­");
  }

  // ğŸªœ Number Line Hop
  function roundNumberLine(){
    setStageHeader("ğŸªœ Number Line Hop", "Jump forward/back to find the answer.");
    let start, move;
    if (grade === "K"){
      start = randInt(0, 10);
      move = randInt(1, 5);
    } else if (grade === "1"){
      start = randInt(0, 20);
      move = randInt(2, 9);
    } else {
      start = randInt(0, 50);
      move = randInt(5, 15);
    }
    const dir = Math.random() < 0.5 ? "forward" : "back";
    const ans = (dir === "forward") ? start + move : Math.max(0, start - move);

    const hops = Array.from({length:move}, ()=> "ğŸŸ©").join("");
    setPrompt(`Start at ${start}. Hop ${dir} ${move}.`, `Hops: ${hops}`, `Start at ${start}. Hop ${dir} ${move}. What number do you land on?`);

    const choices = shuffle([ans, ans + randInt(1,3), Math.max(0, ans - randInt(1,3))].map(x=>String(x)));
    cardChoices(choices, String(ans), "Nice hopping! â­");
  }

  // âš¡ Speed Facts (add/sub based on grade)
  function roundFacts(){
    setStageHeader("âš¡ Speed Facts", "Quick add/subtract with instant feedback.");
    let a,b,op,ans;

    if (grade === "K"){
      a = randInt(0, 10);
      b = randInt(0, 10-a);
      op = "+";
      ans = a + b;
    } else if (grade === "1"){
      const useAdd = Math.random()<0.6;
      if (useAdd){
        a = randInt(0, 20);
        b = randInt(0, 20-a);
        op = "+";
        ans = a + b;
      } else {
        a = randInt(0, 20);
        b = randInt(0, a);
        op = "âˆ’";
        ans = a - b;
      }
    } else {
      const useAdd = Math.random()<0.55;
      if (useAdd){
        a = randInt(5, 20);
        b = randInt(5, 20);
        op = "+";
        ans = a + b;
      } else {
        a = randInt(10, 30);
        b = randInt(1, 20);
        if (b > a) [a,b]=[b,a];
        op = "âˆ’";
        ans = a - b;
      }
    }

    setPrompt(`${a} ${op} ${b} = ?`, "Think: make 10, doubles, or count on/back.", `${a} ${op} ${b} equals what?`);

    const choices = shuffle([ans, ans + randInt(1,3), Math.max(0, ans - randInt(1,3))].map(x=>String(x)));
    cardChoices(choices, String(ans), "Fast facts! â­");
  }

  // ğŸ§± Place Value Builder (mostly Grade 2)
  function roundPlaceValue(){
    setStageHeader("ğŸ§± Place Value Builder", "Build numbers with tens & ones.");
    if (grade !== "2"){
      setPrompt("This game unlocks in Grade 2 ğŸ˜Š", "Pick another game from the hub.", "This game is for grade 2.");
      stageBody.innerHTML = `<div class="game-box"><div class="kid-big">Try âš¡ Speed Facts or ğŸ§º Word Problems!</div></div>`;
      return;
    }

    const tens = randInt(1, 9);
    const ones = randInt(0, 9);
    const num = tens*10 + ones;

    setPrompt(`Build the number: ${num}`, "Choose the tens and ones.", `Build the number ${num}.`);

    const box = document.createElement("div");
    box.className = "game-box";
    box.innerHTML = `
      <div class="small">Pick the tens:</div>
      <div class="quick-strip" id="tensRow" style="justify-content:center; flex-wrap:wrap;"></div>
      <div class="small" style="margin-top:10px;">Pick the ones:</div>
      <div class="quick-strip" id="onesRow" style="justify-content:center; flex-wrap:wrap;"></div>
      <div class="kid-big" id="pvStatus" style="margin-top:10px;">Tens: â€” | Ones: â€”</div>
    `;
    stageBody.appendChild(box);

    let pickT = null;
    let pickO = null;

    function update(){
      const status = document.getElementById("pvStatus");
      status.textContent = `Tens: ${pickT===null?"â€”":pickT} | Ones: ${pickO===null?"â€”":pickO}`;
      if (pickT !== null && pickO !== null){
        const built = pickT*10 + pickO;
        if (built === num){
          feedbackOk("Built it! â­");
          nextRoundSoon();
        } else {
          feedbackNo(`Not quite. You built ${built}. Try again ğŸ™‚`);
        }
      }
    }

    const tensRow = box.querySelector("#tensRow");
    const onesRow = box.querySelector("#onesRow");

    // Keep it small + kid-friendly: offer 3 options each
    const tensChoices = shuffle([tens, Math.max(1, tens-1), Math.min(9, tens+1)]).slice(0,3);
    const onesChoices = shuffle([ones, (ones+2)%10, (ones+5)%10]).slice(0,3);

    tensChoices.forEach(t=>{
      const b = document.createElement("button");
      b.className = "pill";
      b.textContent = `${t} tens`;
      b.onclick = ()=>{ pickT = t; update(); };
      tensRow.appendChild(b);
    });

    onesChoices.forEach(o=>{
      const b = document.createElement("button");
      b.className = "pill";
      b.textContent = `${o} ones`;
      b.onclick = ()=>{ pickO = o; update(); };
      onesRow.appendChild(b);
    });
  }

  // ğŸ§º Word Problem Picnic
  function roundWordProblems(){
    setStageHeader("ğŸ§º Word Problem Picnic", "Solve mini story problems.");
    const bank = {
      K: [
        { q:"There are 3 ducks. 2 more join. How many ducks?", a:5, hint:"Add 3 + 2." },
        { q:"You have 4 apples. You eat 1. How many left?", a:3, hint:"Take away 1." }
      ],
      1: [
        { q:"Lia has 6 stickers. She gets 5 more. How many?", a:11, hint:"Add 6 + 5." },
        { q:"Ben has 12 beads. He gives away 4. How many left?", a:8, hint:"12 âˆ’ 4." }
      ],
      2: [
        { q:"A shelf has 14 books. 6 are checked out. How many left?", a:8, hint:"14 âˆ’ 6." },
        { q:"There are 9 red balloons and 8 blue balloons. How many total?", a:17, hint:"9 + 8." }
      ]
    };

    const it = pick(bank[grade] || bank.K);
    setPrompt(it.q, it.hint, it.q);

    const ans = it.a;
    const choices = shuffle([ans, ans + randInt(1,3), Math.max(0, ans - randInt(1,3))].map(x=>String(x)));
    cardChoices(choices, String(ans), "Solved it! â­");
  }

  // ğŸ”· Shape Safari
  function roundShapes(){
    setStageHeader("ğŸ”· Shape Safari", "Pick the shape and its features.");
    const shapesK = [
      { q:"Which is a circle?", a:"âšª", c:["âšª","ğŸ”º","â¬›"], hint:"Circle is round." },
      { q:"Which is a square?", a:"â¬›", c:["â¬›","âšª","ğŸ”º"], hint:"Square has 4 equal sides." },
      { q:"Which is a triangle?", a:"ğŸ”º", c:["ğŸ”º","âšª","â¬›"], hint:"Triangle has 3 sides." }
    ];
    const shapes1 = [
      { q:"How many sides does a triangle have?", a:"3", c:["3","4","5"], hint:"Triangle = 3 sides." },
      { q:"How many corners does a square have?", a:"4", c:["3","4","5"], hint:"Square = 4 corners." },
      { q:"Which shape has 0 corners?", a:"Circle", c:["Square","Triangle","Circle"], hint:"Circle is round." }
    ];
    const shapes2 = [
      { q:"A rectangle hasâ€¦", a:"4 sides", c:["3 sides","4 sides","5 sides"], hint:"Rectangle has 4 sides." },
      { q:"Which has 4 corners?", a:"Square", c:["Circle","Square","Triangle"], hint:"Corners = vertices." },
      { q:"A triangle hasâ€¦", a:"3 sides", c:["2 sides","3 sides","4 sides"], hint:"Triangle = 3." }
    ];

    const it = pick(grade==="K" ? shapesK : grade==="1" ? shapes1 : shapes2);
    setPrompt(it.q, it.hint, it.q);

    const choices = shuffle(it.c.slice());
    cardChoices(choices, it.a, "Shape expert! â­");
  }

  // -----------------------------
  // Hub + Stage handlers
  // -----------------------------
  document.querySelectorAll(".card.pick").forEach(card=>{
    card.style.cursor = "pointer";
    card.addEventListener("click", ()=> openStage(card.dataset.game));
  });

  backToHubBtn.addEventListener("click", openHub);
  newRoundBtn.addEventListener("click", ()=>{ round++; runRound(); });
  speakBtn.addEventListener("click", ()=> speak(lastSpeakText || promptText.textContent));

  // -----------------------------
  // Diagnostic events
  // -----------------------------
  startDiagBtn.addEventListener("click", ()=>{
    diagQs = getTenDiagQuestions(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagAnswered = false;
    diagMiss = { count:0, compare:0, shapes:0, facts:0, word:0, place:0 };
    showOnly(diagPanel);
    renderDiagQuestion();
  });

  diagNextBtn.addEventListener("click", ()=>{
    if (!diagAnswered) return;
    diagIndex++;
    if (diagIndex >= 10) finishDiagnostic();
    else renderDiagQuestion();
  });

  diagRestartBtn.addEventListener("click", ()=>{
    diagQs = getTenDiagQuestions(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagAnswered = false;
    diagMiss = { count:0, compare:0, shapes:0, facts:0, word:0, place:0 };
    renderDiagQuestion();
  });

  diagSpeakBtn.addEventListener("click", ()=> speak(lastDiagSpeakText || diagQuestion.textContent));

  retakeBtn.addEventListener("click", ()=>{
    localStorage.removeItem(MATH_DIAG_KEY);
    hydrateButtons();
    diagQs = getTenDiagQuestions(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagAnswered = false;
    diagMiss = { count:0, compare:0, shapes:0, facts:0, word:0, place:0 };
    showOnly(diagPanel);
    renderDiagQuestion();
  });

  chooseGameBtn.addEventListener("click", openHub);
  goChooseGameBtn.addEventListener("click", openHub);

  function startRecommended(){
    const saved = readSavedDiag();
    const key = saved?.recommended || recommendGameKey(saved);
    openStage(key);
  }
  recommendedBtn.addEventListener("click", startRecommended);
  goRecommendedBtn.addEventListener("click", startRecommended);

  // -----------------------------
  // Save/read diag + tags + buttons
  // -----------------------------
  function saveDiag(result){ save(MATH_DIAG_KEY, result); }
  function readSavedDiag(){ return load(MATH_DIAG_KEY, null); }

  function renderGameTags(saved){
    const s = saved || readSavedDiag();
    const miss = s?.misses || {};

    function mkTag(keys){
      const n = keys.reduce((sum,k)=> sum + (miss[k] || 0), 0);
      return n ? `Recommended â­ (missed ${n})` : `Ready âœ…`;
    }

    tagCount.textContent  = mkTag(["count","compare"]);
    tagLine.textContent   = (grade === "K") ? "Fun practice ğŸ‰" : "Strategy booster âœ…";
    tagFacts.textContent  = mkTag(["facts"]);
    tagPV.textContent     = (grade === "2") ? mkTag(["place"]) : "Unlock in Grade 2 âœ…";
    tagWP.textContent     = mkTag(["word"]);
    tagShapes.textContent = mkTag(["shapes"]);
  }

  function hydrateButtons(){
    const saved = readSavedDiag();
    const ok = saved && saved.grade === grade && saved.total === 10;
    chooseGameBtn.disabled = !ok;
    chooseGameBtn.style.opacity = ok ? "1" : ".6";
    recommendedBtn.disabled = !ok;
    recommendedBtn.style.opacity = ok ? "1" : ".6";
  }

  // -----------------------------
  // Init
  // -----------------------------
  function hydrate(){
    hydrateButtons();
    const saved = readSavedDiag();
    if (saved && saved.grade === grade) renderGameTags(saved);
    else renderGameTags({ grade, misses:{} });
  }
  hydrate();
  setGameLen(gameLen);
</script>

</body>
</html>
