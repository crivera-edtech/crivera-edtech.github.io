<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Formation | BloomELearning ‚ú®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning ‚ú®</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="phonics.html">Phonics</a></li>
        <li><a href="resources.html">Kids Resources</a></li>
        <li><a href="progress.html">My Progress</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>‚úçÔ∏è Letter Formation Game</h1>
    <p>Trace the shape by touching the green dots in order ‚Äî then celebrate! üéâ</p>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Trace & Shine ‚≠ê</h2>

    <div class="game-box">
      <div class="kid-big">Choose a set:</div>
      <div class="grade-row" id="setTabs">
        <button class="select active" data-set="upper">ABC (Uppercase)</button>
        <button class="select" data-set="lower">abc (Lowercase)</button>
        <button class="select" data-set="nums">123 (Numbers)</button>
      </div>

      <div class="kid-big" style="margin-top:12px;">Pick one:</div>
      <div class="grade-row" id="itemButtons"></div>

      <div class="game-row">
        <button class="btn secondary" id="sayBtn">üîä Say Instructions</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
        <button class="btn" id="nextBtn">Next</button>
      </div>

      <div class="canvas-wrap" style="margin-top:14px;">
        <canvas id="board" width="900" height="520"></canvas>
      </div>

      <div class="status" id="status">Tap a letter or number to begin!</div>
      <div class="badge-row">
        <span class="badge" id="stars">‚≠ê Stars: 0</span>
        <span class="badge" id="dots">üü¢ Dots: 0/0</span>
        <span class="badge" id="perfect">‚ú® Perfect: 0</span>
      </div>

      <p class="small" style="margin-top:10px;">
        Tip: Use your finger on a tablet. Try to touch each dot in order. If you get them all, you earn a sticker!
      </p>
    </div>
  </div>
</section>

<!-- Reward Modal -->
<div class="modal" id="rewardModal" aria-hidden="true">
  <div class="modal-card">
    <div class="sticker" id="stickerEmoji">üéâ</div>
    <div class="modal-title" id="rewardTitle">You did it!</div>
    <div class="modal-sub" id="rewardSub">Great tracing! You earned a sticker.</div>
    <div class="game-row" style="justify-content:center;">
      <button class="btn" id="playAgainBtn">Trace Another</button>
      <button class="btn secondary" id="closeModalBtn">Close</button>
    </div>
  </div>
</div>

<footer>¬© 2026 BloomELearning ‚ú® | Made with üíö</footer>

<script>
/**
 * BloomELearning Letter Formation
 * - Uppercase, Lowercase, Numbers
 * - Connect-the-dots + free drawing
 * - Confetti + sticker reward on completion
 */

const STORAGE_STARS = "bloom_tracing_stars";
const STORAGE_PERFECT = "bloom_tracing_perfect";

let stars = parseInt(localStorage.getItem(STORAGE_STARS) || "0", 10);
let perfectCount = parseInt(localStorage.getItem(STORAGE_PERFECT) || "0", 10);

const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");

const statusEl = document.getElementById("status");
const starsEl = document.getElementById("stars");
const dotsEl = document.getElementById("dots");
const perfectEl = document.getElementById("perfect");

const itemButtonsEl = document.getElementById("itemButtons");
const setTabsEl = document.getElementById("setTabs");

const rewardModal = document.getElementById("rewardModal");
const stickerEmojiEl = document.getElementById("stickerEmoji");
const rewardTitleEl = document.getElementById("rewardTitle");
const rewardSubEl = document.getElementById("rewardSub");

// ---------- DATA (dots) ----------
/**
 * Dots are in the original 900x520 coordinate system
 * We draw in CSS pixels; canvas is responsive but still uses the coordinate system.
 */

const UPPER = [
  { key:"A", model:"A", dots:[ {x:260,y:420},{x:450,y:120},{x:640,y:420},{x:340,y:300},{x:560,y:300} ] },
  { key:"B", model:"B", dots:[ {x:320,y:120},{x:320,y:420},{x:520,y:170},{x:520,y:270},{x:520,y:340},{x:520,y:410} ] },
  { key:"C", model:"C", dots:[ {x:610,y:170},{x:470,y:120},{x:330,y:200},{x:330,y:340},{x:470,y:420},{x:610,y:370} ] },
  { key:"M", model:"M", dots:[ {x:300,y:420},{x:300,y:120},{x:450,y:260},{x:600,y:120},{x:600,y:420} ] },
  { key:"S", model:"S", dots:[ {x:600,y:170},{x:450,y:120},{x:320,y:200},{x:520,y:280},{x:620,y:360},{x:450,y:420} ] }
];

const LOWER = [
  { key:"a", model:"a", dots:[ {x:520,y:260},{x:450,y:190},{x:380,y:260},{x:450,y:330},{x:520,y:330},{x:560,y:420} ] },
  { key:"b", model:"b", dots:[ {x:380,y:120},{x:380,y:420},{x:520,y:260},{x:450,y:200},{x:520,y:330} ] },
  { key:"c", model:"c", dots:[ {x:560,y:220},{x:470,y:190},{x:380,y:260},{x:400,y:340},{x:500,y:360},{x:560,y:320} ] },
  { key:"m", model:"m", dots:[ {x:320,y:360},{x:320,y:240},{x:420,y:310},{x:520,y:240},{x:520,y:360},{x:620,y:240},{x:620,y:360} ] },
  { key:"s", model:"s", dots:[ {x:540,y:230},{x:450,y:200},{x:380,y:260},{x:480,y:300},{x:560,y:340},{x:450,y:380} ] }
];

const NUMS = [
  { key:"0", model:"0", dots:[ {x:450,y:140},{x:560,y:190},{x:560,y:330},{x:450,y:400},{x:340,y:330},{x:340,y:190},{x:450,y:140} ] },
  { key:"1", model:"1", dots:[ {x:450,y:170},{x:450,y:420} ] },
  { key:"2", model:"2", dots:[ {x:340,y:210},{x:450,y:150},{x:560,y:210},{x:340,y:420},{x:560,y:420} ] },
  { key:"3", model:"3", dots:[ {x:360,y:170},{x:520,y:170},{x:460,y:260},{x:520,y:320},{x:360,y:380},{x:520,y:380} ] },
  { key:"4", model:"4", dots:[ {x:540,y:420},{x:540,y:150},{x:360,y:320},{x:600,y:320} ] },
  { key:"5", model:"5", dots:[ {x:560,y:150},{x:360,y:150},{x:360,y:260},{x:520,y:260},{x:560,y:340},{x:420,y:420} ] },
  { key:"6", model:"6", dots:[ {x:540,y:180},{x:420,y:220},{x:360,y:320},{x:450,y:420},{x:560,y:340},{x:450,y:300},{x:360,y:320} ] },
  { key:"7", model:"7", dots:[ {x:340,y:150},{x:560,y:150},{x:420,y:420} ] },
  { key:"8", model:"8", dots:[ {x:450,y:150},{x:520,y:220},{x:450,y:280},{x:380,y:220},{x:450,y:150},{x:520,y:340},{x:450,y:420},{x:380,y:340},{x:520,y:340} ] },
  { key:"9", model:"9", dots:[ {x:520,y:260},{x:450,y:150},{x:360,y:240},{x:450,y:320},{x:560,y:240},{x:520,y:420} ] }
];

// ---------- STATE ----------
let currentSet = "upper";
let currentList = UPPER;
let current = currentList[0];
let dotIndex = 0;
let drawing = false;
let last = null;

// used to determine "perfect" completion (hit every dot in order without missing too much)
let misses = 0;

// Confetti particles
let confetti = [];
let confettiTimer = null;

// ---------- HELPERS ----------
function speak(text){
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1; u.pitch = 1.05;
  window.speechSynthesis.speak(u);
}

function saveCounters(){
  localStorage.setItem(STORAGE_STARS, String(stars));
  localStorage.setItem(STORAGE_PERFECT, String(perfectCount));
}

function refreshBadges(){
  starsEl.textContent = `‚≠ê Stars: ${stars}`;
  perfectEl.textContent = `‚ú® Perfect: ${perfectCount}`;
  dotsEl.textContent = `üü¢ Dots: ${dotIndex}/${current.dots.length}`;
}

function setActiveTab(setName){
  document.querySelectorAll("#setTabs .select").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.set === setName);
  });
}

function buildItemButtons(){
  itemButtonsEl.innerHTML = "";
  currentList.forEach(item=>{
    const b = document.createElement("button");
    b.className = "select";
    b.textContent = item.key;
    b.onclick = () => setItem(item.key);
    itemButtonsEl.appendChild(b);
  });
  highlightItemButton();
}

function highlightItemButton(){
  document.querySelectorAll("#itemButtons .select").forEach(btn=>{
    btn.classList.toggle("active", btn.textContent === current.key);
  });
}

function setSet(setName){
  currentSet = setName;
  setActiveTab(setName);

  if (setName === "upper") currentList = UPPER;
  if (setName === "lower") currentList = LOWER;
  if (setName === "nums") currentList = NUMS;

  current = currentList[0];
  dotIndex = 0;
  misses = 0;
  buildItemButtons();
  highlightItemButton();
  clearAndRedraw(true);
  statusEl.textContent = `Trace ${current.key}! Touch the green dots in order.`;
}

function setItem(key){
  const found = currentList.find(x => x.key === key);
  if (!found) return;
  current = found;
  dotIndex = 0;
  misses = 0;
  highlightItemButton();
  clearAndRedraw(true);
  statusEl.textContent = `Trace ${current.key}! Touch the green dots in order.`;
}

function nextItem(){
  const i = currentList.findIndex(x=>x.key === current.key);
  const next = currentList[(i+1) % currentList.length];
  setItem(next.key);
}

function clearAndRedraw(resetDotProgress){
  // Clear all drawing, optionally reset dot progress
  if (resetDotProgress) dotIndex = 0;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGuide();
  refreshBadges();
}

function drawGuide(){
  // background
  ctx.save();
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();

  // handwriting-ish lines
  ctx.save();
  ctx.strokeStyle = "rgba(58,143,107,0.18)";
  ctx.lineWidth = 3;
  const h = canvas.height;
  ctx.beginPath();
  ctx.moveTo(0, h*0.30); ctx.lineTo(canvas.width, h*0.30);
  ctx.moveTo(0, h*0.70); ctx.lineTo(canvas.width, h*0.70);
  ctx.stroke();
  ctx.restore();

  // model letter/number (ghost)
  ctx.save();
  ctx.globalAlpha = 0.12;
  ctx.fillStyle = "#2f3a2f";
  ctx.font = (currentSet === "nums" ? "240px" : "260px") + " 'Baloo 2', cursive";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(current.model, canvas.width/2, canvas.height/2);
  ctx.restore();

  // dots
  current.dots.forEach((d, i) => {
    const done = i < dotIndex;
    ctx.beginPath();
    ctx.arc(d.x, d.y, 14, 0, Math.PI*2);
    ctx.fillStyle = done ? "rgba(58,143,107,0.45)" : "rgba(58,143,107,0.95)";
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#ffffff";
    ctx.stroke();

    ctx.fillStyle = "#ffffff";
    ctx.font = "16px 'Baloo 2', cursive";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(String(i+1), d.x, d.y);
  });

  refreshBadges();
}

// ---------- INPUT / TRACING ----------
function getPos(e){
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches && e.touches[0];
  const clientX = touch ? touch.clientX : e.clientX;
  const clientY = touch ? touch.clientY : e.clientY;
  return {
    x: (clientX - rect.left) * (canvas.width / rect.width),
    y: (clientY - rect.top) * (canvas.height / rect.height)
  };
}

function distance(a,b){
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  return Math.sqrt(dx*dx + dy*dy);
}

function hitDot(pos){
  const target = current.dots[dotIndex];
  if (!target) return;

  // hit radius
  const hit = distance(pos, target) < 24;

  if (hit) {
    dotIndex++;
    statusEl.textContent = "‚úÖ Nice! Keep going‚Ä¶";
    if (dotIndex >= current.dots.length) {
      completeTrace();
    }
    drawGuide();
  } else {
    // count misses a tiny bit (used for ‚Äúperfect‚Äù)
    misses++;
  }
}

function startDraw(e){
  drawing = true;
  last = getPos(e);
  hitDot(last);
  e.preventDefault();
}

function moveDraw(e){
  if (!drawing) return;
  const pos = getPos(e);

  // draw line
  ctx.save();
  ctx.strokeStyle = "rgba(106,174,214,0.95)";
  ctx.lineWidth = 10;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(last.x, last.y);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
  ctx.restore();

  last = pos;
  hitDot(pos);
  e.preventDefault();
}

function endDraw(){
  drawing = false;
  last = null;
}

// ---------- COMPLETE + REWARD ----------
function completeTrace(){
  stars++;
  const isPerfect = misses <= Math.max(8, current.dots.length * 3); // forgiving
  if (isPerfect) perfectCount++;

  saveCounters();
  refreshBadges();

  launchConfetti();

  const stickers = ["ü¶Ñ","ü¶â","ü¶ñ","üê∞","üêº","üåà","‚≠ê","üçÄ","üéà","üßÅ"];
  const sticker = stickers[Math.floor(Math.random()*stickers.length)];
  stickerEmojiEl.textContent = sticker;

  rewardTitleEl.textContent = isPerfect ? "‚ú® Perfect Trace!" : "üéâ Great Tracing!";
  rewardSubEl.textContent = isPerfect
    ? `You traced ${current.key} perfectly and earned a star!`
    : `You traced ${current.key} and earned a star!`;

  showModal();

  // auto move to next letter after closing modal (optional)
  statusEl.textContent = `üéâ You finished ${current.key}!`;
  speak(isPerfect ? `Perfect! You traced ${current.key}.` : `Great job! You traced ${current.key}.`);
}

function showModal(){
  rewardModal.classList.add("show");
  rewardModal.setAttribute("aria-hidden", "false");
}

function hideModal(){
  rewardModal.classList.remove("show");
  rewardModal.setAttribute("aria-hidden", "true");
}

// ---------- CONFETTI ----------
function launchConfetti(){
  // stop previous
  if (confettiTimer) cancelAnimationFrame(confettiTimer);

  confetti = [];
  const count = 120;
  for (let i=0;i<count;i++){
    confetti.push({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 200,
      r: 4 + Math.random()*6,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*4,
      rot: Math.random()*Math.PI,
      vr: -0.15 + Math.random()*0.3
    });
  }

  const start = performance.now();

  function tick(t){
    // draw guide first (keeps dots visible)
    drawGuide();

    // draw confetti on top
    ctx.save();
    confetti.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.vy += 0.02; // gravity

      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);

      // no fixed colors: use varied alpha greens/blues/yellows via HSL
      const hue = 90 + Math.random()*120;
      ctx.fillStyle = `hsla(${hue}, 70%, 55%, 0.95)`;
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);

      ctx.setTransform(1,0,0,1,0,0);
    });
    ctx.restore();

    // run 1.6 seconds
    if (t - start < 1600){
      confettiTimer = requestAnimationFrame(tick);
    } else {
      // final redraw
      drawGuide();
    }
  }

  confettiTimer = requestAnimationFrame(tick);
}

// ---------- UI WIRING ----------
canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);

canvas.addEventListener("touchstart", startDraw, {passive:false});
canvas.addEventListener("touchmove", moveDraw, {passive:false});
canvas.addEventListener("touchend", endDraw);

document.getElementById("clearBtn").onclick = () => {
  dotIndex = 0;
  misses = 0;
  clearAndRedraw(true);
  statusEl.textContent = `Try again! Touch the dots in order.`;
};

document.getElementById("nextBtn").onclick = () => {
  hideModal();
  nextItem();
};

document.getElementById("sayBtn").onclick = () => {
  speak(`Trace ${current.key}. Touch the green dots in order. When you finish, you earn a star and a sticker!`);
};

// set tabs
document.querySelectorAll("#setTabs .select").forEach(btn=>{
  btn.addEventListener("click", ()=> setSet(btn.dataset.set));
});

// modal buttons
document.getElementById("closeModalBtn").onclick = () => hideModal();
document.getElementById("playAgainBtn").onclick = () => {
  hideModal();
  nextItem();
};
rewardModal.addEventListener("click", (e)=>{
  if (e.target === rewardModal) hideModal();
});

// init
function init(){
  // make canvas use the fixed coordinate system (900x520) for dots
  canvas.width = 900;
  canvas.height = 520;

  // initial UI
  starsEl.textContent = `‚≠ê Stars: ${stars}`;
  perfectEl.textContent = `‚ú® Perfect: ${perfectCount}`;

  buildItemButtons();
  drawGuide();
  statusEl.textContent = `Trace ${current.key}! Touch the green dots in order.`;
}

init();
</script>

</body>
</html>
