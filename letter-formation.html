<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Formation | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="resources.html">Kids Resources</a></li>
        <li><a href="phonics.html">Phonics</a></li>
        <li><a href="progress.html">My Progress</a></li>
        <li><a href="sticker-book.html">Sticker Book</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>âœï¸ Letter Tracing</h1>
    <p>Touch the green dots in order. Press ğŸ”Š to hear how to write the letter.</p>
    <div class="game-row" style="justify-content:center;">
      <a class="btn secondary" href="resources.html#tracing">Back to Resources</a>
      <a class="btn secondary" href="sticker-book.html">ğŸ“– Sticker Book</a>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Trace & Shine â­</h2>

    <div class="game-box">
      <div class="kid-big">Choose a set:</div>
      <div class="grade-row" id="setTabs">
        <button class="select active" data-set="upper">ABC (Uppercase)</button>
        <button class="select" data-set="lower">abc (Lowercase)</button>
        <button class="select" data-set="nums">123 (Numbers)</button>
      </div>

      <div class="kid-big" style="margin-top:12px;">Pick one:</div>
      <div class="grade-row" id="itemButtons"></div>

      <div class="game-row">
        <button class="btn" id="sayBtn">ğŸ”Š How to Write</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
        <button class="btn secondary" id="nextBtn">Next</button>
      </div>

      <div class="canvas-wrap" style="margin-top:14px;">
        <canvas id="board" width="900" height="520"></canvas>
      </div>

      <div class="status" id="status">Tap a letter or number to begin!</div>
      <div class="badge-row">
        <span class="badge" id="stars">â­ Stars: 0</span>
        <span class="badge" id="dots">ğŸŸ¢ Dots: 0/0</span>
        <span class="badge" id="perfect">âœ¨ Perfect: 0</span>
      </div>

      <div class="game-row" style="margin-top:14px;">
        <a class="btn secondary" href="sticker-book.html">ğŸ“– View My Stickers</a>
      </div>

      <p class="small" style="margin-top:10px;">
        Tip: If you miss the dot, try again slowly. You can always press â€œClearâ€ and start over.
      </p>
    </div>
  </div>
</section>

<!-- Reward Modal -->
<div class="modal" id="rewardModal" aria-hidden="true">
  <div class="modal-card">
    <div class="sticker" id="stickerEmoji">ğŸ‰</div>
    <div class="modal-title" id="rewardTitle">You did it!</div>
    <div class="modal-sub" id="rewardSub">Great tracing! You earned a sticker.</div>
    <div class="game-row" style="justify-content:center;">
      <button class="btn" id="playAgainBtn">Trace Another</button>
      <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
      <button class="btn secondary" id="closeModalBtn">Close</button>
    </div>
  </div>
</div>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script>
  // Storage
  const STORAGE_STARS = "bloom_tracing_stars";
  const STORAGE_PERFECT = "bloom_tracing_perfect";
  const STICKER_KEY = "bloom_sticker_book";

  let stars = parseInt(localStorage.getItem(STORAGE_STARS) || "0", 10);
  let perfectCount = parseInt(localStorage.getItem(STORAGE_PERFECT) || "0", 10);

  const canvas = document.getElementById("board");
  const ctx = canvas.getContext("2d");

  const statusEl = document.getElementById("status");
  const starsEl = document.getElementById("stars");
  const dotsEl = document.getElementById("dots");
  const perfectEl = document.getElementById("perfect");

  const itemButtonsEl = document.getElementById("itemButtons");

  const rewardModal = document.getElementById("rewardModal");
  const stickerEmojiEl = document.getElementById("stickerEmoji");
  const rewardTitleEl = document.getElementById("rewardTitle");
  const rewardSubEl = document.getElementById("rewardSub");

  // Letter-specific voice instructions (for letters we currently have)
  const formationVoice = {
    // UPPER
    "A": "To write capital A: Start at the top. Slide down to the left. Go back to the top and slide down to the right. Then draw a line across the middle.",
    "B": "To write capital B: Start at the top and draw a straight line down. Go back to the top. Make a bump to the middle. Then make another bump to the bottom.",
    "C": "To write capital C: Start near the top. Curve around like a big moon, and stop near the bottom.",
    "M": "To write capital M: Start at the top left. Draw a line down. Go back up to the top. Slant down to the middle. Slant up to the top. Then draw a line down.",
    "S": "To write capital S: Start near the top. Curve like a snake to the middle, then curve back to the bottom.",
    // lower
    "a": "To write lowercase a: Make a small circle. Then add a straight line down on the right side.",
    "b": "To write lowercase b: Start at the top and draw a line down. Go back to the middle and make a small bump to the right.",
    "c": "To write lowercase c: Start near the top. Curve around like a small moon.",
    "m": "To write lowercase m: Start with a line down. Go up and make a hump. Then make another hump.",
    "s": "To write lowercase s: Make a small curvy snake shape from top to bottom.",
    // numbers
    "0": "To write zero: Make an oval shape. Start at the top and go around back to the top.",
    "1": "To write one: Start at the top and draw a straight line down.",
    "2": "To write two: Curve across the top, slide down diagonally, then draw a line across the bottom.",
    "3": "To write three: Make a curve on the top and a curve on the bottom, like two little bumps.",
    "4": "To write four: Draw a line down. Then draw a line across. Then draw a line down from the top.",
    "5": "To write five: Draw a line across the top. Go down. Draw a line across the middle. Then curve around to the bottom.",
    "6": "To write six: Curve down and around like a loop. Then close it like a circle at the bottom.",
    "7": "To write seven: Draw a line across the top. Then draw a line down diagonally.",
    "8": "To write eight: Make a small circle on top, then a circle on the bottom.",
    "9": "To write nine: Make a circle on top, then draw a line down."
  };

  function speak(text){
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1; u.pitch = 1.05;
    window.speechSynthesis.speak(u);
  }

  function loadStickerBook(){
    try { return JSON.parse(localStorage.getItem(STICKER_KEY) || "[]"); }
    catch { return []; }
  }

  function addStickerToBook(stickerObj){
    const book = loadStickerBook();
    book.push(stickerObj);
    localStorage.setItem(STICKER_KEY, JSON.stringify(book));
  }

  function saveCounters(){
    localStorage.setItem(STORAGE_STARS, String(stars));
    localStorage.setItem(STORAGE_PERFECT, String(perfectCount));
  }

  // Dots data
  const UPPER = [
    { key:"A", model:"A", dots:[ {x:260,y:420},{x:450,y:120},{x:640,y:420},{x:340,y:300},{x:560,y:300} ] },
    { key:"B", model:"B", dots:[ {x:320,y:120},{x:320,y:420},{x:520,y:170},{x:520,y:270},{x:520,y:340},{x:520,y:410} ] },
    { key:"C", model:"C", dots:[ {x:610,y:170},{x:470,y:120},{x:330,y:200},{x:330,y:340},{x:470,y:420},{x:610,y:370} ] },
    { key:"M", model:"M", dots:[ {x:300,y:420},{x:300,y:120},{x:450,y:260},{x:600,y:120},{x:600,y:420} ] },
    { key:"S", model:"S", dots:[ {x:600,y:170},{x:450,y:120},{x:320,y:200},{x:520,y:280},{x:620,y:360},{x:450,y:420} ] }
  ];

  const LOWER = [
    { key:"a", model:"a", dots:[ {x:520,y:260},{x:450,y:190},{x:380,y:260},{x:450,y:330},{x:520,y:330},{x:560,y:420} ] },
    { key:"b", model:"b", dots:[ {x:380,y:120},{x:380,y:420},{x:520,y:260},{x:450,y:200},{x:520,y:330} ] },
    { key:"c", model:"c", dots:[ {x:560,y:220},{x:470,y:190},{x:380,y:260},{x:400,y:340},{x:500,y:360},{x:560,y:320} ] },
    { key:"m", model:"m", dots:[ {x:320,y:360},{x:320,y:240},{x:420,y:310},{x:520,y:240},{x:520,y:360},{x:620,y:240},{x:620,y:360} ] },
    { key:"s", model:"s", dots:[ {x:540,y:230},{x:450,y:200},{x:380,y:260},{x:480,y:300},{x:560,y:340},{x:450,y:380} ] }
  ];

  const NUMS = [
    { key:"0", model:"0", dots:[ {x:450,y:140},{x:560,y:190},{x:560,y:330},{x:450,y:400},{x:340,y:330},{x:340,y:190},{x:450,y:140} ] },
    { key:"1", model:"1", dots:[ {x:450,y:170},{x:450,y:420} ] },
    { key:"2", model:"2", dots:[ {x:340,y:210},{x:450,y:150},{x:560,y:210},{x:340,y:420},{x:560,y:420} ] },
    { key:"3", model:"3", dots:[ {x:360,y:170},{x:520,y:170},{x:460,y:260},{x:520,y:320},{x:360,y:380},{x:520,y:380} ] },
    { key:"4", model:"4", dots:[ {x:540,y:420},{x:540,y:150},{x:360,y:320},{x:600,y:320} ] },
    { key:"5", model:"5", dots:[ {x:560,y:150},{x:360,y:150},{x:360,y:260},{x:520,y:260},{x:560,y:340},{x:420,y:420} ] },
    { key:"6", model:"6", dots:[ {x:540,y:180},{x:420,y:220},{x:360,y:320},{x:450,y:420},{x:560,y:340},{x:450,y:300},{x:360,y:320} ] },
    { key:"7", model:"7", dots:[ {x:340,y:150},{x:560,y:150},{x:420,y:420} ] },
    { key:"8", model:"8", dots:[ {x:450,y:150},{x:520,y:220},{x:450,y:280},{x:380,y:220},{x:450,y:150},{x:520,y:340},{x:450,y:420},{x:380,y:340},{x:520,y:340} ] },
    { key:"9", model:"9", dots:[ {x:520,y:260},{x:450,y:150},{x:360,y:240},{x:450,y:320},{x:560,y:240},{x:520,y:420} ] }
  ];

  // State
  let currentSet = "upper";
  let currentList = UPPER;
  let current = currentList[0];
  let dotIndex = 0;
  let misses = 0;

  // Confetti (simple)
  let confetti = [];
  let confettiTimer = null;

  function refreshBadges(){
    starsEl.textContent = `â­ Stars: ${stars}`;
    perfectEl.textContent = `âœ¨ Perfect: ${perfectCount}`;
    dotsEl.textContent = `ğŸŸ¢ Dots: ${dotIndex}/${current.dots.length}`;
  }

  function setActiveTab(setName){
    document.querySelectorAll("#setTabs .select").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.set === setName);
    });
  }

  function highlightItemButton(){
    document.querySelectorAll("#itemButtons .select").forEach(btn=>{
      btn.classList.toggle("active", btn.textContent === current.key);
    });
  }

  function buildItemButtons(){
    itemButtonsEl.innerHTML = "";
    currentList.forEach(item=>{
      const b = document.createElement("button");
      b.className = "select";
      b.textContent = item.key;
      b.onclick = () => setItem(item.key);
      itemButtonsEl.appendChild(b);
    });
    highlightItemButton();
  }

  function setSet(setName){
    currentSet = setName;
    setActiveTab(setName);

    if (setName === "upper") currentList = UPPER;
    if (setName === "lower") currentList = LOWER;
    if (setName === "nums") currentList = NUMS;

    current = currentList[0];
    dotIndex = 0;
    misses = 0;
    buildItemButtons();
    redraw(true);
    statusEl.textContent = `Trace ${current.key}! Touch the dots in order.`;
  }

  function setItem(key){
    const found = currentList.find(x => x.key === key);
    if (!found) return;
    current = found;
    dotIndex = 0;
    misses = 0;
    highlightItemButton();
    redraw(true);
    statusEl.textContent = `Trace ${current.key}! Touch the dots in order.`;
  }

  function nextItem(){
    const i = currentList.findIndex(x=>x.key === current.key);
    const next = currentList[(i+1) % currentList.length];
    setItem(next.key);
  }

  function redraw(resetDots){
    if (resetDots) dotIndex = 0;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // background
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // guide lines
    ctx.strokeStyle = "rgba(58,143,107,0.18)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, canvas.height*0.30); ctx.lineTo(canvas.width, canvas.height*0.30);
    ctx.moveTo(0, canvas.height*0.70); ctx.lineTo(canvas.width, canvas.height*0.70);
    ctx.stroke();

    // ghost model
    ctx.globalAlpha = 0.12;
    ctx.fillStyle = "#2f3a2f";
    ctx.font = (currentSet === "nums" ? "240px" : "260px") + " 'Baloo 2', cursive";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(current.model, canvas.width/2, canvas.height/2);
    ctx.globalAlpha = 1;

    // dots
    current.dots.forEach((d, i) => {
      const done = i < dotIndex;
      ctx.beginPath();
      ctx.arc(d.x, d.y, 14, 0, Math.PI*2);
      ctx.fillStyle = done ? "rgba(58,143,107,0.45)" : "rgba(58,143,107,0.95)";
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = "#ffffff";
      ctx.stroke();

      ctx.fillStyle = "#fff";
      ctx.font = "16px 'Baloo 2', cursive";
      ctx.fillText(String(i+1), d.x, d.y);
    });

    refreshBadges();
  }

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const t = e.touches && e.touches[0];
    const cx = t ? t.clientX : e.clientX;
    const cy = t ? t.clientY : e.clientY;
    return {
      x: (cx - rect.left) * (canvas.width / rect.width),
      y: (cy - rect.top) * (canvas.height / rect.height)
    };
  }

  function dist(a,b){
    const dx = a.x-b.x, dy=a.y-b.y;
    return Math.sqrt(dx*dx+dy*dy);
  }

  function hitDot(pos){
    const target = current.dots[dotIndex];
    if (!target) return;

    if (dist(pos, target) < 24){
      dotIndex++;
      statusEl.textContent = "âœ… Nice! Keep goingâ€¦";
      if (dotIndex >= current.dots.length) completeTrace();
      redraw(false);
    } else {
      misses++;
    }
  }

  let drawing = false;
  let last = null;

  function start(e){
    drawing = true;
    last = getPos(e);
    hitDot(last);
    e.preventDefault();
  }

  function move(e){
    if (!drawing) return;
    const pos = getPos(e);

    ctx.strokeStyle = "rgba(106,174,214,0.95)";
    ctx.lineWidth = 10;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();

    last = pos;
    hitDot(pos);
    e.preventDefault();
  }

  function end(){
    drawing = false;
    last = null;
  }

  function launchConfetti(){
    if (confettiTimer) cancelAnimationFrame(confettiTimer);
    confetti = [];
    for (let i=0;i<90;i++){
      confetti.push({
        x: Math.random()*canvas.width,
        y: -20 - Math.random()*120,
        vx: -2 + Math.random()*4,
        vy: 2 + Math.random()*4,
        r: 4 + Math.random()*6
      });
    }
    const start = performance.now();

    function tick(t){
      redraw(false);
      confetti.forEach(p=>{
        p.x += p.vx; p.y += p.vy;
        p.vy += 0.02;
        ctx.fillStyle = `hsla(${90 + Math.random()*120},70%,55%,0.95)`;
        ctx.fillRect(p.x, p.y, p.r*2, p.r*2);
      });

      if (t-start < 1200) confettiTimer = requestAnimationFrame(tick);
      else redraw(false);
    }
    confettiTimer = requestAnimationFrame(tick);
  }

  function completeTrace(){
    stars++;
    const isPerfect = misses <= Math.max(8, current.dots.length * 3);
    if (isPerfect) perfectCount++;

    saveCounters();

    const stickerChoices = ["ğŸ¦„","ğŸ¦‰","ğŸ¦–","ğŸ°","ğŸ¼","ğŸŒˆ","â­","ğŸ€","ğŸˆ","ğŸ§"];
    const sticker = stickerChoices[Math.floor(Math.random()*stickerChoices.length)];
    stickerEmojiEl.textContent = sticker;

    addStickerToBook({
      emoji: sticker,
      item: current.key,
      perfect: isPerfect,
      time: Date.now()
    });

    rewardTitleEl.textContent = isPerfect ? "âœ¨ Perfect Trace!" : "ğŸ‰ Great Tracing!";
    rewardSubEl.textContent = isPerfect
      ? `You traced ${current.key} perfectly and earned a sticker!`
      : `You traced ${current.key} and earned a sticker!`;

    launchConfetti();
    showModal();

    statusEl.textContent = `ğŸ‰ You finished ${current.key}!`;
  }

  function showModal(){
    rewardModal.classList.add("show");
    rewardModal.setAttribute("aria-hidden", "false");
  }

  function hideModal(){
    rewardModal.classList.remove("show");
    rewardModal.setAttribute("aria-hidden", "true");
  }

  // Buttons
  document.getElementById("clearBtn").onclick = () => {
    dotIndex = 0;
    misses = 0;
    redraw(true);
    statusEl.textContent = "Try again! Touch the dots in order.";
  };

  document.getElementById("nextBtn").onclick = () => {
    hideModal();
    nextItem();
  };

  document.getElementById("sayBtn").onclick = () => {
    const msg = formationVoice[current.key] || `Trace ${current.key}. Touch the green dots in order. Start at dot 1 and follow the dots.`;
    speak(msg);
  };

  // Modal buttons
  document.getElementById("closeModalBtn").onclick = () => hideModal();
  document.getElementById("playAgainBtn").onclick = () => { hideModal(); nextItem(); };
  rewardModal.addEventListener("click", (e)=>{ if (e.target === rewardModal) hideModal(); });

  // Tabs
  document.querySelectorAll("#setTabs .select").forEach(btn=>{
    btn.addEventListener("click", ()=> setSet(btn.dataset.set));
  });

  // Canvas events
  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);

  canvas.addEventListener("touchstart", start, {passive:false});
  canvas.addEventListener("touchmove", move, {passive:false});
  canvas.addEventListener("touchend", end);

  // Init with URL parameter
  function init(){
    canvas.width = 900;
    canvas.height = 520;

    starsEl.textContent = `â­ Stars: ${stars}`;
    perfectEl.textContent = `âœ¨ Perfect: ${perfectCount}`;

    const params = new URLSearchParams(window.location.search);
    const setParam = params.get("set");
    if (setParam === "lower" || setParam === "nums" || setParam === "upper"){
      setSet(setParam);
    } else {
      buildItemButtons();
      redraw(true);
      statusEl.textContent = `Trace ${current.key}! Touch the dots in order.`;
    }
  }

  init();
</script>

</body>
</html>
