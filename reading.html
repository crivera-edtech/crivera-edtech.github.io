<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reading | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Reading ğŸ“–</h1>
    <p>Take a quick diagnostic, then play reading games (and decodable stories) that match your grade.</p>
    <div class="quick-strip">
      <button class="btn secondary" id="readAloudBtn">ğŸ”Š Read Aloud</button>
      <a class="btn secondary" href="progress.html">My Progress</a>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">

    <div class="game-box wide">
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>

      <div class="badge-row" style="justify-content:center;">
        <button class="pill active pill-lg" data-grade="K">Kindergarten</button>
        <button class="pill pill-lg" data-grade="1">Grade 1</button>
        <button class="pill pill-lg" data-grade="2">Grade 2</button>
      </div>

      <div class="quick-strip" style="justify-content:center; margin-top:14px;">
        <button class="btn btn-lg" id="startDiagBtn">Start Diagnostic (10)</button>
        <button class="btn secondary btn-lg" id="showGamesBtn" disabled style="opacity:.6;">Choose a Game</button>
        <button class="btn secondary btn-lg" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="game-box wide" id="diagPanel" style="margin-top:16px;">
      <div class="kid-big">Diagnostic âœ…</div>
      <p class="small">10 quick reading questions (grade-based). Listen any time.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div>
            <div class="small" id="meta">Press â€œStart Diagnosticâ€ to begin.</div>
            <div class="kid-big" id="qText" style="margin-top:6px;">â€”</div>
            <p class="small" id="passage" style="margin-top:10px;"></p>
          </div>
          <button class="btn secondary" id="soundBtn">ğŸ”Š</button>
        </div>

        <div class="grid-3" id="choices" style="margin-top:14px;"></div>
        <div class="kid-big" id="result" style="margin-top:12px;"></div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="nextBtn" disabled>Next</button>
          <button class="btn secondary" id="skipBtn" disabled>Skip</button>
        </div>
      </div>
    </div>

    <div class="game-box wide" id="resultsPanel" style="margin-top:16px; display:none;">
      <div class="kid-big">Your Results ğŸŒ¿</div>
      <div class="game-box" style="margin-top:12px;">
        <div class="kid-big" id="scoreLine">Score: â€”</div>
        <p class="small" id="recLine">Recommended path: â€”</p>

        <div class="grid-3" id="lengthGrid" style="margin-top:12px;"></div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="openGames">Choose a Game</button>
          <a class="btn secondary" href="progress.html">View Progress</a>
        </div>
      </div>
    </div>

    <div class="game-box wide" id="gamesPanel" style="margin-top:16px; display:none;">
      <div class="kid-big">Choose a Game ğŸ®</div>
      <div class="grid-3" id="gameCards" style="margin-top:12px;"></div>

      <div class="game-box" id="gameStage" style="margin-top:16px; display:none;">
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div>
            <div class="small" id="gameMeta">â€”</div>
            <div class="kid-big" id="gameQ">â€”</div>
            <p class="small" id="gamePassage" style="margin-top:10px;"></p>
          </div>
          <button class="btn secondary" id="gameSoundBtn">ğŸ”Š</button>
        </div>

        <div id="gameUI" style="margin-top:14px;"></div>

        <div class="kid-big" id="gameResult" style="margin-top:12px;"></div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="gameNextBtn">Next</button>
          <button class="btn secondary" id="backBtn">Back</button>
          <button class="btn secondary" id="resetStarsBtn">Reset Reading â­</button>
        </div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
/* ============================
   Storage + helpers
============================ */
const PROG_KEY="bloom_progress";
const READ_STATE_KEY="bloom_reading_state";
const LAST_ACTIVITY_KEY="bloom_last_activity";

function load(key,f){ try{return JSON.parse(localStorage.getItem(key)||JSON.stringify(f));}catch{return f;} }
function save(key,v){ localStorage.setItem(key,JSON.stringify(v)); }
function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function speak(t){ if(!("speechSynthesis"in window))return; speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.rate=1; u.pitch=1.05; speechSynthesis.speak(u); }

/* ============================
   Progress monitor helpers
============================ */
function ensureProgress(){
  const p = load(PROG_KEY, null);
  if (p && typeof p === "object") return p;

  const fresh = {
    phonicsStars:0, readingStars:0, mathStars:0,
    phonicsPlays:0, phonicsCorrect:0, phonicsAttempts:0,
    readingPlays:0, readingCorrect:0, readingAttempts:0,
    mathPlays:0, mathCorrect:0, mathAttempts:0,
    phonicsLastGame:null, readingLastGame:null, mathLastGame:null,
    phonicsDiag:null, readingDiag:null, mathDiag:null
  };
  save(PROG_KEY, fresh);
  return fresh;
}

function logActivity(area, details){
  save(LAST_ACTIVITY_KEY, { area, details: details || "", time: Date.now() });
}

function bumpCounter(field, inc=1){
  const p = ensureProgress();
  p[field] = (p[field] || 0) + inc;
  save(PROG_KEY, p);
}

function setField(field, value){
  const p = ensureProgress();
  p[field] = value;
  save(PROG_KEY, p);
}

function addReadingStar(){
  const p=ensureProgress();
  p.readingStars=(p.readingStars||0)+1;
  save(PROG_KEY,p);

  const ms=load("bloom_daily_mission",null);
  if(ms && typeof ms.reading==="number"){ ms.reading+=1; save("bloom_daily_mission",ms); }

  logActivity("Reading","Earned a star â­");
}

/* ============================
   Grade select
============================ */
let grade="K";
document.querySelectorAll(".pill[data-grade]").forEach(b=>{
  b.onclick=()=>{
    grade=b.dataset.grade;
    document.querySelectorAll(".pill[data-grade]").forEach(x=>x.classList.toggle("active",x.dataset.grade===grade));
    resetUI();
    const st=load(READ_STATE_KEY,null);
    setGamesEnabled(!!(st && st.grade===grade && st.finished));
    logActivity("Reading","Changed grade to " + (grade==="K" ? "Kindergarten" : "Grade " + grade));
  };
});

/* ============================
   Diagnostic question bank
============================ */
const diag = {
  K: [
    { passage:"Sam has a cap.", q:"What does Sam have?", a:"A cap", c:["A cap","A map","A cat"], tag:"comprehension" },
    { passage:"I see a sun.", q:"What do you see?", a:"A sun", c:["A dog","A sun","A hat"], tag:"comprehension" },
    { passage:"Cat sat.", q:"Which word rhymes with cat?", a:"hat", c:["hat","sun","pig"], tag:"phonics" },
    { passage:"Tap the map.", q:"Which word says map?", a:"map", c:["map","cap","cat"], tag:"decoding" }
  ],
  1: [
    { passage:"The ship is big.", q:"What is big?", a:"The ship", c:["The fish","The ship","The cap"], tag:"comprehension" },
    { passage:"I can chop.", q:"What can you do?", a:"chop", c:["shop","chop","ship"], tag:"decoding" },
    { passage:"She had a red bag.", q:"What color is the bag?", a:"red", c:["blue","red","green"], tag:"comprehension" },
    { passage:"Thin and thick.", q:"Which word starts with th?", a:"thin", c:["ship","thin","chop"], tag:"phonics" }
  ],
  2: [
    { passage:"I see rain on the road.", q:"What do you see?", a:"rain", c:["feet","rain","boat"], tag:"decoding" },
    { passage:"The goat ate oats.", q:"What did the goat do?", a:"ate oats", c:["ran fast","ate oats","took a nap"], tag:"comprehension" },
    { passage:"We will meet at noon.", q:"When will we meet?", a:"at noon", c:["at night","at noon","at dawn"], tag:"comprehension" },
    { passage:"Boat and coat.", q:"Which word rhymes with boat?", a:"coat", c:["feet","coat","rain"], tag:"phonics" }
  ]
};

function buildDiag10(){
  const base = diag[grade];
  let pool=[];
  while(pool.length<10){ pool=pool.concat(shuffle(base)); }
  return pool.slice(0,10);
}

/* ============================
   Diagnostic UI
============================ */
const startDiagBtn=document.getElementById("startDiagBtn");
const showGamesBtn=document.getElementById("showGamesBtn");
const resetBtn=document.getElementById("resetBtn");
const diagPanel=document.getElementById("diagPanel");
const resultsPanel=document.getElementById("resultsPanel");
const gamesPanel=document.getElementById("gamesPanel");

const meta=document.getElementById("meta");
const qText=document.getElementById("qText");
const passage=document.getElementById("passage");
const choices=document.getElementById("choices");
const result=document.getElementById("result");
const soundBtn=document.getElementById("soundBtn");
const nextBtn=document.getElementById("nextBtn");
const skipBtn=document.getElementById("skipBtn");

let qs=[], idx=0, correct=0, answered=false;
let missedTags=new Set();

function setPanels(d,r,g){
  diagPanel.style.display=d?"block":"none";
  resultsPanel.style.display=r?"block":"none";
  gamesPanel.style.display=g?"block":"none";
}
function setGamesEnabled(on){
  showGamesBtn.disabled=!on;
  showGamesBtn.style.opacity=on?"1":".6";
}

function resetUI(){
  setPanels(true,false,false);
  meta.textContent="Press â€œStart Diagnosticâ€ to begin.";
  qText.textContent="â€”";
  passage.textContent="";
  choices.innerHTML="";
  result.textContent="";
  nextBtn.disabled=true;
  skipBtn.disabled=true;
  answered=false;
}

function renderQ(){
  const it=qs[idx];
  meta.textContent=`Question ${idx+1} of ${qs.length}`;
  qText.textContent=it.q;
  passage.textContent=it.passage;
  result.textContent="";
  answered=false;
  nextBtn.disabled=true;
  skipBtn.disabled=false;

  choices.innerHTML="";
  it.c.forEach(ch=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.textAlign="center";
    card.innerHTML=`<h3 style="font-size:22px; margin-bottom:6px;">${ch}</h3><p class="small">Tap!</p>`;
    card.onclick=()=>choose(ch);
    choices.appendChild(card);
  });
}

function choose(ch){
  if(answered) return;
  answered=true;
  nextBtn.disabled=false;

  const it=qs[idx];
  bumpCounter("readingAttempts", 1);

  if(ch===it.a){
    correct++;
    result.textContent="Correct! â­";
    bumpCounter("readingCorrect", 1);
  } else {
    result.textContent=`Good try! Answer: ${it.a}`;
    missedTags.add(it.tag);
  }
}

soundBtn.onclick=()=>{
  const it=qs[idx];
  if(!it) return;
  speak(`${it.passage} Question: ${it.q}`);
};

nextBtn.onclick=()=>{
  if(!answered){
    missedTags.add(qs[idx].tag);
  }
  idx++;
  if(idx>=qs.length) finish();
  else renderQ();
};

skipBtn.onclick=()=>{
  missedTags.add(qs[idx].tag);
  idx++;
  if(idx>=qs.length) finish();
  else renderQ();
};

startDiagBtn.onclick=()=>{
  ensureProgress();
  qs=buildDiag10();
  idx=0; correct=0; missedTags=new Set();
  setPanels(true,false,false);
  nextBtn.disabled=true;
  skipBtn.disabled=false;
  renderQ();
  logActivity("Reading","Started diagnostic (Grade " + (grade==="K" ? "K" : grade) + ")");
};

resetBtn.onclick=()=>{
  save(READ_STATE_KEY,null);
  resetUI();
  setGamesEnabled(false);

  const p = ensureProgress();
  p.readingDiag = null;
  save(PROG_KEY, p);

  logActivity("Reading","Reset diagnostic");
};

function finish(){
  const scorePct=Math.round((correct/qs.length)*100);
  const weaknesses=Array.from(missedTags);

  const state={grade,finished:true,scorePct,weaknesses,timestamp:Date.now()};
  save(READ_STATE_KEY,state);

  // store diag snapshot in progress
  setField("readingDiag", { scorePct, grade, time: Date.now() });

  buildResults(state);
  setPanels(false,true,false);
  setGamesEnabled(true);

  logActivity("Reading","Finished diagnostic: " + scorePct + "%");
}

/* ============================
   Results
============================ */
document.getElementById("openGames").onclick=()=>{
  setPanels(false,false,true);
  renderGameCards();
  document.getElementById("gameStage").style.display="none";
  logActivity("Reading","Opened games after results");
};
showGamesBtn.onclick=()=>{
  setPanels(false,false,true);
  renderGameCards();
  document.getElementById("gameStage").style.display="none";
  logActivity("Reading","Opened games list");
};

const scoreLine=document.getElementById("scoreLine");
const recLine=document.getElementById("recLine");
const lengthGrid=document.getElementById("lengthGrid");

function buildResults(st){
  scoreLine.textContent=`Score: ${st.scorePct}% (Grade ${st.grade})`;
  const w=new Set(st.weaknesses||[]);
  let path=[];
  if(!w.size){
    path=["Decodable Story","Read & Answer","Sentence Scramble"];
  } else {
    if(w.has("decoding")||w.has("phonics")) path.push("Decodable Story");
    path.push("Read & Answer");
    if(w.has("comprehension")) path.push("Picture/Scene Labels");
    path.push("Sight Word Sprint");
  }
  recLine.textContent=`Recommended path: ${path.join(" â†’ ")}`;

  const cards=[
    {t:"Read & Answer", len:"4â€“6 min"},
    {t:"Decodable Story", len: grade==="K" ? "3â€“5 min" : "5â€“8 min"},
    {t:"Sentence Scramble", len:"3â€“6 min"},
    {t:"Scene Labeling", len:"4â€“6 min"},
    {t:"Sight Word Sprint", len:"3â€“5 min"},
    {t:"Main Idea Match", len: grade==="2" ? "4â€“6 min" : "Optional"}
  ].filter(x=>x.len!=="Optional" || grade==="2");

  lengthGrid.innerHTML=cards.slice(0,6).map(c=>`
    <div class="card">
      <h3 style="margin-bottom:6px;">${c.t}</h3>
      <p class="small"><strong>Game length:</strong> ${c.len}</p>
    </div>
  `).join("");
}

/* ============================
   Games
============================ */
const gameCards=document.getElementById("gameCards");
const gameStage=document.getElementById("gameStage");
const gameMeta=document.getElementById("gameMeta");
const gameQ=document.getElementById("gameQ");
const gamePassage=document.getElementById("gamePassage");
const gameUI=document.getElementById("gameUI");
const gameResult=document.getElementById("gameResult");
const gameSoundBtn=document.getElementById("gameSoundBtn");
const gameNextBtn=document.getElementById("gameNextBtn");
document.getElementById("backBtn").onclick=()=> {
  gameStage.style.display="none";
  logActivity("Reading","Back to games list");
};

document.getElementById("resetStarsBtn").onclick=()=>{
  const p=ensureProgress();
  p.readingStars=0; save(PROG_KEY,p);
  alert("Reading stars reset!");
  logActivity("Reading","Reset reading stars");
};

let currentGame=null;
let current=null;

function renderGameCards(){
  const st=load(READ_STATE_KEY,null)||{grade,weaknesses:[]};
  const w=new Set(st.weaknesses||[]);

  const games=[
    {id:"readAnswer", t:"ğŸ“– Read & Answer", len:"4â€“6 min", rec:true},
    {id:"decodable", t:"ğŸ“— Decodable Story", len: grade==="K" ? "3â€“5 min" : "5â€“8 min", rec:w.has("decoding")||w.has("phonics")},
    {id:"scramble", t:"ğŸ§© Sentence Scramble", len:"3â€“6 min", rec:true},
    {id:"sceneLabel", t:"ğŸ–¼ï¸ Scene Labeling", len:"4â€“6 min", rec:w.has("comprehension")},
    {id:"sightSprint", t:"âš¡ Sight Word Sprint", len:"3â€“5 min", rec:true},
    ...(grade==="2" ? [{id:"mainIdea", t:"ğŸ§  Main Idea Match", len:"4â€“6 min", rec:w.has("comprehension")}] : [])
  ];

  gameCards.innerHTML=games.map(g=>`
    <div class="card">
      <h3 style="margin-bottom:6px;">${g.t}</h3>
      <p class="small"><strong>Length:</strong> ${g.len}</p>
      <p class="small">${g.rec ? "âœ… Recommended" : "Optional"}</p>
      <div class="quick-strip" style="justify-content:flex-start; margin-top:10px;">
        <button class="btn" data-play="${g.id}">Play</button>
      </div>
    </div>
  `).join("");

  gameCards.querySelectorAll("[data-play]").forEach(b=>{
    b.onclick=()=> startGame(b.dataset.play);
  });
}

function speakCurrent(){
  if(!current) return;
  const text = (current.passage ? current.passage + " " : "") + (current.q || gameQ.textContent);
  speak(text);
}

gameSoundBtn.onclick=speakCurrent;
document.getElementById("readAloudBtn").onclick=speakCurrent;

gameNextBtn.onclick=()=> playNext();

function startGame(id){
  ensureProgress();
  currentGame=id;
  setField("readingLastGame", id);
  bumpCounter("readingPlays", 1);

  gameStage.style.display="block";
  gameResult.textContent="";
  playNext(true);

  logActivity("Reading","Started game: " + id);
}

function playNext(reset=false){
  gameResult.textContent="";
  if(currentGame==="readAnswer") return gReadAnswer();
  if(currentGame==="decodable") return gDecodable();
  if(currentGame==="scramble") return gScramble();
  if(currentGame==="sceneLabel") return gSceneLabel();
  if(currentGame==="sightSprint") return gSightSprint();
  if(currentGame==="mainIdea") return gMainIdea();
}

function gradeAnswer(ok){
  bumpCounter("readingAttempts", 1);

  if(ok){
    gameResult.textContent="Correct! â­";
    bumpCounter("readingCorrect", 1);
    addReadingStar();
    speak("Correct!");
  } else {
    gameResult.textContent="Try again ğŸ™‚";
    speak("Try again.");
  }
}

/* ----- Game content ----- */
const readBank={
  K:[
    {passage:"Mia has a red kite. The kite goes up.", q:"What color is the kite?", a:"red", c:["red","blue","green"]},
    {passage:"Tom has a pet cat. The cat can nap.", q:"What pet does Tom have?", a:"a cat", c:["a dog","a fish","a cat"]}
  ],
  1:[
    {passage:"The ship is fast. It splashes in the sea.", q:"Where is the ship?", a:"in the sea", c:["in a tree","in the sea","in a box"]},
    {passage:"Chip can chop. Chip chops the log.", q:"What does Chip do?", a:"chop", c:["shop","chop","ship"]}
  ],
  2:[
    {passage:"We went on a boat. The rain stopped. We felt glad.", q:"How did they feel?", a:"glad", c:["mad","glad","sad"]},
    {passage:"The goat ate oats by the road.", q:"What did the goat eat?", a:"oats", c:["boats","oats","coats"]}
  ]
};

function gReadAnswer(){
  const it=shuffle(readBank[grade])[0];
  current={passage:it.passage,q:it.q,a:it.a,c:it.c};

  gameMeta.textContent="Game: Read & Answer";
  gameQ.textContent=it.q;
  gamePassage.textContent=it.passage;
  gameUI.innerHTML="";

  const grid=document.createElement("div");
  grid.className="grid-3";
  it.c.forEach(ch=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.textAlign="center";
    card.innerHTML=`<h3 style="font-size:22px; margin-bottom:6px;">${ch}</h3><p class="small">Tap!</p>`;
    card.onclick=()=> gradeAnswer(ch===it.a);
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);
}

const decodables={
  K:[
    "Sam can tap. Sam can pat. Sam can nap.",
    "I see a cat. I see a bat. I see a hat."
  ],
  1:[
    "The ship is in the shop. Chip can chop the log.",
    "The thin cat can sit. The cat is with the fish."
  ],
  2:[
    "We will meet at noon. We eat oats. We read by the road.",
    "The rain fell. Then the sun came out. We went on a boat."
  ]
};

function gDecodable(){
  const txt=shuffle(decodables[grade])[0];
  current={passage:txt,q:"Pick the best summary:", a:0};

  gameMeta.textContent="Game: Decodable Story";
  gamePassage.textContent=txt;
  gameQ.textContent="Pick the best summary:";
  gameUI.innerHTML="";

  const options = grade==="K"
    ? ["It is about tapping/doing things.", "It is about a rocket.", "It is about a dinosaur."]
    : grade==="1"
      ? ["It is about a ship/shop and actions.", "It is about snow.", "It is about cooking pizza."]
      : ["It is about a simple day/event.", "It is about outer space.", "It is about a video game."];

  const grid=document.createElement("div");
  grid.className="grid-3";
  options.forEach((op,i)=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.textAlign="center";
    card.innerHTML=`<h3 style="font-size:18px; margin-bottom:6px;">${op}</h3><p class="small">Tap!</p>`;
    card.onclick=()=> gradeAnswer(i===0);
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);
}

function gScramble(){
  gameMeta.textContent="Game: Sentence Scramble";
  gamePassage.textContent="";
  gameQ.textContent="Put the words in order!";
  gameUI.innerHTML="";

  const parts = grade==="K"
    ? ["I","see","a","cat"]
    : grade==="1"
      ? ["Chip","can","chop"]
      : ["We","went","on","a","boat"];

  const correctSentence = grade==="K" ? "I see a cat" : grade==="1" ? "Chip can chop" : "We went on a boat";

  let words = shuffle(parts);
  let built = [];

  const builtBox=document.createElement("div");
  builtBox.className="game-box";
  builtBox.innerHTML=`<div class="kid-big" id="builtLine" style="min-height:44px;"></div><p class="small">Tap words to build your sentence.</p>`;

  const row=document.createElement("div");
  row.className="badge-row";
  row.style.justifyContent="flex-start";

  function render(){
    builtBox.querySelector("#builtLine").textContent = built.join(" ");
    row.innerHTML="";
    words.forEach((w,i)=>{
      const b=document.createElement("button");
      b.className="pill";
      b.textContent=w;
      b.onclick=()=>{
        built.push(w);
        words.splice(i,1);
        render();
        if(built.join(" ")===correctSentence){
          gradeAnswer(true);
        }
      };
      row.appendChild(b);
    });
  }

  const actions=document.createElement("div");
  actions.className="quick-strip";
  actions.style.justifyContent="flex-start";
  actions.style.marginTop="12px";
  actions.innerHTML=`<button class="btn secondary" id="scrClear">Clear</button> <button class="btn secondary" id="scrHear">ğŸ”Š Hear</button>`;
  gameUI.appendChild(builtBox);
  gameUI.appendChild(row);
  gameUI.appendChild(actions);

  document.getElementById("scrClear").onclick=()=>{ words=shuffle(parts); built=[]; render(); gameResult.textContent=""; };
  document.getElementById("scrHear").onclick=()=> speak(correctSentence);

  render();
}

function gSceneLabel(){
  gameMeta.textContent="Game: Scene Labeling";
  gamePassage.textContent="";
  gameQ.textContent="Drag a label onto the right spot!";
  gameUI.innerHTML="";

  const scenes = grade==="K"
    ? { scene:"ğŸ   â˜€ï¸  ğŸ±", targets:["cat","sun","house"] }
    : grade==="1"
      ? { scene:"ğŸš¢  ğŸŒŠ  ğŸ§¢", targets:["ship","sea","cap"] }
      : { scene:"â›µ  ğŸŒ§ï¸  ğŸ¦¶", targets:["boat","rain","feet"] };

  const wrap=document.createElement("div");
  wrap.className="game-box";
  wrap.innerHTML=`
    <div class="kid-big" style="font-size:42px;">${scenes.scene}</div>
    <p class="small">Drop each word into a box.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;" id="dropRow"></div>
    <div class="badge-row" id="labels" style="justify-content:flex-start; margin-top:12px;"></div>
    <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
      <button class="btn secondary" id="sceneReset">Reset</button>
    </div>
  `;
  gameUI.appendChild(wrap);

  const dropRow=wrap.querySelector("#dropRow");
  const labels=wrap.querySelector("#labels");

  const slots=scenes.targets.map((t,idx)=>{
    const d=document.createElement("div");
    d.className="card";
    d.style.minWidth="180px";
    d.style.textAlign="center";
    d.style.padding="18px";
    d.innerHTML=`<div class="small">Box ${idx+1}</div><div class="kid-big" data-slot="${idx}" style="margin-top:6px;">_</div>`;
    d.ondragover=(e)=>e.preventDefault();
    d.ondrop=(e)=>{
      e.preventDefault();
      const val=e.dataTransfer.getData("text/plain");
      d.querySelector("[data-slot]").textContent=val;
      check();
    };
    dropRow.appendChild(d);
    return d;
  });

  const wordBank=shuffle(scenes.targets);
  wordBank.forEach(w=>{
    const p=document.createElement("div");
    p.className="pill";
    p.textContent=w;
    p.draggable=true;
    p.style.cursor="grab";
    p.ondragstart=(e)=>e.dataTransfer.setData("text/plain",w);
    labels.appendChild(p);
  });

  function check(){
    const built=slots.map(s=>s.querySelector("[data-slot]").textContent);
    if(built.includes("_")) return;
    const ok = built.slice().sort().join("|") === scenes.targets.slice().sort().join("|");
    gradeAnswer(ok);
  }

  wrap.querySelector("#sceneReset").onclick=()=> gSceneLabel();
}

function gSightSprint(){
  gameMeta.textContent="Game: Sight Word Sprint";
  gamePassage.textContent="";
  gameQ.textContent="Tap the word you hear!";
  gameUI.innerHTML="";

  const bank = grade==="K"
    ? ["the","a","I","see","my"]
    : grade==="1"
      ? ["said","like","have","here","come"]
      : ["because","around","before","could","would"];

  const target = shuffle(bank)[0];
  current={q:`Tap: ${target}`, passage:"", a:target};

  const options = shuffle(bank).slice(0,3);
  if(!options.includes(target)) options[Math.floor(Math.random()*3)]=target;

  const grid=document.createElement("div");
  grid.className="grid-3";
  options.forEach(w=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.textAlign="center";
    card.innerHTML=`<h3 style="font-size:24px; margin-bottom:6px;">${w}</h3><p class="small">Tap!</p>`;
    card.onclick=()=> gradeAnswer(w===target);
    grid.appendChild(card);
  });

  const hear=document.createElement("button");
  hear.className="btn secondary";
  hear.textContent="ğŸ”Š Hear Word";
  hear.onclick=()=> speak(target);

  gameUI.appendChild(hear);
  gameUI.appendChild(grid);
}

function gMainIdea(){
  const it=shuffle(readBank["2"])[0];
  current={passage:it.passage,q:"What is the main idea?", a:0};

  gameMeta.textContent="Game: Main Idea Match";
  gamePassage.textContent=it.passage;
  gameQ.textContent="Pick the main idea:";
  gameUI.innerHTML="";

  const options=[
    "It tells the big thing that happened.",
    "It lists random words.",
    "It is about a spaceship."
  ];

  const grid=document.createElement("div");
  grid.className="grid-3";
  options.forEach((op,i)=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.textAlign="center";
    card.innerHTML=`<h3 style="font-size:18px; margin-bottom:6px;">${op}</h3><p class="small">Tap!</p>`;
    card.onclick=()=> gradeAnswer(i===0);
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);
}

/* init */
(function init(){
  ensureProgress();
  resetUI();
  const st=load(READ_STATE_KEY,null);
  if(st && st.grade===grade && st.finished){
    setGamesEnabled(true);
    buildResults(st);
    setPanels(false,true,false);
  } else {
    setGamesEnabled(false);
  }
})();
</script>

</body>
</html>
