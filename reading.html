<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reading | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Reading ğŸ“–</h1>
    <p>Take a quick diagnostic, then choose a reading game or a decodable text.</p>
  </div>
</section>

<section class="section">
  <div class="container">

    <div class="game-box wide">
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>

      <div class="badge-row" style="justify-content:center;">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>

      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn" id="startDiagBtn">Start 10-Question Diagnostic</button>
        <button class="btn secondary" id="goGamesBtn" disabled style="opacity:.6;">Choose a Game</button>
        <a class="btn secondary" href="progress.html">My Progress</a>
      </div>
    </div>

    <!-- DIAGNOSTIC -->
    <div class="game-box wide" id="diagWrap" style="margin-top:16px; display:none;">
      <div class="kid-big">Reading Diagnostic âœ…</div>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="small" id="diagMeta">Question 1 of 10</div>
            <div class="kid-big" id="diagQ">Question loadsâ€¦</div>
          </div>
          <button class="btn secondary" id="diagSoundBtn" title="Read aloud" aria-label="Read aloud">ğŸ”Š</button>
        </div>

        <div class="small" id="diagSupport" style="margin-top:6px;"></div>
        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
        <div class="kid-big" id="diagResult" style="margin-top:14px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:10px;">
          <button class="btn" id="diagNextBtn">Next</button>
          <button class="btn secondary" id="diagSkipBtn">Skip</button>
        </div>
      </div>
    </div>

    <!-- AFTER DIAG -->
    <div class="game-box wide" id="afterDiagWrap" style="margin-top:16px; display:none;">
      <div class="kid-big">Your Plan ğŸŒ¿</div>

      <div class="game-box" style="margin-top:12px;">
        <div class="grid-3">
          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Score</h3>
            <div class="kid-big" id="planScore">â€”</div>
            <div class="small" id="planGrade">â€”</div>
          </div>

          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Recommended Path</h3>
            <div class="small" id="planPath" style="line-height:1.5;">â€”</div>
          </div>

          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Game Length</h3>
            <div class="kid-big" id="planLen">â€”</div>
            <div class="small" id="planLenNote">â€”</div>
          </div>
        </div>

        <div class="quick-strip" style="justify-content:center; margin-top:12px;">
          <button class="btn" id="openGamesBtn">Open Games</button>
          <button class="btn secondary" id="retakeBtn">Retake Diagnostic</button>
        </div>
      </div>
    </div>

    <!-- GAME HUB -->
    <div class="game-box wide" id="gamesHub" style="margin-top:16px; display:none;">
      <div class="kid-big">Choose a Reading Game ğŸ®</div>
      <p class="small" id="hubDesc" style="margin-top:6px;"></p>
      <div class="grid-3" id="gameCards" style="margin-top:14px;"></div>
    </div>

    <!-- GAME PLAYER -->
    <div class="game-box wide" id="playWrap" style="margin-top:16px; display:none;">
      <div class="kid-big" id="gameTitle">Game</div>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="small" id="gameMeta">â€”</div>
            <div class="kid-big" id="gamePrompt">Promptâ€¦</div>
          </div>
          <button class="btn secondary" id="gameSoundBtn" title="Read aloud" aria-label="Read aloud">ğŸ”Š</button>
        </div>

        <div class="small" id="gameSupport" style="margin-top:6px;"></div>
        <div id="stage" style="margin-top:14px;"></div>
        <div class="kid-big" id="result" style="margin-top:14px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
          <button class="btn" id="nextBtn">Next</button>
          <button class="btn secondary" id="backBtn">Back to Games</button>
        </div>

        <div class="small" style="margin-top:10px;">Earn â­ for correct answers.</div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
  const PROG_KEY = "bloom_progress";
  const READ_DIAG_KEY = "bloom_reading_diag";

  function load(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function addStar(){
    const p = load(PROG_KEY, { phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0 });
    p.readingStars = (p.readingStars || 0) + 1;
    save(PROG_KEY, p);
  }

  function speak(text){
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1;
    u.pitch = 1.05;
    speechSynthesis.speak(u);
  }

  let grade = new URLSearchParams(location.search).get("grade") || localStorage.getItem("bloom_pref_grade") || "K";
  const gradeButtons = document.querySelectorAll(".pill[data-grade]");
  function setGrade(g){
    grade = g;
    localStorage.setItem("bloom_pref_grade", g);
    gradeButtons.forEach(b => b.classList.toggle("active", b.dataset.grade === grade));
    refreshGoGames();
    refreshHub();
  }
  gradeButtons.forEach(btn => btn.onclick = ()=> setGrade(btn.dataset.grade));
  setGrade(grade);

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // -------- Diagnostic bank (10 items grade-aware) --------
  const BANK = {
    "K": [
      {q:"Point to the word: cat", choices:["cat","cap","can"], correct:"cat", focus:"word"},
      {q:"Which word starts like 'sun'?", choices:["sit","sun","map"], correct:"sun", focus:"word"},
      {q:"Mia ran. What did Mia do?", choices:["ran","sat","ate"], correct:"ran", focus:"comprehension"},
      {q:"Sam has a hat. What does Sam have?", choices:["a hat","a cat","a mat"], correct:"a hat", focus:"comprehension"},
      {q:"Find the word: the", choices:["the","then","them"], correct:"the", focus:"sight"},
      {q:"Find the word: and", choices:["and","end","add"], correct:"and", focus:"sight"},
      {q:"Ben is sad. How does Ben feel?", choices:["sad","mad","glad"], correct:"sad", focus:"comprehension"},
      {q:"A dog can run. What can a dog do?", choices:["run","read","sleep"], correct:"run", focus:"comprehension"},
      {q:"Find the word: to", choices:["to","too","two"], correct:"to", focus:"sight"},
      {q:"A bat sat. What sat?", choices:["bat","cat","hat"], correct:"bat", focus:"comprehension"}
    ],
    "1": [
      {q:"The pig dug. What did the pig do?", choices:["dug","hug","bug"], correct:"dug", focus:"comprehension"},
      {q:"Find the word: said", choices:["said","sad","sid"], correct:"said", focus:"sight"},
      {q:"Jen had a red bag. What color is the bag?", choices:["red","blue","green"], correct:"red", focus:"comprehension"},
      {q:"Which word means 'small'?", choices:["tiny","tall","fast"], correct:"tiny", focus:"vocab"},
      {q:"Pick the best title: 'I Can Hop'", choices:["Hopping","Cooking","Swimming"], correct:"Hopping", focus:"mainidea"},
      {q:"Tom can not find his cap. What is the problem?", choices:["He lost his cap","He ate his cap","He sold his cap"], correct:"He lost his cap", focus:"comprehension"},
      {q:"Find the word: because", choices:["because","become","before"], correct:"because", focus:"sight"},
      {q:"Which sentence is a question?", choices:["Can you help?","I like cats.","We ran fast."], correct:"Can you help?", focus:"skills"},
      {q:"What happens next? 'She tied her shoe. She stood up.'", choices:["She walks","She sleeps","She eats"], correct:"She walks", focus:"sequence"},
      {q:"Find the word: could", choices:["could","cold","cloud"], correct:"could", focus:"sight"}
    ],
    "2": [
      {q:"Liam practiced daily. Why did Liam improve?", choices:["Practice","Luck","Noise"], correct:"Practice", focus:"mainidea"},
      {q:"Which word is a synonym for 'happy'?", choices:["glad","mad","sad"], correct:"glad", focus:"vocab"},
      {q:"What is the setting? 'At the park, Mia fed ducks.'", choices:["park","school","store"], correct:"park", focus:"skills"},
      {q:"What does 'careful' mean?", choices:["cautious","sleepy","loud"], correct:"cautious", focus:"vocab"},
      {q:"Pick the best title: 'A Rainy Day'", choices:["Rainy Day","Sunny Beach","Snow Fun"], correct:"Rainy Day", focus:"mainidea"},
      {q:"What is the problem? 'Ben forgot his lunch.'", choices:["He has no lunch","He has too much lunch","He ate lunch"], correct:"He has no lunch", focus:"comprehension"},
      {q:"Which is a fact?", choices:["The dog is brown.","Dogs are the best.","This is the cutest dog."], correct:"The dog is brown.", focus:"skills"},
      {q:"What happens first? 'She mixed. She baked. She ate.'", choices:["mixed","baked","ate"], correct:"mixed", focus:"sequence"},
      {q:"Find the meaning of 'tiny'?", choices:["very small","very big","very fast"], correct:"very small", focus:"vocab"},
      {q:"What is the lesson? 'Share with friends.'", choices:["Sharing is good","Never share","Hide toys"], correct:"Sharing is good", focus:"skills"}
    ]
  };

  // -------- Diagnostic state --------
  const diagWrap = document.getElementById("diagWrap");
  const afterWrap = document.getElementById("afterDiagWrap");
  const hub = document.getElementById("gamesHub");
  const playWrap = document.getElementById("playWrap");

  const diagMeta = document.getElementById("diagMeta");
  const diagQ = document.getElementById("diagQ");
  const diagSupport = document.getElementById("diagSupport");
  const diagChoices = document.getElementById("diagChoices");
  const diagResult = document.getElementById("diagResult");

  let diagItems = [];
  let dIndex=0, dScore=0, dWrong=[];
  let lastDiag = null;

  function startDiag(){
    diagItems = shuffle(BANK[grade]).slice(0,10);
    dIndex=0; dScore=0; dWrong=[];
    diagWrap.style.display="block";
    afterWrap.style.display="none";
    hub.style.display="none";
    playWrap.style.display="none";
    renderDiag();
    window.scrollTo({top: diagWrap.offsetTop-10, behavior:"smooth"});
  }

  function renderDiag(){
    const it = diagItems[dIndex];
    lastDiag = it;
    diagMeta.textContent = `Question ${dIndex+1} of 10`;
    diagQ.textContent = it.q;
    diagSupport.textContent = "Tap ğŸ”Š to read aloud.";
    diagResult.textContent = "";

    diagChoices.innerHTML="";
    it.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className="card";
      card.style.textAlign="center";
      card.innerHTML = `<h3 style="font-size:22px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> diagAnswer(c);
      diagChoices.appendChild(card);
    });
  }

  function diagAnswer(choice){
    if (diagResult.textContent) return;
    const it = diagItems[dIndex];
    if (choice === it.correct){
      dScore++;
      diagResult.textContent = "Correct! â­";
    } else {
      dWrong.push(it.focus);
      diagResult.textContent = `Try again ğŸ™‚ Answer: ${it.correct}`;
    }
  }

  function diagNext(skipped=false){
    const it = diagItems[dIndex];
    if (!diagResult.textContent || skipped) dWrong.push(it.focus);
    dIndex++;
    if (dIndex>=10) finishDiag();
    else renderDiag();
  }

  function finishDiag(){
    const pct = Math.round((dScore/10)*100);
    const counts = dWrong.reduce((m,k)=>(m[k]=(m[k]||0)+1,m),{});
    const focusOrder = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);

    save(READ_DIAG_KEY, {date:Date.now(), grade, score:pct, focusOrder});

    document.getElementById("planScore").textContent = `${pct}%`;
    document.getElementById("planGrade").textContent = `Grade: ${grade==="K"?"Kindergarten":"Grade "+grade}`;

    const map = { sight:"Sight Words", vocab:"Vocabulary", mainidea:"Main Idea", sequence:"Sequence", skills:"Reading Skills", comprehension:"Comprehension", word:"Word Reading" };
    const path = focusOrder.slice(0,3).map(k=>map[k]).filter(Boolean);
    document.getElementById("planPath").textContent = path.length ? path.join(" â†’ ") : "Mixed Practice";

    let minutes = pct>=90 ? 6 : pct>=70 ? 8 : 10;
    document.getElementById("planLen").textContent = `${minutes} min`;
    document.getElementById("planLenNote").textContent = (pct>=90) ? "Try 1 story + 1 game" : (pct>=70) ? "Try 2 games" : "Try 2 games + decodable";

    diagWrap.style.display="none";
    afterWrap.style.display="block";
    refreshGoGames();
    window.scrollTo({top: afterWrap.offsetTop-10, behavior:"smooth"});
  }

  function refreshGoGames(){
    const saved = load(READ_DIAG_KEY, null);
    const ok = saved && saved.grade === grade;
    const btn = document.getElementById("goGamesBtn");
    btn.disabled = !ok;
    btn.style.opacity = ok ? "1" : ".6";
  }

  // -------- Reading Games (grade-aware) --------
  const GAMES = [
    {id:"decodable", name:"ğŸ“˜ Decodable Text", desc:"Read a decodable story and answer a question.", min:5, grades:["K","1","2"]},
    {id:"comprehension", name:"âœ… Quick Comprehension", desc:"Read a short passage and answer.", min:4, grades:["K","1","2"]},
    {id:"sentenceScramble", name:"ğŸ§© Sentence Scramble", desc:"Put words in order to make a sentence.", min:4, grades:["1","2"]},
    {id:"labelScene", name:"ğŸ  Label the Scene", desc:"Label everyday objects in a scenario.", min:5, grades:["K","1","2"]}
  ];

  const hubDesc = document.getElementById("hubDesc");
  const gameCards = document.getElementById("gameCards");

  function refreshHub(){
    const saved = load(READ_DIAG_KEY, null);
    hubDesc.textContent = saved && saved.grade===grade ? "Games are filtered for your grade. â­" : "Take the diagnostic first.";
    const list = GAMES.filter(g=>g.grades.includes(grade));
    gameCards.innerHTML="";
    list.forEach(g=>{
      const c = document.createElement("div");
      c.className="card";
      c.innerHTML = `
        <h3 style="margin-bottom:6px;">${g.name}</h3>
        <p class="small" style="line-height:1.5;">${g.desc}</p>
        <p class="small" style="margin-top:8px;"><strong>Length:</strong> ${g.min} min</p>
        <div class="quick-strip" style="margin-top:10px; justify-content:flex-start;">
          <button class="btn secondary" data-id="${g.id}">Play</button>
        </div>
      `;
      c.querySelector("button").onclick = ()=> startGame(g.id);
      gameCards.appendChild(c);
    });
  }

  function openHub(){
    afterWrap.style.display="none";
    diagWrap.style.display="none";
    hub.style.display="block";
    playWrap.style.display="none";
    refreshHub();
    window.scrollTo({top: hub.offsetTop-10, behavior:"smooth"});
  }

  // -------- Player --------
  const gameTitle = document.getElementById("gameTitle");
  const gameMeta = document.getElementById("gameMeta");
  const gamePrompt = document.getElementById("gamePrompt");
  const gameSupport = document.getElementById("gameSupport");
  const stage = document.getElementById("stage");
  const result = document.getElementById("result");

  let activeGame=null, gIndex=0, lastReadText="";

  function startGame(id){
    activeGame=id;
    gIndex=0;
    hub.style.display="none";
    playWrap.style.display="block";
    renderGame();
    window.scrollTo({top: playWrap.offsetTop-10, behavior:"smooth"});
  }

  function choiceCards(choices, onPick){
    const wrap = document.createElement("div");
    wrap.className="grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className="card";
      card.style.textAlign="center";
      card.innerHTML = `<h3 style="font-size:22px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> onPick(c);
      wrap.appendChild(card);
    });
    return wrap;
  }

  function renderDecodable(){
    gameTitle.textContent = "ğŸ“˜ Decodable Text";
    gameMeta.textContent = "Read a short decodable story.";
    result.textContent = "";

    const stories = {
      "K": [
        {text:"Sam sat. Sam sat on a mat. The mat is tan.", q:"Where did Sam sit?", choices:["on a mat","on a cat","on a hat"], correct:"on a mat"},
        {text:"I see a red bag. The bag is big.", q:"What color is the bag?", choices:["red","blue","green"], correct:"red"}
      ],
      "1": [
        {text:"Chip and Ben ran to the shop. Chip got a box. Ben got a snack.", q:"Where did they go?", choices:["to the shop","to the zoo","to a lake"], correct:"to the shop"},
        {text:"Shan had a shell. She put it on the shelf.", q:"What did Shan have?", choices:["a shell","a shoe","a fish"], correct:"a shell"}
      ],
      "2": [
        {text:"Mia saw a boat on the lake. The boat was made of oak. Mia waved as it sailed.", q:"What was the boat made of?", choices:["oak","ice","sand"], correct:"oak"},
        {text:"Jake felt the rain. He put on his coat and stayed safe. He waited for the sun.", q:"Why did Jake put on his coat?", choices:["It was raining","It was hot","It was snowing"], correct:"It was raining"}
      ]
    };

    const it = stories[grade][gIndex % stories[grade].length];
    lastReadText = it.text + " " + it.q;

    gamePrompt.textContent = it.text;
    gameSupport.textContent = it.q;

    stage.innerHTML="";
    stage.appendChild(choiceCards(it.choices, (pick)=>{
      if (pick === it.correct){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderQuickComp(){
    gameTitle.textContent = "âœ… Quick Comprehension";
    gameMeta.textContent = "Read and answer.";
    result.textContent = "";

    const bank = {
      "K": [
        {p:"A cat naps.", q:"What does the cat do?", choices:["naps","runs","reads"], correct:"naps"},
        {p:"The sun is hot.", q:"How is the sun?", choices:["hot","cold","wet"], correct:"hot"}
      ],
      "1": [
        {p:"Lena lost her hat. She looked under the bed.", q:"What did Lena lose?", choices:["hat","cat","map"], correct:"hat"},
        {p:"The frog hops. It can jump far.", q:"What can the frog do?", choices:["jump","sleep","cook"], correct:"jump"}
      ],
      "2": [
        {p:"Ben practiced reading. He improved each day.", q:"What helped Ben improve?", choices:["practice","noise","fear"], correct:"practice"},
        {p:"Ava shared her snack with a friend.", q:"What did Ava do?", choices:["shared","hid","sold"], correct:"shared"}
      ]
    };

    const it = bank[grade][gIndex % bank[grade].length];
    lastReadText = it.p + " " + it.q;

    gamePrompt.textContent = it.p;
    gameSupport.textContent = it.q;

    stage.innerHTML="";
    stage.appendChild(choiceCards(it.choices, (pick)=>{
      if (pick === it.correct){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderScramble(){
    gameTitle.textContent = "ğŸ§© Sentence Scramble";
    gameMeta.textContent = "Put words in order.";
    result.textContent = "";

    const bank = grade==="2"
      ? ["I can read this.", "The dog runs fast.", "We went to the park."]
      : ["I can hop.", "We see the sun.", "She has a hat."];

    const sentence = bank[gIndex % bank.length];
    lastReadText = sentence;

    const words = sentence.replace(".", "").split(" ");
    const shuffled = shuffle(words);

    gamePrompt.textContent = "Tap words to build the sentence.";
    gameSupport.textContent = "Make it match the correct sentence.";

    stage.innerHTML="";
    const tray = document.createElement("div");
    tray.className="game-box";
    tray.style.display="flex";
    tray.style.gap="10px";
    tray.style.flexWrap="wrap";
    tray.style.justifyContent="center";

    const built = document.createElement("div");
    built.className="game-box";
    built.style.marginTop="10px";
    built.style.textAlign="center";

    let current = [];

    shuffled.forEach(w=>{
      const b = document.createElement("button");
      b.className="pill";
      b.textContent = w;
      b.onclick = ()=>{
        current.push(w);
        renderBuilt();
      };
      tray.appendChild(b);
    });

    function renderBuilt(){
      built.innerHTML = `<div class="kid-big" style="margin:0;">${current.join(" ")}</div>`;
      const checkRow = document.createElement("div");
      checkRow.className="quick-strip";
      checkRow.style.justifyContent="center";
      checkRow.style.marginTop="10px";

      const check = document.createElement("button");
      check.className="btn";
      check.textContent="Check";
      check.onclick = ()=>{
        const made = current.join(" ") + ".";
        if (made === sentence){
          result.textContent = "Correct! â­";
          addStar();
        } else {
          result.textContent = "Try again ğŸ™‚";
        }
      };

      const clear = document.createElement("button");
      clear.className="btn secondary";
      clear.textContent="Clear";
      clear.onclick = ()=>{ current = []; result.textContent=""; renderBuilt(); };

      checkRow.appendChild(check);
      checkRow.appendChild(clear);
      built.appendChild(checkRow);
    }

    renderBuilt();
    stage.appendChild(tray);
    stage.appendChild(built);
  }

  function renderLabelScene(){
    gameTitle.textContent = "ğŸ  Label the Scene";
    gameMeta.textContent = "Pick the best label.";
    result.textContent = "";

    const scenes = {
      "K": [
        {emoji:"ğŸ½ï¸", prompt:"At the table, point to:", target:"plate", choices:["plate","boat","rain"]},
        {emoji:"ğŸ›ï¸", prompt:"In the bedroom, point to:", target:"bed", choices:["bed","bag","bug"]}
      ],
      "1": [
        {emoji:"ğŸ«", prompt:"At school, find:", target:"desk", choices:["desk","duck","dock"]},
        {emoji:"ğŸ›’", prompt:"At the store, find:", target:"cart", choices:["cart","coat","cat"]}
      ],
      "2": [
        {emoji:"ğŸï¸", prompt:"At the park, find:", target:"bench", choices:["bench","beach","branch"]},
        {emoji:"ğŸ³", prompt:"In the kitchen, find:", target:"spoon", choices:["spoon","spool","sport"]}
      ]
    };

    const it = scenes[grade][gIndex % scenes[grade].length];
    lastReadText = `${it.prompt} ${it.target}`;

    gamePrompt.innerHTML = `${it.emoji} ${it.prompt} <strong>${it.target}</strong>`;
    gameSupport.textContent = "Choose the correct label.";

    stage.innerHTML="";
    stage.appendChild(choiceCards(it.choices, (pick)=>{
      if (pick === it.target){
        result.textContent = "Correct! â­";
        addStar();
      } else {
        result.textContent = "Try again ğŸ™‚";
      }
    }));
  }

  function renderGame(){
    result.textContent = "";
    if (activeGame==="decodable") return renderDecodable();
    if (activeGame==="comprehension") return renderQuickComp();
    if (activeGame==="sentenceScramble") return renderScramble();
    if (activeGame==="labelScene") return renderLabelScene();
  }

  // -------- Controls --------
  document.getElementById("startDiagBtn").onclick = startDiag;
  document.getElementById("diagNextBtn").onclick = ()=> diagNext(false);
  document.getElementById("diagSkipBtn").onclick = ()=> diagNext(true);
  document.getElementById("diagSoundBtn").onclick = ()=> { if (lastDiag) speak(lastDiag.q); };

  document.getElementById("openGamesBtn").onclick = openHub;
  document.getElementById("goGamesBtn").onclick = openHub;

  document.getElementById("retakeBtn").onclick = ()=>{
    const saved = load(READ_DIAG_KEY, null);
    if (saved && saved.grade===grade) localStorage.removeItem(READ_DIAG_KEY);
    afterWrap.style.display="none";
    hub.style.display="none";
    playWrap.style.display="none";
    diagWrap.style.display="none";
    refreshGoGames();
    alert("Diagnostic cleared. Press Start Diagnostic to begin again!");
  };

  document.getElementById("nextBtn").onclick = ()=>{ gIndex++; renderGame(); };
  document.getElementById("backBtn").onclick = openHub;
  document.getElementById("gameSoundBtn").onclick = ()=> { if (lastReadText) speak(lastReadText); };

  refreshGoGames();
  refreshHub();
</script>

</body>
</html>
