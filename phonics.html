<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<!-- SAME DROPDOWN NAV -->
<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a href="#">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Take a quick diagnostic. Then play a game that matches what you need most!</p>
    <div class="quick-strip">
      <a class="btn secondary" href="progress.html">My Progress</a>
      <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
    </div>
    <div class="hero-note">Kâ€“2: letter names + letter sounds</div>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Start Here ğŸŒŸ</h2>

    <div class="game-box wide">
      <!-- Grade pick -->
      <div class="badge-row">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>

      <!-- Mode buttons -->
      <div class="quick-strip" style="margin-top:14px;">
        <button class="btn" id="goDiagBtn">Take Diagnostic</button>
        <button class="btn secondary" id="goGameBtn">Go to Game</button>
        <button class="btn secondary" id="retakeBtn">Retake Diagnostic</button>
      </div>

      <!-- DIAGNOSTIC PANEL -->
      <div class="game-box" id="diagPanel" style="margin-top:14px;">
        <p class="kid-big">Diagnostic âœ…</p>
        <p class="small">Answer letter <strong>name</strong> and <strong>sound</strong> questions.</p>

        <div class="game-box" style="margin-top:12px;">
          <!-- Question Row with Sound Button -->
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <p class="kid-big" id="diagQ" style="margin:0;">Press â€œTake Diagnosticâ€ to begin.</p>
            <button class="btn secondary" id="diagSpeakBtn" style="white-space:nowrap;">ğŸ”Š</button>
          </div>

          <p class="small" id="diagHint"></p>

          <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
          <p class="kid-big" id="diagResult" style="margin-top:14px;"></p>

          <div class="quick-strip">
            <button class="btn" id="diagNextBtn">Next</button>
            <button class="btn secondary" id="diagSkipBtn">Skip</button>
          </div>

          <p class="small" style="margin-top:10px;">
            Tip: Press ğŸ”Š to hear the letter name or the sound out loud.
          </p>
        </div>
      </div>

      <!-- GAME PANEL -->
      <div class="game-box" id="gamePanel" style="margin-top:14px; display:none;">
        <p class="kid-big">Mini Game ğŸ®</p>
        <p class="small" id="gamePlan">Your game is based on your diagnostic.</p>

        <div class="game-box" style="margin-top:12px;">
          <!-- Question Row with Sound Button -->
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <p class="kid-big" id="gameQ" style="margin:0;">Game question loads hereâ€¦</p>
            <button class="btn secondary" id="gameSpeakBtn" style="white-space:nowrap;">ğŸ”Š</button>
          </div>

          <p class="small" id="gameHint"></p>

          <div class="grid-3" id="gameChoices" style="margin-top:14px;"></div>
          <p class="kid-big" id="gameResult" style="margin-top:14px;"></p>

          <div class="quick-strip">
            <button class="btn" id="gameNextBtn">Next</button>
            <button class="btn secondary" id="resetStarsBtn">Reset Stars</button>
          </div>

          <p class="small" style="margin-top:10px;">
            Tip: Press ğŸ”Š to hear the sound again.
          </p>
        </div>
      </div>

    </div>
  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script>
  // ---------- Storage Keys ----------
  const PROG_KEY = "bloom_progress";
  const PHONICS_DIAG_KEY = "bloom_phonics_diag";

  // ---------- Helpers ----------
  function load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // Speech: â€œletter nameâ€ vs â€œsoundâ€
  function speak(text) {
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95;
    speechSynthesis.speak(u);
  }

  function speakLetterName(letter){
    speak(`The letter is ${letter}.`);
  }

  function speakSound(soundText){
    // Try to say a child-friendly version
    // Example soundText: "/m/" or "long A (ai/ay)"
    if (soundText.includes("/")) {
      const cleaned = soundText.replaceAll("/", "").trim();
      speak(`The sound is ${cleaned}. ${cleaned}.`);
    } else {
      speak(`Listen. ${soundText}.`);
    }
  }

  // ---------- Grade Selection ----------
  let grade = "K";
  function renderGradeButtons(){
    document.querySelectorAll(".pill").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.grade === grade);
    });
  }
  document.querySelectorAll(".pill").forEach(btn=>{
    btn.onclick = ()=>{
      grade = btn.dataset.grade;
      renderGradeButtons();
      updateModeButtons();
      showDiagnosticIntro();
    };
  });

  // ---------- Content Banks (Kâ€“2) ----------
  const gradeBanks = {
    "K": {
      nameItems: [
        { letter:"A", correct:"A", choices:["A","B","D"] },
        { letter:"M", correct:"M", choices:["N","M","W"] },
        { letter:"S", correct:"S", choices:["S","C","G"] }
      ],
      soundItems: [
        { sound:"/m/", correct:"M", choices:["M","S","T"], hint:"/m/ like moon" },
        { sound:"/s/", correct:"S", choices:["B","S","D"], hint:"/s/ like sun" },
        { sound:"/t/", correct:"T", choices:["T","A","P"], hint:"/t/ like top" }
      ]
    },
    "1": {
      nameItems: [
        { letter:"B", correct:"B", choices:["B","D","P"] },
        { letter:"R", correct:"R", choices:["R","K","H"] },
        { letter:"T", correct:"T", choices:["T","F","E"] }
      ],
      soundItems: [
        { sound:"/sh/", correct:"SH", choices:["CH","SH","TH"], hint:"SH like ship" },
        { sound:"/ch/", correct:"CH", choices:["CH","PH","WH"], hint:"CH like chop" },
        { sound:"/th/", correct:"TH", choices:["TH","SH","CH"], hint:"TH like this" }
      ]
    },
    "2": {
      nameItems: [
        { letter:"G", correct:"G", choices:["G","J","Q"] },
        { letter:"P", correct:"P", choices:["P","R","B"] },
        { letter:"V", correct:"V", choices:["V","W","Y"] }
      ],
      soundItems: [
        { sound:"long A (ai/ay)", correct:"AI", choices:["AI","OA","EE"], hint:"AI like rain" },
        { sound:"long E (ee/ea)", correct:"EE", choices:["EE","OO","AI"], hint:"EE like feet" },
        { sound:"long O (oa/ow)", correct:"OA", choices:["OA","EE","AI"], hint:"OA like boat" }
      ]
    }
  };

  // ---------- Diagnostic Builder ----------
  function buildDiagnostic(grade){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`What is the NAME of this letter: ${x.letter}?`,
      hint:"Say the letter name out loud.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      sound: x.sound,
      prompt:`Which letter(s) make ${x.sound}?`,
      hint:x.hint || "Listen for the sound.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    return shuffle([...nameQs, ...soundQs]);
  }

  // ---------- Targeted Game Builder ----------
  function buildGame(grade, missedFocusKeys){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`Letter NAME: ${x.letter} is calledâ€¦`,
      hint:"Pick the correct letter name.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      sound: x.sound,
      prompt:`Letter SOUND: Which makes ${x.sound}?`,
      hint:x.hint || "Listen for the sound.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    const pool = [...nameQs, ...soundQs];
    const missed = pool.filter(q => missedFocusKeys.includes(q.focusKey));
    const rest   = pool.filter(q => !missedFocusKeys.includes(q.focusKey));

    const game = [];
    while (game.length < 10) {
      if (missed.length) game.push(missed.shift());
      else game.push(rest[game.length % rest.length]);
    }
    return game;
  }

  // ---------- State ----------
  let diagQs = [];
  let diagIndex = 0;
  let diagCorrect = 0;
  let diagMissed = [];
  let lastDiagQ = null;

  let gameQs = [];
  let gameIndex = 0;
  let lastGameQ = null;

  // ---------- UI refs ----------
  const diagPanel = document.getElementById("diagPanel");
  const gamePanel = document.getElementById("gamePanel");

  const diagQEl = document.getElementById("diagQ");
  const diagHintEl = document.getElementById("diagHint");
  const diagChoicesEl = document.getElementById("diagChoices");
  const diagResultEl = document.getElementById("diagResult");

  const gameQEl = document.getElementById("gameQ");
  const gameHintEl = document.getElementById("gameHint");
  const gameChoicesEl = document.getElementById("gameChoices");
  const gameResultEl = document.getElementById("gameResult");
  const gamePlanEl = document.getElementById("gamePlan");

  const goDiagBtn = document.getElementById("goDiagBtn");
  const goGameBtn = document.getElementById("goGameBtn");
  const retakeBtn = document.getElementById("retakeBtn");

  function updateModeButtons(){
    const saved = load(PHONICS_DIAG_KEY, null);
    const hasCurrent = saved && saved.grade === grade;
    goGameBtn.disabled = !hasCurrent;
    goGameBtn.style.opacity = hasCurrent ? "1" : ".6";
  }

  // ---------- Diagnostic UI ----------
  function showDiagnosticIntro(){
    diagQEl.textContent = "Press â€œTake Diagnosticâ€ to begin.";
    diagHintEl.textContent = "";
    diagChoicesEl.innerHTML = "";
    diagResultEl.textContent = "";
    diagPanel.style.display = "block";
    gamePanel.style.display = "none";
    lastDiagQ = null;
    lastGameQ = null;
  }

  function renderDiagQuestion(){
    const q = diagQs[diagIndex];
    lastDiagQ = q;

    diagQEl.textContent = q.prompt;
    diagHintEl.textContent = q.hint || "";
    diagResultEl.textContent = "";

    diagChoicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkDiagAnswer(c);
      diagChoicesEl.appendChild(card);
    });
  }

  function playDiagSound(){
    if (!lastDiagQ) return speak("Press take diagnostic to begin.");
    if (lastDiagQ.type === "name") speakLetterName(lastDiagQ.letter);
    else speakSound(lastDiagQ.sound);
  }

  function checkDiagAnswer(choice){
    if (diagResultEl.textContent) return;

    const q = diagQs[diagIndex];
    if (choice === q.correct){
      diagCorrect++;
      diagResultEl.textContent = "Correct! â­";
      speak("Correct!");
    } else {
      diagMissed.push(q.focusKey);
      diagResultEl.textContent = `Good try! Answer: ${q.correct}`;
      speak("Good try.");
      // extra help: replay sound automatically for sound questions
      if (q.type === "sound") speakSound(q.sound);
    }
  }

  function finishDiagnostic(){
    const total = diagQs.length || 1;
    const score = Math.round((diagCorrect / total) * 100);

    const resultObj = { grade, score, missed: diagMissed, date: Date.now() };
    save(PHONICS_DIAG_KEY, resultObj);

    gameQs = buildGame(grade, diagMissed);
    gameIndex = 0;

    const missedNames = diagMissed.filter(x=>x.startsWith("name:")).length;
    const missedSounds = diagMissed.filter(x=>x.startsWith("sound:")).length;

    let planText = `Diagnostic score: ${score}% â€” `;
    if (missedNames === 0 && missedSounds === 0) planText += "Awesome! We'll do a fun mix of practice.";
    else {
      planText += "We will practice: ";
      const parts = [];
      if (missedNames) parts.push(`letter names (${missedNames})`);
      if (missedSounds) parts.push(`letter sounds (${missedSounds})`);
      planText += parts.join(" and ") + ".";
    }
    gamePlanEl.textContent = planText;

    updateModeButtons();
    startGameFromSaved();
  }

  // ---------- Game UI ----------
  function renderGameQuestion(){
    const q = gameQs[gameIndex % gameQs.length];
    lastGameQ = q;

    gameQEl.textContent = q.prompt;
    gameHintEl.textContent = q.hint || "";
    gameResultEl.textContent = "";

    gameChoicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkGameAnswer(c);
      gameChoicesEl.appendChild(card);
    });
  }

  function playGameSound(){
    if (!lastGameQ) return speak("Start the game after the diagnostic.");
    if (lastGameQ.type === "name") speakLetterName(lastGameQ.letter);
    else speakSound(lastGameQ.sound);
  }

  function addPhonicsStar(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    save(PROG_KEY, p);
  }

  function checkGameAnswer(choice){
    if (gameResultEl.textContent) return;

    const q = gameQs[gameIndex % gameQs.length];
    if (choice === q.correct){
      gameResultEl.textContent = "Correct! â­";
      addPhonicsStar();
      speak("Correct!");
    } else {
      gameResultEl.textContent = "Try again ğŸ™‚";
      speak("Try again.");
      // replay sound for sound-type items to support learning
      if (q.type === "sound") speakSound(q.sound);
    }
  }

  function startGameFromSaved(){
    const savedDiag = load(PHONICS_DIAG_KEY, null);
    if (!savedDiag || savedDiag.grade !== grade){
      showDiagnosticIntro();
      return;
    }

    gameQs = buildGame(grade, savedDiag.missed || []);
    gameIndex = 0;

    const missedNames = (savedDiag.missed || []).filter(x=>x.startsWith("name:")).length;
    const missedSounds = (savedDiag.missed || []).filter(x=>x.startsWith("sound:")).length;

    let planText = `Diagnostic score: ${savedDiag.score}% â€” `;
    if (missedNames === 0 && missedSounds === 0) planText += "Awesome! We'll do a fun mix of practice.";
    else {
      planText += "We will practice: ";
      const parts = [];
      if (missedNames) parts.push(`letter names (${missedNames})`);
      if (missedSounds) parts.push(`letter sounds (${missedSounds})`);
      planText += parts.join(" and ") + ".";
    }
    gamePlanEl.textContent = planText;

    diagPanel.style.display = "none";
    gamePanel.style.display = "block";
    renderGameQuestion();
  }

  // ---------- Buttons ----------
  goDiagBtn.onclick = ()=>{
    diagQs = buildDiagnostic(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagMissed = [];
    diagPanel.style.display = "block";
    gamePanel.style.display = "none";
    renderDiagQuestion();
    playDiagSound(); // auto-play first prompt
  };

  document.getElementById("diagNextBtn").onclick = ()=>{
    if (!diagQs.length) return;

    if (!diagResultEl.textContent){
      diagMissed.push(diagQs[diagIndex].focusKey);
    }

    diagIndex++;
    if (diagIndex >= diagQs.length){
      finishDiagnostic();
    } else {
      renderDiagQuestion();
      playDiagSound();
    }
  };

  document.getElementById("diagSkipBtn").onclick = ()=>{
    if (!diagQs.length) return;
    diagMissed.push(diagQs[diagIndex].focusKey);

    diagIndex++;
    if (diagIndex >= diagQs.length){
      finishDiagnostic();
    } else {
      renderDiagQuestion();
      playDiagSound();
    }
  };

  goGameBtn.onclick = ()=> startGameFromSaved();

  retakeBtn.onclick = ()=>{
    const savedDiag = load(PHONICS_DIAG_KEY, null);
    if (savedDiag && savedDiag.grade === grade){
      localStorage.removeItem(PHONICS_DIAG_KEY);
    }
    updateModeButtons();
    showDiagnosticIntro();
    alert("Diagnostic cleared. Press â€œTake Diagnosticâ€ to start again!");
  };

  document.getElementById("gameNextBtn").onclick = ()=>{
    gameIndex++;
    renderGameQuestion();
    playGameSound();
  };

  document.getElementById("resetStarsBtn").onclick = ()=>{
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = 0;
    save(PROG_KEY, p);
    alert("Phonics stars reset!");
  };

  // Sound buttons near question
  document.getElementById("diagSpeakBtn").onclick = playDiagSound;
  document.getElementById("gameSpeakBtn").onclick = playGameSound;

  // ---------- Initialize ----------
  renderGradeButtons();
  updateModeButtons();
  showDiagnosticIntro();
</script>

</body>
</html>
