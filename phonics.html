<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>

    <!-- NAV matches your other pages (dropdowns controlled by nav.js) -->
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Pick your grade, take a quick diagnostic, then choose a game to practice!</p>

    <div class="game-box wide" style="margin-top:14px;">
      <div class="kid-big">Choose Grade ğŸŒŸ</div>
      <div class="badge-row" id="gradeRow">
        <button class="pill active" data-grade="K" type="button">Kindergarten</button>
        <button class="pill" data-grade="1" type="button">Grade 1</button>
        <button class="pill" data-grade="2" type="button">Grade 2</button>
      </div>

      <div class="quick-strip" style="margin-top:10px;">
        <button class="btn" id="startDiagBtn" type="button">Start Diagnostic</button>
        <button class="btn secondary" id="openGamesBtn" type="button">Choose a Game</button>
        <a class="btn secondary" href="progress.html">My Progress</a>
      </div>

      <div class="hero-note" id="diagNote">Tip: Do the diagnostic first so games match your needs.</div>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">

    <!-- DIAGNOSTIC PANEL -->
    <div class="game-box wide" id="diagPanel">
      <h2 class="section-title">Phonics Diagnostic âœ…</h2>

      <div class="game-box">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="diagQ" style="margin:0; flex:1;">Press â€œStart Diagnosticâ€ to begin.</p>
          <button class="btn secondary" id="diagSoundBtn" type="button" title="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="diagHint" style="margin-top:8px;"></p>
        <p class="small" id="diagStatus" style="display:none;"></p>

        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>

        <p class="kid-big" id="diagResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="diagNextBtn" type="button">Next</button>
          <button class="btn secondary" id="diagSkipBtn" type="button">Skip</button>
          <button class="btn secondary" id="diagResetBtn" type="button">Reset Diagnostic</button>
        </div>

        <div class="small" style="margin-top:10px;">
          Score: <span id="diagScore">0</span> / <span id="diagTotal">0</span>
        </div>
      </div>
    </div>

    <!-- GAME SELECT PANEL -->
    <div class="game-box wide" id="gamesPanel" style="margin-top:18px; display:none;">
      <h2 class="section-title">Choose a Game ğŸ®</h2>

      <div class="grid-3">
        <div class="card">
          <h3>ğŸ”Š Sound â†’ Name</h3>
          <p>Hear a sound and pick the correct letter name.</p>
          <button class="btn" data-game="soundToName" type="button">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ”¤ Name â†’ Sound</h3>
          <p>See a letter and pick the correct sound.</p>
          <button class="btn" data-game="nameToSound" type="button">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ–¼ï¸ Picture Labeling</h3>
          <p>Pick the word that matches the picture and starting sound.</p>
          <button class="btn" data-game="pictureLabel" type="button">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ§± CVC Words</h3>
          <p>Choose the correct CVC word (cat, map, sun).</p>
          <button class="btn" data-game="cvcWords" type="button">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ§© CVC Drag Builder</h3>
          <p>Listen to the word, then drag letters into boxes to build it.</p>
          <button class="btn" data-game="cvcDrag" type="button">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ€ Vowels Focus</h3>
          <p>Practice short vowels (a, e, i, o, u) + grade 2 vowel teams.</p>
          <button class="btn" data-game="vowels" type="button">Play</button>
        </div>

        <div class="card">
          <h3>â­ Rewards</h3>
          <p>Earn stars by answering correctly!</p>
          <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
        </div>

        <div class="card">
          <h3>ğŸ“Š Progress</h3>
          <p>Check how many phonics stars you have.</p>
          <a class="btn secondary" href="progress.html">My Progress</a>
        </div>
      </div>
    </div>

    <!-- GAME PLAY PANEL -->
    <div class="game-box wide" id="playPanel" style="margin-top:18px; display:none;">
      <h2 class="section-title" id="playTitle">Game</h2>

      <div class="game-box">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="playQ" style="margin:0; flex:1;">Game question loads hereâ€¦</p>
          <button class="btn secondary" id="playSoundBtn" type="button" title="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="playHint" style="margin-top:8px;"></p>
        <p class="small" id="playStatus" style="display:none;"></p>

        <!-- Picture area (used by picture labeling) -->
        <div id="pictureBox" class="game-box" style="display:none; margin-top:12px; text-align:center;">
          <div class="kid-big" id="pictureEmoji" style="font-size:44px;">ğŸ–¼ï¸</div>
          <div class="small" id="pictureCaption"></div>
        </div>

        <!-- CVC Drag Builder (only used by cvcDrag) -->
        <div id="cvcDragBox" class="game-box" style="display:none; margin-top:12px;">
          <div class="kid-big">Build the Word ğŸ§©</div>
          <p class="small">Drag letters into the boxes. Tap ğŸ”Š to hear the word again.</p>

          <div class="cvc-tiles" id="cvcTiles"
               style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;"></div>

          <div class="cvc-slots" style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
            <div class="cvc-slot" data-slot="0" aria-label="letter slot 1"></div>
            <div class="cvc-slot" data-slot="1" aria-label="letter slot 2"></div>
            <div class="cvc-slot" data-slot="2" aria-label="letter slot 3"></div>
          </div>

          <div class="quick-strip" style="margin-top:12px;">
            <button class="btn secondary" id="cvcClearBtn" type="button">Clear</button>
            <button class="btn" id="cvcCheckBtn" type="button">Check</button>
          </div>

          <p class="small" style="margin-top:10px;">Word built: <strong id="cvcBuilt">___</strong></p>
        </div>

        <!-- Multiple-choice choices (used by all non-drag games) -->
        <div class="grid-3" id="playChoices" style="margin-top:14px;"></div>

        <p class="kid-big" id="playResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="playNextBtn" type="button">Next</button>
          <button class="btn secondary" id="backToGamesBtn" type="button">Back to Games</button>
          <button class="btn secondary" id="resetStarsBtn" type="button">Reset Stars</button>
        </div>

        <div class="small" style="margin-top:10px;">
          Stars earned in Phonics: <strong id="starCount">0</strong>
        </div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script>
  // =============================
  // Storage Keys
  // =============================
  const PROG_KEY = "bloom_progress";
  const DIAG_KEY = "bloom_phonics_diag_v2";
  const PREF_GRADE_KEY = "bloom_pref_grade";

  // =============================
  // Helpers
  // =============================
  function load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj) { localStorage.setItem(key, JSON.stringify(obj)); }

  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function showStatus(el, msg){
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.style.display = "none"; }, 2000);
  }

  // =============================
  // Audio (real mp3 preferred; fallback to TTS)
  // =============================
  const audio = new Audio();
  audio.preload = "auto";

  // Your existing sounds folder (add more if you want)
  const soundAudio = {
    "m": "./assets/audio/sounds/m.mp3",
    "s": "./assets/audio/sounds/s.mp3",
    "t": "./assets/audio/sounds/t.mp3",
    "sh": "./assets/audio/sounds/sh.mp3",
    "ch": "./assets/audio/sounds/ch.mp3",
    "th": "./assets/audio/sounds/th.mp3",
    "short-a": "./assets/audio/sounds/short-a.mp3",
    "short-e": "./assets/audio/sounds/short-e.mp3",
    "short-i": "./assets/audio/sounds/short-i.mp3",
    "short-o": "./assets/audio/sounds/short-o.mp3",
    "short-u": "./assets/audio/sounds/short-u.mp3",
    "long-a": "./assets/audio/sounds/long-a.mp3",
    "long-e": "./assets/audio/sounds/long-e.mp3",
    "long-o": "./assets/audio/sounds/long-o.mp3"
  };

  // Letters folder (you already started these)
  const letterAudio = {
    "A": "./assets/audio/letters/A.mp3",
    "B": "./assets/audio/letters/B.mp3",
    "R": "./assets/audio/letters/R.mp3",
    "T": "./assets/audio/letters/T.mp3",
    "G": "./assets/audio/letters/G.mp3",
    "P": "./assets/audio/letters/P.mp3",
    "V": "./assets/audio/letters/V.mp3",
    "M": "./assets/audio/letters/M.mp3",
    "S": "./assets/audio/letters/S.mp3"
  };

  // Optional: word audio for CVC Drag Builder
  // Put files here if you want REAL word audio:
  // assets/audio/words/cat.mp3, map.mp3, sun.mp3, cap.mp3, pin.mp3, bed.mp3
  const wordAudio = {
    "cat": "./assets/audio/words/cat.mp3",
    "map": "./assets/audio/words/map.mp3",
    "sun": "./assets/audio/words/sun.mp3",
    "cap": "./assets/audio/words/cap.mp3",
    "pin": "./assets/audio/words/pin.mp3",
    "bed": "./assets/audio/words/bed.mp3"
  };

  function speakFallback(text){
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95;
    u.pitch = 1.05;
    window.speechSynthesis.speak(u);
  }

  async function playAudio(src, statusEl, ttsFallbackText){
    try {
      audio.pause();
      audio.currentTime = 0;
      audio.src = src || "";
      if (!src) throw new Error("no-src");
      await audio.play();
    } catch (e) {
      if (ttsFallbackText) speakFallback(ttsFallbackText);
      else showStatus(statusEl, "Audio missing. Add mp3 files in assets/audio/â€¦");
    }
  }

  async function playWord(word, statusEl){
    const src = wordAudio[word];
    await playAudio(src, statusEl, `Build the word: ${word}.`);
    if (!src) showStatus(statusEl, "Tip: Add recorded word mp3s in assets/audio/words/");
  }

  // =============================
  // Grade selection
  // =============================
  let grade = localStorage.getItem(PREF_GRADE_KEY) || "K";
  const gradeRow = document.getElementById("gradeRow");

  function renderGrades(){
    gradeRow.querySelectorAll(".pill").forEach(b=>{
      b.classList.toggle("active", b.dataset.grade === grade);
    });
    localStorage.setItem(PREF_GRADE_KEY, grade);

    const d = load(DIAG_KEY, null);
    const note = document.getElementById("diagNote");
    if (!d || d.grade !== grade) {
      note.textContent = "Tip: Do the diagnostic first so games match your needs.";
    } else {
      note.textContent = `Diagnostic saved for Grade ${grade}. You can choose a game now!`;
    }
  }

  gradeRow.querySelectorAll(".pill").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      grade = btn.dataset.grade;
      renderGrades();
      resetPanelsForGrade();
    });
  });

  // =============================
  // Banks by grade (Diagnostic + Games)
  // =============================
  const banks = {
    "K": {
      letterNames: ["A","M","S","T","B","R"],
      letterSounds: [
        { soundKey:"m", label:"/m/", correct:"M", choices:["M","S","T"] },
        { soundKey:"s", label:"/s/", correct:"S", choices:["B","S","D"] },
        { soundKey:"t", label:"/t/", correct:"T", choices:["T","A","P"] }
      ],
      vowels: [
        { soundKey:"short-a", label:"short a (apple)", correct:"A", choices:["A","E","I"] },
        { soundKey:"short-e", label:"short e (egg)", correct:"E", choices:["E","A","O"] }
      ]
    },
    "1": {
      letterNames: ["B","R","T","G","P","V"],
      letterSounds: [
        { soundKey:"sh", label:"/sh/", correct:"SH", choices:["CH","SH","TH"] },
        { soundKey:"ch", label:"/ch/", correct:"CH", choices:["CH","PH","WH"] },
        { soundKey:"th", label:"/th/", correct:"TH", choices:["TH","SH","CH"] }
      ],
      vowels: [
        { soundKey:"short-i", label:"short i (igloo)", correct:"I", choices:["I","A","E"] },
        { soundKey:"short-o", label:"short o (octopus)", correct:"O", choices:["O","U","E"] }
      ]
    },
    "2": {
      letterNames: ["G","P","V","R","S","T"],
      letterSounds: [
        { soundKey:"long-a", label:"long a (ai/ay)", correct:"AI", choices:["AI","EE","OA"] },
        { soundKey:"long-e", label:"long e (ee/ea)", correct:"EE", choices:["EE","AI","OA"] },
        { soundKey:"long-o", label:"long o (oa/ow)", correct:"OA", choices:["OA","EE","AI"] }
      ],
      vowels: [
        { soundKey:"short-u", label:"short u (umbrella)", correct:"U", choices:["U","O","A"] }
      ]
    }
  };

  const pictureItems = {
    "K": [
      { emoji:"ğŸ±", word:"cat", start:"c", prompt:"Pick the word for this picture." },
      { emoji:"ğŸ¶", word:"dog", start:"d", prompt:"Pick the word for this picture." },
      { emoji:"ğŸŒ", word:"sun", start:"s", prompt:"Pick the word for this picture." }
    ],
    "1": [
      { emoji:"ğŸ›³ï¸", word:"ship", start:"sh", prompt:"Pick the word for this picture." },
      { emoji:"ğŸŸ", word:"chips", start:"ch", prompt:"Pick the word for this picture." },
      { emoji:"ğŸ‘", word:"thin", start:"th", prompt:"Pick the word for this picture." }
    ],
    "2": [
      { emoji:"â›µ", word:"boat", start:"oa", prompt:"Pick the word for this picture." },
      { emoji:"ğŸŒ§ï¸", word:"rain", start:"ai", prompt:"Pick the word for this picture." },
      { emoji:"ğŸ¦¶", word:"feet", start:"ee", prompt:"Pick the word for this picture." }
    ]
  };

  const cvcItems = {
    "K": [
      { prompt:"Pick the CVC word for: ğŸ±", correct:"cat", choices:["cat","cake","cap"] },
      { prompt:"Pick the CVC word for: ğŸ§¢", correct:"cap", choices:["cap","cope","cup"] },
      { prompt:"Pick the CVC word for: â˜€ï¸", correct:"sun", choices:["sun","sand","seen"] }
    ],
    "1": [
      { prompt:"Pick the CVC word for: ğŸ·", correct:"pig", choices:["pig","page","peg"] },
      { prompt:"Pick the CVC word for: ğŸ§¤", correct:"mit", choices:["mit","mate","met"] },
      { prompt:"Pick the CVC word for: ğŸ¸", correct:"frog", choices:["frog","from","free"] }
    ],
    "2": [
      { prompt:"Pick the word with a vowel team: ğŸŒ§ï¸", correct:"rain", choices:["rain","ran","rin"] },
      { prompt:"Pick the word with a vowel team: ğŸ¦¶", correct:"feet", choices:["feet","fit","fat"] },
      { prompt:"Pick the word with a vowel team: â›µ", correct:"boat", choices:["boat","bot","bat"] }
    ]
  };

  // CVC Drag Builder sets (safe, simple)
  const cvcDragSets = {
    "K": [
      { word:"cat", tiles:["c","a","t","m","s","p"] },
      { word:"map", tiles:["m","a","p","t","s","c"] },
      { word:"sun", tiles:["s","u","n","a","t","m"] }
    ],
    "1": [
      { word:"cap", tiles:["c","a","p","t","m","s"] },
      { word:"pin", tiles:["p","i","n","a","t","m"] },
      { word:"bed", tiles:["b","e","d","a","t","m"] }
    ],
    "2": [
      { word:"cat", tiles:["c","a","t","p","i","n"] },
      { word:"map", tiles:["m","a","p","b","e","d"] },
      { word:"sun", tiles:["s","u","n","c","a","t"] }
    ]
  };

  // =============================
  // Progress (stars)
  // =============================
  function getProgress(){
    return load(PROG_KEY, { phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null });
  }
  function setProgress(p){ save(PROG_KEY, p); }

  function addPhonicsStar(){
    const p = getProgress();
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    setProgress(p);
    renderStars();
  }

  function renderStars(){
    const p = getProgress();
    document.getElementById("starCount").textContent = p.phonicsStars || 0;
  }

  // =============================
  // Panels & UI refs
  // =============================
  const diagPanel = document.getElementById("diagPanel");
  const gamesPanel = document.getElementById("gamesPanel");
  const playPanel = document.getElementById("playPanel");

  const diagQEl = document.getElementById("diagQ");
  const diagHintEl = document.getElementById("diagHint");
  const diagChoicesEl = document.getElementById("diagChoices");
  const diagResultEl = document.getElementById("diagResult");
  const diagStatusEl = document.getElementById("diagStatus");
  const diagScoreEl = document.getElementById("diagScore");
  const diagTotalEl = document.getElementById("diagTotal");

  const playTitleEl = document.getElementById("playTitle");
  const playQEl = document.getElementById("playQ");
  const playHintEl = document.getElementById("playHint");
  const playChoicesEl = document.getElementById("playChoices");
  const playResultEl = document.getElementById("playResult");
  const playStatusEl = document.getElementById("playStatus");

  const pictureBox = document.getElementById("pictureBox");
  const pictureEmoji = document.getElementById("pictureEmoji");
  const pictureCaption = document.getElementById("pictureCaption");

  const cvcDragBox = document.getElementById("cvcDragBox");
  const cvcTilesEl = document.getElementById("cvcTiles");
  const cvcBuiltEl = document.getElementById("cvcBuilt");
  const cvcClearBtn = document.getElementById("cvcClearBtn");
  const cvcCheckBtn = document.getElementById("cvcCheckBtn");
  const slotEls = Array.from(document.querySelectorAll(".cvc-slot"));

  // =============================
  // Diagnostic
  // =============================
  let diagQs = [];
  let diagIdx = 0;
  let diagCorrect = 0;
  let lastDiagQ = null;

  function buildDiagnostic(g){
    const b = banks[g];

    const nameQs = b.letterNames.slice(0, 6).map(L => ({
      type: "name",
      prompt: `What is the NAME of this letter: ${L}?`,
      hint: "Tap ğŸ”Š to hear the letter name.",
      letter: L,
      correct: L,
      choices: shuffle([L, ...shuffle("ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").filter(x=>x!==L)).slice(0,2)])
    }));

    const soundQs = b.letterSounds.map(s => ({
      type: "sound",
      prompt: `Which letter(s) make this sound?`,
      hint: "Tap ğŸ”Š to hear the sound.",
      soundKey: s.soundKey,
      soundLabel: s.label,
      correct: s.correct,
      choices: shuffle(s.choices.slice())
    }));

    const vowelQs = b.vowels.map(v => ({
      type: "vowel",
      prompt: `Which vowel matches this sound?`,
      hint: "Tap ğŸ”Š to hear the vowel sound.",
      soundKey: v.soundKey,
      soundLabel: v.label,
      correct: v.correct,
      choices: shuffle(v.choices.slice())
    }));

    return shuffle([...nameQs, ...soundQs, ...vowelQs]).slice(0, 10);
  }

  function renderDiag(){
    const q = diagQs[diagIdx];
    lastDiagQ = q;

    diagResultEl.textContent = "";
    diagTotalEl.textContent = diagQs.length;
    diagScoreEl.textContent = diagCorrect;

    diagQEl.textContent = (q.type === "sound" || q.type === "vowel")
      ? `${q.prompt} (${q.soundLabel})`
      : q.prompt;

    diagHintEl.textContent = q.hint || "";

    diagChoicesEl.innerHTML = "";
    q.choices.forEach(choice=>{
      const c = document.createElement("div");
      c.className = "card";
      c.style.textAlign = "center";
      c.style.cursor = "pointer";
      c.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${choice}</h3><p class="small">Tap!</p>`;
      c.onclick = ()=>checkDiag(choice);
      diagChoicesEl.appendChild(c);
    });
  }

  function checkDiag(choice){
    if (diagResultEl.textContent) return;
    const q = diagQs[diagIdx];

    if (choice === q.correct){
      diagCorrect++;
      diagScoreEl.textContent = diagCorrect;
      diagResultEl.textContent = "Correct! â­";
    } else {
      diagResultEl.textContent = `Good try! Answer: ${q.correct}`;
    }
  }

  function finishDiag(){
    const total = diagQs.length || 1;
    const scorePct = Math.round((diagCorrect / total) * 100);

    save(DIAG_KEY, { grade, scorePct, date: Date.now() });
    diagResultEl.textContent = `Done! Your score: ${scorePct}%. Now choose a game ğŸ®`;

    renderGrades();
    setPanels("games");
  }

  function playDiagSound(){
    if (!lastDiagQ) { showStatus(diagStatusEl, "Start the diagnostic first!"); return; }

    if (lastDiagQ.type === "name"){
      const L = lastDiagQ.letter;
      const src = letterAudio[L];
      playAudio(src, diagStatusEl, `Letter ${L}`);
    } else {
      const src = soundAudio[lastDiagQ.soundKey];
      playAudio(src, diagStatusEl, lastDiagQ.soundLabel);
    }
  }

  // =============================
  // Panels
  // =============================
  function setPanels(show){
    diagPanel.style.display = (show === "diag") ? "block" : "none";
    gamesPanel.style.display = (show === "games") ? "block" : "none";
    playPanel.style.display = (show === "play") ? "block" : "none";
  }

  function resetPanelsForGrade(){
    diagQEl.textContent = "Press â€œStart Diagnosticâ€ to begin.";
    diagHintEl.textContent = "";
    diagChoicesEl.innerHTML = "";
    diagResultEl.textContent = "";
    diagScoreEl.textContent = "0";
    diagTotalEl.textContent = "0";

    diagQs = [];
    diagIdx = 0;
    diagCorrect = 0;
    lastDiagQ = null;

    setPanels("diag");
  }

  // =============================
  // Games (multiple choice)
  // =============================
  let currentGame = null;
  let lastPlayQ = null;

  function buildGameQuestion(gameType){
    const b = banks[grade];

    if (gameType === "soundToName"){
      const s = b.letterSounds[Math.floor(Math.random() * b.letterSounds.length)];
      return {
        type:"soundToName",
        prompt:"Hear the sound. Pick the letter name!",
        hint:"Tap ğŸ”Š then tap the right answer.",
        soundKey: s.soundKey,
        soundLabel: s.label,
        correct: s.correct,
        choices: shuffle(s.choices.slice())
      };
    }

    if (gameType === "nameToSound"){
      const L = b.letterNames[Math.floor(Math.random() * b.letterNames.length)];
      const soundChoices = shuffle(b.letterSounds.map(x=>x.label)).slice(0,3);
      let correctLabel = (b.letterSounds[0] && b.letterSounds[0].label) ? b.letterSounds[0].label : soundChoices[0];

      // If we can find a matching sound item by first letter (K level), use it:
      const found = b.letterSounds.find(x => x.correct === L);
      if (found) correctLabel = found.label;

      if (!soundChoices.includes(correctLabel)){
        soundChoices[Math.floor(Math.random()*soundChoices.length)] = correctLabel;
      }

      return {
        type:"nameToSound",
        prompt:`What sound does this letter make?  ${L}`,
        hint:"Tap ğŸ”Š to hear the letter name. Then choose the sound.",
        letter: L,
        correct: correctLabel,
        choices: shuffle(soundChoices)
      };
    }

    if (gameType === "pictureLabel"){
      const it = pictureItems[grade][Math.floor(Math.random() * pictureItems[grade].length)];
      const words = pictureItems[grade].map(x=>x.word);
      const distractors = shuffle(words.filter(w=>w!==it.word)).slice(0,2);
      return {
        type:"pictureLabel",
        prompt: it.prompt,
        hint:"Look at the picture. Pick the correct word.",
        pictureEmoji: it.emoji,
        pictureCaption: `Starts with: ${it.start.toUpperCase()}`,
        correct: it.word,
        choices: shuffle([it.word, ...distractors])
      };
    }

    if (gameType === "cvcWords"){
      const it = cvcItems[grade][Math.floor(Math.random() * cvcItems[grade].length)];
      return {
        type:"cvcWords",
        prompt: it.prompt,
        hint:"Choose the best answer.",
        correct: it.correct,
        choices: shuffle(it.choices.slice())
      };
    }

    if (gameType === "vowels"){
      const v = banks[grade].vowels[Math.floor(Math.random() * banks[grade].vowels.length)];
      return {
        type:"vowels",
        prompt:"Tap ğŸ”Š and choose the vowel!",
        hint:`Listen for: ${v.label}`,
        soundKey: v.soundKey,
        soundLabel: v.label,
        correct: v.correct,
        choices: shuffle(v.choices.slice())
      };
    }

    return null;
  }

  function showChoiceMode(){
    // show/hide sub-areas
    cvcDragBox.style.display = "none";
    pictureBox.style.display = "none";
    playChoicesEl.style.display = "grid";
  }

  function renderGameQuestion(){
    showChoiceMode();

    const q = buildGameQuestion(currentGame);
    lastPlayQ = q;

    playResultEl.textContent = "";
    playChoicesEl.innerHTML = "";

    const titles = {
      soundToName: "Sound â†’ Name ğŸ”Š",
      nameToSound: "Name â†’ Sound ğŸ”¤",
      pictureLabel: "Picture Labeling ğŸ–¼ï¸",
      cvcWords: "CVC Words ğŸ§±",
      vowels: "Vowels ğŸ€",
      cvcDrag: "CVC Drag Builder ğŸ§©"
    };
    playTitleEl.textContent = titles[currentGame] || "Game ğŸ®";

    if (q.type === "soundToName" || q.type === "vowels"){
      playQEl.textContent = `${q.prompt} (${q.soundLabel})`;
    } else {
      playQEl.textContent = q.prompt;
    }

    playHintEl.textContent = q.hint || "";

    if (q.type === "pictureLabel"){
      pictureBox.style.display = "block";
      pictureEmoji.textContent = q.pictureEmoji;
      pictureCaption.textContent = q.pictureCaption;
    }

    q.choices.forEach(choice=>{
      const c = document.createElement("div");
      c.className = "card";
      c.style.textAlign = "center";
      c.style.cursor = "pointer";
      c.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${choice}</h3><p class="small">Tap!</p>`;
      c.onclick = ()=>checkGame(choice);
      playChoicesEl.appendChild(c);
    });

    renderStars();
  }

  function playGameSound(){
    if (!lastPlayQ && currentGame !== "cvcDrag") {
      showStatus(playStatusEl, "Pick a game first!");
      return;
    }

    if (currentGame === "cvcDrag"){
      if (cvcCurrent) playWord(cvcCurrent.word, playStatusEl);
      else showStatus(playStatusEl, "Press Next to get a word!");
      return;
    }

    if (lastPlayQ.type === "soundToName" || lastPlayQ.type === "vowels"){
      playAudio(soundAudio[lastPlayQ.soundKey], playStatusEl, lastPlayQ.soundLabel);
      return;
    }

    if (lastPlayQ.type === "nameToSound"){
      const L = lastPlayQ.letter;
      playAudio(letterAudio[L], playStatusEl, `Letter ${L}`);
      return;
    }

    // otherwise speak question
    speakFallback(lastPlayQ.prompt);
  }

  function checkGame(choice){
    if (playResultEl.textContent) return;
    if (choice === lastPlayQ.correct){
      playResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      playResultEl.textContent = "Try again ğŸ™‚";
    }
  }

  // =============================
  // CVC Drag Builder
  // =============================
  let cvcCurrent = null;
  let placed = ["","",""];
  let tappingLetter = null;

  function styleSlots(){
    slotEls.forEach((slot, idx)=>{
      // Inline style so it works even if you don't edit styles.css
      slot.style.width = "90px";
      slot.style.height = "90px";
      slot.style.borderRadius = "22px";
      slot.style.display = "flex";
      slot.style.alignItems = "center";
      slot.style.justifyContent = "center";
      slot.style.fontSize = "34px";
      slot.style.fontWeight = "900";
      slot.style.textTransform = "uppercase";
      slot.style.border = "3px dashed rgba(0,0,0,0.12)";
      slot.style.background = "rgba(255,255,255,0.75)";
      slot.style.transition = "transform 0.12s ease";

      slot.addEventListener("dragover", (e)=> e.preventDefault());
      slot.addEventListener("drop", (e)=>{
        e.preventDefault();
        const letter = e.dataTransfer.getData("text/plain") || "";
        if (!letter) return;
        placed[idx] = letter;
        slot.textContent = letter.toUpperCase();
        updateBuilt();
      });

      // Mobile: tap tile then tap slot
      slot.addEventListener("click", ()=>{
        if (!tappingLetter) return;
        placed[idx] = tappingLetter;
        slot.textContent = tappingLetter.toUpperCase();
        tappingLetter = null;
        updateBuilt();
      });
    });
  }

  function updateBuilt(){
    const word = placed.map(x=>x || "_").join("");
    cvcBuiltEl.textContent = word;
  }

  function clearSlots(){
    placed = ["","",""];
    slotEls.forEach(s=> s.textContent = "");
    updateBuilt();
  }

  function makeTile(letter){
    const tile = document.createElement("div");
    tile.className = "card";
    tile.style.width = "90px";
    tile.style.padding = "16px";
    tile.style.textAlign = "center";
    tile.style.cursor = "grab";
    tile.setAttribute("draggable", "true");
    tile.innerHTML = `<div style="font-size:34px; font-weight:900; text-transform:uppercase;">${letter}</div><div class="small">drag</div>`;

    tile.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", letter);
      tile.style.opacity = "0.6";
    });
    tile.addEventListener("dragend", ()=>{
      tile.style.opacity = "1";
    });

    // Tap support
    tile.addEventListener("click", ()=>{
      tappingLetter = letter;
      showStatus(playStatusEl, `Tap a box to place "${letter.toUpperCase()}".`);
    });

    return tile;
  }

  function showDragMode(){
    // hide other modes
    pictureBox.style.display = "none";
    playChoicesEl.style.display = "none";

    cvcDragBox.style.display = "block";
    playTitleEl.textContent = "CVC Drag Builder ğŸ§©";
    playQEl.textContent = "Listen to the word. Drag letters into the boxes to build it!";
    playHintEl.textContent = "Tap ğŸ”Š to hear the word again. Then build it.";
    playResultEl.textContent = "";
  }

  function pickNewCvcPuzzle(){
    const set = cvcDragSets[grade] || cvcDragSets["K"];
    cvcCurrent = set[Math.floor(Math.random() * set.length)];

    // render tiles
    cvcTilesEl.innerHTML = "";
    cvcCurrent.tiles.forEach(l => cvcTilesEl.appendChild(makeTile(l)));

    clearSlots();
    playWord(cvcCurrent.word, playStatusEl);
  }

  function checkCvcPuzzle(){
    if (!cvcCurrent) return;
    const built = placed.join("").toLowerCase();

    if (built === cvcCurrent.word){
      playResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      playResultEl.textContent = "Not yet â€” listen again and try ğŸ™‚";
      playWord(cvcCurrent.word, playStatusEl);
    }
  }

  // =============================
  // Buttons
  // =============================
  document.getElementById("startDiagBtn").addEventListener("click", ()=>{
    diagQs = buildDiagnostic(grade);
    diagIdx = 0;
    diagCorrect = 0;
    lastDiagQ = null;

    setPanels("diag");
    renderDiag();
  });

  document.getElementById("openGamesBtn").addEventListener("click", ()=>{
    setPanels("games");
  });

  document.getElementById("diagSoundBtn").addEventListener("click", playDiagSound);

  document.getElementById("diagNextBtn").addEventListener("click", ()=>{
    if (!diagQs.length) return;

    // if no answer chosen, treat as skipped
    if (!diagResultEl.textContent){
      diagResultEl.textContent = "Skipped ğŸ™‚";
    }

    diagIdx++;
    if (diagIdx >= diagQs.length) finishDiag();
    else renderDiag();
  });

  document.getElementById("diagSkipBtn").addEventListener("click", ()=>{
    if (!diagQs.length) return;
    diagResultEl.textContent = "Skipped ğŸ™‚";
    diagIdx++;
    if (diagIdx >= diagQs.length) finishDiag();
    else renderDiag();
  });

  document.getElementById("diagResetBtn").addEventListener("click", ()=>{
    localStorage.removeItem(DIAG_KEY);
    resetPanelsForGrade();
    renderGrades();
    alert("Diagnostic reset!");
  });

  // choose a game
  document.querySelectorAll("[data-game]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentGame = btn.dataset.game;
      setPanels("play");

      if (currentGame === "cvcDrag"){
        showDragMode();
        pickNewCvcPuzzle();
      } else {
        renderGameQuestion();
      }
    });
  });

  // sound button in play panel
  document.getElementById("playSoundBtn").addEventListener("click", playGameSound);

  // next button behavior
  document.getElementById("playNextBtn").addEventListener("click", ()=>{
    if (currentGame === "cvcDrag"){
      pickNewCvcPuzzle();
    } else {
      renderGameQuestion();
    }
  });

  document.getElementById("backToGamesBtn").addEventListener("click", ()=>{
    setPanels("games");
  });

  document.getElementById("resetStarsBtn").addEventListener("click", ()=>{
    const p = getProgress();
    p.phonicsStars = 0;
    setProgress(p);
    renderStars();
    alert("Phonics stars reset!");
  });

  // CVC drag buttons
  cvcClearBtn.addEventListener("click", clearSlots);
  cvcCheckBtn.addEventListener("click", checkCvcPuzzle);

  // =============================
  // Init
  // =============================
  styleSlots();
  renderGrades();
  renderStars();
  resetPanelsForGrade();
</script>

<!-- Shared dropdown script -->
<script src="./nav.js"></script>

</body>
</html>
