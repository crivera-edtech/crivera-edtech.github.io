<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="login.html">ğŸ§’ Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Pick a grade, take a quick diagnostic, then play games that match your needs.</p>
    <div class="quick-strip">
      <a class="btn secondary" href="progress.html">My Progress</a>
      <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">

    <!-- Top Control Box -->
    <div class="game-box wide">
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>

      <div class="badge-row" style="justify-content:center;">
        <button class="pill active pill-lg" data-grade="K">Kindergarten</button>
        <button class="pill pill-lg" data-grade="1">Grade 1</button>
        <button class="pill pill-lg" data-grade="2">Grade 2</button>
      </div>

      <div class="quick-strip" style="justify-content:center; margin-top:14px;">
        <button class="btn btn-lg" id="startDiagBtn">Start Diagnostic (10)</button>
        <button class="btn secondary btn-lg" id="showGamesBtn" disabled style="opacity:.6;">Choose a Game</button>
        <button class="btn secondary btn-lg" id="resetDiagBtn">Reset</button>
      </div>
    </div>

    <!-- Diagnostic Panel -->
    <div class="game-box wide" id="diagPanel" style="margin-top:16px;">
      <div class="kid-big">Diagnostic âœ…</div>
      <p class="small">10 quick questions: letter names, sounds, and vowels (grade-based).</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div>
            <div class="small" id="diagMeta">Press â€œStart Diagnosticâ€ to begin.</div>
            <div class="kid-big" id="diagQ" style="margin-top:6px;">â€”</div>
          </div>
          <button class="btn secondary" id="diagSoundBtn" title="Read / Play sound" aria-label="Sound">ğŸ”Š</button>
        </div>

        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
        <div class="kid-big" id="diagResult" style="margin-top:12px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
          <button class="btn" id="diagNextBtn" disabled>Next</button>
          <button class="btn secondary" id="diagSkipBtn" disabled>Skip</button>
        </div>
      </div>
    </div>

    <!-- Results + Recommended Path -->
    <div class="game-box wide" id="resultsPanel" style="margin-top:16px; display:none;">
      <div class="kid-big">Your Results ğŸŒ¿</div>
      <div class="game-box" style="margin-top:12px;">
        <div class="kid-big" id="scoreLine">Score: â€”</div>
        <p class="small" id="recLine">Recommended path: â€”</p>

        <div class="grid-3" id="gameLengthGrid" style="margin-top:12px;"></div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="openGamesFromResults">Choose a Game</button>
          <a class="btn secondary" href="progress.html">View Progress</a>
        </div>
      </div>
    </div>

    <!-- Games Panel -->
    <div class="game-box wide" id="gamesPanel" style="margin-top:16px; display:none;">
      <div class="kid-big">Choose a Game ğŸ®</div>
      <p class="small">Games change a little each time so practice stays fun.</p>

      <div class="grid-3" id="gameCards" style="margin-top:12px;"></div>

      <!-- Game Stage -->
      <div class="game-box" id="gameStage" style="margin-top:16px; display:none;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div>
            <div class="small" id="gameMeta">â€”</div>
            <div class="kid-big" id="gameQ">â€”</div>
          </div>
          <button class="btn secondary" id="gameSoundBtn" title="Read / Play sound">ğŸ”Š</button>
        </div>

        <div id="gameUI" style="margin-top:14px;"></div>

        <div class="kid-big" id="gameResult" style="margin-top:12px;"></div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="gameNextBtn">Next</button>
          <button class="btn secondary" id="backToGamesBtn">Back</button>
          <button class="btn secondary" id="resetStarsBtn">Reset Phonics â­</button>
        </div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
/* ============================
   Shared helpers + storage
============================ */
const PROG_KEY = "bloom_progress";
const PHONICS_STATE_KEY = "bloom_phonics_state";
const LAST_ACTIVITY_KEY = "bloom_last_activity";

function load(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function speak(text){
  if (!("speechSynthesis" in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1;
  u.pitch = 1.05;
  speechSynthesis.speak(u);
}

/* ============================
   Progress monitor helpers
============================ */
function ensureProgress(){
  const p = load(PROG_KEY, null);
  if (p && typeof p === "object") return p;

  const fresh = {
    phonicsStars: 0, readingStars: 0, mathStars: 0,
    phonicsPlays: 0, phonicsCorrect: 0, phonicsAttempts: 0,
    phonicsLastGame: null, phonicsDiag: null
  };
  save(PROG_KEY, fresh);
  return fresh;
}

function logActivity(area, details){
  save(LAST_ACTIVITY_KEY, { area, details: details || "", time: Date.now() });
}

function bumpCounter(field, inc=1){
  const p = ensureProgress();
  p[field] = (p[field] || 0) + inc;
  save(PROG_KEY, p);
}

function setField(field, value){
  const p = ensureProgress();
  p[field] = value;
  save(PROG_KEY, p);
}

function addPhonicsStar(){
  const p = ensureProgress();
  p.phonicsStars = (p.phonicsStars || 0) + 1;
  save(PROG_KEY, p);

  // mission counter (optional)
  const ms = load("bloom_daily_mission", null);
  if (ms && typeof ms.phonics === "number"){
    ms.phonics += 1;
    save("bloom_daily_mission", ms);
  }

  logActivity("Phonics", "Earned a star â­");
}

/* ============================
   Grade select
============================ */
let grade = "K";
document.querySelectorAll(".pill[data-grade]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    grade = btn.dataset.grade;
    document.querySelectorAll(".pill[data-grade]").forEach(b=>{
      b.classList.toggle("active", b.dataset.grade === grade);
    });
    // Reset panels for new grade
    setPanels({ diag:true, results:false, games:false });
    resetDiagUI();
    // if saved state matches grade, enable games
    const st = load(PHONICS_STATE_KEY, null);
    setGamesEnabled(!!(st && st.grade === grade && st.finished));
    logActivity("Phonics", "Changed grade to " + (grade === "K" ? "Kindergarten" : "Grade " + grade));
  });
});

/* ============================
   Diagnostic question banks (K-2)
============================ */
const letterNameBank = {
  K: ["A","M","S","T","B","P","R","G","V","D"],
  1: ["B","R","T","G","P","V","C","K","H","F"],
  2: ["G","P","V","J","Q","Y","X","W","N","L"]
};

const soundBank = {
  K: [
    { sound:"/m/ like moon", answer:"M", choices:["M","S","T"] },
    { sound:"/s/ like sun",  answer:"S", choices:["B","S","D"] },
    { sound:"/t/ like top",  answer:"T", choices:["T","A","P"] }
  ],
  1: [
    { sound:"/sh/ like ship", answer:"SH", choices:["CH","SH","TH"] },
    { sound:"/ch/ like chop", answer:"CH", choices:["CH","PH","WH"] },
    { sound:"/th/ like this", answer:"TH", choices:["TH","SH","CH"] }
  ],
  2: [
    { sound:"long A (ai/ay) like rain", answer:"AI", choices:["AI","EE","OA"] },
    { sound:"long E (ee/ea) like feet", answer:"EE", choices:["EE","AI","OA"] },
    { sound:"long O (oa/ow) like boat", answer:"OA", choices:["OA","AI","EE"] }
  ]
};

const vowelBank = {
  K: [
    { q:"Which one is a vowel?", answer:"A", choices:["A","B","T"] },
    { q:"Which one is a vowel?", answer:"E", choices:["E","S","M"] }
  ],
  1: [
    { q:"Which one is a vowel?", answer:"I", choices:["I","R","G"] },
    { q:"Which one is a vowel?", answer:"O", choices:["O","T","K"] }
  ],
  2: [
    { q:"Which one is a vowel?", answer:"U", choices:["U","V","P"] },
    { q:"Which one is a vowel?", answer:"A", choices:["A","J","Q"] }
  ]
};

function buildDiagnostic(grade){
  // 10 questions total: 4 letter names, 4 sounds, 2 vowels
  const names = shuffle(letterNameBank[grade]).slice(0,4).map(L => ({
    type:"name",
    prompt:`What is the NAME of this letter: ${L}?`,
    soundText:`The letter is ${L}.`,
    answer:L,
    choices: shuffle([L, randomDifferentLetter(L), randomDifferentLetter(L)]).slice(0,3)
  }));

  const sounds = shuffle(soundBank[grade]).slice(0,4).map(s => ({
    type:"sound",
    prompt:`Which letter(s) make this sound?`,
    soundText:s.sound,
    answer:s.answer,
    choices: shuffle(s.choices)
  }));

  const vowels = shuffle(vowelBank[grade]).slice(0,2).map(v => ({
    type:"vowel",
    prompt:v.q,
    soundText:v.q,
    answer:v.answer,
    choices: shuffle(v.choices)
  }));

  return shuffle([...names, ...sounds, ...vowels]);
}

function randomDifferentLetter(notThis){
  const all = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  let pick = notThis;
  while (pick === notThis) pick = all[Math.floor(Math.random()*all.length)];
  return pick;
}

/* ============================
   Diagnostic UI logic
============================ */
const startDiagBtn = document.getElementById("startDiagBtn");
const showGamesBtn = document.getElementById("showGamesBtn");
const resetDiagBtn = document.getElementById("resetDiagBtn");

const diagPanel = document.getElementById("diagPanel");
const resultsPanel = document.getElementById("resultsPanel");
const gamesPanel = document.getElementById("gamesPanel");

const diagMeta = document.getElementById("diagMeta");
const diagQ = document.getElementById("diagQ");
const diagChoices = document.getElementById("diagChoices");
const diagResult = document.getElementById("diagResult");
const diagNextBtn = document.getElementById("diagNextBtn");
const diagSkipBtn = document.getElementById("diagSkipBtn");
const diagSoundBtn = document.getElementById("diagSoundBtn");

let diagQs = [];
let diagIndex = 0;
let diagCorrect = 0;
let diagMissedTags = new Set();
let diagAnswered = false;

function setPanels({diag, results, games}){
  diagPanel.style.display = diag ? "block" : "none";
  resultsPanel.style.display = results ? "block" : "none";
  gamesPanel.style.display = games ? "block" : "none";
}

function setGamesEnabled(on){
  showGamesBtn.disabled = !on;
  showGamesBtn.style.opacity = on ? "1" : ".6";
}

function resetDiagUI(){
  diagMeta.textContent = "Press â€œStart Diagnosticâ€ to begin.";
  diagQ.textContent = "â€”";
  diagChoices.innerHTML = "";
  diagResult.textContent = "";
  diagNextBtn.disabled = true;
  diagSkipBtn.disabled = true;
  diagAnswered = false;
}

function renderDiagQ(){
  const q = diagQs[diagIndex];
  diagMeta.textContent = `Question ${diagIndex+1} of ${diagQs.length}`;
  diagQ.textContent = q.prompt;
  diagResult.textContent = "";
  diagAnswered = false;
  diagNextBtn.disabled = true;
  diagSkipBtn.disabled = false;

  diagChoices.innerHTML = "";
  q.choices.forEach(choice=>{
    const c = document.createElement("div");
    c.className = "card";
    c.style.textAlign = "center";
    c.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${choice}</h3><p class="small">Tap!</p>`;
    c.onclick = ()=> chooseDiag(choice);
    diagChoices.appendChild(c);
  });
}

function chooseDiag(choice){
  if (diagAnswered) return;
  diagAnswered = true;
  diagNextBtn.disabled = false;

  const q = diagQs[diagIndex];
  bumpCounter("phonicsAttempts", 1);

  if (choice === q.answer){
    diagCorrect++;
    diagResult.textContent = "Correct! â­";
    bumpCounter("phonicsCorrect", 1);
  } else {
    diagResult.textContent = `Good try! Answer: ${q.answer}`;
    if (q.type === "name") diagMissedTags.add("letterNames");
    if (q.type === "sound") diagMissedTags.add("letterSounds");
    if (q.type === "vowel") diagMissedTags.add("vowels");
  }
}

diagSoundBtn.onclick = ()=>{
  const q = diagQs[diagIndex];
  if (!q) return;
  speak(q.soundText || q.prompt);
};

diagNextBtn.onclick = ()=>{
  if (!diagAnswered){
    const q = diagQs[diagIndex];
    if (q.type === "name") diagMissedTags.add("letterNames");
    if (q.type === "sound") diagMissedTags.add("letterSounds");
    if (q.type === "vowel") diagMissedTags.add("vowels");
  }
  diagIndex++;
  if (diagIndex >= diagQs.length) finishDiagnostic();
  else renderDiagQ();
};

diagSkipBtn.onclick = ()=>{
  const q = diagQs[diagIndex];
  if (q.type === "name") diagMissedTags.add("letterNames");
  if (q.type === "sound") diagMissedTags.add("letterSounds");
  if (q.type === "vowel") diagMissedTags.add("vowels");

  diagIndex++;
  if (diagIndex >= diagQs.length) finishDiagnostic();
  else renderDiagQ();
};

startDiagBtn.onclick = ()=>{
  ensureProgress();
  diagQs = buildDiagnostic(grade);
  diagIndex = 0;
  diagCorrect = 0;
  diagMissedTags = new Set();
  setPanels({diag:true, results:false, games:false});
  diagNextBtn.disabled = true;
  diagSkipBtn.disabled = false;
  renderDiagQ();
  logActivity("Phonics", "Started diagnostic (Grade " + (grade === "K" ? "K" : grade) + ")");
};

resetDiagBtn.onclick = ()=>{
  save(PHONICS_STATE_KEY, null);
  resetDiagUI();
  setPanels({diag:true, results:false, games:false});
  setGamesEnabled(false);

  const p = ensureProgress();
  p.phonicsDiag = null;
  save(PROG_KEY, p);

  logActivity("Phonics", "Reset diagnostic");
};

function finishDiagnostic(){
  const scorePct = Math.round((diagCorrect / diagQs.length) * 100);
  const weaknesses = Array.from(diagMissedTags);

  const state = {
    grade,
    finished:true,
    scorePct,
    weaknesses,
    timestamp: Date.now()
  };
  save(PHONICS_STATE_KEY, state);

  // store diag snapshot in progress
  setField("phonicsDiag", { scorePct, grade, time: Date.now() });

  buildRecommendations(state);
  setPanels({diag:false, results:true, games:false});
  setGamesEnabled(true);

  logActivity("Phonics", "Finished diagnostic: " + scorePct + "%");
}

/* ============================
   Recommendations + game lengths
============================ */
const scoreLine = document.getElementById("scoreLine");
const recLine = document.getElementById("recLine");
const gameLengthGrid = document.getElementById("gameLengthGrid");
document.getElementById("openGamesFromResults").onclick = ()=> {
  setPanels({diag:false, results:false, games:true});
  renderGameCards();
  document.getElementById("gameStage").style.display = "none";
  logActivity("Phonics", "Opened games after results");
};

function buildRecommendations(state){
  scoreLine.textContent = `Score: ${state.scorePct}% (Grade ${state.grade})`;

  const w = state.weaknesses;
  let path = [];

  if (!w.length){
    path = ["Mix Practice", "CVC Builder", "Picture Labeling"];
  } else {
    if (w.includes("letterNames")) path.push("Letter Name Practice");
    if (w.includes("letterSounds")) path.push("Sound Match Practice");
    if (w.includes("vowels")) path.push("Vowel Fun");
    path.push("CVC Builder");
  }

  recLine.textContent = `Recommended path: ${path.join(" â†’ ")}`;

  const cards = [
    { title:"Letter Name â†” Sound Match", length: grade==="K" ? "3â€“5 min" : "4â€“6 min" },
    { title:"Picture Labeling", length: "4â€“6 min" },
    { title:"CVC Builder (Drag & Build)", length: grade==="K" ? "4â€“6 min" : "5â€“8 min" },
    { title:"Tracing (On-Screen)", length: "2â€“4 min" },
    { title:"Typing Sounds", length: "3â€“5 min" },
    { title:"Word Family Train", length: grade==="2" ? "Optional" : "4â€“6 min" },
    { title:"Vowel Team Treasure", length: grade==="2" ? "5â€“8 min" : "Optional" },
    { title:"Mystery Picture Reveal", length: "3â€“6 min" }
  ].filter(x => x.length !== "Optional" || grade==="2");

  gameLengthGrid.innerHTML = cards.slice(0,6).map(c => `
    <div class="card">
      <h3 style="margin-bottom:6px;">${c.title}</h3>
      <p class="small"><strong>Game length:</strong> ${c.length}</p>
    </div>
  `).join("");
}

/* ============================
   Games (grade-appropriate)
============================ */
const showGamesFromTop = showGamesBtn;
showGamesFromTop.onclick = ()=>{
  setPanels({diag:false, results:false, games:true});
  renderGameCards();
  document.getElementById("gameStage").style.display = "none";
  logActivity("Phonics", "Opened games list");
};

function renderGameCards(){
  const st = load(PHONICS_STATE_KEY, null) || { grade, weaknesses:[] };
  const w = new Set(st.weaknesses || []);

  const games = [
    { id:"nameToSound", title:"Letter Name â†’ Sound", emoji:"ğŸ”¤", length: grade==="K" ? "3â€“5 min" : "4â€“6 min", rec: w.has("letterSounds") },
    { id:"soundToName", title:"Sound â†’ Letter", emoji:"ğŸ”Š", length: "4â€“6 min", rec: w.has("letterSounds") },
    { id:"pictureLabel", title:"Picture Labeling", emoji:"ğŸ–¼ï¸", length: "4â€“6 min", rec: true },
    { id:"cvcBuilder", title:"CVC Builder (Drag)", emoji:"ğŸ§±", length: grade==="K" ? "4â€“6 min" : "5â€“8 min", rec: true },
    { id:"tracing", title:"Tracing Game", emoji:"âœï¸", length: "2â€“4 min", rec: w.has("letterNames") || w.has("vowels") },
    { id:"typing", title:"Typing Game", emoji:"âŒ¨ï¸", length: "3â€“5 min", rec: grade!=="K" },
    { id:"mysteryReveal", title:"Mystery Picture Reveal", emoji:"â“", length: "3â€“6 min", rec: true },
    ...(grade==="2" ? [{ id:"vowelTreasure", title:"Vowel Team Treasure", emoji:"ğŸ’", length:"5â€“8 min", rec:true }] : []),
    ...(grade!=="2" ? [{ id:"wordFamilyTrain", title:"Word Family Train", emoji:"ğŸš‚", length:"4â€“6 min", rec:true }] : [])
  ];

  const container = document.getElementById("gameCards");
  container.innerHTML = games.map(g => `
    <div class="card">
      <h3 style="margin-bottom:6px;">${g.emoji} ${g.title}</h3>
      <p class="small"><strong>Length:</strong> ${g.length}</p>
      <p class="small">${g.rec ? "âœ… Recommended" : "Optional"}</p>
      <div class="quick-strip" style="justify-content:flex-start; margin-top:10px;">
        <button class="btn" data-play="${g.id}">Play</button>
      </div>
    </div>
  `).join("");

  container.querySelectorAll("[data-play]").forEach(btn=>{
    btn.onclick = ()=> startGame(btn.dataset.play);
  });
}

/* ============================
   Game engine
============================ */
const gameStage = document.getElementById("gameStage");
const gameMeta = document.getElementById("gameMeta");
const gameQ = document.getElementById("gameQ");
const gameUI = document.getElementById("gameUI");
const gameResult = document.getElementById("gameResult");
const gameSoundBtn = document.getElementById("gameSoundBtn");
const gameNextBtn = document.getElementById("gameNextBtn");
const backToGamesBtn = document.getElementById("backToGamesBtn");
const resetStarsBtn = document.getElementById("resetStarsBtn");

let currentGame = null;
let currentItem = null;

backToGamesBtn.onclick = ()=>{
  gameStage.style.display = "none";
  logActivity("Phonics", "Back to games list");
};

resetStarsBtn.onclick = ()=>{
  const p = ensureProgress();
  p.phonicsStars = 0;
  save(PROG_KEY, p);
  alert("Phonics stars reset!");
  logActivity("Phonics", "Reset phonics stars");
};

gameSoundBtn.onclick = ()=>{
  if (!currentItem) return;
  speak(currentItem.soundText || currentItem.prompt || gameQ.textContent);
};

gameNextBtn.onclick = ()=>{
  if (!currentGame) return;
  playNext();
};

function startGame(id){
  ensureProgress();
  currentGame = id;
  setField("phonicsLastGame", id);
  bumpCounter("phonicsPlays", 1);

  gameStage.style.display = "block";
  gameResult.textContent = "";
  playNext(true);

  logActivity("Phonics", "Started game: " + id);
}

/* ---------- Game content banks ---------- */
const basicLetterSounds = {
  K: [
    { letter:"M", sound:"/m/ like moon" },
    { letter:"S", sound:"/s/ like sun" },
    { letter:"T", sound:"/t/ like top" },
    { letter:"A", sound:"/a/ like apple" },
    { letter:"P", sound:"/p/ like pig" }
  ],
  1: [
    { letter:"SH", sound:"/sh/ like ship" },
    { letter:"CH", sound:"/ch/ like chop" },
    { letter:"TH", sound:"/th/ like this" },
    { letter:"B", sound:"/b/ like ball" },
    { letter:"R", sound:"/r/ like rainbow" }
  ],
  2: [
    { letter:"AI", sound:"long A like rain" },
    { letter:"EE", sound:"long E like feet" },
    { letter:"OA", sound:"long O like boat" },
    { letter:"V", sound:"/v/ like violin" },
    { letter:"G", sound:"/g/ like goat" }
  ]
};

const pictureLabels = {
  K: [
    { pic:"ğŸ±", word:"cat" },
    { pic:"â˜€ï¸", word:"sun" },
    { pic:"ğŸ·", word:"pig" }
  ],
  1: [
    { pic:"ğŸš¢", word:"ship" },
    { pic:"ğŸŸ", word:"chip" },
    { pic:"ğŸ‘‘", word:"king" }
  ],
  2: [
    { pic:"â›µ", word:"boat" },
    { pic:"ğŸ¦¶", word:"feet" },
    { pic:"ğŸŒ§ï¸", word:"rain" }
  ]
};

const cvcWords = {
  K: [
    { word:"cat", letters:["c","a","t"] },
    { word:"sun", letters:["s","u","n"] },
    { word:"map", letters:["m","a","p"] }
  ],
  1: [
    { word:"ship", letters:["sh","i","p"] },
    { word:"chop", letters:["ch","o","p"] },
    { word:"thin", letters:["th","i","n"] }
  ],
  2: [
    { word:"rain", letters:["r","ai","n"] },
    { word:"feet", letters:["f","ee","t"] },
    { word:"boat", letters:["b","oa","t"] }
  ]
};

/* ---------- Game routing ---------- */
function playNext(reset=false){
  gameResult.textContent = "";
  if (reset) currentItem = null;

  if (currentGame === "nameToSound") return renderNameToSound();
  if (currentGame === "soundToName") return renderSoundToName();
  if (currentGame === "pictureLabel") return renderPictureLabel();
  if (currentGame === "cvcBuilder") return renderCvcBuilder();
  if (currentGame === "tracing") return renderTracing();
  if (currentGame === "typing") return renderTyping();
  if (currentGame === "mysteryReveal") return renderMysteryReveal();
  if (currentGame === "wordFamilyTrain") return renderWordFamilyTrain();
  if (currentGame === "vowelTreasure") return renderVowelTreasure();
}

/* ---------- Game renders ---------- */
function renderNameToSound(){
  const item = shuffle(basicLetterSounds[grade])[0];
  currentItem = { prompt:`What sound does ${item.letter} make?`, soundText:`What sound does ${item.letter} make?`, answer:item.sound };

  gameMeta.textContent = "Game: Letter Name â†’ Sound";
  gameQ.textContent = `What sound does ${item.letter} make?`;
  gameUI.innerHTML = "";

  const choices = buildChoices(item.sound, basicLetterSounds[grade].map(x=>x.sound));
  const grid = document.createElement("div");
  grid.className = "grid-3";
  choices.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.textAlign = "center";
    card.innerHTML = `<h3 style="font-size:20px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
    card.onclick = ()=> gradeAnswer(c === item.sound);
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);
}

function renderSoundToName(){
  const item = shuffle(basicLetterSounds[grade])[0];
  currentItem = { prompt:`Which letter(s) make this sound?`, soundText:item.sound, answer:item.letter };

  gameMeta.textContent = "Game: Sound â†’ Letter";
  gameQ.textContent = "Which letter(s) make this sound?";
  gameUI.innerHTML = "";

  const choices = buildChoices(item.letter, basicLetterSounds[grade].map(x=>x.letter));
  const grid = document.createElement("div");
  grid.className = "grid-3";
  choices.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.textAlign = "center";
    card.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
    card.onclick = ()=> gradeAnswer(c === item.letter);
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);

  gameSoundBtn.onclick = ()=> speak(item.sound);
}

function renderPictureLabel(){
  const item = shuffle(pictureLabels[grade])[0];
  const firstLetter = item.word[0].toUpperCase();
  currentItem = { prompt:`Which word matches this picture?`, soundText:`Find the word for ${item.word}.`, answer:item.word };

  gameMeta.textContent = "Game: Picture Labeling";
  gameQ.textContent = `Label the picture: ${item.pic}`;
  gameUI.innerHTML = "";

  const distractors = grade==="K"
    ? ["map","pig","sun","cat","bat"]
    : grade==="1"
      ? ["ship","chip","shop","chop","thin","this"]
      : ["rain","feet","boat","goat","meet","coat"];

  const choices = buildChoices(item.word, distractors);
  const grid = document.createElement("div");
  grid.className = "grid-3";
  choices.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.textAlign = "center";
    card.innerHTML = `<h3 style="font-size:24px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
    card.onclick = ()=> gradeAnswer(c === item.word);
    grid.appendChild(card);
  });

  const note = document.createElement("p");
  note.className = "small";
  note.style.marginTop = "10px";
  note.textContent = `Hint: It starts with "${firstLetter}".`;

  gameUI.appendChild(grid);
  gameUI.appendChild(note);
}

function renderCvcBuilder(){
  const item = shuffle(cvcWords[grade])[0];
  currentItem = { prompt:`Build the word: ${item.word}`, soundText:`Build the word ${item.word}.`, answer:item.word };

  gameMeta.textContent = "Game: CVC Builder (Drag)";
  gameQ.textContent = `Build: "${item.word}"`;
  gameUI.innerHTML = "";

  const bank = shuffle([ ...item.letters, ...extraLettersForGrade() ]).slice(0, 7);

  const slots = document.createElement("div");
  slots.style.display = "flex";
  slots.style.gap = "12px";
  slots.style.flexWrap = "wrap";
  slots.style.marginBottom = "12px";

  const slotEls = [];
  item.letters.forEach((_, i)=>{
    const s = document.createElement("div");
    s.className = "card";
    s.style.minWidth = "90px";
    s.style.textAlign = "center";
    s.style.padding = "18px";
    s.innerHTML = `<div class="small">Box ${i+1}</div><div class="kid-big" data-slot="${i}" style="margin-top:6px;">_</div>`;
    s.ondragover = (e)=> e.preventDefault();
    s.ondrop = (e)=>{
      e.preventDefault();
      const val = e.dataTransfer.getData("text/plain");
      s.querySelector("[data-slot]").textContent = val;
      checkBuilt();
    };
    slotEls.push(s);
    slots.appendChild(s);
  });

  const tiles = document.createElement("div");
  tiles.className = "badge-row";
  tiles.style.justifyContent = "flex-start";
  tiles.style.marginTop = "8px";

  bank.forEach(ch=>{
    const t = document.createElement("div");
    t.className = "pill";
    t.style.cursor = "grab";
    t.style.userSelect = "none";
    t.textContent = ch;
    t.draggable = true;
    t.ondragstart = (e)=> e.dataTransfer.setData("text/plain", ch);
    tiles.appendChild(t);
  });

  const actions = document.createElement("div");
  actions.className = "quick-strip";
  actions.style.justifyContent = "flex-start";
  actions.style.marginTop = "12px";
  actions.innerHTML = `
    <button class="btn secondary" id="clearBuild">Clear</button>
    <button class="btn secondary" id="hearWord">ğŸ”Š Hear Word</button>
  `;

  gameUI.appendChild(slots);
  gameUI.appendChild(tiles);
  gameUI.appendChild(actions);

  document.getElementById("clearBuild").onclick = ()=>{
    slotEls.forEach(s=> s.querySelector("[data-slot]").textContent = "_");
    gameResult.textContent = "";
  };
  document.getElementById("hearWord").onclick = ()=> speak(item.word);

  function checkBuilt(){
    const built = slotEls.map(s=> s.querySelector("[data-slot]").textContent).join("");
    if (built.includes("_")) return;

    bumpCounter("phonicsAttempts", 1);

    if (built.toLowerCase() === item.word.toLowerCase()){
      gradeAnswer(true);
    } else {
      gameResult.textContent = "Almost! Try again ğŸ™‚";
      speak("Try again.");
    }
  }
}

function renderTracing(){
  const letters = grade==="K" ? ["A","M","S","T"] : grade==="1" ? ["B","R","SH","CH"] : ["AI","EE","OA","G"];
  const L = shuffle(letters)[0];

  currentItem = { prompt:`Trace: ${L}`, soundText:`Trace ${L}.`, answer:L };
  gameMeta.textContent = "Game: Tracing";
  gameQ.textContent = `Trace: ${L}`;
  gameUI.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.className = "game-box";
  wrap.innerHTML = `
    <p class="small">Use your mouse/finger to trace. Then tap â€œDoneâ€ to earn a star.</p>
    <canvas id="traceCanvas" width="760" height="240" style="width:100%; max-width:760px; border-radius:18px; border:2px solid rgba(0,0,0,0.08); background:#fff;"></canvas>
    <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
      <button class="btn" id="traceDone">Done</button>
      <button class="btn secondary" id="traceClear">Clear</button>
      <button class="btn secondary" id="traceHear">ğŸ”Š Hear</button>
    </div>
  `;
  gameUI.appendChild(wrap);

  const c = document.getElementById("traceCanvas");
  const ctx = c.getContext("2d");
  ctx.lineWidth = 8;
  ctx.lineCap = "round";

  ctx.save();
  ctx.globalAlpha = 0.12;
  ctx.font = "160px 'Baloo 2', cursive";
  ctx.fillText(L, 30, 170);
  ctx.restore();

  let drawing = false;
  function pos(e){
    const r = c.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    return {x, y};
  }
  function start(e){ drawing = true; const p = pos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
  function move(e){
    if (!drawing) return;
    e.preventDefault();
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }
  function end(){ drawing = false; }

  c.addEventListener("mousedown", start);
  c.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);
  c.addEventListener("touchstart", start, {passive:false});
  c.addEventListener("touchmove", move, {passive:false});
  window.addEventListener("touchend", end);

  document.getElementById("traceClear").onclick = ()=> location.reload();
  document.getElementById("traceHear").onclick = ()=> speak(`Trace ${L}`);
  document.getElementById("traceDone").onclick = ()=> {
    bumpCounter("phonicsAttempts", 1);
    bumpCounter("phonicsCorrect", 1);
    gradeAnswer(true);
  };
}

function renderTyping(){
  const item = shuffle(basicLetterSounds[grade])[0];
  currentItem = { prompt:`Type the letters for this sound.`, soundText:item.sound, answer:item.letter };

  gameMeta.textContent = "Game: Typing Sounds";
  gameQ.textContent = "Listen, then type the answer:";
  gameUI.innerHTML = "";

  const box = document.createElement("div");
  box.className = "game-box";
  box.innerHTML = `
    <div class="kid-big" style="margin-bottom:8px;">${item.sound}</div>
    <input id="typeInput" placeholder="Type here..." style="width:min(420px,100%); padding:14px 16px; border-radius:999px; border:2px solid rgba(0,0,0,0.12); font-family:inherit; font-size:18px;">
    <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
      <button class="btn" id="checkTypeBtn">Check</button>
      <button class="btn secondary" id="hearTypeBtn">ğŸ”Š Hear Sound</button>
    </div>
    <p class="small">Examples: M, SH, AI</p>
  `;
  gameUI.appendChild(box);

  document.getElementById("hearTypeBtn").onclick = ()=> speak(item.sound);
  document.getElementById("checkTypeBtn").onclick = ()=>{
    const v = (document.getElementById("typeInput").value || "").trim().toUpperCase();
    bumpCounter("phonicsAttempts", 1);
    if (v === item.letter) bumpCounter("phonicsCorrect", 1);
    gradeAnswer(v === item.letter);
  };
}

function renderMysteryReveal(){
  const item = shuffle(pictureLabels[grade])[0];
  const target = item.word.toUpperCase();

  gameMeta.textContent = "Game: Mystery Picture Reveal";
  gameQ.textContent = "Get 3 correct answers to reveal the picture!";
  gameUI.innerHTML = "";

  let revealed = 0;

  const revealBox = document.createElement("div");
  revealBox.className = "game-box";
  revealBox.innerHTML = `
    <div class="kid-big" id="revealPic" style="font-size:64px;">â“</div>
    <p class="small" id="revealMsg">Correct answers: 0 / 3</p>
  `;

  const round = document.createElement("div");
  round.style.marginTop = "12px";

  const playRound = ()=>{
    const q = shuffle(basicLetterSounds[grade])[0];
    const choices = buildChoices(q.letter, basicLetterSounds[grade].map(x=>x.letter));
    currentItem = { prompt:"Which letter(s)?", soundText:q.sound, answer:q.letter };

    const grid = document.createElement("div");
    grid.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=>{
        bumpCounter("phonicsAttempts", 1);

        if (c === q.letter){
          bumpCounter("phonicsCorrect", 1);
          addPhonicsStar();
          revealed++;
          document.getElementById("revealMsg").textContent = `Correct answers: ${revealed} / 3`;
          if (revealed >= 3){
            document.getElementById("revealPic").textContent = item.pic;
            document.getElementById("revealMsg").textContent = `Itâ€™s ${target}! ğŸ‰`;
            speak(`Great job! It's ${item.word}.`);
            logActivity("Phonics", "Revealed mystery picture ğŸ‰");
          } else {
            speak("Correct!");
            playRound();
          }
        } else {
          speak("Try again.");
        }
      };
      grid.appendChild(card);
    });

    round.innerHTML = "";
    round.appendChild(grid);
  };

  const soundBtn = document.createElement("button");
  soundBtn.className = "btn secondary";
  soundBtn.textContent = "ğŸ”Š Hear Sound";
  soundBtn.onclick = ()=> speak(currentItem?.soundText || "Listen!");

  gameUI.appendChild(revealBox);
  gameUI.appendChild(soundBtn);
  gameUI.appendChild(round);

  playRound();
}

function renderWordFamilyTrain(){
  const families = ["-at","-an","-op","-it","-ug"];
  const family = shuffle(families)[0];

  const word = (family === "-at") ? "cat" :
               (family === "-an") ? "pan" :
               (family === "-op") ? "hop" :
               (family === "-it") ? "sit" : "bug";

  currentItem = { prompt:`Which word is in the ${family} family?`, soundText:`Which word is in the ${family} family?`, answer:word };

  gameMeta.textContent = "Game: Word Family Train ğŸš‚";
  gameQ.textContent = `Pick the word in the ${family} family`;
  gameUI.innerHTML = "";

  const choices = buildChoices(word, ["map","sun","dog","hat","pin","cup","top","van","rug","lip"]);
  const grid = document.createElement("div");
  grid.className = "grid-3";
  choices.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.textAlign = "center";
    card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
    card.onclick = ()=>{
      bumpCounter("phonicsAttempts", 1);
      if (c === word) bumpCounter("phonicsCorrect", 1);
      gradeAnswer(c === word);
    };
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);
}

function renderVowelTreasure(){
  const items = [
    { word:"rain", team:"AI" },
    { word:"feet", team:"EE" },
    { word:"boat", team:"OA" }
  ];
  const it = shuffle(items)[0];

  currentItem = { prompt:`Which vowel team is in "${it.word}"?`, soundText:`Which vowel team is in ${it.word}?`, answer:it.team };

  gameMeta.textContent = "Game: Vowel Team Treasure ğŸ’";
  gameQ.textContent = `Which vowel team is in "${it.word}"?`;
  gameUI.innerHTML = "";

  const choices = buildChoices(it.team, ["AI","EE","OA"]);
  const grid = document.createElement("div");
  grid.className = "grid-3";
  choices.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.textAlign = "center";
    card.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
    card.onclick = ()=>{
      bumpCounter("phonicsAttempts", 1);
      if (c === it.team) bumpCounter("phonicsCorrect", 1);
      gradeAnswer(c === it.team);
    };
    grid.appendChild(card);
  });
  gameUI.appendChild(grid);
}

/* ---------- scoring for games ---------- */
function gradeAnswer(correct){
  bumpCounter("phonicsAttempts", 0); // no-op but ensures progress exists

  if (correct){
    gameResult.textContent = "Correct! â­";
    bumpCounter("phonicsCorrect", 1);
    addPhonicsStar();
    speak("Correct!");
  } else {
    gameResult.textContent = "Try again ğŸ™‚";
    speak("Try again.");
  }
}

/* ---------- utilities ---------- */
function buildChoices(correct, pool){
  const candidates = shuffle(pool.filter(x=>x!==correct)).slice(0,2);
  return shuffle([correct, ...candidates]);
}
function extraLettersForGrade(){
  if (grade==="K") return ["b","t","s","m","p","a","i","o","u","n"];
  if (grade==="1") return ["sh","ch","th","b","r","t","a","i","o","u","n"];
  return ["ai","ee","oa","r","f","b","t","n"];
}

/* ============================
   Init
============================ */
(function init(){
  ensureProgress();

  const st = load(PHONICS_STATE_KEY, null);
  if (st && st.grade === grade && st.finished){
    setGamesEnabled(true);
    buildRecommendations(st);
    setPanels({diag:false, results:true, games:false});
  } else {
    setGamesEnabled(false);
    resetDiagUI();
    setPanels({diag:true, results:false, games:false});
  }
})();
</script>

</body>
</html>
