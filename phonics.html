<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Pick your grade, take a 10-question diagnostic, then choose a game to practice!</p>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Start Here ğŸŒŸ</h2>

    <div class="game-box wide">

      <!-- Grade row (same size as action row) -->
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>
      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn secondary grade-btn active" data-grade="K" type="button">Kindergarten</button>
        <button class="btn secondary grade-btn" data-grade="1" type="button">Grade 1</button>
        <button class="btn secondary grade-btn" data-grade="2" type="button">Grade 2</button>
      </div>

      <!-- Actions row -->
      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn" id="startDiagBtn" type="button">Start Diagnostic</button>
        <button class="btn secondary" id="recommendedBtn" type="button" disabled>Recommended Path</button>
        <button class="btn secondary" id="chooseGameBtn" type="button" disabled>Choose a Game</button>
        <a class="btn secondary" href="progress.html">My Progress</a>
      </div>

      <!-- Game length selector -->
      <div class="game-box" style="margin-top:14px;">
        <div class="small" style="text-align:center; margin-bottom:10px;">Game Length</div>
        <div class="quick-strip" style="justify-content:center;">
          <button class="btn secondary len-btn active" data-len="5" type="button">5 Rounds</button>
          <button class="btn secondary len-btn" data-len="10" type="button">10 Rounds</button>
          <button class="btn secondary len-btn" data-len="endless" type="button">Endless</button>
        </div>
        <div class="hero-note" style="text-align:center; margin-top:10px;">
          Tip: Your grade + game length are saved on this device.
        </div>
      </div>

      <!-- Diagnostic Panel -->
      <div id="diagPanel" class="game-box" style="margin-top:16px; display:none;">
        <div class="kid-big">Diagnostic âœ…</div>
        <p class="small" id="diagSub">Answer 10 questions. Weâ€™ll recommend what to practice next.</p>

        <div class="game-box" style="margin-top:12px;">
          <div class="small" id="diagProgressText">Question 1 of 10</div>
          <div class="kid-big" id="diagQuestion" style="margin-top:6px;">Press â€œStart Diagnosticâ€.</div>
          <div class="small" id="diagHint" style="margin-top:6px;"></div>

          <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>

          <div class="quick-strip" style="justify-content:center; margin-top:12px;">
            <button class="btn secondary" id="diagNextBtn" type="button" disabled>Next</button>
            <button class="btn secondary" id="diagRestartBtn" type="button">Restart</button>
          </div>

          <div class="kid-big" id="diagFeedback" style="margin-top:12px;"></div>
        </div>
      </div>

      <!-- Results Panel -->
      <div id="resultsPanel" class="game-box" style="margin-top:16px; display:none;">
        <div class="kid-big">Results ğŸŒ¿</div>
        <p class="small" id="resultsSummary">Nice work!</p>

        <div class="grid-3" style="margin-top:12px;">
          <div class="card" style="text-align:center;">
            <h3 style="font-size:22px; margin-bottom:6px;">Score</h3>
            <div class="kid-big" id="scoreBox">0 / 10</div>
          </div>
          <div class="card" style="text-align:center;">
            <h3 style="font-size:22px; margin-bottom:6px;">Needs Practice</h3>
            <div class="small" id="needsBox">â€”</div>
          </div>
          <div class="card" style="text-align:center;">
            <h3 style="font-size:22px; margin-bottom:6px;">Recommended Next</h3>
            <div class="small" id="readyBox">â€”</div>
          </div>
        </div>

        <div class="quick-strip" style="justify-content:center; margin-top:14px;">
          <button class="btn" id="goRecommendedBtn" type="button">Start Recommended Path</button>
          <button class="btn secondary" id="goChooseGameBtn" type="button">Choose a Game</button>
          <button class="btn secondary" id="retakeBtn" type="button">Retake Diagnostic</button>
        </div>
      </div>

      <!-- Game Hub -->
      <div id="gameHub" class="game-box" style="margin-top:16px; display:none;">
        <div class="kid-big">Pick a Game ğŸ®</div>
        <p class="small">Choose what you want to practice next. (Games change by grade!)</p>

        <div class="grid-3" style="margin-top:12px;">
          <div class="card pick" data-game="names">
            <h3>ğŸ”  Letter Names</h3><p class="small">Tap the correct letter name.</p>
            <div class="small tag" id="tagNames"></div>
          </div>

          <div class="card pick" data-game="sounds">
            <h3>ğŸ”Š Letter Sounds</h3><p class="small">Pick the letter/letters that match the sound.</p>
            <div class="small tag" id="tagSounds"></div>
          </div>

          <div class="card pick" data-game="pictures">
            <h3>ğŸ–¼ï¸ Picture Labeling</h3><p class="small">Match picture + beginning sound.</p>
            <div class="small tag" id="tagPictures"></div>
          </div>

          <div class="card pick" data-game="build">
            <h3>ğŸ§± Word Builder</h3><p class="small">Drag tiles into boxes to build the word.</p>
            <div class="small tag" id="tagBuild"></div>
          </div>

          <div class="card pick" data-game="families">
            <h3>ğŸš‚ Word Family Train</h3><p class="small">Sort words into the right family.</p>
            <div class="small tag" id="tagFamilies"></div>
          </div>

          <div class="card pick" data-game="treasure">
            <h3>ğŸ—ºï¸ Vowel Team Treasure</h3><p class="small">Choose the vowel team to open treasure!</p>
            <div class="small tag" id="tagTreasure"></div>
          </div>

          <div class="card pick" data-game="mystery">
            <h3>ğŸ•µï¸ Mystery Reveal</h3><p class="small">Correct answers reveal a picture!</p>
            <div class="small tag" id="tagMystery"></div>
          </div>

          <div class="card pick" data-game="trace">
            <h3>âœï¸ Tracing Game</h3><p class="small">Trace letters in a big friendly box.</p>
            <div class="small tag" id="tagTrace"></div>
          </div>

          <div class="card pick" data-game="type">
            <h3>âŒ¨ï¸ Typing Game</h3><p class="small">Type letters/words that match the prompt.</p>
            <div class="small tag" id="tagType"></div>
          </div>
        </div>

        <div class="hero-note" style="text-align:center; margin-top:12px;">
          Earn â­ for correct answers. Your stars save on this device.
        </div>
      </div>

      <!-- Game Stage -->
      <div id="gameStage" class="game-box" style="margin-top:16px; display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <div class="kid-big" id="gameTitle">Game</div>
            <div class="small" id="gameDesc"></div>
          </div>
          <div class="quick-strip" style="justify-content:flex-end;">
            <button class="btn secondary" id="backToHubBtn" type="button">â† Back</button>
            <button class="btn secondary" id="newRoundBtn" type="button">New Round</button>
          </div>
        </div>

        <div class="game-box" style="margin-top:12px;">
          <div class="small" id="roundText">Round 1</div>
          <div class="kid-big" id="promptText" style="margin-top:6px;">Prompt</div>
          <div class="small" id="promptHint" style="margin-top:6px;"></div>

          <div id="stageBody" style="margin-top:14px;"></div>

          <div class="kid-big" id="stageFeedback" style="margin-top:12px;"></div>
          <div class="small" id="starsText" style="margin-top:6px;"></div>
        </div>
      </div>

    </div>
  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
  // -----------------------------
  // Storage Keys
  // -----------------------------
  const PREF_GRADE_KEY = "bloom_pref_grade";
  const PREF_LEN_KEY   = "bloom_pref_game_len";
  const PHONICS_DIAG_KEY = "bloom_phonics_diag_v4";
  const PROG_KEY = "bloom_progress";

  // -----------------------------
  // Helpers
  // -----------------------------
  function load(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function addPhonicsStar(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    save(PROG_KEY, p);
    return p.phonicsStars;
  }
  function getPhonicsStars(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    return (p.phonicsStars || 0);
  }

  // -----------------------------
  // UI refs
  // -----------------------------
  const startDiagBtn = document.getElementById("startDiagBtn");
  const chooseGameBtn = document.getElementById("chooseGameBtn");
  const recommendedBtn = document.getElementById("recommendedBtn");

  const diagPanel = document.getElementById("diagPanel");
  const resultsPanel = document.getElementById("resultsPanel");
  const gameHub = document.getElementById("gameHub");
  const gameStage = document.getElementById("gameStage");

  const diagQuestion = document.getElementById("diagQuestion");
  const diagHint = document.getElementById("diagHint");
  const diagChoices = document.getElementById("diagChoices");
  const diagProgressText = document.getElementById("diagProgressText");
  const diagNextBtn = document.getElementById("diagNextBtn");
  const diagRestartBtn = document.getElementById("diagRestartBtn");
  const diagFeedback = document.getElementById("diagFeedback");

  const scoreBox = document.getElementById("scoreBox");
  const needsBox = document.getElementById("needsBox");
  const readyBox = document.getElementById("readyBox");
  const resultsSummary = document.getElementById("resultsSummary");
  const goChooseGameBtn = document.getElementById("goChooseGameBtn");
  const goRecommendedBtn = document.getElementById("goRecommendedBtn");
  const retakeBtn = document.getElementById("retakeBtn");

  const tagNames = document.getElementById("tagNames");
  const tagSounds = document.getElementById("tagSounds");
  const tagPictures = document.getElementById("tagPictures");
  const tagBuild = document.getElementById("tagBuild");
  const tagFamilies = document.getElementById("tagFamilies");
  const tagTreasure = document.getElementById("tagTreasure");
  const tagMystery = document.getElementById("tagMystery");
  const tagTrace = document.getElementById("tagTrace");
  const tagType = document.getElementById("tagType");

  const gameTitle = document.getElementById("gameTitle");
  const gameDesc = document.getElementById("gameDesc");
  const roundText = document.getElementById("roundText");
  const promptText = document.getElementById("promptText");
  const promptHint = document.getElementById("promptHint");
  const stageBody = document.getElementById("stageBody");
  const stageFeedback = document.getElementById("stageFeedback");
  const starsText = document.getElementById("starsText");

  const backToHubBtn = document.getElementById("backToHubBtn");
  const newRoundBtn = document.getElementById("newRoundBtn");

  function showOnly(panel){
    diagPanel.style.display = "none";
    resultsPanel.style.display = "none";
    gameHub.style.display = "none";
    gameStage.style.display = "none";
    panel.style.display = "block";
  }

  // -----------------------------
  // Grade selection
  // -----------------------------
  let grade = localStorage.getItem(PREF_GRADE_KEY) || "K";
  const gradeBtns = Array.from(document.querySelectorAll(".grade-btn"));
  function setGrade(g){
    grade = g;
    localStorage.setItem(PREF_GRADE_KEY, g);
    gradeBtns.forEach(b => b.classList.toggle("active", b.dataset.grade === grade));
    hydrateButtons();
    if (gameHub.style.display !== "none") renderGameTags(readSavedDiag());
  }
  gradeBtns.forEach(btn=> btn.addEventListener("click", ()=> setGrade(btn.dataset.grade)));

  // -----------------------------
  // Game length selection
  // -----------------------------
  let gameLen = localStorage.getItem(PREF_LEN_KEY) || "5"; // "5" | "10" | "endless"
  const lenBtns = Array.from(document.querySelectorAll(".len-btn"));
  function setGameLen(v){
    gameLen = v;
    localStorage.setItem(PREF_LEN_KEY, v);
    lenBtns.forEach(b => b.classList.toggle("active", b.dataset.len === gameLen));
  }
  lenBtns.forEach(btn=> btn.addEventListener("click", ()=> setGameLen(btn.dataset.len)));
  setGameLen(gameLen);

  // -----------------------------
  // Diagnostic Banks
  // -----------------------------
  const diagBanks = {
    K: [
      { skill:"names",  q:"Which letter is: A?", choices:["A","B","D"], correctIndex:0, hint:"Look for the first letter." },
      { skill:"names",  q:"Which letter is: M?", choices:["N","M","W"], correctIndex:1, hint:"M has two mountains." },
      { skill:"names",  q:"Which letter is: S?", choices:["S","C","G"], correctIndex:0, hint:"S looks like a snake." },
      { skill:"names",  q:"Which letter is: T?", choices:["T","F","E"], correctIndex:0, hint:"T has a top line." },

      { skill:"sounds", q:"Which letter makes the /m/ sound?", choices:["M","S","T"], correctIndex:0, hint:"/m/ like moon." },
      { skill:"sounds", q:"Which letter makes the /s/ sound?", choices:["B","S","D"], correctIndex:1, hint:"/s/ like sun." },
      { skill:"sounds", q:"Which letter makes the /t/ sound?", choices:["T","A","P"], correctIndex:0, hint:"/t/ like top." },
      { skill:"sounds", q:"Which letter makes the /p/ sound?", choices:["P","V","B"], correctIndex:0, hint:"/p/ like pop!" },

      { skill:"vowels", q:"Which one is a vowel?", choices:["A","T","M"], correctIndex:0, hint:"Vowels: A E I O U." },
      { skill:"vowels", q:"Which one is a vowel?", choices:["E","S","R"], correctIndex:0, hint:"Vowels: A E I O U." },
      { skill:"vowels", q:"Which one is a vowel?", choices:["I","B","D"], correctIndex:0, hint:"Vowels: A E I O U." },
      { skill:"sounds", q:"Which letter makes /g/?", choices:["G","J","Q"], correctIndex:0, hint:"/g/ like go." }
    ],
    1: [
      { skill:"names",  q:"Which letter is: B?", choices:["B","D","P"], correctIndex:0, hint:"B has two bumps." },
      { skill:"names",  q:"Which letter is: R?", choices:["R","K","H"], correctIndex:0, hint:"R has a leg." },
      { skill:"names",  q:"Which letter is: V?", choices:["V","W","Y"], correctIndex:0, hint:"V is pointy." },
      { skill:"names",  q:"Which letter is: G?", choices:["G","J","Q"], correctIndex:0, hint:"G is like C with a hook." },

      { skill:"sounds", q:"Which letter makes /b/?", choices:["D","B","P"], correctIndex:1, hint:"/b/ like ball." },
      { skill:"sounds", q:"Which letter makes /r/?", choices:["R","L","H"], correctIndex:0, hint:"/r/ like rabbit." },
      { skill:"sounds", q:"Which begins with /sh/?", choices:["ship","cat","top"], correctIndex:0, hint:"/sh/ is quiet." },
      { skill:"sounds", q:"Which begins with /ch/?", choices:["rain","chop","sun"], correctIndex:1, hint:"/ch/ like choo-choo." },
      { skill:"sounds", q:"Which begins with /th/?", choices:["this","ship","chip"], correctIndex:0, hint:"/th/ like this." },

      { skill:"vowels", q:"Which is the SHORT vowel sound in â€œcatâ€?", choices:["Äƒ","Ä","Ä“"], correctIndex:0, hint:"cat has short a." },
      { skill:"vowels", q:"Which is the SHORT vowel sound in â€œpinâ€?", choices:["Ä«","Ä­","Å"], correctIndex:1, hint:"pin has short i." },
      { skill:"vowels", q:"Which is the SHORT vowel sound in â€œhotâ€?", choices:["Å","Å«","Ä“"], correctIndex:0, hint:"hot has short o." }
    ],
    2: [
      { skill:"names",  q:"Which letter is: P?", choices:["P","R","B"], correctIndex:0, hint:"P has one bump." },
      { skill:"names",  q:"Which letter is: J?", choices:["J","I","L"], correctIndex:0, hint:"J has a hook." },
      { skill:"names",  q:"Which letter is: Q?", choices:["Q","O","G"], correctIndex:0, hint:"Q has a tail." },

      { skill:"vowels", q:"Which word has a LONG A sound?", choices:["rain","cat","hat"], correctIndex:0, hint:"ai can make long a." },
      { skill:"vowels", q:"Which word has a LONG E sound?", choices:["feet","pet","pen"], correctIndex:0, hint:"ee can make long e." },
      { skill:"vowels", q:"Which word has a LONG O sound?", choices:["boat","hot","hop"], correctIndex:0, hint:"oa can make long o." },

      { skill:"sounds", q:"Which team can make LONG A?", choices:["ai","ee","oa"], correctIndex:0, hint:"ai like rain." },
      { skill:"sounds", q:"Which team can make LONG E?", choices:["ee","ai","oa"], correctIndex:0, hint:"ee like feet." },
      { skill:"sounds", q:"Which team can make LONG O?", choices:["oa","ee","ai"], correctIndex:0, hint:"oa like boat." },

      { skill:"sounds", q:"Which starts with /v/?", choices:["van","sun","map"], correctIndex:0, hint:"/v/ like van." },
      { skill:"vowels", q:"Pick the word with a vowel team:", choices:["ship","rain","cat"], correctIndex:1, hint:"rain has ai." },
      { skill:"sounds", q:"Which ends with /-ck/?", choices:["duck","dune","duty"], correctIndex:0, hint:"duck ends with -ck." }
    ]
  };

  function getTenDiagQuestions(g){
    const pool = (diagBanks[g] || diagBanks.K).slice();
    return shuffle(pool).slice(0, 10);
  }

  // -----------------------------
  // Diagnostic state
  // -----------------------------
  let diagQs = [];
  let diagIndex = 0;
  let diagCorrect = 0;
  let diagAnswered = false;
  let diagMiss = { names:0, sounds:0, vowels:0 };

  function renderDiagQuestion(){
    diagAnswered = false;
    diagFeedback.textContent = "";
    diagNextBtn.disabled = true;

    const q = diagQs[diagIndex];
    diagProgressText.textContent = `Question ${diagIndex + 1} of 10`;
    diagQuestion.textContent = q.q;
    diagHint.textContent = q.hint || "";

    diagChoices.innerHTML = "";
    q.choices.forEach((c, idx)=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:24px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.addEventListener("click", ()=> pickDiagAnswer(idx));
      diagChoices.appendChild(card);
    });
  }

  function pickDiagAnswer(choiceIndex){
    if (diagAnswered) return;
    diagAnswered = true;

    const q = diagQs[diagIndex];
    const correct = (choiceIndex === q.correctIndex);

    if (correct){
      diagCorrect++;
      diagFeedback.textContent = "Correct! â­";
    } else {
      diagFeedback.textContent = `Good try! âœ… Answer: ${q.choices[q.correctIndex]}`;
      if (q.skill in diagMiss) diagMiss[q.skill] += 1;
    }

    Array.from(diagChoices.children).forEach((card, idx)=>{
      card.style.opacity = "0.9";
      if (idx === q.correctIndex) card.style.outline = "3px solid rgba(46, 125, 80, .35)";
      if (idx === choiceIndex && idx !== q.correctIndex) card.style.outline = "3px solid rgba(180, 60, 60, .22)";
    });

    diagNextBtn.disabled = false;
  }

  function saveDiag(result){ save(PHONICS_DIAG_KEY, result); }
  function readSavedDiag(){ return load(PHONICS_DIAG_KEY, null); }

  function finishDiagnostic(){
    const score = diagCorrect;
    const total = 10;

    const misses = [
      { label:"Letter Names", key:"names", n:diagMiss.names },
      { label:"Letter Sounds", key:"sounds", n:diagMiss.sounds },
      { label:"Vowels", key:"vowels", n:diagMiss.vowels }
    ].sort((a,b)=> b.n - a.n);

    const needs = misses[0].n === 0 ? "Nothing big â€” youâ€™re doing great!" : misses.filter(x=>x.n>0).map(x=>x.label).slice(0,2).join(", ");
    const next = recommendGameKey({ misses: diagMiss, grade });

    const result = { date: Date.now(), grade, score, total, misses: { ...diagMiss }, recommended: next };
    saveDiag(result);

    scoreBox.textContent = `${score} / ${total}`;
    needsBox.textContent = needs;
    readyBox.textContent = humanGameName(next);
    resultsSummary.textContent = `You scored ${Math.round((score/total)*100)}% for Grade ${grade === "K" ? "K" : grade}!`;

    renderGameTags(result);
    hydrateButtons();
    showOnly(resultsPanel);
  }

  // -----------------------------
  // Recommendations
  // -----------------------------
  function recommendGameKey(saved){
    const miss = saved?.misses || { names:0, sounds:0, vowels:0 };
    // choose biggest need; if tie, pick more engaging
    const max = Math.max(miss.names||0, miss.sounds||0, miss.vowels||0);
    if (max === 0) return "mystery";
    if (miss.sounds === max) return "pictures"; // sound practice through meaning
    if (miss.names === max) return "names";
    return "treasure"; // vowels / teams
  }

  function humanGameName(key){
    const map = {
      names: "Letter Names",
      sounds: "Letter Sounds",
      pictures: "Picture Labeling",
      build: "Word Builder",
      families: "Word Family Train",
      treasure: "Vowel Team Treasure",
      mystery: "Mystery Reveal",
      trace: "Tracing Game",
      type: "Typing Game"
    };
    return map[key] || "Mystery Reveal";
  }

  // -----------------------------
  // Game tags
  // -----------------------------
  function renderGameTags(saved){
    const s = saved || readSavedDiag();
    const miss = s?.misses || { names:0, sounds:0, vowels:0 };

    function tagFor(skillKey){
      const n = miss[skillKey] || 0;
      return n ? `Recommended â­ (missed ${n})` : `Ready âœ…`;
    }

    tagNames.textContent = tagFor("names");
    tagSounds.textContent = tagFor("sounds");
    tagTreasure.textContent = tagFor("vowels");

    tagPictures.textContent = (miss.sounds || miss.names) ? "Recommended â­" : "Great practice âœ…";
    tagBuild.textContent = (grade === "2") ? "Spelling boost âœ…" : "CVC practice âœ…";
    tagFamilies.textContent = (grade === "2") ? "Harder families âœ…" : "Great for Kâ€“1 âœ…";
    tagMystery.textContent = "Fun mix ğŸ‰";
    tagTrace.textContent = "Handwriting âœ…";
    tagType.textContent = (grade === "K") ? "Letter practice âœ…" : "Word practice âœ…";
  }

  // -----------------------------
  // Enable/disable action buttons
  // -----------------------------
  function hydrateButtons(){
    const saved = readSavedDiag();
    const ok = saved && saved.grade === grade && saved.total === 10;
    chooseGameBtn.disabled = !ok;
    chooseGameBtn.style.opacity = ok ? "1" : ".6";
    recommendedBtn.disabled = !ok;
    recommendedBtn.style.opacity = ok ? "1" : ".6";
  }

  // -----------------------------
  // Game Engine with length
  // -----------------------------
  let activeGame = null;
  let round = 1;
  let roundsTarget = 5;

  function calcRoundsTarget(){
    if (gameLen === "endless") return Infinity;
    const n = parseInt(gameLen, 10);
    return Number.isFinite(n) ? n : 5;
  }

  function setStageHeader(title, desc){
    gameTitle.textContent = title;
    gameDesc.textContent = desc;
    stageFeedback.textContent = "";
    starsText.textContent = `Phonics â­: ${getPhonicsStars()}`;
  }
  function setPrompt(text, hint){
    promptText.textContent = text;
    promptHint.textContent = hint || "";
    stageFeedback.textContent = "";
    const maxText = (roundsTarget === Infinity) ? "Endless" : roundsTarget;
    roundText.textContent = `Round ${round} of ${maxText}`;
    stageBody.innerHTML = "";
  }
  function feedbackOk(msg){
    stageFeedback.textContent = msg || "Correct! â­";
    addPhonicsStar();
    starsText.textContent = `Phonics â­: ${getPhonicsStars()}`;
  }
  function feedbackNo(msg){ stageFeedback.textContent = msg || "Try again ğŸ™‚"; }

  function openHub(){
    renderGameTags(readSavedDiag());
    showOnly(gameHub);
  }

  function openStage(gameKey){
    activeGame = gameKey;
    round = 1;
    roundsTarget = calcRoundsTarget();
    showOnly(gameStage);
    runRound();
  }

  function maybeFinish(){
    if (roundsTarget !== Infinity && round > roundsTarget){
      stageFeedback.textContent = "ğŸ‰ Great job! You finished your game!";
      promptText.textContent = "Want to play another game?";
      promptHint.textContent = "Tap â† Back to pick a new one, or press New Round.";
      stageBody.innerHTML = "";
      return true;
    }
    return false;
  }

  function nextRoundSoon(){
    setTimeout(()=>{
      round++;
      if (maybeFinish()) return;
      runRound();
    }, 650);
  }

  function runRound(){
    stageFeedback.textContent = "";
    starsText.textContent = `Phonics â­: ${getPhonicsStars()}`;
    if (maybeFinish()) return;

    if (activeGame === "names") return roundLetterNames();
    if (activeGame === "sounds") return roundLetterSounds();
    if (activeGame === "pictures") return roundPictures();
    if (activeGame === "build") return roundBuilder();
    if (activeGame === "families") return roundFamilies();
    if (activeGame === "treasure") return roundTreasure();
    if (activeGame === "mystery") return roundMystery();
    if (activeGame === "trace") return roundTrace();
    if (activeGame === "type") return roundType();
  }

  // -----------------------------
  // Game Content
  // -----------------------------
  const lettersK = ["A","M","S","T","P","B","R","G","N","C","D","F"];
  const letters2 = ["A","E","I","O","U","B","D","P","R","G","J","Q","V","W","Y","T","M","S","N","C"];

  const soundItems = {
    K: [
      { prompt:"Which letter makes /m/?", choices:["M","S","T"], correct:"M", hint:"/m/ like moon" },
      { prompt:"Which letter makes /s/?", choices:["B","S","D"], correct:"S", hint:"/s/ like sun" },
      { prompt:"Which letter makes /t/?", choices:["T","A","P"], correct:"T", hint:"/t/ like top" },
      { prompt:"Which letter makes /p/?", choices:["P","V","B"], correct:"P", hint:"/p/ like pop" }
    ],
    1: [
      { prompt:"Which begins with /sh/?", choices:["ship","cat","top"], correct:"ship", hint:"/sh/ is quiet" },
      { prompt:"Which begins with /ch/?", choices:["rain","chop","sun"], correct:"chop", hint:"/ch/ like choo-choo" },
      { prompt:"Which begins with /th/?", choices:["this","ship","chip"], correct:"this", hint:"/th/ like this" },
      { prompt:"Which letter makes /r/?", choices:["R","L","H"], correct:"R", hint:"/r/ like rabbit" }
    ],
    2: [
      { prompt:"Which team can make LONG A?", choices:["ai","ee","oa"], correct:"ai", hint:"ai like rain" },
      { prompt:"Which team can make LONG E?", choices:["ee","ai","oa"], correct:"ee", hint:"ee like feet" },
      { prompt:"Which team can make LONG O?", choices:["oa","ee","ai"], correct:"oa", hint:"oa like boat" },
      { prompt:"Which starts with /v/?", choices:["van","sun","map"], correct:"van", hint:"/v/ like van" }
    ]
  };

  const pictureItems = {
    K: [
      { pic:"ğŸ±", word:"cat", sound:"/c/", choices:["cat","sun","map"], correct:"cat" },
      { pic:"â˜€ï¸", word:"sun", sound:"/s/", choices:["top","sun","pig"], correct:"sun" },
      { pic:"ğŸ—ºï¸", word:"map", sound:"/m/", choices:["map","cat","bug"], correct:"map" },
      { pic:"ğŸ©", word:"hat", sound:"/h/", choices:["hat","bat","cat"], correct:"hat" }
    ],
    1: [
      { pic:"ğŸš¢", word:"ship", sound:"/sh/", choices:["ship","chip","shop"], correct:"ship" },
      { pic:"ğŸŸ", word:"chip", sound:"/ch/", choices:["chin","chip","thin"], correct:"chip" },
      { pic:"ğŸ‘‰", word:"this", sound:"/th/", choices:["this","ship","chin"], correct:"this" },
      { pic:"ğŸ¸", word:"frog", sound:"/fr/", choices:["frog","flag","from"], correct:"frog" }
    ],
    2: [
      { pic:"ğŸŒ§ï¸", word:"rain", sound:"long A (ai)", choices:["rain","ran","run"], correct:"rain" },
      { pic:"ğŸ›¶", word:"boat", sound:"long O (oa)", choices:["boat","bot","bat"], correct:"boat" },
      { pic:"ğŸ¦¶", word:"feet", sound:"long E (ee)", choices:["feet","fit","fat"], correct:"feet" },
      { pic:"ğŸ§", word:"cake", sound:"CVCe (a_e)", choices:["cake","cak","cack"], correct:"cake" }
    ]
  };

  const buildTargets = {
    K: [
      { pic:"ğŸ¶", word:"dog" },
      { pic:"ğŸ±", word:"cat" },
      { pic:"ğŸ–", word:"pig" },
      { pic:"ğŸ§¢", word:"cap" },
      { pic:"ğŸšŒ", word:"bus" }
    ],
    1: [
      { pic:"ğŸ§¤", word:"mit" },
      { pic:"ğŸ§¢", word:"cap" },
      { pic:"ğŸŸ", word:"fish" },
      { pic:"ğŸš¢", word:"ship" },
      { pic:"ğŸŸ", word:"chip" }
    ],
    2: [
      { pic:"ğŸ›¶", word:"boat" },
      { pic:"ğŸ¦¶", word:"feet" },
      { pic:"ğŸŒ§ï¸", word:"rain" },
      { pic:"ğŸ§", word:"cake" },
      { pic:"ğŸ¸", word:"frog" }
    ]
  };

  const familySets = {
    K: [
      { family:"-at", words:["cat","hat","bat","rat"], traps:["sun","map","pig","top"] },
      { family:"-an", words:["fan","man","pan","can"], traps:["cap","cup","cat","dog"] },
      { family:"-ig", words:["pig","wig","dig","fig"], traps:["bag","bug","log","tag"] }
    ],
    1: [
      { family:"-op", words:["top","mop","hop","pop"], traps:["map","cap","cat","sun"] },
      { family:"-et", words:["pet","jet","net","wet"], traps:["pit","pat","pot","put"] },
      { family:"-uck", words:["duck","luck","tuck","muck"], traps:["dock","deck","dunk","tack"] }
    ],
    2: [
      { family:"-ight", words:["light","night","sight","right"], traps:["late","note","seat","rain"] },
      { family:"-ake", words:["cake","bake","lake","make"], traps:["back","sock","book","feet"] },
      { family:"-ain", words:["rain","train","chain","brain"], traps:["ran","ramp","ring","road"] }
    ]
  };

  const treasureRounds = {
    K: [
      { sound:"short a (Äƒ)", choices:["a","e","i"], correct:"a", hint:"cat" },
      { sound:"short i (Ä­)", choices:["o","i","u"], correct:"i", hint:"pin" }
    ],
    1: [
      { sound:"short o (Å)", choices:["o","a","e"], correct:"o", hint:"hot" },
      { sound:"short u (Å­)", choices:["u","o","i"], correct:"u", hint:"sun" }
    ],
    2: [
      { sound:"long A", choices:["ai","ee","oa"], correct:"ai", hint:"rain" },
      { sound:"long E", choices:["ee","ai","oa"], correct:"ee", hint:"feet" },
      { sound:"long O", choices:["oa","ee","ai"], correct:"oa", hint:"boat" }
    ]
  };

  const mysteryPicks = {
    K: { emoji:"ğŸ¦„", tiles:9 },
    1: { emoji:"ğŸ¦‰", tiles:9 },
    2: { emoji:"ğŸ¦–", tiles:9 }
  };

  // -----------------------------
  // Games
  // -----------------------------
  function roundLetterNames(){
    setStageHeader("ğŸ”  Letter Names", "Tap the correct letter name.");
    const pool = (grade === "2") ? letters2 : lettersK;
    const answer = pick(pool);
    const choices = shuffle([answer, pick(pool), pick(pool)]).slice(0,3);
    setPrompt(`Which letter is: ${answer}?`, "Look carefully at the shapes.");

    const grid = document.createElement("div");
    grid.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:34px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> (c === answer) ? (feedbackOk("Correct! â­"), nextRoundSoon()) : feedbackNo("Try again ğŸ™‚");
      grid.appendChild(card);
    });
    stageBody.appendChild(grid);
  }

  function roundLetterSounds(){
    setStageHeader("ğŸ”Š Letter Sounds", "Pick the letter/word that matches the sound.");
    const item = pick(soundItems[grade] || soundItems.K);
    const choices = shuffle(item.choices.slice());
    setPrompt(item.prompt, item.hint);

    const grid = document.createElement("div");
    grid.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> (c === item.correct) ? (feedbackOk("Correct! â­"), nextRoundSoon()) : feedbackNo("Try again ğŸ™‚");
      grid.appendChild(card);
    });
    stageBody.appendChild(grid);
  }

  function roundPictures(){
    setStageHeader("ğŸ–¼ï¸ Picture Labeling", "Pick the word that matches the picture + sound.");
    const it = pick(pictureItems[grade] || pictureItems.K);
    const choices = shuffle(it.choices.slice());
    setPrompt(`What is this? ${it.pic}`, `Choose the word. (Hint: ${it.sound})`);

    const grid = document.createElement("div");
    grid.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:24px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> (c === it.correct) ? (feedbackOk("Correct! â­"), nextRoundSoon()) : feedbackNo("Try again ğŸ™‚");
      grid.appendChild(card);
    });
    stageBody.appendChild(grid);
  }

  function toUnits(word){
    if (grade === "K") return word.split("");
    const combos = ["sh","ch","th","ck","ee","oa","ai"];
    const units = [];
    let i = 0;
    while (i < word.length){
      const two = word.slice(i, i+2);
      if (combos.includes(two)){
        units.push(two); i += 2;
      } else {
        units.push(word[i]); i += 1;
      }
    }
    return units;
  }
  function getDistractorUnits(correctUnits){
    const pool = (grade === "2")
      ? ["a","e","i","o","u","ai","ee","oa","sh","ch","th","ck","r","m","s","t","p","b","n","g"]
      : (grade === "1")
      ? ["a","e","i","o","u","sh","ch","th","ck","r","m","s","t","p","b","n","g"]
      : ["a","e","i","o","u","r","m","s","t","p","b","n","g","c","d","f"];
    const d = [];
    while (d.length < 5){
      const x = pick(pool);
      if (!correctUnits.includes(x)) d.push(x);
    }
    return d;
  }

  function roundBuilder(){
    setStageHeader("ğŸ§± Word Builder", "Drag tiles into the boxes to build the word.");
    const target = pick(buildTargets[grade] || buildTargets.K);
    const word = target.word.toLowerCase();
    const units = toUnits(word);

    setPrompt(`Build this word: ${target.pic}`, "Drag tiles into the boxes. Then press â€œCheckâ€.");

    const boxWrap = document.createElement("div");
    boxWrap.style.display = "flex";
    boxWrap.style.gap = "10px";
    boxWrap.style.justifyContent = "center";
    boxWrap.style.flexWrap = "wrap";

    const slots = [];
    units.forEach((u, idx)=>{
      const slot = document.createElement("div");
      slot.dataset.index = String(idx);
      slot.dataset.value = "";
      slot.style.width = "72px";
      slot.style.height = "72px";
      slot.style.borderRadius = "18px";
      slot.style.border = "3px dashed rgba(0,0,0,.12)";
      slot.style.background = "rgba(255,255,255,.6)";
      slot.style.display = "flex";
      slot.style.alignItems = "center";
      slot.style.justifyContent = "center";
      slot.style.fontSize = "24px";
      slot.style.fontWeight = "900";
      slot.style.userSelect = "none";

      slot.ondragover = (e)=> e.preventDefault();
      slot.ondrop = (e)=>{
        e.preventDefault();
        const data = e.dataTransfer.getData("text/plain");
        if (!data) return;
        slot.dataset.value = data;
        slot.textContent = data.toUpperCase();
      };

      slots.push(slot);
      boxWrap.appendChild(slot);
    });

    const tileWrap = document.createElement("div");
    tileWrap.style.display = "flex";
    tileWrap.style.gap = "10px";
    tileWrap.style.justifyContent = "center";
    tileWrap.style.flexWrap = "wrap";
    tileWrap.style.marginTop = "14px";

    const distractors = getDistractorUnits(units);
    const tiles = shuffle([...units, ...distractors]).slice(0, units.length + 3);

    tiles.forEach(t=>{
      const tile = document.createElement("div");
      tile.className = "card";
      tile.style.width = "90px";
      tile.style.padding = "14px";
      tile.style.textAlign = "center";
      tile.style.cursor = "grab";
      tile.draggable = true;
      tile.ondragstart = (e)=> e.dataTransfer.setData("text/plain", t);
      tile.innerHTML = `<h3 style="font-size:26px; margin:0;">${t.toUpperCase()}</h3>`;
      tileWrap.appendChild(tile);
    });

    const actions = document.createElement("div");
    actions.className = "quick-strip";
    actions.style.justifyContent = "center";
    actions.style.marginTop = "14px";

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn";
    checkBtn.type = "button";
    checkBtn.textContent = "Check";

    const clearBtn = document.createElement("button");
    clearBtn.className = "btn secondary";
    clearBtn.type = "button";
    clearBtn.textContent = "Clear";

    clearBtn.onclick = ()=>{
      slots.forEach(s=>{ s.dataset.value = ""; s.textContent = ""; });
      stageFeedback.textContent = "";
    };

    checkBtn.onclick = ()=>{
      const built = slots.map(s=>s.dataset.value).join("").toLowerCase();
      if (!built || built.length < 2){
        feedbackNo("Drag tiles into the boxes first ğŸ™‚");
        return;
      }
      if (built === word){
        feedbackOk("You built it! â­");
        nextRoundSoon();
      } else {
        feedbackNo(`Not yet â€” you made â€œ${built}â€. Try again!`);
      }
    };

    actions.appendChild(checkBtn);
    actions.appendChild(clearBtn);

    stageBody.appendChild(boxWrap);
    stageBody.appendChild(tileWrap);
    stageBody.appendChild(actions);
  }

  function roundFamilies(){
    setStageHeader("ğŸš‚ Word Family Train", "Pick the word that belongs in the word family train!");
    const set = pick(familySets[grade] || familySets.K);
    const correct = pick(set.words);
    const options = shuffle([correct, pick(set.traps), pick(set.traps)]).slice(0,3);

    setPrompt(`Which word is in the ${set.family} family?`, `Look for the ending â€œ${set.family.replace("-", "")}â€.`);

    const grid = document.createElement("div");
    grid.className = "grid-3";
    options.forEach(w=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${w}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> (w === correct) ? (feedbackOk("Train car added! â­"), nextRoundSoon()) : feedbackNo("Try again ğŸ™‚");
      grid.appendChild(card);
    });
    stageBody.appendChild(grid);
  }

  function roundTreasure(){
    setStageHeader("ğŸ—ºï¸ Vowel Team Treasure", "Choose the correct vowel (or vowel team) to unlock treasure!");
    const it = pick(treasureRounds[grade] || treasureRounds.K);
    const choices = shuffle(it.choices.slice());

    setPrompt(`Open the treasure for: ${it.sound}`, `Hint word: ${it.hint}`);

    const grid = document.createElement("div");
    grid.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${String(c).toUpperCase()}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> (c === it.correct) ? (feedbackOk("Treasure unlocked! â­"), nextRoundSoon()) : feedbackNo("Try again ğŸ™‚");
      grid.appendChild(card);
    });
    stageBody.appendChild(grid);
  }

  // Mystery reveal
  let mystery = null;
  function roundMystery(){
    setStageHeader("ğŸ•µï¸ Mystery Reveal", "Answer to reveal tiles! Finish all tiles to see the mystery.");
    if (!mystery || mystery.grade !== grade || mystery.revealed >= mystery.total){
      const m = mysteryPicks[grade] || mysteryPicks.K;
      mystery = { grade, emoji: m.emoji, total: m.tiles, revealed: 0 };
    }

    const qType = pick(["names","sounds","vowels","pictures"]);
    let q = null;

    if (qType === "names"){
      const pool = (grade === "2") ? letters2 : lettersK;
      const ans = pick(pool);
      const choices = shuffle([ans, pick(pool), pick(pool)]).slice(0,3);
      q = { prompt:`Which letter is: ${ans}?`, hint:"Pick the correct letter.", choices, correct: ans };
    } else if (qType === "sounds"){
      const it = pick(soundItems[grade] || soundItems.K);
      q = { prompt: it.prompt, hint: it.hint, choices: shuffle(it.choices.slice()), correct: it.correct };
    } else if (qType === "vowels"){
      const it = pick(treasureRounds[grade] || treasureRounds.K);
      q = { prompt:`Pick: ${it.sound}`, hint:`Hint word: ${it.hint}`, choices: shuffle(it.choices.slice()), correct: it.correct };
    } else {
      const it = pick(pictureItems[grade] || pictureItems.K);
      q = { prompt:`What is this? ${it.pic}`, hint:`Sound clue: ${it.sound}`, choices: shuffle(it.choices.slice()), correct: it.correct };
    }

    setPrompt(q.prompt, q.hint);

    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gridTemplateColumns = "repeat(3, minmax(0, 1fr))";
    wrap.style.gap = "10px";
    wrap.style.marginTop = "12px";

    for (let i=0; i<mystery.total; i++){
      const tile = document.createElement("div");
      tile.className = "card";
      tile.style.textAlign = "center";
      tile.style.padding = "18px";
      tile.style.minHeight = "70px";
      tile.innerHTML = `<div style="font-size:30px;">${i < mystery.revealed ? mystery.emoji : "â“"}</div>`;
      wrap.appendChild(tile);
    }

    const grid = document.createElement("div");
    grid.className = "grid-3";
    grid.style.marginTop = "14px";

    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.style.cursor = "pointer";
      card.innerHTML = `<h3 style="font-size:24px; margin-bottom:6px;">${String(c).toUpperCase()}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=>{
        if (String(c) === String(q.correct)){
          mystery.revealed = clamp(mystery.revealed + 1, 0, mystery.total);
          feedbackOk(`Tile revealed! (${mystery.revealed}/${mystery.total}) â­`);
          if (mystery.revealed >= mystery.total){
            setTimeout(()=>{ stageFeedback.textContent = "ğŸ‰ Mystery complete!"; }, 250);
          } else {
            setTimeout(()=>{ round++; runRound(); }, 650);
          }
        } else {
          feedbackNo("Try again ğŸ™‚");
        }
      };
      grid.appendChild(card);
    });

    stageBody.appendChild(wrap);
    stageBody.appendChild(grid);
  }

  // -----------------------------
  // NEW: Tracing game
  // -----------------------------
  const traceLetters = {
    K: ["A","M","S","T","P"],
    1: ["B","R","G","D","N"],
    2: ["C","H","V","J","Q"]
  };

  function roundTrace(){
    setStageHeader("âœï¸ Tracing Game", "Trace the letter in the big box. Stay inside the guide!");
    const letter = pick(traceLetters[grade] || traceLetters.K);
    const lower = letter.toLowerCase();

    setPrompt(`Trace: ${letter} (or ${lower})`, "Use your mouse or finger. Press â€œCheckâ€ when done.");

    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gap = "12px";
    wrap.style.justifyItems = "center";

    const controls = document.createElement("div");
    controls.className = "quick-strip";
    controls.style.justifyContent = "center";

    const upperBtn = document.createElement("button");
    upperBtn.className = "btn secondary";
    upperBtn.type = "button";
    upperBtn.textContent = "Uppercase";

    const lowerBtn = document.createElement("button");
    lowerBtn.className = "btn secondary";
    lowerBtn.type = "button";
    lowerBtn.textContent = "Lowercase";

    let mode = "upper";
    controls.appendChild(upperBtn);
    controls.appendChild(lowerBtn);

    const canvas = document.createElement("canvas");
    canvas.width = 520;
    canvas.height = 260;
    canvas.style.width = "min(520px, 100%)";
    canvas.style.borderRadius = "18px";
    canvas.style.border = "3px solid rgba(0,0,0,.10)";
    canvas.style.background = "rgba(255,255,255,.7)";
    canvas.style.boxShadow = "0 12px 26px rgba(0,0,0,.06)";

    const ctx = canvas.getContext("2d");

    function drawGuide(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // faint guide letter
      ctx.save();
      ctx.globalAlpha = 0.12;
      ctx.fillStyle = "#2e7d50";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "200px 'Baloo 2', sans-serif";
      ctx.fillText(mode === "upper" ? letter : lower, canvas.width/2, canvas.height/2 + 10);
      ctx.restore();

      // guide lines
      ctx.save();
      ctx.globalAlpha = 0.12;
      ctx.strokeStyle = "#2e7d50";
      ctx.lineWidth = 3;
      ctx.setLineDash([10, 10]);
      ctx.strokeRect(18, 18, canvas.width-36, canvas.height-36);
      ctx.restore();
    }

    let drawing = false;
    let points = []; // track points for "stayed in bounds" score
    let startTime = Date.now();

    function posFromEvent(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.clientX - r.left) * (canvas.width / r.width);
      const y = (e.clientY - r.top) * (canvas.height / r.height);
      return {x,y};
    }

    function begin(e){
      drawing = true;
      const p = posFromEvent(e);
      points.push(p);
      ctx.save();
      ctx.strokeStyle = "#2e7d50";
      ctx.lineWidth = 10;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      ctx.restore();
    }
    function move(e){
      if (!drawing) return;
      const p = posFromEvent(e);
      points.push(p);

      ctx.save();
      ctx.strokeStyle = "#2e7d50";
      ctx.lineWidth = 10;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.beginPath();
      const prev = points[points.length - 2];
      ctx.moveTo(prev.x, prev.y);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      ctx.restore();
    }
    function end(){
      drawing = false;
    }

    // mouse
    canvas.addEventListener("mousedown", (e)=> begin(e));
    window.addEventListener("mousemove", (e)=> move(e));
    window.addEventListener("mouseup", end);

    // touch
    canvas.addEventListener("touchstart", (e)=>{
      e.preventDefault();
      const t = e.touches[0];
      begin({ clientX: t.clientX, clientY: t.clientY });
    }, {passive:false});

    canvas.addEventListener("touchmove", (e)=>{
      e.preventDefault();
      const t = e.touches[0];
      move({ clientX: t.clientX, clientY: t.clientY });
    }, {passive:false});

    canvas.addEventListener("touchend", (e)=>{ e.preventDefault(); end(); }, {passive:false});

    function clearInk(){
      points = [];
      drawGuide();
      startTime = Date.now();
      stageFeedback.textContent = "";
    }

    function inBoundsScore(){
      // simple: % points within inner rectangle
      if (points.length < 12) return 0;
      const pad = 18;
      const minX = pad, minY = pad, maxX = canvas.width-pad, maxY = canvas.height-pad;
      let inside = 0;
      points.forEach(p=>{
        if (p.x>=minX && p.x<=maxX && p.y>=minY && p.y<=maxY) inside++;
      });
      return Math.round((inside / points.length) * 100);
    }

    const actions = document.createElement("div");
    actions.className = "quick-strip";
    actions.style.justifyContent = "center";
    actions.style.marginTop = "10px";

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn";
    checkBtn.type = "button";
    checkBtn.textContent = "Check";

    const clearBtn = document.createElement("button");
    clearBtn.className = "btn secondary";
    clearBtn.type = "button";
    clearBtn.textContent = "Clear";

    clearBtn.onclick = clearInk;

    checkBtn.onclick = ()=>{
      const score = inBoundsScore();
      const secs = Math.max(1, Math.round((Date.now() - startTime)/1000));

      if (points.length < 12){
        feedbackNo("Trace a little more before checking ğŸ™‚");
        return;
      }

      // pass condition: stayed mostly inside
      if (score >= 70){
        feedbackOk(`Nice tracing! â­ (Inside: ${score}%, Time: ${secs}s)`);
        nextRoundSoon();
      } else {
        feedbackNo(`Almost! Try to stay inside the box. (Inside: ${score}%)`);
      }
    };

    actions.appendChild(checkBtn);
    actions.appendChild(clearBtn);

    upperBtn.onclick = ()=>{
      mode = "upper";
      upperBtn.classList.add("active");
      lowerBtn.classList.remove("active");
      clearInk();
    };
    lowerBtn.onclick = ()=>{
      mode = "lower";
      lowerBtn.classList.add("active");
      upperBtn.classList.remove("active");
      clearInk();
    };

    wrap.appendChild(controls);
    wrap.appendChild(canvas);
    wrap.appendChild(actions);

    stageBody.appendChild(wrap);

    drawGuide();
  }

  // -----------------------------
  // NEW: Typing game
  // -----------------------------
  const typingBanks = {
    K: {
      prompts: [
        { prompt:"Type the letter: A", answer:"A", hint:"Capital A" },
        { prompt:"Type the letter: m", answer:"m", hint:"Lowercase m" },
        { prompt:"Type the letter: S", answer:"S", hint:"Capital S" },
        { prompt:"Type the vowel: a", answer:"a", hint:"Vowel" }
      ]
    },
    1: {
      prompts: [
        { prompt:"Type the word: cat", answer:"cat", hint:"CVC word" },
        { prompt:"Type the word: ship", answer:"ship", hint:"starts with sh" },
        { prompt:"Type the word: chop", answer:"chop", hint:"starts with ch" },
        { prompt:"Type the word: this", answer:"this", hint:"starts with th" }
      ]
    },
    2: {
      prompts: [
        { prompt:"Type the word: rain", answer:"rain", hint:"ai = long A" },
        { prompt:"Type the word: feet", answer:"feet", hint:"ee = long E" },
        { prompt:"Type the word: boat", answer:"boat", hint:"oa = long O" },
        { prompt:"Type the word: cake", answer:"cake", hint:"CVCe word" }
      ]
    }
  };

  function roundType(){
    setStageHeader("âŒ¨ï¸ Typing Game", "Type the answer carefully. Then press Check!");
    const it = pick((typingBanks[grade] || typingBanks.K).prompts);

    setPrompt(it.prompt, it.hint);

    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gap = "12px";
    wrap.style.justifyItems = "center";

    const input = document.createElement("input");
    input.type = "text";
    input.autocomplete = "off";
    input.spellcheck = false;
    input.placeholder = (grade === "K") ? "Type hereâ€¦" : "Type the wordâ€¦";
    input.style.width = "min(520px, 100%)";
    input.style.padding = "16px 18px";
    input.style.borderRadius = "18px";
    input.style.border = "3px solid rgba(0,0,0,.10)";
    input.style.fontSize = "22px";
    input.style.fontWeight = "800";
    input.style.outline = "none";
    input.style.background = "rgba(255,255,255,.75)";

    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") check();
    });

    const actions = document.createElement("div");
    actions.className = "quick-strip";
    actions.style.justifyContent = "center";

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn";
    checkBtn.type = "button";
    checkBtn.textContent = "Check";

    const clearBtn = document.createElement("button");
    clearBtn.className = "btn secondary";
    clearBtn.type = "button";
    clearBtn.textContent = "Clear";

    function normalize(s){
      // K allows case-insensitive for single letters, grade 1/2 case-insensitive for words
      return String(s || "").trim();
    }

    function check(){
      const typed = normalize(input.value);
      if (!typed){
        feedbackNo("Type something first ğŸ™‚");
        return;
      }

      const ans = normalize(it.answer);

      // For K: if answer is a single letter, allow case-insensitive match
      if (grade === "K" && ans.length === 1){
        if (typed.toLowerCase() === ans.toLowerCase()){
          feedbackOk("Correct! â­");
          nextRoundSoon();
        } else {
          feedbackNo(`Try again ğŸ™‚ (Hint: ${it.hint})`);
        }
        return;
      }

      // Grades 1â€“2: match ignoring case
      if (typed.toLowerCase() === ans.toLowerCase()){
        feedbackOk("Correct! â­");
        nextRoundSoon();
      } else {
        feedbackNo("Try again ğŸ™‚");
      }
    }

    checkBtn.onclick = check;
    clearBtn.onclick = ()=>{ input.value = ""; stageFeedback.textContent = ""; input.focus(); };

    actions.appendChild(checkBtn);
    actions.appendChild(clearBtn);

    wrap.appendChild(input);
    wrap.appendChild(actions);
    stageBody.appendChild(wrap);

    setTimeout(()=> input.focus(), 50);
  }

  // -----------------------------
  // Game hub click handlers
  // -----------------------------
  document.querySelectorAll(".card.pick").forEach(card=>{
    card.style.cursor = "pointer";
    card.addEventListener("click", ()=> openStage(card.dataset.game));
  });

  backToHubBtn.addEventListener("click", openHub);
  newRoundBtn.addEventListener("click", ()=>{ round++; runRound(); });

  // -----------------------------
  // Diagnostic events
  // -----------------------------
  startDiagBtn.addEventListener("click", ()=>{
    diagQs = getTenDiagQuestions(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagAnswered = false;
    diagMiss = { names:0, sounds:0, vowels:0 };
    showOnly(diagPanel);
    renderDiagQuestion();
  });

  diagNextBtn.addEventListener("click", ()=>{
    if (!diagAnswered) return;
    diagIndex++;
    if (diagIndex >= 10) finishDiagnostic();
    else renderDiagQuestion();
  });

  diagRestartBtn.addEventListener("click", ()=>{
    diagQs = getTenDiagQuestions(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagAnswered = false;
    diagMiss = { names:0, sounds:0, vowels:0 };
    renderDiagQuestion();
  });

  retakeBtn.addEventListener("click", ()=>{
    localStorage.removeItem(PHONICS_DIAG_KEY);
    hydrateButtons();
    diagQs = getTenDiagQuestions(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagAnswered = false;
    diagMiss = { names:0, sounds:0, vowels:0 };
    showOnly(diagPanel);
    renderDiagQuestion();
  });

  chooseGameBtn.addEventListener("click", ()=>{ renderGameTags(readSavedDiag()); showOnly(gameHub); });
  goChooseGameBtn.addEventListener("click", ()=>{ renderGameTags(readSavedDiag()); showOnly(gameHub); });

  // Recommended Path button: jump straight into best game
  function startRecommended(){
    const saved = readSavedDiag();
    const key = saved?.recommended || recommendGameKey(saved);
    openStage(key);
  }
  recommendedBtn.addEventListener("click", startRecommended);
  goRecommendedBtn.addEventListener("click", startRecommended);

  // -----------------------------
  // Init
  // -----------------------------
  setGrade(grade);
  hydrateButtons();
  const saved = readSavedDiag();
  if (saved && saved.grade === grade) renderGameTags(saved);
  else renderGameTags({ grade, misses:{names:0,sounds:0,vowels:0} });
</script>

</body>
</html>
