<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a class="dropdown-toggle" href="#" aria-expanded="false">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Pick your grade, take a quick diagnostic, then choose a game to practice!</p>
  </div>
</section>

<section class="section">
  <div class="container">

    <div class="game-box wide">
      <div class="kid-big" style="text-align:center;">Choose Grade ğŸŒŸ</div>

      <div class="badge-row" style="justify-content:center;">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>

      <div class="quick-strip" style="justify-content:center; margin-top:12px;">
        <button class="btn" id="startDiagBtn">Start 10-Question Diagnostic</button>
        <button class="btn secondary" id="goGamesBtn" disabled style="opacity:.6;">Choose a Game</button>
        <a class="btn secondary" href="progress.html">My Progress</a>
      </div>
    </div>

    <!-- DIAGNOSTIC -->
    <div class="game-box wide" id="diagWrap" style="margin-top:16px; display:none;">
      <div class="kid-big">Phonics Diagnostic âœ…</div>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="small" id="diagMeta">Question 1 of 10</div>
            <div class="kid-big" id="diagQ">Question loads hereâ€¦</div>
          </div>
          <button class="btn secondary" id="diagSoundBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <div class="small" id="diagSupport" style="margin-top:6px;"></div>

        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>

        <div class="kid-big" id="diagResult" style="margin-top:14px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:10px;">
          <button class="btn" id="diagNextBtn">Next</button>
          <button class="btn secondary" id="diagSkipBtn">Skip</button>
        </div>
      </div>
    </div>

    <!-- AFTER DIAG: RECOMMENDED PATH + LENGTH + GAME HUB -->
    <div class="game-box wide" id="afterDiagWrap" style="margin-top:16px; display:none;">
      <div class="kid-big">Your Plan ğŸŒ¿</div>

      <div class="game-box" style="margin-top:12px;">
        <div class="grid-3">
          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Score</h3>
            <div class="kid-big" id="planScore">â€”</div>
            <div class="small" id="planGrade">â€”</div>
          </div>

          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Recommended Path</h3>
            <div class="small" id="planPath" style="line-height:1.5;">â€”</div>
          </div>

          <div class="card" style="text-align:center;">
            <h3 style="margin-bottom:6px;">Game Length</h3>
            <div class="kid-big" id="planLen">â€”</div>
            <div class="small" id="planLenNote">â€”</div>
          </div>
        </div>

        <div class="quick-strip" style="justify-content:center; margin-top:12px;">
          <button class="btn" id="openGamesBtn">Open Games</button>
          <button class="btn secondary" id="retakeBtn">Retake Diagnostic</button>
        </div>
      </div>
    </div>

    <!-- GAME HUB -->
    <div class="game-box wide" id="gamesHub" style="margin-top:16px; display:none;">
      <div class="kid-big">Choose a Game ğŸ®</div>
      <p class="small" id="gameHubDesc" style="margin-top:6px;">Pick a game below.</p>

      <div class="grid-3" id="gameCards" style="margin-top:14px;"></div>
    </div>

    <!-- GAME PLAYER -->
    <div class="game-box wide" id="gamePlayWrap" style="margin-top:16px; display:none;">
      <div class="kid-big" id="gameTitle">Game</div>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="small" id="gameMeta">â€”</div>
            <div class="kid-big" id="gamePrompt">Prompt loadsâ€¦</div>
          </div>
          <button class="btn secondary" id="gameSoundBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <div class="small" id="gameSupport" style="margin-top:6px;"></div>

        <div id="gameStage" style="margin-top:14px;"></div>

        <div class="kid-big" id="gameResult" style="margin-top:14px;"></div>

        <div class="quick-strip" style="justify-content:flex-start; margin-top:12px;">
          <button class="btn" id="gameNextBtn">Next</button>
          <button class="btn secondary" id="backToGamesBtn">Back to Games</button>
        </div>

        <div class="small" style="margin-top:10px;">Earn â­ for correct answers.</div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script src="./nav.js"></script>
<script>
  // =========================
  // Storage
  // =========================
  const PROG_KEY = "bloom_progress";
  const PHONICS_DIAG_KEY = "bloom_phonics_diag";

  function load(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function addStar(){
    const p = load(PROG_KEY, { phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0 });
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    save(PROG_KEY, p);
  }

  // =========================
  // Grade
  // =========================
  let grade = new URLSearchParams(location.search).get("grade") || localStorage.getItem("bloom_pref_grade") || "K";
  const gradeButtons = document.querySelectorAll(".pill[data-grade]");
  function setGrade(g){
    grade = g;
    localStorage.setItem("bloom_pref_grade", g);
    gradeButtons.forEach(b => b.classList.toggle("active", b.dataset.grade === grade));
    refreshGameHub();
    refreshGoGamesEnabled();
  }
  gradeButtons.forEach(btn => btn.addEventListener("click", ()=> setGrade(btn.dataset.grade)));
  setGrade(grade);

  // =========================
  // Audio helpers
  // - Uses real audio if present; otherwise fallback to TTS.
  // =========================
  const audio = new Audio();
  audio.preload = "auto";

  const soundAudio = {
    "m": "./assets/audio/sounds/m.mp3",
    "s": "./assets/audio/sounds/s.mp3",
    "t": "./assets/audio/sounds/t.mp3",
    "sh": "./assets/audio/sounds/sh.mp3",
    "ch": "./assets/audio/sounds/ch.mp3",
    "th": "./assets/audio/sounds/th.mp3",
    "long-a": "./assets/audio/sounds/long-a.mp3",
    "long-e": "./assets/audio/sounds/long-e.mp3",
    "long-o": "./assets/audio/sounds/long-o.mp3"
  };

  const letterAudio = {
    "A": "./assets/audio/letters/A.mp3",
    "B": "./assets/audio/letters/B.mp3",
    "M": "./assets/audio/letters/M.mp3",
    "S": "./assets/audio/letters/S.mp3",
    "T": "./assets/audio/letters/T.mp3",
    "R": "./assets/audio/letters/R.mp3",
    "G": "./assets/audio/letters/G.mp3",
    "P": "./assets/audio/letters/P.mp3",
    "V": "./assets/audio/letters/V.mp3"
  };

  function speak(text){
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1;
    u.pitch = 1.05;
    speechSynthesis.speak(u);
  }

  async function playFileOrTTS(src, ttsText){
    try {
      if (src) {
        audio.pause(); audio.currentTime = 0;
        audio.src = src;
        await audio.play();
        return;
      }
    } catch {}
    if (ttsText) speak(ttsText);
  }

  // =========================
  // Diagnostic bank (10 Q total)
  // Focus tags: name / sound / vowels / cvc
  // =========================
  const BANK = {
    "K": {
      diag: [
        {type:"name", letter:"A", prompt:"What is the NAME of this letter: A?", choices:["A","B","D"], correct:"A", focus:"name"},
        {type:"name", letter:"M", prompt:"What is the NAME of this letter: M?", choices:["N","M","W"], correct:"M", focus:"name"},
        {type:"sound", soundKey:"m", prompt:"Which letter makes this sound?", choices:["M","S","T"], correct:"M", focus:"sound"},
        {type:"sound", soundKey:"s", prompt:"Which letter makes this sound?", choices:["B","S","D"], correct:"S", focus:"sound"},
        {type:"vowel", prompt:"Which one is a vowel?", choices:["A","M","T"], correct:"A", focus:"vowels"},
        {type:"vowel", prompt:"Which one is a vowel?", choices:["S","E","T"], correct:"E", focus:"vowels"},
        {type:"cvc", prompt:"Pick the word that says: cat", choices:["cat","cot","cut"], correct:"cat", focus:"cvc"},
        {type:"cvc", prompt:"Pick the word that says: map", choices:["map","mop","mip"], correct:"map", focus:"cvc"},
        {type:"pic", emoji:"ğŸ", prompt:"Apple starts withâ€¦", choices:["A","S","M"], correct:"A", focus:"sound"},
        {type:"pic", emoji:"â˜€ï¸", prompt:"Sun starts withâ€¦", choices:["S","T","A"], correct:"S", focus:"sound"}
      ]
    },
    "1": {
      diag: [
        {type:"name", letter:"R", prompt:"What is the NAME of this letter: R?", choices:["R","K","H"], correct:"R", focus:"name"},
        {type:"name", letter:"T", prompt:"What is the NAME of this letter: T?", choices:["T","F","E"], correct:"T", focus:"name"},
        {type:"sound", soundKey:"sh", prompt:"Which letters make this sound?", choices:["CH","SH","TH"], correct:"SH", focus:"sound"},
        {type:"sound", soundKey:"ch", prompt:"Which letters make this sound?", choices:["CH","PH","WH"], correct:"CH", focus:"sound"},
        {type:"vowel", prompt:"Which one is a vowel?", choices:["A","R","T"], correct:"A", focus:"vowels"},
        {type:"vowel", prompt:"Which one is a vowel?", choices:["S","I","T"], correct:"I", focus:"vowels"},
        {type:"cvc", prompt:"Pick the word that says: ship", choices:["ship","shop","shep"], correct:"ship", focus:"cvc"},
        {type:"cvc", prompt:"Pick the word that says: chop", choices:["chap","chop","chip"], correct:"chop", focus:"cvc"},
        {type:"pic", emoji:"ğŸ¸", prompt:"Frog starts withâ€¦", choices:["F","R","G"], correct:"F", focus:"sound"},
        {type:"pic", emoji:"ğŸ¦", prompt:"Lion starts withâ€¦", choices:["L","I","T"], correct:"L", focus:"sound"}
      ]
    },
    "2": {
      diag: [
        {type:"name", letter:"G", prompt:"What is the NAME of this letter: G?", choices:["G","J","Q"], correct:"G", focus:"name"},
        {type:"name", letter:"V", prompt:"What is the NAME of this letter: V?", choices:["V","W","Y"], correct:"V", focus:"name"},
        {type:"sound", soundKey:"th", prompt:"Which letters make this sound?", choices:["TH","SH","CH"], correct:"TH", focus:"sound"},
        {type:"sound", soundKey:"long-a", prompt:"Which vowel team says long A?", choices:["AI","EE","OA"], correct:"AI", focus:"vowels"},
        {type:"sound", soundKey:"long-e", prompt:"Which vowel team says long E?", choices:["EE","AI","OA"], correct:"EE", focus:"vowels"},
        {type:"sound", soundKey:"long-o", prompt:"Which vowel team says long O?", choices:["OA","EE","AI"], correct:"OA", focus:"vowels"},
        {type:"cvc", prompt:"Pick the best spelling for: rain", choices:["ran","rain","rein"], correct:"rain", focus:"vowels"},
        {type:"cvc", prompt:"Pick the best spelling for: boat", choices:["bot","boet","boat"], correct:"boat", focus:"vowels"},
        {type:"pic", emoji:"ğŸ›³ï¸", prompt:"Boat starts withâ€¦", choices:["B","P","D"], correct:"B", focus:"sound"},
        {type:"pic", emoji:"ğŸ§€", prompt:"Cheese starts withâ€¦", choices:["CH","SH","TH"], correct:"CH", focus:"sound"}
      ]
    }
  };

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // =========================
  // Diagnostic UI
  // =========================
  const diagWrap = document.getElementById("diagWrap");
  const afterDiagWrap = document.getElementById("afterDiagWrap");
  const gamesHub = document.getElementById("gamesHub");
  const gamePlayWrap = document.getElementById("gamePlayWrap");

  const diagMeta = document.getElementById("diagMeta");
  const diagQ = document.getElementById("diagQ");
  const diagSupport = document.getElementById("diagSupport");
  const diagChoices = document.getElementById("diagChoices");
  const diagResult = document.getElementById("diagResult");
  const diagSoundBtn = document.getElementById("diagSoundBtn");

  let diagItems = [];
  let dIndex = 0;
  let dScore = 0;
  let dWrong = []; // focus tags
  let lastDiagItem = null;

  function openDiagnostic(){
    diagItems = shuffle(BANK[grade].diag).slice(0,10);
    dIndex = 0;
    dScore = 0;
    dWrong = [];
    diagResult.textContent = "";
    diagWrap.style.display = "block";
    afterDiagWrap.style.display = "none";
    gamesHub.style.display = "none";
    gamePlayWrap.style.display = "none";
    renderDiag();
    window.scrollTo({top: diagWrap.offsetTop - 10, behavior:"smooth"});
  }

  function renderDiag(){
    const it = diagItems[dIndex];
    lastDiagItem = it;

    diagMeta.textContent = `Question ${dIndex+1} of 10`;
    diagResult.textContent = "";

    if (it.type === "pic") {
      diagQ.innerHTML = `${it.emoji} ${it.prompt}`;
    } else {
      diagQ.textContent = it.prompt;
    }

    // Support line
    if (it.type === "sound") diagSupport.textContent = "Tap ğŸ”Š to hear the sound.";
    else if (it.type === "name") diagSupport.textContent = "Tap ğŸ”Š to hear the letter name.";
    else diagSupport.textContent = "";

    diagChoices.innerHTML = "";
    it.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> diagAnswer(c);
      diagChoices.appendChild(card);
    });
  }

  function diagPlaySound(){
    const it = lastDiagItem;
    if (!it) return;

    if (it.type === "sound") {
      playFileOrTTS(soundAudio[it.soundKey], "Listen.");
    } else if (it.type === "name") {
      playFileOrTTS(letterAudio[it.letter], `The letter is ${it.letter}.`);
    } else if (it.type === "vowel") {
      speak("Which one is a vowel?");
    } else if (it.type === "cvc") {
      speak(it.prompt);
    } else if (it.type === "pic") {
      speak(it.prompt);
    } else {
      speak(it.prompt);
    }
  }

  function diagAnswer(choice){
    const it = diagItems[dIndex];
    if (diagResult.textContent) return; // prevent double clicks

    if (choice === it.correct){
      dScore++;
      diagResult.textContent = "Correct! â­";
    } else {
      dWrong.push(it.focus);
      diagResult.textContent = `Good try! Answer: ${it.correct}`;
    }
  }

  function diagNext(skipped=false){
    const it = diagItems[dIndex];
    // If they never answered and click next/skip, count it as wrong focus
    if (!diagResult.textContent || skipped){
      dWrong.push(it.focus);
    }
    dIndex++;
    if (dIndex >= diagItems.length){
      finishDiagnostic();
    } else {
      renderDiag();
    }
  }

  function finishDiagnostic(){
    const pct = Math.round((dScore/10)*100);
    const wrongCounts = dWrong.reduce((m,k)=> (m[k]=(m[k]||0)+1, m), {});
    const focusOrder = Object.entries(wrongCounts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);

    const plan = {
      date: Date.now(),
      grade,
      score: pct,
      focusOrder
    };
    save(PHONICS_DIAG_KEY, plan);

    // Show plan
    document.getElementById("planScore").textContent = `${pct}%`;
    document.getElementById("planGrade").textContent = `Grade: ${grade === "K" ? "Kindergarten" : "Grade " + grade}`;

    const pathParts = [];
    if (focusOrder.includes("sound")) pathParts.push("Letter Sounds");
    if (focusOrder.includes("name")) pathParts.push("Letter Names");
    if (focusOrder.includes("vowels")) pathParts.push("Vowels & Vowel Teams");
    if (focusOrder.includes("cvc")) pathParts.push("CVC Words");
    if (!pathParts.length) pathParts.push("Mixed Review");

    document.getElementById("planPath").textContent = pathParts.join(" â†’ ");

    // Game length recommendation after diagnostic
    let minutes;
    if (pct >= 90) minutes = 6;
    else if (pct >= 70) minutes = 8;
    else minutes = 10;

    document.getElementById("planLen").textContent = `${minutes} min`;
    document.getElementById("planLenNote").textContent =
      (pct >= 90) ? "Try 2 quick games" :
      (pct >= 70) ? "Try 2â€“3 games" :
      "Try 3 games + tracing";

    diagWrap.style.display = "none";
    afterDiagWrap.style.display = "block";
    gamesHub.style.display = "none";
    gamePlayWrap.style.display = "none";

    refreshGoGamesEnabled();
    window.scrollTo({top: afterDiagWrap.offsetTop - 10, behavior:"smooth"});
  }

  function refreshGoGamesEnabled(){
    const saved = load(PHONICS_DIAG_KEY, null);
    const ok = saved && saved.grade === grade;
    const btn = document.getElementById("goGamesBtn");
    btn.disabled = !ok;
    btn.style.opacity = ok ? "1" : ".6";
  }

  // =========================
  // Games (grade-aware)
  // Each game: id, name, desc, min, grades
  // =========================
  const GAMES = [
    {id:"soundToLetter", name:"ğŸ”Š Sound â†’ Letter", desc:"Listen to a sound and choose the correct letter.", min:3, grades:["K","1","2"]},
    {id:"letterToSound", name:"ğŸ”¤ Letter â†’ Sound", desc:"See a letter and choose the sound it makes.", min:3, grades:["K","1","2"]},
    {id:"pictureLabel", name:"ğŸ–¼ï¸ Picture Starter", desc:"Pick the beginning sound/letters for a picture.", min:4, grades:["K","1","2"]},
    {id:"cvcBuilder", name:"ğŸ§± CVC Builder", desc:"Build a word by dragging letters into boxes.", min:5, grades:["K","1"]},
    {id:"wordFamilyTrain", name:"ğŸš‚ Word Family Train", desc:"Pick words that belong to the same family.", min:4, grades:["K","1"]},
    {id:"vowelTreasure", name:"ğŸ§­ Vowel Team Treasure", desc:"Choose the right vowel team for a word.", min:5, grades:["2"]},
    {id:"mysteryReveal", name:"ğŸ Mystery Reveal", desc:"Answer correctly to reveal a mystery picture.", min:5, grades:["K","1","2"]},
    {id:"typingGame", name:"âŒ¨ï¸ Typing Game", desc:"Type the letter or word you hear.", min:4, grades:["K","1","2"]},
    {id:"tracingGame", name:"âœï¸ Tracing Game", desc:"Trace uppercase or lowercase letters.", min:6, grades:["K","1","2"]}
  ];

  function getPlan(){
    return load(PHONICS_DIAG_KEY, null);
  }

  function refreshGameHub(){
    const plan = getPlan();
    const desc = document.getElementById("gameHubDesc");
    if (plan && plan.grade === grade){
      desc.textContent = "Games are filtered for your grade. â­";
    } else {
      desc.textContent = "Take the diagnostic first to unlock your plan and game length.";
    }

    const list = GAMES.filter(g=>g.grades.includes(grade));
    const cards = document.getElementById("gameCards");
    cards.innerHTML = "";

    list.forEach(g=>{
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `
        <h3 style="margin-bottom:6px;">${g.name}</h3>
        <p class="small" style="line-height:1.5;">${g.desc}</p>
        <p class="small" style="margin-top:8px;"><strong>Length:</strong> ${g.min} min</p>
        <div class="quick-strip" style="margin-top:10px; justify-content:flex-start;">
          <button class="btn secondary" data-game="${g.id}">Play</button>
        </div>
      `;
      c.querySelector("button").onclick = ()=> startGame(g.id);
      cards.appendChild(c);
    });
  }

  function openGames(){
    afterDiagWrap.style.display = "none";
    diagWrap.style.display = "none";
    gamesHub.style.display = "block";
    gamePlayWrap.style.display = "none";
    refreshGameHub();
    window.scrollTo({top: gamesHub.offsetTop - 10, behavior:"smooth"});
  }

  // =========================
  // Game engine (varied)
  // =========================
  const gameTitle = document.getElementById("gameTitle");
  const gameMeta = document.getElementById("gameMeta");
  const gamePrompt = document.getElementById("gamePrompt");
  const gameSupport = document.getElementById("gameSupport");
  const gameStage = document.getElementById("gameStage");
  const gameResult = document.getElementById("gameResult");
  const gameSoundBtn = document.getElementById("gameSoundBtn");

  let activeGame = null;
  let gIndex = 0;
  let lastGameItem = null;

  // Shared item banks for games
  const SOUND_ITEMS = {
    "K": [
      {soundKey:"m", correct:"M", choices:["M","S","T"], say:"/m/"},
      {soundKey:"s", correct:"S", choices:["B","S","D"], say:"/s/"},
      {soundKey:"t", correct:"T", choices:["T","A","P"], say:"/t/"}
    ],
    "1": [
      {soundKey:"sh", correct:"SH", choices:["CH","SH","TH"], say:"/sh/"},
      {soundKey:"ch", correct:"CH", choices:["CH","PH","WH"], say:"/ch/"},
      {soundKey:"th", correct:"TH", choices:["TH","SH","CH"], say:"/th/"}
    ],
    "2": [
      {soundKey:"long-a", correct:"AI", choices:["AI","EE","OA"], say:"long A"},
      {soundKey:"long-e", correct:"EE", choices:["EE","AI","OA"], say:"long E"},
      {soundKey:"long-o", correct:"OA", choices:["OA","EE","AI"], say:"long O"}
    ]
  };

  const LETTER_ITEMS = {
    "K": [
      {letter:"A", correct:"A", choices:["/a/","/m/","/s/"], tts:"A"},
      {letter:"M", correct:"/m/", choices:["/m/","/s/","/t/"], tts:"M"},
      {letter:"S", correct:"/s/", choices:["/m/","/s/","/t/"], tts:"S"}
    ],
    "1": [
      {letter:"SH", correct:"/sh/", choices:["/ch/","/sh/","/th/"], tts:"S H"},
      {letter:"CH", correct:"/ch/", choices:["/ch/","/sh/","/th/"], tts:"C H"},
      {letter:"TH", correct:"/th/", choices:["/th/","/sh/","/ch/"], tts:"T H"}
    ],
    "2": [
      {letter:"AI", correct:"long A", choices:["long A","long E","long O"], tts:"A I"},
      {letter:"EE", correct:"long E", choices:["long E","long A","long O"], tts:"E E"},
      {letter:"OA", correct:"long O", choices:["long O","long A","long E"], tts:"O A"}
    ]
  };

  const PICTURE_ITEMS = {
    "K": [
      {emoji:"ğŸ", word:"apple", correct:"A", choices:["A","S","M"]},
      {emoji:"â˜€ï¸", word:"sun", correct:"S", choices:["S","T","A"]},
      {emoji:"ğŸŒ™", word:"moon", correct:"M", choices:["M","N","W"]}
    ],
    "1": [
      {emoji:"ğŸ§¦", word:"sock", correct:"S", choices:["S","C","T"]},
      {emoji:"ğŸŸ", word:"fish", correct:"F", choices:["F","P","V"]},
      {emoji:"ğŸš¢", word:"ship", correct:"SH", choices:["CH","SH","TH"]}
    ],
    "2": [
      {emoji:"ğŸ›³ï¸", word:"boat", correct:"B", choices:["B","P","D"]},
      {emoji:"ğŸ§€", word:"cheese", correct:"CH", choices:["CH","SH","TH"]},
      {emoji:"ğŸŒ§ï¸", word:"rain", correct:"AI", choices:["AI","EE","OA"]}
    ]
  };

  // Mystery reveal simple pieces
  const MYSTERY = [
    {pic:"ğŸ¦„", name:"Unicorn"},
    {pic:"ğŸ¦–", name:"Dino"},
    {pic:"ğŸ¦‰", name:"Owl"}
  ];
  let reveal = { target:null, pieces:0 };

  function startGame(id){
    activeGame = id;
    gIndex = 0;
    gameResult.textContent = "";
    lastGameItem = null;

    gamesHub.style.display = "none";
    gamePlayWrap.style.display = "block";

    renderGame();
    window.scrollTo({top: gamePlayWrap.offsetTop - 10, behavior:"smooth"});
  }

  function setGameHeader(title, meta){
    gameTitle.textContent = title;
    gameMeta.textContent = meta || "";
  }

  function renderChoiceCards(choices, onPick){
    const wrap = document.createElement("div");
    wrap.className = "grid-3";
    choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:28px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> onPick(c);
      wrap.appendChild(card);
    });
    return wrap;
  }

  // ---- CVC Drag Builder ----
  const BAD_WORDS = new Set(["ass","sex","fuk","fuck","shit"]);
  function makeCVCWordBank(){
    // Simple safe set (K/1)
    const words = ["cat","map","sun","top","pig","hat","rip","mop","sit","lap"];
    return shuffle(words);
  }

  function renderCVCBuilder(){
    setGameHeader("ğŸ§± CVC Builder", "Drag letters into the boxes.");

    const words = makeCVCWordBank();
    const target = words[gIndex % words.length];
    lastGameItem = { target };

    gamePrompt.textContent = "Build the word you hear.";
    gameSupport.textContent = "Tap ğŸ”Š then drag letters into the boxes.";

    const stage = document.createElement("div");

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "10px";
    row.style.flexWrap = "wrap";
    row.style.justifyContent = "center";

    const boxes = [];
    for (let i=0;i<3;i++){
      const b = document.createElement("div");
      b.className = "card";
      b.style.width = "90px";
      b.style.height = "90px";
      b.style.display = "flex";
      b.style.alignItems = "center";
      b.style.justifyContent = "center";
      b.style.fontSize = "34px";
      b.style.fontWeight = "900";
      b.dataset.index = String(i);
      b.dataset.value = "";
      b.ondragover = (e)=>{ e.preventDefault(); };
      b.ondrop = (e)=>{
        e.preventDefault();
        const letter = e.dataTransfer.getData("text/plain");
        b.textContent = letter;
        b.dataset.value = letter;
      };
      boxes.push(b);
      row.appendChild(b);
    }

    const tiles = document.createElement("div");
    tiles.style.display = "flex";
    tiles.style.gap = "10px";
    tiles.style.flexWrap = "wrap";
    tiles.style.justifyContent = "center";
    tiles.style.marginTop = "12px";

    const letters = shuffle(target.split("").concat(shuffle(["a","e","i","o","u","m","s","t","p"]).slice(0,3))).slice(0,6);
    letters.forEach(L=>{
      const t = document.createElement("div");
      t.className = "card";
      t.style.width = "80px";
      t.style.height = "80px";
      t.style.display = "flex";
      t.style.alignItems = "center";
      t.style.justifyContent = "center";
      t.style.fontSize = "32px";
      t.style.fontWeight = "900";
      t.textContent = L;
      t.draggable = true;
      t.ondragstart = (e)=>{ e.dataTransfer.setData("text/plain", L); };
      tiles.appendChild(t);
    });

    const checkRow = document.createElement("div");
    checkRow.className = "quick-strip";
    checkRow.style.justifyContent = "center";
    checkRow.style.marginTop = "12px";

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn";
    checkBtn.textContent = "Check Word";
    checkBtn.onclick = ()=>{
      const built = boxes.map(b=>b.dataset.value || "").join("").toLowerCase();
      if (!built || built.length < 3){
        gameResult.textContent = "Add 3 letters ğŸ™‚";
        return;
      }
      if (BAD_WORDS.has(built)){
        gameResult.textContent = "Oops â€” try a different word ğŸ™‚";
        boxes.forEach(b=>{ b.textContent=""; b.dataset.value=""; });
        return;
      }
      if (built === target){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    };

    const clearBtn = document.createElement("button");
    clearBtn.className = "btn secondary";
    clearBtn.textContent = "Clear";
    clearBtn.onclick = ()=>{
      boxes.forEach(b=>{ b.textContent=""; b.dataset.value=""; });
      gameResult.textContent = "";
    };

    checkRow.appendChild(checkBtn);
    checkRow.appendChild(clearBtn);

    stage.appendChild(row);
    stage.appendChild(tiles);
    stage.appendChild(checkRow);

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  // ---- Tracing Game ----
  function renderTracing(){
    setGameHeader("âœï¸ Tracing Game", "Trace the letter on the board.");
    const lettersByGrade = grade === "2" ? ["A","E","I","O","U","M","S","T"] : ["A","M","S","T","E","I"];
    const letter = lettersByGrade[gIndex % lettersByGrade.length];

    lastGameItem = { letter };

    gamePrompt.textContent = `Trace: ${letter}`;
    gameSupport.textContent = "Use your mouse or finger (touch screen).";

    const stage = document.createElement("div");
    stage.style.display = "grid";
    stage.style.gap = "10px";

    const topRow = document.createElement("div");
    topRow.className = "quick-strip";
    topRow.style.justifyContent = "center";

    const upperBtn = document.createElement("button");
    upperBtn.className = "pill active";
    upperBtn.textContent = "Uppercase";
    const lowerBtn = document.createElement("button");
    lowerBtn.className = "pill";
    lowerBtn.textContent = "Lowercase";

    let isLower = false;
    function setCase(lower){
      isLower = lower;
      upperBtn.classList.toggle("active", !isLower);
      lowerBtn.classList.toggle("active", isLower);
      drawGuide();
    }

    upperBtn.onclick = ()=> setCase(false);
    lowerBtn.onclick = ()=> setCase(true);

    topRow.appendChild(upperBtn);
    topRow.appendChild(lowerBtn);

    const canvas = document.createElement("canvas");
    canvas.width = 900;
    canvas.height = 420;
    canvas.style.width = "100%";
    canvas.style.maxWidth = "900px";
    canvas.style.borderRadius = "22px";
    canvas.style.border = "2px solid rgba(0,0,0,0.08)";
    canvas.style.background = "white";
    canvas.style.margin = "0 auto";
    canvas.style.display = "block";

    const ctx = canvas.getContext("2d");

    function drawGuide(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // guide lines
      ctx.globalAlpha = 0.14;
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(80, 140); ctx.lineTo(820, 140);
      ctx.moveTo(80, 280); ctx.lineTo(820, 280);
      ctx.strokeStyle = "#0b3d2e";
      ctx.stroke();
      ctx.globalAlpha = 1;

      // big letter
      ctx.save();
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "#0b3d2e";
      ctx.font = "260px 'Baloo 2', cursive";
      const L = isLower ? letter.toLowerCase() : letter;
      ctx.fillText(L, 360, 305);
      ctx.restore();
    }

    let drawing = false;
    function pos(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
      return { x: x*(canvas.width/r.width), y: y*(canvas.height/r.height) };
    }

    function start(e){
      drawing = true;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(p.x,p.y);
      e.preventDefault();
    }
    function move(e){
      if (!drawing) return;
      const p = pos(e);
      ctx.lineTo(p.x,p.y);
      ctx.strokeStyle = "#0b3d2e";
      ctx.lineWidth = 12;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.stroke();
      e.preventDefault();
    }
    function end(e){
      drawing = false;
      e.preventDefault();
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    canvas.addEventListener("mouseup", end);
    canvas.addEventListener("mouseleave", end);

    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    canvas.addEventListener("touchend", end, {passive:false});

    const controls = document.createElement("div");
    controls.className = "quick-strip";
    controls.style.justifyContent = "center";

    const clear = document.createElement("button");
    clear.className = "btn secondary";
    clear.textContent = "Clear";
    clear.onclick = ()=>{ drawGuide(); gameResult.textContent=""; };

    const done = document.createElement("button");
    done.className = "btn";
    done.textContent = "Done!";
    done.onclick = ()=>{
      gameResult.textContent = "Nice tracing! â­";
      addStar();
      const p = load(PROG_KEY, {tracingDone:0});
      p.tracingDone = (p.tracingDone || 0) + 1;
      save(PROG_KEY, p);
    };

    controls.appendChild(done);
    controls.appendChild(clear);

    stage.appendChild(topRow);
    stage.appendChild(canvas);
    stage.appendChild(controls);

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);

    drawGuide();
  }

  // ---- Typing Game ----
  function renderTyping(){
    setGameHeader("âŒ¨ï¸ Typing Game", "Type what you hear.");
    const pool = grade === "2"
      ? ["rain","boat","seed","chain","goat","feet"]
      : ["cat","map","sun","top","sit","mop"];

    const target = pool[gIndex % pool.length];
    lastGameItem = { target };

    gamePrompt.textContent = "Listen, then type the word.";
    gameSupport.textContent = "Tap ğŸ”Š then type in the box.";

    const stage = document.createElement("div");
    stage.style.display = "grid";
    stage.style.gap = "12px";
    stage.style.justifyItems = "center";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Type hereâ€¦";
    input.style.width = "min(520px, 100%)";
    input.style.padding = "14px 16px";
    input.style.borderRadius = "999px";
    input.style.border = "2px solid rgba(0,0,0,0.12)";
    input.style.fontSize = "18px";
    input.style.fontFamily = "inherit";

    const row = document.createElement("div");
    row.className = "quick-strip";
    row.style.justifyContent = "center";

    const check = document.createElement("button");
    check.className = "btn";
    check.textContent = "Check";
    check.onclick = ()=>{
      const val = (input.value || "").trim().toLowerCase();
      if (!val) { gameResult.textContent = "Type something ğŸ™‚"; return; }
      if (val === target){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    };

    const show = document.createElement("button");
    show.className = "btn secondary";
    show.textContent = "Show Word";
    show.onclick = ()=>{
      gameResult.textContent = `Word: ${target}`;
    };

    row.appendChild(check);
    row.appendChild(show);

    stage.appendChild(input);
    stage.appendChild(row);

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  // ---- Mystery Reveal ----
  function renderMystery(){
    setGameHeader("ğŸ Mystery Reveal", "Answer to reveal a surprise!");
    if (!reveal.target || gIndex === 0){
      reveal.target = MYSTERY[Math.floor(Math.random()*MYSTERY.length)];
      reveal.pieces = 0;
    }

    // Use sound->letter questions as the engine
    const items = SOUND_ITEMS[grade] || SOUND_ITEMS["K"];
    const q = items[gIndex % items.length];
    lastGameItem = { type:"sound", soundKey:q.soundKey, say:q.say };

    gamePrompt.textContent = "Which letter(s) match the sound?";
    gameSupport.textContent = "Tap ğŸ”Š then choose.";

    const stage = document.createElement("div");

    const revealBox = document.createElement("div");
    revealBox.className = "card";
    revealBox.style.textAlign = "center";
    revealBox.innerHTML = `
      <h3 style="margin-bottom:6px;">Mystery Picture</h3>
      <div style="font-size:64px; margin:8px 0;">${reveal.pieces >= 3 ? reveal.target.pic : "â“"}</div>
      <div class="small">${reveal.pieces}/3 pieces</div>
    `;

    const choices = renderChoiceCards(q.choices, (pick)=>{
      if (pick === q.correct){
        addStar();
        reveal.pieces = Math.min(3, reveal.pieces + 1);
        gameResult.textContent = (reveal.pieces >= 3)
          ? `You revealed: ${reveal.target.name}! â­â­`
          : "Correct! You earned a piece â­";
        renderGame(); // re-render to show progress
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    });

    stage.appendChild(revealBox);
    stage.appendChild(choices);

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  // ---- Core multiple choice games ----
  function renderSoundToLetter(){
    setGameHeader("ğŸ”Š Sound â†’ Letter", "Listen then choose.");
    const items = SOUND_ITEMS[grade] || SOUND_ITEMS["K"];
    const q = items[gIndex % items.length];
    lastGameItem = { type:"sound", soundKey:q.soundKey, tts:"Listen." };

    gamePrompt.textContent = "Which letter(s) make this sound?";
    gameSupport.textContent = "Tap ğŸ”Š then choose.";

    const stage = renderChoiceCards(q.choices, (pick)=>{
      if (pick === q.correct){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = `Try again ğŸ™‚`;
      }
    });

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  function renderLetterToSound(){
    setGameHeader("ğŸ”¤ Letter â†’ Sound", "Look then choose.");
    const items = LETTER_ITEMS[grade] || LETTER_ITEMS["K"];
    const q = items[gIndex % items.length];
    lastGameItem = { type:"letter", letter:q.letter, tts:`${q.letter}` };

    gamePrompt.textContent = `What sound does: ${q.letter} make?`;
    gameSupport.textContent = "Tap ğŸ”Š to hear the letter name (optional).";

    const stage = renderChoiceCards(q.choices, (pick)=>{
      if (pick === q.correct){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    });

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  function renderPictureLabel(){
    setGameHeader("ğŸ–¼ï¸ Picture Starter", "Pick the beginning sound/letters.");
    const items = PICTURE_ITEMS[grade] || PICTURE_ITEMS["K"];
    const q = items[gIndex % items.length];
    lastGameItem = { type:"tts", tts:`${q.word}` };

    gamePrompt.innerHTML = `${q.emoji} What does <strong>${q.word}</strong> start with?`;
    gameSupport.textContent = "Say the word out loud, then choose.";

    const stage = renderChoiceCards(q.choices, (pick)=>{
      if (pick === q.correct){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    });

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  function renderWordFamilyTrain(){
    setGameHeader("ğŸš‚ Word Family Train", "Pick the word that matches the family!");
    const families = ["-at","-op","-it","-an","-ug"];
    const fam = families[gIndex % families.length];

    const pool = {
      "-at": {good:["cat","hat","bat"], bad:["sit","sun","mop"]},
      "-op": {good:["mop","top","hop"], bad:["cat","sit","map"]},
      "-it": {good:["sit","hit","fit"], bad:["sun","mop","cat"]},
      "-an": {good:["man","fan","pan"], bad:["mop","sit","cat"]},
      "-ug": {good:["bug","hug","rug"], bad:["cat","mop","sit"]}
    };

    const options = shuffle(pool[fam].good.slice(0,2).concat(pool[fam].bad.slice(0,1)));
    const correctSet = new Set(pool[fam].good);

    lastGameItem = { type:"tts", tts:`Find a ${fam} word.` };

    gamePrompt.textContent = `Which word belongs to the ${fam} family?`;
    gameSupport.textContent = "Choose the best match.";

    const stage = renderChoiceCards(options, (pick)=>{
      if (correctSet.has(pick)){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    });

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  function renderVowelTreasure(){
    setGameHeader("ğŸ§­ Vowel Team Treasure", "Choose the vowel team.");
    const items = [
      {word:"rain", correct:"AI", choices:["AI","EE","OA"]},
      {word:"boat", correct:"OA", choices:["OA","EE","AI"]},
      {word:"feet", correct:"EE", choices:["EE","AI","OA"]}
    ];
    const q = items[gIndex % items.length];
    lastGameItem = { type:"tts", tts:q.word };

    gamePrompt.textContent = `Which vowel team is in: ${q.word}?`;
    gameSupport.textContent = "Tap ğŸ”Š to hear the word (optional).";

    const stage = renderChoiceCards(q.choices, (pick)=>{
      if (pick === q.correct){
        gameResult.textContent = "Correct! â­";
        addStar();
      } else {
        gameResult.textContent = "Try again ğŸ™‚";
      }
    });

    gameStage.innerHTML = "";
    gameStage.appendChild(stage);
  }

  function renderGame(){
    gameResult.textContent = "";

    if (activeGame === "soundToLetter") return renderSoundToLetter();
    if (activeGame === "letterToSound") return renderLetterToSound();
    if (activeGame === "pictureLabel") return renderPictureLabel();
    if (activeGame === "cvcBuilder") return renderCVCBuilder();
    if (activeGame === "wordFamilyTrain") return renderWordFamilyTrain();
    if (activeGame === "vowelTreasure") return renderVowelTreasure();
    if (activeGame === "mysteryReveal") return renderMystery();
    if (activeGame === "typingGame") return renderTyping();
    if (activeGame === "tracingGame") return renderTracing();
  }

  function gamePlaySound(){
    if (!lastGameItem) return;

    if (lastGameItem.type === "sound") {
      playFileOrTTS(soundAudio[lastGameItem.soundKey], "Listen.");
    } else if (lastGameItem.type === "letter") {
      // If it is a single letter and you have audio, use it; otherwise TTS
      const L = String(lastGameItem.letter || "");
      const single = L.length === 1 ? letterAudio[L] : null;
      playFileOrTTS(single, L);
    } else if (lastGameItem.type === "tts") {
      speak(lastGameItem.tts || "");
    } else if (lastGameItem.target) {
      speak(lastGameItem.target);
    } else {
      speak("Listen.");
    }
  }

  // =========================
  // Buttons
  // =========================
  document.getElementById("startDiagBtn").onclick = openDiagnostic;
  diagSoundBtn.onclick = diagPlaySound;
  document.getElementById("diagNextBtn").onclick = ()=> diagNext(false);
  document.getElementById("diagSkipBtn").onclick = ()=> diagNext(true);

  document.getElementById("openGamesBtn").onclick = openGames;
  document.getElementById("goGamesBtn").onclick = openGames;

  document.getElementById("retakeBtn").onclick = ()=>{
    const saved = load(PHONICS_DIAG_KEY, null);
    if (saved && saved.grade === grade) localStorage.removeItem(PHONICS_DIAG_KEY);
    afterDiagWrap.style.display = "none";
    gamesHub.style.display = "none";
    gamePlayWrap.style.display = "none";
    diagWrap.style.display = "none";
    refreshGoGamesEnabled();
    alert("Diagnostic cleared. Press Start Diagnostic to begin again!");
  };

  document.getElementById("gameNextBtn").onclick = ()=>{
    gIndex++;
    renderGame();
  };

  document.getElementById("backToGamesBtn").onclick = ()=>{
    gamePlayWrap.style.display = "none";
    gamesHub.style.display = "block";
    window.scrollTo({top: gamesHub.offsetTop - 10, behavior:"smooth"});
  };

  gameSoundBtn.onclick = gamePlaySound;

  // Init: enable "Choose a Game" if diag exists for this grade
  refreshGoGamesEnabled();
  refreshGameHub();
</script>

</body>
</html>
