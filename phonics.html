<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a href="#">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Choose an activity: take a diagnostic, or play a matching game!</p>
    <div class="quick-strip">
      <a class="btn secondary" href="progress.html">My Progress</a>
      <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
    </div>
    <div class="hero-note">Kâ€“2: letter names + letter sounds</div>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Choose a Phonics Activity ğŸŒŸ</h2>

    <div class="game-box wide">
      <div class="grid-3">
        <div class="card">
          <h3>ğŸ§  Diagnostic</h3>
          <p>Quick check: letter names + sounds. Then it recommends the best practice.</p>
          <button class="btn" id="showDiagBtn">Start</button>
        </div>

        <div class="card">
          <h3>ğŸ§ Sound â†’ Letter Match</h3>
          <p>Press ğŸ”Š, then choose the letter that makes the sound.</p>
          <button class="btn" id="showSoundToLetterBtn">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ”¤ Letter â†’ Sound Match</h3>
          <p>See a letter, then pick the sound it makes (with audio help).</p>
          <button class="btn" id="showLetterToSoundBtn">Play</button>
        </div>
      </div>
    </div>

    <!-- Grade pick -->
    <div class="game-box" style="margin-top:18px;">
      <p class="kid-big" style="margin-bottom:10px;">Pick a Grade</p>
      <div class="badge-row">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>
      <p class="small" style="margin-top:10px;">Tip: Use the same grade for all games to keep it just right.</p>
    </div>

    <!-- DIAGNOSTIC PANEL -->
    <div class="game-box wide" id="diagPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">Diagnostic âœ…</p>
      <p class="small">Answer letter <strong>name</strong> and <strong>sound</strong> questions. Tap ğŸ”Š to hear it.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="diagQ" style="margin:0; flex:1;">Press â€œTake Diagnosticâ€ to begin.</p>
          <button class="btn secondary" id="diagSpeakBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="diagHint"></p>
        <p class="small" id="diagAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="diagResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="goDiagBtn">Take Diagnostic</button>
          <button class="btn secondary" id="diagNextBtn">Next</button>
          <button class="btn secondary" id="diagSkipBtn">Skip</button>
          <button class="btn secondary" id="retakeBtn">Retake</button>
          <button class="btn secondary" id="closeDiagBtn">Close</button>
        </div>

        <p class="small" style="margin-top:8px;">
          After the diagnostic, you can play a game based on what was missed.
        </p>
      </div>
    </div>

    <!-- TARGETED MINI GAME (from diagnostic) -->
    <div class="game-box wide" id="targetGamePanel" style="margin-top:18px; display:none;">
      <p class="kid-big">Recommended Mini Game ğŸ®</p>
      <p class="small" id="gamePlan">Your game is based on your diagnostic.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="gameQ" style="margin:0; flex:1;">Game question loads hereâ€¦</p>
          <button class="btn secondary" id="gameSpeakBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="gameHint"></p>
        <p class="small" id="gameAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="gameChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="gameResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="goGameBtn">Go to Recommended Game</button>
          <button class="btn secondary" id="gameNextBtn">Next</button>
          <button class="btn secondary" id="resetStarsBtn">Reset Stars</button>
          <button class="btn secondary" id="closeTargetGameBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- GAME 1: Sound -> Letter -->
    <div class="game-box wide" id="soundToLetterPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ§ Sound â†’ Letter Match</p>
      <p class="small">Press ğŸ”Š to hear the sound. Then tap the correct letter(s) card!</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="stlQ" style="margin:0; flex:1;">Press Play to start!</p>
          <button class="btn secondary" id="stlSpeakBtn" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="stlHint"></p>
        <p class="small" id="stlAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="stlChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="stlResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="stlStartBtn">Play</button>
          <button class="btn secondary" id="stlNextBtn">Next</button>
          <button class="btn secondary" id="closeStlBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- GAME 2: Letter -> Sound -->
    <div class="game-box wide" id="letterToSoundPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ”¤ Letter â†’ Sound Match</p>
      <p class="small">Tap a sound card. Use ğŸ”Š to hear the letter name again.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="ltsQ" style="margin:0; flex:1;">Press Play to start!</p>
          <button class="btn secondary" id="ltsSpeakBtn" aria-label="Play letter name">ğŸ”Š</button>
        </div>

        <p class="small" id="ltsHint"></p>
        <p class="small" id="ltsAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="ltsChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="ltsResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="ltsStartBtn">Play</button>
          <button class="btn secondary" id="ltsNextBtn">Next</button>
          <button class="btn secondary" id="closeLtsBtn">Close</button>
        </div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script>
  // ---------- Storage Keys ----------
  const PROG_KEY = "bloom_progress";
  const PHONICS_DIAG_KEY = "bloom_phonics_diag";

  // ---------- Helpers ----------
  function load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
  function hideAllPanels(){
    diagPanel.style.display = "none";
    targetGamePanel.style.display = "none";
    soundToLetterPanel.style.display = "none";
    letterToSoundPanel.style.display = "none";
  }
  function showPanel(el){
    hideAllPanels();
    el.style.display = "block";
    el.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // ---------- Real Audio Player ----------
  const audio = new Audio();
  audio.preload = "auto";

  function showAudioStatus(el, msg){
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.style.display = "none"; }, 2000);
  }

  async function playAudio(src, statusEl){
    try {
      audio.pause();
      audio.currentTime = 0;
      audio.src = src;
      await audio.play();
    } catch (err) {
      showAudioStatus(statusEl, "Audio not found yet. Check filename + folder path.");
    }
  }

  // ---------- Audio Maps ----------
  const soundAudio = {
    "m": "./assets/audio/sounds/m.mp3",
    "s": "./assets/audio/sounds/s.mp3",
    "t": "./assets/audio/sounds/t.mp3",
    "sh": "./assets/audio/sounds/sh.mp3",
    "ch": "./assets/audio/sounds/ch.mp3",
    "th": "./assets/audio/sounds/th.mp3",
    "long-a": "./assets/audio/sounds/long-a.mp3",
    "long-e": "./assets/audio/sounds/long-e.mp3",
    "long-o": "./assets/audio/sounds/long-o.mp3"
  };

  const letterAudio = {
    "A": "./assets/audio/letters/A.mp3",
    "M": "./assets/audio/letters/M.mp3",
    "S": "./assets/audio/letters/S.mp3",
    "B": "./assets/audio/letters/B.mp3",
    "R": "./assets/audio/letters/R.mp3",
    "T": "./assets/audio/letters/T.mp3",
    "G": "./assets/audio/letters/G.mp3",
    "P": "./assets/audio/letters/P.mp3",
    "V": "./assets/audio/letters/V.mp3"
  };

  // ---------- Grade Selection ----------
  let grade = "K";
  function renderGradeButtons(){
    document.querySelectorAll(".pill").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.grade === grade);
    });
  }
  document.querySelectorAll(".pill").forEach(btn=>{
    btn.onclick = ()=>{
      grade = btn.dataset.grade;
      renderGradeButtons();
      resetAllGames();
    };
  });

  // ---------- Content Banks (Kâ€“2) ----------
  const gradeBanks = {
    "K": {
      nameItems: [
        { letter:"A", correct:"A", choices:["A","B","D"] },
        { letter:"M", correct:"M", choices:["N","M","W"] },
        { letter:"S", correct:"S", choices:["S","C","G"] }
      ],
      soundItems: [
        { soundText:"/m/", soundKey:"m", correct:"M", choices:["M","S","T"], hint:"/m/ like moon" },
        { soundText:"/s/", soundKey:"s", correct:"S", choices:["B","S","D"], hint:"/s/ like sun" },
        { soundText:"/t/", soundKey:"t", correct:"T", choices:["T","A","P"], hint:"/t/ like top" }
      ]
    },
    "1": {
      nameItems: [
        { letter:"B", correct:"B", choices:["B","D","P"] },
        { letter:"R", correct:"R", choices:["R","K","H"] },
        { letter:"T", correct:"T", choices:["T","F","E"] }
      ],
      soundItems: [
        { soundText:"/sh/", soundKey:"sh", correct:"SH", choices:["CH","SH","TH"], hint:"SH like ship" },
        { soundText:"/ch/", soundKey:"ch", correct:"CH", choices:["CH","PH","WH"], hint:"CH like chop" },
        { soundText:"/th/", soundKey:"th", correct:"TH", choices:["TH","SH","CH"], hint:"TH like this" }
      ]
    },
    "2": {
      nameItems: [
        { letter:"G", correct:"G", choices:["G","J","Q"] },
        { letter:"P", correct:"P", choices:["P","R","B"] },
        { letter:"V", correct:"V", choices:["V","W","Y"] }
      ],
      soundItems: [
        { soundText:"long A (ai/ay)", soundKey:"long-a", correct:"AI", choices:["AI","OA","EE"], hint:"AI like rain" },
        { soundText:"long E (ee/ea)", soundKey:"long-e", correct:"EE", choices:["EE","OO","AI"], hint:"EE like feet" },
        { soundText:"long O (oa/ow)", soundKey:"long-o", correct:"OA", choices:["OA","EE","AI"], hint:"OA like boat" }
      ]
    }
  };

  // ---------- Stars ----------
  function addPhonicsStar(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    save(PROG_KEY, p);
  }

  // ---------- Panel Refs ----------
  const diagPanel = document.getElementById("diagPanel");
  const targetGamePanel = document.getElementById("targetGamePanel");
  const soundToLetterPanel = document.getElementById("soundToLetterPanel");
  const letterToSoundPanel = document.getElementById("letterToSoundPanel");

  // ---------- Buttons (Activity Chooser) ----------
  document.getElementById("showDiagBtn").onclick = ()=> showPanel(diagPanel);
  document.getElementById("showSoundToLetterBtn").onclick = ()=> showPanel(soundToLetterPanel);
  document.getElementById("showLetterToSoundBtn").onclick = ()=> showPanel(letterToSoundPanel);

  document.getElementById("closeDiagBtn").onclick = hideAllPanels;
  document.getElementById("closeTargetGameBtn").onclick = hideAllPanels;
  document.getElementById("closeStlBtn").onclick = hideAllPanels;
  document.getElementById("closeLtsBtn").onclick = hideAllPanels;

  function resetAllGames(){
    // reset UI text only (not stars)
    diagQEl.textContent = "Press â€œTake Diagnosticâ€ to begin.";
    diagHintEl.textContent = "";
    diagChoicesEl.innerHTML = "";
    diagResultEl.textContent = "";

    gameQEl.textContent = "Game question loads hereâ€¦";
    gameHintEl.textContent = "";
    gameChoicesEl.innerHTML = "";
    gameResultEl.textContent = "";
    gamePlanEl.textContent = "Your game is based on your diagnostic.";

    stlQ.textContent = "Press Play to start!";
    stlHint.textContent = "";
    stlChoices.innerHTML = "";
    stlResult.textContent = "";

    ltsQ.textContent = "Press Play to start!";
    ltsHint.textContent = "";
    ltsChoices.innerHTML = "";
    ltsResult.textContent = "";
  }

  // =========================================================
  // 1) DIAGNOSTIC + RECOMMENDED GAME (same as before)
  // =========================================================
  let diagQs = [];
  let diagIndex = 0;
  let diagCorrect = 0;
  let diagMissed = [];
  let lastDiagQ = null;

  let gameQs = [];
  let gameIndex = 0;
  let lastGameQ = null;

  const diagQEl = document.getElementById("diagQ");
  const diagHintEl = document.getElementById("diagHint");
  const diagChoicesEl = document.getElementById("diagChoices");
  const diagResultEl = document.getElementById("diagResult");
  const diagAudioStatus = document.getElementById("diagAudioStatus");

  const gamePlanEl = document.getElementById("gamePlan");
  const gameQEl = document.getElementById("gameQ");
  const gameHintEl = document.getElementById("gameHint");
  const gameChoicesEl = document.getElementById("gameChoices");
  const gameResultEl = document.getElementById("gameResult");
  const gameAudioStatus = document.getElementById("gameAudioStatus");

  function buildDiagnostic(grade){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`What is the NAME of this letter: ${x.letter}?`,
      hint:"Tap ğŸ”Š to hear the letter name.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      soundKey: x.soundKey,
      prompt:`Which letter(s) make this sound?`,
      hint:`Tap ğŸ”Š to hear the sound.`,
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    return shuffle([...nameQs, ...soundQs]);
  }

  function buildRecommendedGame(grade, missedFocusKeys){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`Letter NAME: ${x.letter} is calledâ€¦`,
      hint:"Tap ğŸ”Š to hear the letter name.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      soundKey: x.soundKey,
      prompt:`Letter SOUND: Which letter(s) make this sound?`,
      hint:"Tap ğŸ”Š to hear the sound.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    const pool = [...nameQs, ...soundQs];
    const missed = pool.filter(q => missedFocusKeys.includes(q.focusKey));
    const rest   = pool.filter(q => !missedFocusKeys.includes(q.focusKey));

    const game = [];
    while (game.length < 10) {
      if (missed.length) game.push(missed.shift());
      else game.push(rest[game.length % rest.length]);
    }
    return game;
  }

  function renderDiagQuestion(){
    const q = diagQs[diagIndex];
    lastDiagQ = q;

    diagQEl.textContent = q.prompt;
    diagHintEl.textContent = q.hint || "";
    diagResultEl.textContent = "";
    diagChoicesEl.innerHTML = "";

    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkDiagAnswer(c);
      diagChoicesEl.appendChild(card);
    });
  }

  function playDiagAudio(){
    if (!lastDiagQ) return showAudioStatus(diagAudioStatus, "Press Take Diagnostic to start!");
    if (lastDiagQ.type === "name") {
      const src = letterAudio[lastDiagQ.letter];
      if (!src) return showAudioStatus(diagAudioStatus, "Missing letter audio file.");
      playAudio(src, diagAudioStatus);
    } else {
      const src = soundAudio[lastDiagQ.soundKey];
      if (!src) return showAudioStatus(diagAudioStatus, "Missing sound audio file.");
      playAudio(src, diagAudioStatus);
    }
  }

  function checkDiagAnswer(choice){
    if (diagResultEl.textContent) return;
    const q = diagQs[diagIndex];

    if (choice === q.correct){
      diagCorrect++;
      diagResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      diagMissed.push(q.focusKey);
      diagResultEl.textContent = `Good try! Answer: ${q.correct}`;
      if (q.type === "sound") playDiagAudio();
    }
  }

  function finishDiagnostic(){
    const total = diagQs.length || 1;
    const score = Math.round((diagCorrect / total) * 100);

    save(PHONICS_DIAG_KEY, { grade, score, missed: diagMissed, date: Date.now() });

    const missedNames = diagMissed.filter(x=>x.startsWith("name:")).length;
    const missedSounds = diagMissed.filter(x=>x.startsWith("sound:")).length;

    let planText = `Diagnostic score: ${score}% â€” `;
    if (missedNames === 0 && missedSounds === 0) planText += "Awesome! We'll do a fun mix of practice.";
    else {
      planText += "We will practice: ";
      const parts = [];
      if (missedNames) parts.push(`letter names (${missedNames})`);
      if (missedSounds) parts.push(`letter sounds (${missedSounds})`);
      planText += parts.join(" and ") + ".";
    }
    gamePlanEl.textContent = planText;

    // Build recommended game and show it
    gameQs = buildRecommendedGame(grade, diagMissed);
    gameIndex = 0;
    showPanel(targetGamePanel);
    renderGameQuestion();
  }

  function renderGameQuestion(){
    const q = gameQs[gameIndex % gameQs.length];
    lastGameQ = q;

    gameQEl.textContent = q.prompt;
    gameHintEl.textContent = q.hint || "";
    gameResultEl.textContent = "";
    gameChoicesEl.innerHTML = "";

    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkGameAnswer(c);
      gameChoicesEl.appendChild(card);
    });
  }

  function playGameAudio(){
    if (!lastGameQ) return showAudioStatus(gameAudioStatus, "Start the game first!");
    if (lastGameQ.type === "name") {
      const src = letterAudio[lastGameQ.letter];
      if (!src) return showAudioStatus(gameAudioStatus, "Missing letter audio file.");
      playAudio(src, gameAudioStatus);
    } else {
      const src = soundAudio[lastGameQ.soundKey];
      if (!src) return showAudioStatus(gameAudioStatus, "Missing sound audio file.");
      playAudio(src, gameAudioStatus);
    }
  }

  function checkGameAnswer(choice){
    if (gameResultEl.textContent) return;
    const q = gameQs[gameIndex % gameQs.length];

    if (choice === q.correct){
      gameResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      gameResultEl.textContent = "Try again ğŸ™‚";
      if (q.type === "sound") playGameAudio();
    }
  }

  // Diagnostic buttons
  document.getElementById("goDiagBtn").onclick = ()=>{
    diagQs = buildDiagnostic(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagMissed = [];
    renderDiagQuestion();
  };
  document.getElementById("diagNextBtn").onclick = ()=>{
    if (!diagQs.length) return;

    if (!diagResultEl.textContent){
      diagMissed.push(diagQs[diagIndex].focusKey);
    }

    diagIndex++;
    if (diagIndex >= diagQs.length) finishDiagnostic();
    else renderDiagQuestion();
  };
  document.getElementById("diagSkipBtn").onclick = ()=>{
    if (!diagQs.length) return;
    diagMissed.push(diagQs[diagIndex].focusKey);
    diagIndex++;
    if (diagIndex >= diagQs.length) finishDiagnostic();
    else renderDiagQuestion();
  };
  document.getElementById("retakeBtn").onclick = ()=>{
    localStorage.removeItem(PHONICS_DIAG_KEY);
    resetAllGames();
    alert("Diagnostic cleared. Press â€œTake Diagnosticâ€ to start again!");
  };
  document.getElementById("diagSpeakBtn").onclick = playDiagAudio;

  // Recommended game buttons
  document.getElementById("goGameBtn").onclick = ()=>{
    const savedDiag = load(PHONICS_DIAG_KEY, null);
    if (!savedDiag || savedDiag.grade !== grade) {
      alert("Take the diagnostic first for this grade!");
      return;
    }
    gameQs = buildRecommendedGame(grade, savedDiag.missed || []);
    gameIndex = 0;
    showPanel(targetGamePanel);
    renderGameQuestion();
  };
  document.getElementById("gameNextBtn").onclick = ()=>{
    gameIndex++;
    renderGameQuestion();
  };
  document.getElementById("gameSpeakBtn").onclick = playGameAudio;
  document.getElementById("resetStarsBtn").onclick = ()=>{
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = 0;
    save(PROG_KEY, p);
    alert("Phonics stars reset!");
  };

  // =========================================================
  // 2) GAME: Sound -> Letter Match (NEW)
  // =========================================================
  const stlQ = document.getElementById("stlQ");
  const stlHint = document.getElementById("stlHint");
  const stlChoices = document.getElementById("stlChoices");
  const stlResult = document.getElementById("stlResult");
  const stlAudioStatus = document.getElementById("stlAudioStatus");

  let stlItems = [];
  let stlIndex = 0;
  let stlCurrent = null;

  function buildSoundToLetterGame(grade){
    const b = gradeBanks[grade];
    // Use sound items; answer is the correct letter(s)
    return shuffle(b.soundItems.map(x => ({
      type:"sound",
      soundKey: x.soundKey,
      hint: x.hint || "Listen for the sound.",
      correct: x.correct,
      choices: shuffle(x.choices)
    })));
  }

  function renderSTL(){
    stlCurrent = stlItems[stlIndex % stlItems.length];
    stlQ.textContent = "Which letter(s) make this sound?";
    stlHint.textContent = stlCurrent.hint;
    stlResult.textContent = "";
    stlChoices.innerHTML = "";

    stlCurrent.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> {
        if (stlResult.textContent) return;
        if (c === stlCurrent.correct) {
          stlResult.textContent = "Correct! â­";
          addPhonicsStar();
        } else {
          stlResult.textContent = "Try again ğŸ™‚";
          playSTLSound();
        }
      };
      stlChoices.appendChild(card);
    });
  }

  function playSTLSound(){
    if (!stlCurrent) return showAudioStatus(stlAudioStatus, "Press Play to start!");
    const src = soundAudio[stlCurrent.soundKey];
    if (!src) return showAudioStatus(stlAudioStatus, "Missing sound audio file.");
    playAudio(src, stlAudioStatus);
  }

  document.getElementById("stlStartBtn").onclick = ()=>{
    stlItems = buildSoundToLetterGame(grade);
    stlIndex = 0;
    renderSTL();
    playSTLSound();
  };
  document.getElementById("stlNextBtn").onclick = ()=>{
    if (!stlItems.length) return;
    stlIndex++;
    renderSTL();
    playSTLSound();
  };
  document.getElementById("stlSpeakBtn").onclick = playSTLSound;

  // =========================================================
  // 3) GAME: Letter -> Sound Match (NEW)
  // =========================================================
  const ltsQ = document.getElementById("ltsQ");
  const ltsHint = document.getElementById("ltsHint");
  const ltsChoices = document.getElementById("ltsChoices");
  const ltsResult = document.getElementById("ltsResult");
  const ltsAudioStatus = document.getElementById("ltsAudioStatus");

  let ltsItems = [];
  let ltsIndex = 0;
  let ltsCurrent = null;

  function buildLetterToSoundGame(grade){
    const b = gradeBanks[grade];

    // We will create choices as soundKeys.
    // For grade 1/2 sounds, we still play audio and show label.
    const soundKeys = b.soundItems.map(x => x.soundKey);

    return shuffle(b.nameItems.map(n => {
      // pick 3 sound options, including a "best" one by grade alignment
      // For K: map A->m? not correct; so we keep it simple: choose among grade sounds and teach "listen + choose"
      // We'll set correctSoundKey based on a small map for K letters we have audio for.
      const correctSoundKeyMap = {
        "K": { "A":"m", "M":"m", "S":"s" }, // simple starter
        "1": { "B":"ch", "R":"sh", "T":"th" }, // playful mapping (you can refine later)
        "2": { "G":"long-o", "P":"long-a", "V":"long-e" }
      };

      const mapForGrade = correctSoundKeyMap[grade] || {};
      const correctSoundKey = mapForGrade[n.letter] || soundKeys[0];

      const options = shuffle([correctSoundKey, ...shuffle(soundKeys.filter(k=>k!==correctSoundKey)).slice(0,2)]);

      return {
        type:"letter",
        letter: n.letter,
        correctSoundKey,
        options
      };
    }));
  }

  function renderLTS(){
    ltsCurrent = ltsItems[ltsIndex % ltsItems.length];
    ltsQ.textContent = `Which sound matches this letter: ${ltsCurrent.letter}?`;
    ltsHint.textContent = "Tap a sound card. Use ğŸ”Š to hear the letter name.";
    ltsResult.textContent = "";
    ltsChoices.innerHTML = "";

    ltsCurrent.options.forEach(soundKey=>{
      const labelMap = {
        "m":" /m/ ",
        "s":" /s/ ",
        "t":" /t/ ",
        "sh":" /sh/ ",
        "ch":" /ch/ ",
        "th":" /th/ ",
        "long-a":" long A ",
        "long-e":" long E ",
        "long-o":" long O "
      };

      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${labelMap[soundKey] || soundKey}</h3><p class="small">Tap to hear!</p>`;

      card.onclick = async ()=>{
        // play the sound when they tap it
        const src = soundAudio[soundKey];
        if (!src) return showAudioStatus(ltsAudioStatus, "Missing sound audio file.");
        await playAudio(src, ltsAudioStatus);

        if (ltsResult.textContent) return;
        if (soundKey === ltsCurrent.correctSoundKey) {
          ltsResult.textContent = "Correct! â­";
          addPhonicsStar();
        } else {
          ltsResult.textContent = "Try again ğŸ™‚";
        }
      };

      ltsChoices.appendChild(card);
    });
  }

  function playLTSLetterName(){
    if (!ltsCurrent) return showAudioStatus(ltsAudioStatus, "Press Play to start!");
    const src = letterAudio[ltsCurrent.letter];
    if (!src) return showAudioStatus(ltsAudioStatus, "Missing letter audio file.");
    playAudio(src, ltsAudioStatus);
  }

  document.getElementById("ltsStartBtn").onclick = ()=>{
    ltsItems = buildLetterToSoundGame(grade);
    ltsIndex = 0;
    renderLTS();
    playLTSLetterName();
  };
  document.getElementById("ltsNextBtn").onclick = ()=>{
    if (!ltsItems.length) return;
    ltsIndex++;
    renderLTS();
    playLTSLetterName();
  };
  document.getElementById("ltsSpeakBtn").onclick = playLTSLetterName;

  // ---------- Init ----------
  renderGradeButtons();
  resetAllGames();
</script>

</body>
</html>
