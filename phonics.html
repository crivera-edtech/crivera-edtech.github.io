<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a href="#">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics ğŸ”¤</h1>
    <p>Take a quick diagnostic. Then play a game based on what you need most!</p>
    <div class="quick-strip">
      <a class="btn secondary" href="progress.html">My Progress</a>
      <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
    </div>
    <div class="hero-note">Kâ€“2: letter names + letter sounds</div>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Start Here ğŸŒŸ</h2>

    <div class="game-box wide">
      <!-- Grade pick -->
      <div class="badge-row">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>

      <!-- Mode buttons -->
      <div class="quick-strip" style="margin-top:14px;">
        <button class="btn" id="goDiagBtn">Take Diagnostic</button>
        <button class="btn secondary" id="goGameBtn">Go to Game</button>
        <button class="btn secondary" id="retakeBtn">Retake Diagnostic</button>
      </div>

      <!-- DIAGNOSTIC PANEL -->
      <div class="game-box" id="diagPanel" style="margin-top:14px;">
        <p class="kid-big">Diagnostic âœ…</p>
        <p class="small">Answer letter <strong>name</strong> and <strong>sound</strong> questions. Tap ğŸ”Š to hear it.</p>

        <div class="game-box" style="margin-top:12px;">
          <!-- Question Row with ğŸ”Š next to question -->
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
            <p class="kid-big" id="diagQ" style="margin:0; flex:1;">Press â€œTake Diagnosticâ€ to begin.</p>
            <button class="btn secondary" id="diagSpeakBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
          </div>

          <p class="small" id="diagHint"></p>
          <p class="small" id="diagAudioStatus" style="display:none;"></p>

          <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
          <p class="kid-big" id="diagResult" style="margin-top:14px;"></p>

          <div class="quick-strip">
            <button class="btn" id="diagNextBtn">Next</button>
            <button class="btn secondary" id="diagSkipBtn">Skip</button>
          </div>
        </div>
      </div>

      <!-- GAME PANEL -->
      <div class="game-box" id="gamePanel" style="margin-top:14px; display:none;">
        <p class="kid-big">Mini Game ğŸ®</p>
        <p class="small" id="gamePlan">Your game is based on your diagnostic.</p>

        <div class="game-box" style="margin-top:12px;">
          <!-- Question Row with ğŸ”Š next to question -->
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
            <p class="kid-big" id="gameQ" style="margin:0; flex:1;">Game question loads hereâ€¦</p>
            <button class="btn secondary" id="gameSpeakBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
          </div>

          <p class="small" id="gameHint"></p>
          <p class="small" id="gameAudioStatus" style="display:none;"></p>

          <div class="grid-3" id="gameChoices" style="margin-top:14px;"></div>
          <p class="kid-big" id="gameResult" style="margin-top:14px;"></p>

          <div class="quick-strip">
            <button class="btn" id="gameNextBtn">Next</button>
            <button class="btn secondary" id="resetStarsBtn">Reset Stars</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script>
  // ---------- Storage Keys ----------
  const PROG_KEY = "bloom_progress";
  const PHONICS_DIAG_KEY = "bloom_phonics_diag";

  // ---------- Helpers ----------
  function load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // ---------- Real Audio Player ----------
  // Put audio files in: assets/audio/sounds/ and assets/audio/letters/
  // Example: assets/audio/sounds/m.mp3, sh.mp3, long-a.mp3
  // Example: assets/audio/letters/A.mp3

  const audio = new Audio();
  audio.preload = "auto";

  function showAudioStatus(el, msg){
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.style.display = "none"; }, 2000);
  }

  async function playAudio(src, statusEl){
    try {
      audio.pause();
      audio.currentTime = 0;
      audio.src = src;
      await audio.play();
    } catch (err) {
      showAudioStatus(statusEl, "Audio not found yet. Add the mp3 file to your repo.");
    }
  }

  // ---------- Grade Selection ----------
  let grade = "K";
  function renderGradeButtons(){
    document.querySelectorAll(".pill").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.grade === grade);
    });
  }
  document.querySelectorAll(".pill").forEach(btn=>{
    btn.onclick = ()=>{
      grade = btn.dataset.grade;
      renderGradeButtons();
      updateModeButtons();
      showDiagnosticIntro();
    };
  });

  // ---------- Audio Maps ----------
  // soundKey values map to filenames
  const soundAudio = {
    "m": "./assets/audio/sounds/m.mp3",
    "s": "./assets/audio/sounds/s.mp3",
    "t": "./assets/audio/sounds/t.mp3",
    "sh": "./assets/audio/sounds/sh.mp3",
    "ch": "./assets/audio/sounds/ch.mp3",
    "th": "./assets/audio/sounds/th.mp3",
    "long-a": "./assets/audio/sounds/long-a.mp3",
    "long-e": "./assets/audio/sounds/long-e.mp3",
    "long-o": "./assets/audio/sounds/long-o.mp3"
  };

  const letterAudio = {
    "A": "./assets/audio/letters/A.mp3",
    "M": "./assets/audio/letters/M.mp3",
    "S": "./assets/audio/letters/S.mp3",
    "B": "./assets/audio/letters/B.mp3",
    "R": "./assets/audio/letters/R.mp3",
    "T": "./assets/audio/letters/T.mp3",
    "G": "./assets/audio/letters/G.mp3",
    "P": "./assets/audio/letters/P.mp3",
    "V": "./assets/audio/letters/V.mp3"
  };

  // ---------- Content Banks (Kâ€“2) ----------
  // Each sound question has a soundKey which points to the mp3 filename
  const gradeBanks = {
    "K": {
      nameItems: [
        { letter:"A", correct:"A", choices:["A","B","D"] },
        { letter:"M", correct:"M", choices:["N","M","W"] },
        { letter:"S", correct:"S", choices:["S","C","G"] }
      ],
      soundItems: [
        { soundText:"/m/", soundKey:"m", correct:"M", choices:["M","S","T"], hint:"/m/ like moon" },
        { soundText:"/s/", soundKey:"s", correct:"S", choices:["B","S","D"], hint:"/s/ like sun" },
        { soundText:"/t/", soundKey:"t", correct:"T", choices:["T","A","P"], hint:"/t/ like top" }
      ]
    },
    "1": {
      nameItems: [
        { letter:"B", correct:"B", choices:["B","D","P"] },
        { letter:"R", correct:"R", choices:["R","K","H"] },
        { letter:"T", correct:"T", choices:["T","F","E"] }
      ],
      soundItems: [
        { soundText:"/sh/", soundKey:"sh", correct:"SH", choices:["CH","SH","TH"], hint:"SH like ship" },
        { soundText:"/ch/", soundKey:"ch", correct:"CH", choices:["CH","PH","WH"], hint:"CH like chop" },
        { soundText:"/th/", soundKey:"th", correct:"TH", choices:["TH","SH","CH"], hint:"TH like this" }
      ]
    },
    "2": {
      nameItems: [
        { letter:"G", correct:"G", choices:["G","J","Q"] },
        { letter:"P", correct:"P", choices:["P","R","B"] },
        { letter:"V", correct:"V", choices:["V","W","Y"] }
      ],
      soundItems: [
        { soundText:"long A (ai/ay)", soundKey:"long-a", correct:"AI", choices:["AI","OA","EE"], hint:"AI like rain" },
        { soundText:"long E (ee/ea)", soundKey:"long-e", correct:"EE", choices:["EE","OO","AI"], hint:"EE like feet" },
        { soundText:"long O (oa/ow)", soundKey:"long-o", correct:"OA", choices:["OA","EE","AI"], hint:"OA like boat" }
      ]
    }
  };

  // ---------- Diagnostic Builder ----------
  function buildDiagnostic(grade){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`What is the NAME of this letter: ${x.letter}?`,
      hint:"Tap ğŸ”Š to hear the letter name.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      soundText: x.soundText,
      soundKey: x.soundKey,
      prompt:`Which letter(s) make this sound?`,
      hint:`Tap ğŸ”Š to hear the sound.`,
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    return shuffle([...nameQs, ...soundQs]);
  }

  // ---------- Targeted Game Builder ----------
  function buildGame(grade, missedFocusKeys){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`Letter NAME: ${x.letter} is calledâ€¦`,
      hint:"Tap ğŸ”Š to hear the letter name.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      soundText: x.soundText,
      soundKey: x.soundKey,
      prompt:`Letter SOUND: Which letter(s) make this sound?`,
      hint:"Tap ğŸ”Š to hear the sound.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    const pool = [...nameQs, ...soundQs];
    const missed = pool.filter(q => missedFocusKeys.includes(q.focusKey));
    const rest   = pool.filter(q => !missedFocusKeys.includes(q.focusKey));

    const game = [];
    while (game.length < 10) {
      if (missed.length) game.push(missed.shift());
      else game.push(rest[game.length % rest.length]);
    }
    return game;
  }

  // ---------- State ----------
  let diagQs = [];
  let diagIndex = 0;
  let diagCorrect = 0;
  let diagMissed = [];
  let lastDiagQ = null;

  let gameQs = [];
  let gameIndex = 0;
  let lastGameQ = null;

  // ---------- UI refs ----------
  const diagPanel = document.getElementById("diagPanel");
  const gamePanel = document.getElementById("gamePanel");

  const diagQEl = document.getElementById("diagQ");
  const diagHintEl = document.getElementById("diagHint");
  const diagChoicesEl = document.getElementById("diagChoices");
  const diagResultEl = document.getElementById("diagResult");
  const diagAudioStatus = document.getElementById("diagAudioStatus");

  const gameQEl = document.getElementById("gameQ");
  const gameHintEl = document.getElementById("gameHint");
  const gameChoicesEl = document.getElementById("gameChoices");
  const gameResultEl = document.getElementById("gameResult");
  const gamePlanEl = document.getElementById("gamePlan");
  const gameAudioStatus = document.getElementById("gameAudioStatus");

  const goDiagBtn = document.getElementById("goDiagBtn");
  const goGameBtn = document.getElementById("goGameBtn");
  const retakeBtn = document.getElementById("retakeBtn");

  function updateModeButtons(){
    const saved = load(PHONICS_DIAG_KEY, null);
    const hasCurrent = saved && saved.grade === grade;
    goGameBtn.disabled = !hasCurrent;
    goGameBtn.style.opacity = hasCurrent ? "1" : ".6";
  }

  // ---------- Diagnostic UI ----------
  function showDiagnosticIntro(){
    diagQEl.textContent = "Press â€œTake Diagnosticâ€ to begin.";
    diagHintEl.textContent = "";
    diagChoicesEl.innerHTML = "";
    diagResultEl.textContent = "";
    diagPanel.style.display = "block";
    gamePanel.style.display = "none";
    lastDiagQ = null;
    lastGameQ = null;
  }

  function renderDiagQuestion(){
    const q = diagQs[diagIndex];
    lastDiagQ = q;

    // For sound questions, question text stays â€œWhich letter(s) make this sound?â€
    // (sound is played using audio button)
    diagQEl.textContent = q.prompt;
    diagHintEl.textContent = q.hint || "";
    diagResultEl.textContent = "";

    diagChoicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkDiagAnswer(c);
      diagChoicesEl.appendChild(card);
    });
  }

  function playDiagAudio(){
    if (!lastDiagQ) {
      showAudioStatus(diagAudioStatus, "Press Take Diagnostic to start!");
      return;
    }

    if (lastDiagQ.type === "name") {
      const src = letterAudio[lastDiagQ.letter];
      if (!src) return showAudioStatus(diagAudioStatus, "Add letter audio file for this letter.");
      playAudio(src, diagAudioStatus);
    } else {
      const src = soundAudio[lastDiagQ.soundKey];
      if (!src) return showAudioStatus(diagAudioStatus, "Add sound audio file for this sound.");
      playAudio(src, diagAudioStatus);
    }
  }

  function checkDiagAnswer(choice){
    if (diagResultEl.textContent) return;

    const q = diagQs[diagIndex];
    if (choice === q.correct){
      diagCorrect++;
      diagResultEl.textContent = "Correct! â­";
    } else {
      diagMissed.push(q.focusKey);
      diagResultEl.textContent = `Good try! Answer: ${q.correct}`;
      // replay audio for extra help on sound items
      if (q.type === "sound") playDiagAudio();
    }
  }

  function finishDiagnostic(){
    const total = diagQs.length || 1;
    const score = Math.round((diagCorrect / total) * 100);

    const resultObj = { grade, score, missed: diagMissed, date: Date.now() };
    save(PHONICS_DIAG_KEY, resultObj);

    gameQs = buildGame(grade, diagMissed);
    gameIndex = 0;

    const missedNames = diagMissed.filter(x=>x.startsWith("name:")).length;
    const missedSounds = diagMissed.filter(x=>x.startsWith("sound:")).length;

    let planText = `Diagnostic score: ${score}% â€” `;
    if (missedNames === 0 && missedSounds === 0) planText += "Awesome! We'll do a fun mix of practice.";
    else {
      planText += "We will practice: ";
      const parts = [];
      if (missedNames) parts.push(`letter names (${missedNames})`);
      if (missedSounds) parts.push(`letter sounds (${missedSounds})`);
      planText += parts.join(" and ") + ".";
    }
    gamePlanEl.textContent = planText;

    updateModeButtons();
    startGameFromSaved();
  }

  // ---------- Game UI ----------
  function renderGameQuestion(){
    const q = gameQs[gameIndex % gameQs.length];
    lastGameQ = q;

    gameQEl.textContent = q.prompt;
    gameHintEl.textContent = q.hint || "";
    gameResultEl.textContent = "";

    gameChoicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkGameAnswer(c);
      gameChoicesEl.appendChild(card);
    });
  }

  function addPhonicsStar(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    save(PROG_KEY, p);
  }

  function playGameAudio(){
    if (!lastGameQ) {
      showAudioStatus(gameAudioStatus, "Take the diagnostic first!");
      return;
    }

    if (lastGameQ.type === "name") {
      const src = letterAudio[lastGameQ.letter];
      if (!src) return showAudioStatus(gameAudioStatus, "Add letter audio file for this letter.");
      playAudio(src, gameAudioStatus);
    } else {
      const src = soundAudio[lastGameQ.soundKey];
      if (!src) return showAudioStatus(gameAudioStatus, "Add sound audio file for this sound.");
      playAudio(src, gameAudioStatus);
    }
  }

  function checkGameAnswer(choice){
    if (gameResultEl.textContent) return;

    const q = gameQs[gameIndex % gameQs.length];
    if (choice === q.correct){
      gameResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      gameResultEl.textContent = "Try again ğŸ™‚";
      // replay audio for help
      if (q.type === "sound") playGameAudio();
    }
  }

  function startGameFromSaved(){
    const savedDiag = load(PHONICS_DIAG_KEY, null);
    if (!savedDiag || savedDiag.grade !== grade){
      showDiagnosticIntro();
      return;
    }

    gameQs = buildGame(grade, savedDiag.missed || []);
    gameIndex = 0;

    diagPanel.style.display = "none";
    gamePanel.style.display = "block";
    renderGameQuestion();
  }

  // ---------- Buttons ----------
  goDiagBtn.onclick = ()=>{
    diagQs = buildDiagnostic(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagMissed = [];
    diagPanel.style.display = "block";
    gamePanel.style.display = "none";
    renderDiagQuestion();
  };

  document.getElementById("diagNextBtn").onclick = ()=>{
    if (!diagQs.length) return;

    if (!diagResultEl.textContent){
      diagMissed.push(diagQs[diagIndex].focusKey);
    }

    diagIndex++;
    if (diagIndex >= diagQs.length){
      finishDiagnostic();
    } else {
      renderDiagQuestion();
    }
  };

  document.getElementById("diagSkipBtn").onclick = ()=>{
    if (!diagQs.length) return;
    diagMissed.push(diagQs[diagIndex].focusKey);

    diagIndex++;
    if (diagIndex >= diagQs.length){
      finishDiagnostic();
    } else {
      renderDiagQuestion();
    }
  };

  goGameBtn.onclick = ()=> startGameFromSaved();

  retakeBtn.onclick = ()=>{
    const savedDiag = load(PHONICS_DIAG_KEY, null);
    if (savedDiag && savedDiag.grade === grade){
      localStorage.removeItem(PHONICS_DIAG_KEY);
    }
    updateModeButtons();
    showDiagnosticIntro();
    alert("Diagnostic cleared. Press â€œTake Diagnosticâ€ to start again!");
  };

  document.getElementById("gameNextBtn").onclick = ()=>{
    gameIndex++;
    renderGameQuestion();
  };

  document.getElementById("resetStarsBtn").onclick = ()=>{
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = 0;
    save(PROG_KEY, p);
    alert("Phonics stars reset!");
  };

  // ğŸ”Š buttons next to question
  document.getElementById("diagSpeakBtn").onclick = playDiagAudio;
  document.getElementById("gameSpeakBtn").onclick = playGameAudio;

  // ---------- Initialize ----------
  renderGradeButtons();
  updateModeButtons();
  showDiagnosticIntro();
</script>

</body>
</html>
