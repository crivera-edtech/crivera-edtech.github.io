<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonics | BloomELearning âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<header>
  <div class="container">
    <div class="logo">BloomELearning âœ¨</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>

        <li class="dropdown">
          <a href="#">Subjects</a>
          <div class="dropdown-menu">
            <a href="phonics.html">ğŸ”¤ Phonics</a>
            <a href="reading.html">ğŸ“– Reading</a>
            <a href="math.html">â• Math</a>
            <a href="letter-formation.html">âœï¸ Letter Tracing</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Resources</a>
          <div class="dropdown-menu">
            <a href="resources.html">ğŸ¥ Kids Resources</a>
            <a href="parent-resources.html">ğŸ§‘â€ğŸ« Parent Resources</a>
            <a href="standards.html">ğŸ“˜ Standards (Kâ€“2)</a>
          </div>
        </li>

        <li class="dropdown">
          <a href="#">Student</a>
          <div class="dropdown-menu">
            <a href="student-login.html">ğŸ§’ Student Login</a>
            <a href="progress.html">ğŸ“Š My Progress</a>
            <a href="sticker-book.html">ğŸ“– Sticker Book</a>
          </div>
        </li>

        <li><a href="games.html">ğŸ® Games</a></li>
        <li><a href="diagnostic.html">ğŸ§  Diagnostic</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Phonics Playground ğŸ”¤ğŸŒ¿</h1>
    <p>Pick a game: match sounds, label pictures, build silly words, or read decodable stories!</p>
    <div class="quick-strip">
      <a class="btn secondary" href="progress.html">My Progress</a>
      <a class="btn secondary" href="sticker-book.html">Sticker Book</a>
    </div>
    <div class="hero-note">Kâ€“2 practice: letter names, letter sounds, blending, and decodable reading</div>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="section-title">Choose a Phonics Game ğŸŒŸ</h2>

    <div class="game-box wide">
      <div class="grid-3">
        <div class="card">
          <h3>ğŸ§  Diagnostic</h3>
          <p>Letter names + sounds. Then it recommends practice.</p>
          <button class="btn" id="showDiagBtn">Start</button>
        </div>

        <div class="card">
          <h3>ğŸ§ Sound â†’ Letter</h3>
          <p>Hear the sound. Tap the letter card.</p>
          <button class="btn" id="showSoundToLetterBtn">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ”¤ Letter â†’ Sound</h3>
          <p>See the letter. Choose the sound card.</p>
          <button class="btn" id="showLetterToSoundBtn">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ–¼ï¸ Label the Picture</h3>
          <p>Pick the word that matches the picture AND starts with the sound.</p>
          <button class="btn" id="showLabelPicBtn">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ§ª Nonsense Word Lab</h3>
          <p>Swap vowels to make safe silly words (no bad words).</p>
          <button class="btn" id="showNonsenseBtn">Play</button>
        </div>

        <div class="card">
          <h3>ğŸ“š Decodable Reading</h3>
          <p>Pick stories by skill: CVC, digraphs, or long vowel teams.</p>
          <button class="btn" id="showDecodableBtn">Read</button>
        </div>
      </div>
    </div>

    <!-- Grade pick -->
    <div class="game-box" style="margin-top:18px;">
      <p class="kid-big" style="margin-bottom:10px;">Pick a Grade</p>
      <div class="badge-row">
        <button class="pill active" data-grade="K">Kindergarten</button>
        <button class="pill" data-grade="1">Grade 1</button>
        <button class="pill" data-grade="2">Grade 2</button>
      </div>
      <p class="small" style="margin-top:10px;">Tip: Keep the same grade so games stay â€œjust right.â€</p>
    </div>

    <!-- DIAGNOSTIC -->
    <div class="game-box wide" id="diagPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">Diagnostic âœ…</p>
      <p class="small">Answer letter <strong>name</strong> and <strong>sound</strong> questions. Tap ğŸ”Š to hear it.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="diagQ" style="margin:0; flex:1;">Press â€œTake Diagnosticâ€ to begin.</p>
          <button class="btn secondary" id="diagSpeakBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="diagHint"></p>
        <p class="small" id="diagAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="diagChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="diagResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="goDiagBtn">Take Diagnostic</button>
          <button class="btn secondary" id="diagNextBtn">Next</button>
          <button class="btn secondary" id="diagSkipBtn">Skip</button>
          <button class="btn secondary" id="retakeBtn">Retake</button>
          <button class="btn secondary" id="closeDiagBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- RECOMMENDED GAME -->
    <div class="game-box wide" id="targetGamePanel" style="margin-top:18px; display:none;">
      <p class="kid-big">Recommended Mini Game ğŸ®</p>
      <p class="small" id="gamePlan">Your game is based on your diagnostic.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="gameQ" style="margin:0; flex:1;">Game question loads hereâ€¦</p>
          <button class="btn secondary" id="gameSpeakBtn" title="Play sound" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="gameHint"></p>
        <p class="small" id="gameAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="gameChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="gameResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="goGameBtn">Go</button>
          <button class="btn secondary" id="gameNextBtn">Next</button>
          <button class="btn secondary" id="resetStarsBtn">Reset Stars</button>
          <button class="btn secondary" id="closeTargetGameBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- GAME: Sound -> Letter -->
    <div class="game-box wide" id="soundToLetterPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ§ Sound â†’ Letter Match</p>
      <p class="small">Press ğŸ”Š. Then tap the correct letter(s).</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="stlQ" style="margin:0; flex:1;">Press Play to start!</p>
          <button class="btn secondary" id="stlSpeakBtn" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="stlHint"></p>
        <p class="small" id="stlAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="stlChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="stlResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="stlStartBtn">Play</button>
          <button class="btn secondary" id="stlNextBtn">Next</button>
          <button class="btn secondary" id="closeStlBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- GAME: Letter -> Sound -->
    <div class="game-box wide" id="letterToSoundPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ”¤ Letter â†’ Sound Match</p>
      <p class="small">Tap a sound card to answer. Use ğŸ”Š to hear the letter name again.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="ltsQ" style="margin:0; flex:1;">Press Play to start!</p>
          <button class="btn secondary" id="ltsSpeakBtn" aria-label="Play letter name">ğŸ”Š</button>
        </div>

        <p class="small" id="ltsHint"></p>
        <p class="small" id="ltsAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="ltsChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="ltsResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="ltsStartBtn">Play</button>
          <button class="btn secondary" id="ltsNextBtn">Next</button>
          <button class="btn secondary" id="closeLtsBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Label the Picture -->
    <div class="game-box wide" id="labelPicPanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ–¼ï¸ Label the Picture</p>
      <p class="small">Pick the word that matches the picture AND starts with the sound. Press ğŸ”Š to hear the sound.</p>

      <div class="game-box" style="margin-top:12px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <p class="kid-big" id="lpQ" style="margin:0; flex:1;">Press Play to start!</p>
          <button class="btn secondary" id="lpSpeakBtn" aria-label="Play sound">ğŸ”Š</button>
        </div>

        <p class="small" id="lpHint"></p>
        <p class="small" id="lpAudioStatus" style="display:none;"></p>

        <div class="grid-3" id="lpChoices" style="margin-top:14px;"></div>
        <p class="kid-big" id="lpResult" style="margin-top:14px;"></p>

        <div class="quick-strip">
          <button class="btn" id="lpStartBtn">Play</button>
          <button class="btn secondary" id="lpNextBtn">Next</button>
          <button class="btn secondary" id="closeLpBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Nonsense Word Lab -->
    <div class="game-box wide" id="nonsensePanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ§ª Nonsense Word Lab</p>
      <p class="small">Build a silly word by swapping the vowel. It blocks bad words automatically.</p>

      <div class="game-box" style="margin-top:12px;">
        <p class="kid-big" id="nwWord" style="margin:0;">Press â€œMake a Wordâ€!</p>
        <p class="small" id="nwHint">Pick a vowel button to change the middle sound.</p>
        <p class="small" id="nwStatus" style="display:none;"></p>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="nwMakeBtn">Make a Word</button>
          <button class="btn secondary" id="nwPlayC1Btn">ğŸ”Š Start</button>
          <button class="btn secondary" id="nwPlayVBtn">ğŸ”Š Vowel</button>
          <button class="btn secondary" id="nwPlayC2Btn">ğŸ”Š End</button>
        </div>

        <div class="badge-row" style="margin-top:12px;">
          <button class="pill" data-v="a">a</button>
          <button class="pill" data-v="e">e</button>
          <button class="pill" data-v="i">i</button>
          <button class="pill" data-v="o">o</button>
          <button class="pill" data-v="u">u</button>
        </div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="nwCheckBtn">Check</button>
          <button class="btn secondary" id="closeNwBtn">Close</button>
        </div>

        <p class="small" id="nwRealCheck" style="margin-top:10px;"></p>
      </div>
    </div>

    <!-- Decodable Reading -->
    <div class="game-box wide" id="decodablePanel" style="margin-top:18px; display:none;">
      <p class="kid-big">ğŸ“š Decodable Reading</p>
      <p class="small">Pick a skill focus, then pick a story. Tap ğŸ”Š to read aloud.</p>

      <div class="game-box" style="margin-top:12px;">
        <div class="badge-row" id="decOptionsRow" style="gap:10px; flex-wrap:wrap;"></div>

        <div class="quick-strip" style="margin-top:12px;">
          <button class="btn" id="decPickBtn">Pick a Story</button>
          <button class="btn secondary" id="decReadBtn">ğŸ”Š Read Aloud</button>
          <button class="btn secondary" id="decStopBtn">â¹ Stop</button>
          <button class="btn secondary" id="closeDecBtn">Close</button>
        </div>

        <div style="margin-top:12px;">
          <p class="kid-big" id="decTitle" style="margin:0;">Press â€œPick a Storyâ€</p>
          <p class="small" id="decFocus"></p>
          <div class="game-box" style="margin-top:10px;">
            <p id="decText" style="margin:0; font-size:18px; line-height:1.6;"></p>
          </div>
        </div>

        <div class="game-box" style="margin-top:12px;">
          <p class="kid-big" id="decQ" style="margin:0;">Question:</p>
          <div class="grid-3" id="decChoices" style="margin-top:12px;"></div>
          <p class="kid-big" id="decResult" style="margin-top:12px;"></p>
        </div>
      </div>
    </div>

  </div>
</section>

<footer>Â© 2026 BloomELearning âœ¨ | Made with ğŸ’š</footer>

<script>
  // =========================
  // Storage Keys
  // =========================
  const PROG_KEY = "bloom_progress";
  const PHONICS_DIAG_KEY = "bloom_phonics_diag";

  // =========================
  // Helpers
  // =========================
  function load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function save(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
  function hideAllPanels(){
    diagPanel.style.display = "none";
    targetGamePanel.style.display = "none";
    soundToLetterPanel.style.display = "none";
    letterToSoundPanel.style.display = "none";
    labelPicPanel.style.display = "none";
    nonsensePanel.style.display = "none";
    decodablePanel.style.display = "none";
  }
  function showPanel(el){
    hideAllPanels();
    el.style.display = "block";
    el.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // =========================
  // Progress Stars
  // =========================
  function addPhonicsStar(){
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = (p.phonicsStars || 0) + 1;
    save(PROG_KEY, p);
  }

  // =========================
  // Audio (real mp3)
  // =========================
  const audio = new Audio();
  audio.preload = "auto";

  function showAudioStatus(el, msg){
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.style.display = "none"; }, 2000);
  }
  async function playAudio(src, statusEl){
    try {
      audio.pause();
      audio.currentTime = 0;
      audio.src = src;
      await audio.play();
    } catch {
      showAudioStatus(statusEl, "Audio not found. Check filename + folder path.");
    }
  }

  // Your mp3 file paths:
  const soundAudio = {
    "m": "./assets/audio/sounds/m.mp3",
    "s": "./assets/audio/sounds/s.mp3",
    "t": "./assets/audio/sounds/t.mp3",
    "sh": "./assets/audio/sounds/sh.mp3",
    "ch": "./assets/audio/sounds/ch.mp3",
    "th": "./assets/audio/sounds/th.mp3",
    "long-a": "./assets/audio/sounds/long-a.mp3",
    "long-e": "./assets/audio/sounds/long-e.mp3",
    "long-o": "./assets/audio/sounds/long-o.mp3"
  };
  const letterAudio = {
    "A": "./assets/audio/letters/A.mp3",
    "M": "./assets/audio/letters/M.mp3",
    "S": "./assets/audio/letters/S.mp3",
    "B": "./assets/audio/letters/B.mp3",
    "R": "./assets/audio/letters/R.mp3",
    "T": "./assets/audio/letters/T.mp3",
    "G": "./assets/audio/letters/G.mp3",
    "P": "./assets/audio/letters/P.mp3",
    "V": "./assets/audio/letters/V.mp3"
  };

  // Read-aloud for decodables
  function speakText(text){
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.9;
    u.pitch = 1.1;
    window.speechSynthesis.speak(u);
  }
  function stopSpeak(){
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
  }

  // =========================
  // Grade selection
  // =========================
  let grade = "K";
  function renderGradeButtons(){
    document.querySelectorAll(".pill[data-grade]").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.grade === grade);
    });
    buildDecodableOptions();
    resetPanelsText();
  }
  document.querySelectorAll(".pill[data-grade]").forEach(btn=>{
    btn.onclick = ()=>{
      grade = btn.dataset.grade;
      renderGradeButtons();
      // reset gameplay state for all games when grade changes
      resetAllGameState();
    };
  });

  // =========================
  // Panel refs
  // =========================
  const diagPanel = document.getElementById("diagPanel");
  const targetGamePanel = document.getElementById("targetGamePanel");
  const soundToLetterPanel = document.getElementById("soundToLetterPanel");
  const letterToSoundPanel = document.getElementById("letterToSoundPanel");
  const labelPicPanel = document.getElementById("labelPicPanel");
  const nonsensePanel = document.getElementById("nonsensePanel");
  const decodablePanel = document.getElementById("decodablePanel");

  // Top buttons
  document.getElementById("showDiagBtn").onclick = ()=> showPanel(diagPanel);
  document.getElementById("showSoundToLetterBtn").onclick = ()=> showPanel(soundToLetterPanel);
  document.getElementById("showLetterToSoundBtn").onclick = ()=> showPanel(letterToSoundPanel);
  document.getElementById("showLabelPicBtn").onclick = ()=> showPanel(labelPicPanel);
  document.getElementById("showNonsenseBtn").onclick = ()=> showPanel(nonsensePanel);
  document.getElementById("showDecodableBtn").onclick = ()=> { showPanel(decodablePanel); buildDecodableOptions(); };

  document.getElementById("closeDiagBtn").onclick = hideAllPanels;
  document.getElementById("closeTargetGameBtn").onclick = hideAllPanels;
  document.getElementById("closeStlBtn").onclick = hideAllPanels;
  document.getElementById("closeLtsBtn").onclick = hideAllPanels;
  document.getElementById("closeLpBtn").onclick = hideAllPanels;
  document.getElementById("closeNwBtn").onclick = hideAllPanels;
  document.getElementById("closeDecBtn").onclick = ()=>{ stopSpeak(); hideAllPanels(); };

  // =========================
  // Banks (Kâ€“2)
  // =========================
  // Diagnostic + Target game uses these
  const gradeBanks = {
    "K": {
      nameItems: [
        { letter:"A", correct:"A", choices:["A","B","D"] },
        { letter:"M", correct:"M", choices:["N","M","W"] },
        { letter:"S", correct:"S", choices:["S","C","G"] }
      ],
      soundItems: [
        { soundText:"/m/", soundKey:"m", correct:"M", choices:["M","S","T"], hint:"/m/ like moon" },
        { soundText:"/s/", soundKey:"s", correct:"S", choices:["B","S","D"], hint:"/s/ like sun" },
        { soundText:"/t/", soundKey:"t", correct:"T", choices:["T","A","P"], hint:"/t/ like top" }
      ],
      soundToLetter: [
        { soundKey:"m", correct:"M", choices:["M","S","T"], hint:"Tap the letter for the sound." },
        { soundKey:"s", correct:"S", choices:["B","S","D"], hint:"Tap the letter for the sound." },
        { soundKey:"t", correct:"T", choices:["T","A","P"], hint:"Tap the letter for the sound." }
      ],
      letterToSound: [
        { letter:"M", correctSoundKey:"m", choices:["m","s","t"], hint:"Tap the sound for the letter." },
        { letter:"S", correctSoundKey:"s", choices:["m","s","t"], hint:"Tap the sound for the letter." },
        { letter:"T", correctSoundKey:"t", choices:["m","s","t"], hint:"Tap the sound for the letter." }
      ],
      labelPics: [
        { soundKey:"m", picture:"ğŸŒ™", answer:"moon", choices:["moon","sun","top"], hint:"Starts with /m/" },
        { soundKey:"s", picture:"â˜€ï¸", answer:"sun", choices:["sun","moon","top"], hint:"Starts with /s/" },
        { soundKey:"t", picture:"ğŸ©", answer:"top", choices:["top","sun","moon"], hint:"Starts with /t/" }
      ]
    },

    "1": {
      nameItems: [
        { letter:"B", correct:"B", choices:["B","D","P"] },
        { letter:"R", correct:"R", choices:["R","K","H"] },
        { letter:"T", correct:"T", choices:["T","F","E"] }
      ],
      soundItems: [
        { soundText:"/sh/", soundKey:"sh", correct:"SH", choices:["CH","SH","TH"], hint:"SH like ship" },
        { soundText:"/ch/", soundKey:"ch", correct:"CH", choices:["CH","PH","WH"], hint:"CH like chop" },
        { soundText:"/th/", soundKey:"th", correct:"TH", choices:["TH","SH","CH"], hint:"TH like this" }
      ],
      soundToLetter: [
        { soundKey:"sh", correct:"SH", choices:["CH","SH","TH"], hint:"Tap the team for the sound." },
        { soundKey:"ch", correct:"CH", choices:["CH","PH","WH"], hint:"Tap the team for the sound." },
        { soundKey:"th", correct:"TH", choices:["TH","SH","CH"], hint:"Tap the team for the sound." }
      ],
      letterToSound: [
        { letter:"B", correctSoundKey:"ch", choices:["sh","ch","th"], hint:"(Practice) Tap the sound card." },
        { letter:"R", correctSoundKey:"sh", choices:["sh","ch","th"], hint:"(Practice) Tap the sound card." },
        { letter:"T", correctSoundKey:"th", choices:["sh","ch","th"], hint:"(Practice) Tap the sound card." }
      ],
      labelPics: [
        { soundKey:"sh", picture:"ğŸš¢", answer:"ship", choices:["ship","chop","this"], hint:"Starts with /sh/" },
        { soundKey:"ch", picture:"ğŸª“", answer:"chop", choices:["this","ship","chop"], hint:"Starts with /ch/" },
        { soundKey:"th", picture:"ğŸ‘", answer:"this", choices:["chop","this","ship"], hint:"Starts with /th/" }
      ]
    },

    "2": {
      nameItems: [
        { letter:"G", correct:"G", choices:["G","J","Q"] },
        { letter:"P", correct:"P", choices:["P","R","B"] },
        { letter:"V", correct:"V", choices:["V","W","Y"] }
      ],
      soundItems: [
        { soundText:"long A (ai/ay)", soundKey:"long-a", correct:"AI", choices:["AI","OA","EE"], hint:"AI like rain" },
        { soundText:"long E (ee/ea)", soundKey:"long-e", correct:"EE", choices:["EE","OO","AI"], hint:"EE like feet" },
        { soundText:"long O (oa/ow)", soundKey:"long-o", correct:"OA", choices:["OA","EE","AI"], hint:"OA like boat" }
      ],
      soundToLetter: [
        { soundKey:"long-a", correct:"AI", choices:["AI","EE","OA"], hint:"Tap the vowel team." },
        { soundKey:"long-e", correct:"EE", choices:["EE","AI","OA"], hint:"Tap the vowel team." },
        { soundKey:"long-o", correct:"OA", choices:["OA","AI","EE"], hint:"Tap the vowel team." }
      ],
      letterToSound: [
        { letter:"A", correctSoundKey:"long-a", choices:["long-a","long-e","long-o"], hint:"Tap the long vowel sound." },
        { letter:"E", correctSoundKey:"long-e", choices:["long-a","long-e","long-o"], hint:"Tap the long vowel sound." },
        { letter:"O", correctSoundKey:"long-o", choices:["long-a","long-e","long-o"], hint:"Tap the long vowel sound." }
      ],
      labelPics: [
        { soundKey:"long-a", picture:"ğŸŒ§ï¸", answer:"rain", choices:["rain","feet","boat"], hint:"Has long A (ai/ay)" },
        { soundKey:"long-e", picture:"ğŸ¦¶", answer:"feet", choices:["boat","rain","feet"], hint:"Has long E (ee/ea)" },
        { soundKey:"long-o", picture:"â›µ", answer:"boat", choices:["feet","boat","rain"], hint:"Has long O (oa/ow)" }
      ]
    }
  };

  // =========================
  // Diagnostic + Recommended Game
  // =========================
  function buildDiagnostic(grade){
    const b = gradeBanks[grade];

    const nameQs = b.nameItems.map(x => ({
      type:"name",
      letter: x.letter,
      prompt:`What is the NAME of this letter: ${x.letter}?`,
      hint:"Tap ğŸ”Š to hear the letter name.",
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`name:${x.letter}`
    }));

    const soundQs = b.soundItems.map(x => ({
      type:"sound",
      soundText: x.soundText,
      soundKey: x.soundKey,
      prompt:`Which letter(s) make this sound?`,
      hint:`Tap ğŸ”Š to hear the sound.`,
      correct:x.correct,
      choices:shuffle(x.choices),
      focusKey:`sound:${x.correct}`
    }));

    return shuffle([...nameQs, ...soundQs]);
  }

  function buildGame(grade, missedFocusKeys){
    const b = gradeBanks[grade];

    const pool = [
      ...b.nameItems.map(x => ({
        type:"name",
        letter: x.letter,
        prompt:`Letter NAME: ${x.letter} is calledâ€¦`,
        hint:"Tap ğŸ”Š to hear the letter name.",
        correct:x.correct,
        choices:shuffle(x.choices),
        focusKey:`name:${x.letter}`
      })),
      ...b.soundItems.map(x => ({
        type:"sound",
        soundText: x.soundText,
        soundKey: x.soundKey,
        prompt:`Letter SOUND: Which letter(s) make this sound?`,
        hint:"Tap ğŸ”Š to hear the sound.",
        correct:x.correct,
        choices:shuffle(x.choices),
        focusKey:`sound:${x.correct}`
      }))
    ];

    const missed = pool.filter(q => missedFocusKeys.includes(q.focusKey));
    const rest   = pool.filter(q => !missedFocusKeys.includes(q.focusKey));

    const game = [];
    while (game.length < 10) {
      if (missed.length) game.push(missed.shift());
      else game.push(rest[game.length % rest.length]);
    }
    return game;
  }

  // Diagnostic state
  let diagQs = [];
  let diagIndex = 0;
  let diagCorrect = 0;
  let diagMissed = [];
  let lastDiagQ = null;

  // Recommended game state
  let gameQs = [];
  let gameIndex = 0;
  let lastGameQ = null;

  // UI refs
  const diagQEl = document.getElementById("diagQ");
  const diagHintEl = document.getElementById("diagHint");
  const diagChoicesEl = document.getElementById("diagChoices");
  const diagResultEl = document.getElementById("diagResult");
  const diagAudioStatus = document.getElementById("diagAudioStatus");

  const gamePlanEl = document.getElementById("gamePlan");
  const gameQEl = document.getElementById("gameQ");
  const gameHintEl = document.getElementById("gameHint");
  const gameChoicesEl = document.getElementById("gameChoices");
  const gameResultEl = document.getElementById("gameResult");
  const gameAudioStatus = document.getElementById("gameAudioStatus");

  function renderDiagQuestion(){
    const q = diagQs[diagIndex];
    lastDiagQ = q;
    diagQEl.textContent = q.prompt;
    diagHintEl.textContent = q.hint || "";
    diagResultEl.textContent = "";

    diagChoicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkDiagAnswer(c);
      diagChoicesEl.appendChild(card);
    });
  }

  function playDiagAudio(){
    if (!lastDiagQ) return showAudioStatus(diagAudioStatus, "Press Take Diagnostic to start!");
    if (lastDiagQ.type === "name") {
      const src = letterAudio[lastDiagQ.letter];
      if (!src) return showAudioStatus(diagAudioStatus, "Missing letter mp3 for this letter.");
      playAudio(src, diagAudioStatus);
    } else {
      const src = soundAudio[lastDiagQ.soundKey];
      if (!src) return showAudioStatus(diagAudioStatus, "Missing sound mp3 for this sound.");
      playAudio(src, diagAudioStatus);
    }
  }

  function checkDiagAnswer(choice){
    if (diagResultEl.textContent) return;
    const q = diagQs[diagIndex];
    if (choice === q.correct){
      diagCorrect++;
      diagResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      diagMissed.push(q.focusKey);
      diagResultEl.textContent = `Good try! Answer: ${q.correct}`;
      if (q.type === "sound") playDiagAudio();
    }
  }

  function finishDiagnostic(){
    const total = diagQs.length || 1;
    const score = Math.round((diagCorrect / total) * 100);

    const resultObj = { grade, score, missed: diagMissed, date: Date.now() };
    save(PHONICS_DIAG_KEY, resultObj);

    const missedNames = diagMissed.filter(x=>x.startsWith("name:")).length;
    const missedSounds = diagMissed.filter(x=>x.startsWith("sound:")).length;

    let planText = `Diagnostic score: ${score}% â€” `;
    if (missedNames === 0 && missedSounds === 0) {
      planText += "Awesome! We'll do a fun mix of practice.";
    } else {
      planText += "We will practice: ";
      const parts = [];
      if (missedNames) parts.push(`letter names (${missedNames})`);
      if (missedSounds) parts.push(`letter sounds (${missedSounds})`);
      planText += parts.join(" and ") + ".";
    }
    gamePlanEl.textContent = planText;

    // build recommended game + show it
    gameQs = buildGame(grade, diagMissed);
    gameIndex = 0;
    showPanel(targetGamePanel);
    renderGameQuestion();
  }

  function renderGameQuestion(){
    const q = gameQs[gameIndex % gameQs.length];
    lastGameQ = q;

    gameQEl.textContent = q.prompt;
    gameHintEl.textContent = q.hint || "";
    gameResultEl.textContent = "";

    gameChoicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=> checkGameAnswer(c);
      gameChoicesEl.appendChild(card);
    });
  }

  function playGameAudio(){
    if (!lastGameQ) return showAudioStatus(gameAudioStatus, "Take the diagnostic first!");
    if (lastGameQ.type === "name") {
      const src = letterAudio[lastGameQ.letter];
      if (!src) return showAudioStatus(gameAudioStatus, "Missing letter mp3 for this letter.");
      playAudio(src, gameAudioStatus);
    } else {
      const src = soundAudio[lastGameQ.soundKey];
      if (!src) return showAudioStatus(gameAudioStatus, "Missing sound mp3 for this sound.");
      playAudio(src, gameAudioStatus);
    }
  }

  function checkGameAnswer(choice){
    if (gameResultEl.textContent) return;
    const q = gameQs[gameIndex % gameQs.length];
    if (choice === q.correct){
      gameResultEl.textContent = "Correct! â­";
      addPhonicsStar();
    } else {
      gameResultEl.textContent = "Try again ğŸ™‚";
      if (q.type === "sound") playGameAudio();
    }
  }

  // Diagnostic buttons
  document.getElementById("diagSpeakBtn").onclick = playDiagAudio;

  document.getElementById("goDiagBtn").onclick = ()=>{
    diagQs = buildDiagnostic(grade);
    diagIndex = 0;
    diagCorrect = 0;
    diagMissed = [];
    lastDiagQ = null;
    renderDiagQuestion();
  };

  document.getElementById("diagNextBtn").onclick = ()=>{
    if (!diagQs.length) return;
    if (!diagResultEl.textContent){
      diagMissed.push(diagQs[diagIndex].focusKey);
    }
    diagIndex++;
    if (diagIndex >= diagQs.length) finishDiagnostic();
    else renderDiagQuestion();
  };

  document.getElementById("diagSkipBtn").onclick = ()=>{
    if (!diagQs.length) return;
    diagMissed.push(diagQs[diagIndex].focusKey);
    diagIndex++;
    if (diagIndex >= diagQs.length) finishDiagnostic();
    else renderDiagQuestion();
  };

  document.getElementById("retakeBtn").onclick = ()=>{
    localStorage.removeItem(PHONICS_DIAG_KEY);
    diagQs = [];
    diagIndex = 0;
    diagCorrect = 0;
    diagMissed = [];
    lastDiagQ = null;
    diagQEl.textContent = "Press â€œTake Diagnosticâ€ to begin.";
    diagHintEl.textContent = "";
    diagChoicesEl.innerHTML = "";
    diagResultEl.textContent = "";
    alert("Diagnostic cleared. Press â€œTake Diagnosticâ€ again.");
  };

  // Recommended game buttons
  document.getElementById("gameSpeakBtn").onclick = playGameAudio;
  document.getElementById("goGameBtn").onclick = ()=> renderGameQuestion();
  document.getElementById("gameNextBtn").onclick = ()=>{ gameIndex++; renderGameQuestion(); };
  document.getElementById("resetStarsBtn").onclick = ()=>{
    const p = load(PROG_KEY, {
      phonicsStars:0, readingStars:0, mathStars:0, tracingDone:0, gamesStars:0, diagnosticScore:null
    });
    p.phonicsStars = 0;
    save(PROG_KEY, p);
    alert("Phonics stars reset!");
  };

  // =========================
  // GAME: Sound -> Letter
  // =========================
  const stlQ = document.getElementById("stlQ");
  const stlHint = document.getElementById("stlHint");
  const stlChoices = document.getElementById("stlChoices");
  const stlResult = document.getElementById("stlResult");
  const stlAudioStatus = document.getElementById("stlAudioStatus");

  let stlItems = [];
  let stlIndex = 0;
  let stlCurrent = null;

  function stlLoad(){
    stlItems = shuffle(gradeBanks[grade].soundToLetter);
    stlIndex = 0;
    stlCurrent = null;
    stlQ.textContent = "Press Play to start!";
    stlHint.textContent = "";
    stlChoices.innerHTML = "";
    stlResult.textContent = "";
  }

  function stlRender(){
    stlCurrent = stlItems[stlIndex % stlItems.length];
    stlQ.textContent = "Which letter(s) match this sound?";
    stlHint.textContent = stlCurrent.hint || "";
    stlResult.textContent = "";
    stlChoices.innerHTML = "";

    stlCurrent.choices.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:30px; margin-bottom:6px;">${c}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=>{
        if (stlResult.textContent) return;
        if (c === stlCurrent.correct){
          stlResult.textContent = "Correct! â­";
          addPhonicsStar();
        } else {
          stlResult.textContent = "Try again ğŸ™‚";
        }
      };
      stlChoices.appendChild(card);
    });

    stlPlaySound();
  }

  function stlPlaySound(){
    if (!stlCurrent) return showAudioStatus(stlAudioStatus, "Press Play first!");
    const src = soundAudio[stlCurrent.soundKey];
    if (!src) return showAudioStatus(stlAudioStatus, "Missing sound mp3 for this sound.");
    playAudio(src, stlAudioStatus);
  }

  document.getElementById("stlSpeakBtn").onclick = stlPlaySound;
  document.getElementById("stlStartBtn").onclick = ()=>{ stlLoad(); stlRender(); };
  document.getElementById("stlNextBtn").onclick = ()=>{ stlIndex++; stlRender(); };

  // =========================
  // GAME: Letter -> Sound
  // =========================
  const ltsQ = document.getElementById("ltsQ");
  const ltsHint = document.getElementById("ltsHint");
  const ltsChoices = document.getElementById("ltsChoices");
  const ltsResult = document.getElementById("ltsResult");
  const ltsAudioStatus = document.getElementById("ltsAudioStatus");

  let ltsItems = [];
  let ltsIndex = 0;
  let ltsCurrent = null;

  function ltsLoad(){
    ltsItems = shuffle(gradeBanks[grade].letterToSound);
    ltsIndex = 0;
    ltsCurrent = null;
    ltsQ.textContent = "Press Play to start!";
    ltsHint.textContent = "";
    ltsChoices.innerHTML = "";
    ltsResult.textContent = "";
  }

  function prettySoundLabel(soundKey){
    const map = {
      "m": "/m/",
      "s": "/s/",
      "t": "/t/",
      "sh": "/sh/",
      "ch": "/ch/",
      "th": "/th/",
      "long-a": "Long A",
      "long-e": "Long E",
      "long-o": "Long O"
    };
    return map[soundKey] || soundKey;
  }

  function ltsRender(){
    ltsCurrent = ltsItems[ltsIndex % ltsItems.length];
    ltsResult.textContent = "";
    ltsChoices.innerHTML = "";

    ltsQ.textContent = `What SOUND goes with: ${ltsCurrent.letter}?`;
    ltsHint.textContent = ltsCurrent.hint || "";

    ltsCurrent.choices.forEach(sk=>{
      const label = prettySoundLabel(sk);
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${label}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=>{
        // play that sound when tapped (kid-friendly)
        const src = soundAudio[sk];
        if (src) playAudio(src, ltsAudioStatus);

        if (ltsResult.textContent) return;
        if (sk === ltsCurrent.correctSoundKey){
          ltsResult.textContent = "Correct! â­";
          addPhonicsStar();
        } else {
          ltsResult.textContent = "Try again ğŸ™‚";
        }
      };
      ltsChoices.appendChild(card);
    });
  }

  function ltsPlayLetterName(){
    if (!ltsCurrent) return showAudioStatus(ltsAudioStatus, "Press Play first!");
    const src = letterAudio[ltsCurrent.letter];
    if (!src) return showAudioStatus(ltsAudioStatus, "Missing letter mp3 for this letter.");
    playAudio(src, ltsAudioStatus);
  }

  document.getElementById("ltsSpeakBtn").onclick = ltsPlayLetterName;
  document.getElementById("ltsStartBtn").onclick = ()=>{ ltsLoad(); ltsRender(); ltsPlayLetterName(); };
  document.getElementById("ltsNextBtn").onclick = ()=>{ ltsIndex++; ltsRender(); ltsPlayLetterName(); };

  // =========================
  // GAME: Label the Picture
  // =========================
  const lpQ = document.getElementById("lpQ");
  const lpHint = document.getElementById("lpHint");
  const lpChoices = document.getElementById("lpChoices");
  const lpResult = document.getElementById("lpResult");
  const lpAudioStatus = document.getElementById("lpAudioStatus");

  let lpItems = [];
  let lpIndex = 0;
  let lpCurrent = null;

  function lpLoad(){
    lpItems = shuffle(gradeBanks[grade].labelPics);
    lpIndex = 0;
    lpCurrent = null;
    lpQ.textContent = "Press Play to start!";
    lpHint.textContent = "";
    lpChoices.innerHTML = "";
    lpResult.textContent = "";
  }

  function lpRender(){
    lpCurrent = lpItems[lpIndex % lpItems.length];
    lpResult.textContent = "";
    lpChoices.innerHTML = "";

    lpQ.textContent = `What word matches this picture: ${lpCurrent.picture}?`;
    lpHint.textContent = lpCurrent.hint || "";

    lpCurrent.choices.forEach(w=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:26px; margin-bottom:6px;">${w}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=>{
        if (lpResult.textContent) return;
        if (w === lpCurrent.answer){
          lpResult.textContent = "Correct! â­";
          addPhonicsStar();
        } else {
          lpResult.textContent = "Try again ğŸ™‚";
        }
      };
      lpChoices.appendChild(card);
    });

    lpPlaySound();
  }

  function lpPlaySound(){
    if (!lpCurrent) return showAudioStatus(lpAudioStatus, "Press Play first!");
    const src = soundAudio[lpCurrent.soundKey];
    if (!src) return showAudioStatus(lpAudioStatus, "Missing sound mp3 for this sound.");
    playAudio(src, lpAudioStatus);
  }

  document.getElementById("lpSpeakBtn").onclick = lpPlaySound;
  document.getElementById("lpStartBtn").onclick = ()=>{ lpLoad(); lpRender(); };
  document.getElementById("lpNextBtn").onclick = ()=>{ lpIndex++; lpRender(); };

  // =========================
  // Nonsense Word Lab (safe)
  // =========================
  const nwWord = document.getElementById("nwWord");
  const nwRealCheck = document.getElementById("nwRealCheck");
  const nwStatus = document.getElementById("nwStatus");

  // Strong blocklist (substring) â€” keeps it safe
  const blockedSubstrings = [
    "ass","sex","cum","dick","shit","fuck","bitch","cunt","piss","porn","nude","rape","fag","slut","whore"
  ];

  function isBlocked(word){
    const lower = word.toLowerCase();
    return blockedSubstrings.some(b => lower.includes(b));
  }

  // Use safe onsets that you already have audio for
  const safeOnsets = ["m","s","t","sh","ch","th"];
  // Endings: we don't have audio files for these by default â€” that's okay
  const safeCodas = ["m","s","t","n","p"];
  const vowels = ["a","e","i","o","u"];

  let nw = { c1:"m", v:"a", c2:"t" };

  function buildNonsenseWord(){
    for (let tries=0; tries<60; tries++){
      const c1 = safeOnsets[Math.floor(Math.random()*safeOnsets.length)];
      const v  = vowels[Math.floor(Math.random()*vowels.length)];
      const c2 = safeCodas[Math.floor(Math.random()*safeCodas.length)];
      const w = `${c1}${v}${c2}`;
      if (!isBlocked(w)) { nw = { c1, v, c2 }; return w; }
    }
    nw = { c1:"m", v:"a", c2:"t" };
    return "mat";
  }

  function showNW(){
    const w = `${nw.c1}${nw.v}${nw.c2}`;
    nwWord.textContent = `Your silly word: ${w}`;
    nwRealCheck.textContent = "";
  }

  function setVowel(v){
    const old = nw.v;
    nw.v = v;
    const w = `${nw.c1}${nw.v}${nw.c2}`;
    if (isBlocked(w)) {
      nw.v = old;
      showAudioStatus(nwStatus, "Oops! Not allowed. Try another vowel.");
    }
    showNW();
  }

  function nwPlayStart(){
    const src = soundAudio[nw.c1];
    if (!src) return showAudioStatus(nwStatus, "No audio for that start sound yet.");
    playAudio(src, nwStatus);
  }

  function nwPlayVowel(){
    // you don't have short vowel mp3s yet â€” we keep it friendly
    showAudioStatus(nwStatus, "Short vowel audio not added yet (optional).");
  }

  function nwPlayEnd(){
    // you likely donâ€™t have mp3s for ending sounds â€” optional
    showAudioStatus(nwStatus, "End sound audio not added yet (optional).");
  }

  document.getElementById("nwMakeBtn").onclick = ()=>{ buildNonsenseWord(); showNW(); };
  document.getElementById("nwCheckBtn").onclick = ()=>{
    addPhonicsStar();
    nwRealCheck.textContent = "ğŸŒŸ Nice! You made a safe silly word!";
  };
  document.querySelectorAll("#nonsensePanel .pill[data-v]").forEach(btn=>btn.onclick=()=>setVowel(btn.dataset.v));
  document.getElementById("nwPlayC1Btn").onclick = nwPlayStart;
  document.getElementById("nwPlayVBtn").onclick = nwPlayVowel;
  document.getElementById("nwPlayC2Btn").onclick = nwPlayEnd;

  // =========================
  // Decodable Reading (Options + More Stories)
  // =========================
  const decOptionsRow = document.getElementById("decOptionsRow");
  const decTitle = document.getElementById("decTitle");
  const decFocus = document.getElementById("decFocus");
  const decText = document.getElementById("decText");
  const decQ = document.getElementById("decQ");
  const decChoices = document.getElementById("decChoices");
  const decResult = document.getElementById("decResult");

  let decOption = "mix";
  let currentStory = null;

  const decodableOptionsByGrade = {
    "K": [
      { key:"cvc-a", label:"CVC (a)" },
      { key:"cvc-i", label:"CVC (i)" },
      { key:"cvc-o", label:"CVC (o)" },
      { key:"mix", label:"Mix" }
    ],
    "1": [
      { key:"digraphs", label:"sh/ch/th" },
      { key:"mix", label:"Mix" }
    ],
    "2": [
      { key:"ai-ay", label:"AI / AY (Long A)" },
      { key:"ee-ea", label:"EE / EA (Long E)" },
      { key:"oa-ow", label:"OA / OW (Long O)" },
      { key:"mix", label:"Mix" }
    ]
  };

  const decodables = {
    "K": {
      "cvc-a": [
        { title:"Sam on a Mat", focus:"CVC with a: sat, mat, tap", text:"Sam sat on a mat. Sam can tap. Tap, tap, tap!", q:"Where did Sam sit?", correct:"on a mat", choices:["on a mat","in a boat","in the rain"] },
        { title:"The Cat Nap", focus:"CVC with a: cat, nap", text:"A cat can nap. The cat sat. The cat had a nap.", q:"What can the cat do?", correct:"nap", choices:["nap","ship","row"] },
        { title:"Max the Man", focus:"CVC with a: max, man", text:"Max is a man. Max can pat a mat. Max is glad.", q:"Who is Max?", correct:"a man", choices:["a boat","a man","a cat"] }
      ],
      "cvc-i": [
        { title:"Tim and the Lid", focus:"CVC with i: sit, lid", text:"Tim did sit. Tim hid a lid. Tim is still.", q:"What did Tim hide?", correct:"a lid", choices:["a lid","a boat","a ship"] },
        { title:"Pig in a Bin", focus:"CVC with i: pig, bin", text:"A pig is in a bin. The pig did wig. The pig is in!", q:"Where is the pig?", correct:"in a bin", choices:["in a bin","on a mat","in the rain"] },
        { title:"Six Bits", focus:"CVC with i: six, bits", text:"I have six bits. I mix bits. I fix bits.", q:"How many bits?", correct:"six", choices:["six","two","ten"] }
      ],
      "cvc-o": [
        { title:"Tom on Top", focus:"CVC with o: Tom, top", text:"Tom sat on top. Tom can hop. Hop, hop, hop!", q:"What can Tom do?", correct:"hop", choices:["hop","row","read"] },
        { title:"Pop the Pot", focus:"CVC with o: pop, pot", text:"Pop! Pop! Pop! A pot can pop. Stop the pop!", q:"What can pop?", correct:"a pot", choices:["a ship","a pot","a mat"] },
        { title:"Rob the Dog", focus:"CVC with o: rob, dog", text:"Rob has a dog. The dog can jog. Rob and the dog jog.", q:"Who has a dog?", correct:"Rob", choices:["Sam","Rob","Tim"] }
      ],
      "mix": [
        { title:"Sam and Tim", focus:"Mixed CVC", text:"Sam sat. Tim sat. Sam can tap. Tim can hop.", q:"Who can hop?", correct:"Tim", choices:["Sam","Tim","the cat"] },
        { title:"Cat and Dog", focus:"Mixed CVC", text:"A cat can nap. A dog can jog. The cat and dog had fun.", q:"What can the dog do?", correct:"jog", choices:["jog","row","read"] }
      ]
    },
    "1": {
      "digraphs": [
        { title:"Ship and Shell", focus:"sh", text:"I see a ship. I see a shell. The ship is big.", q:"What is big?", correct:"the ship", choices:["the ship","the shell","the chop"] },
        { title:"Chop the Stick", focus:"ch", text:"I chop a stick. Chop, chop! I can chop fast.", q:"What do you chop?", correct:"a stick", choices:["a stick","a ship","a mat"] },
        { title:"This and That", focus:"th", text:"This is my math. That is my map. This is that.", q:"What is my map?", correct:"that", choices:["that","this","ship"] }
      ],
      "mix": [
        { title:"Ship or Chop", focus:"sh/ch/th mix", text:"The ship is big. I chop a stick. This is fun.", q:"What is big?", correct:"the ship", choices:["the ship","the chop","the stick"] }
      ]
    },
    "2": {
      "ai-ay": [
        { title:"Rain Day", focus:"AI/AY (Long A): rain, play, stay", text:"It may rain today. I play a game. I stay inside and read.", q:"What might happen today?", correct:"rain", choices:["rain","snow","ship"] },
        { title:"Jay Can Play", focus:"AI/AY: Jay, play, day", text:"Jay can play all day. Jay may wait for the rain to go away.", q:"Who can play?", correct:"Jay", choices:["Jay","Sam","Rob"] },
        { title:"Trail Trip", focus:"AI: trail", text:"I see a trail. I walk on the trail. The trail is safe.", q:"What do you walk on?", correct:"the trail", choices:["the trail","the boat","the ship"] }
      ],
      "ee-ea": [
        { title:"Feet on the Street", focus:"EE/EA (Long E): feet, see", text:"I see my feet. My feet meet the street. I feel so free!", q:"What do you see?", correct:"feet", choices:["feet","boat","rain"] },
        { title:"Green Leaf", focus:"EE/EA: green", text:"I see a green leaf. The leaf is neat. I keep the leaf.", q:"What color is the leaf?", correct:"green", choices:["green","blue","red"] },
        { title:"Team Treat", focus:"EA: team", text:"The team will eat. We beat the heat. We feel great!", q:"What will the team do?", correct:"eat", choices:["eat","row","chop"] }
      ],
      "oa-ow": [
        { title:"Boat Ride", focus:"OA/OW (Long O): boat, float, slow", text:"I float in a boat. I row slow. The boat will go home.", q:"What do you float in?", correct:"a boat", choices:["a boat","a ship","a mat"] },
        { title:"Snow Glow", focus:"OW: snow", text:"I see snow. The snow will blow. I go slow in the snow.", q:"What do you see?", correct:"snow", choices:["snow","rain","feet"] },
        { title:"Road to Home", focus:"OA: road", text:"I go on the road. The road is wide. I go home.", q:"Where do you go?", correct:"home", choices:["home","ship","trail"] }
      ],
      "mix": [
        { title:"A Day to Read", focus:"Long vowel mix", text:"I may stay and read. I see green trees. I float in a boat.", q:"What can you float in?", correct:"a boat", choices:["a boat","a mat","a bin"] }
      ]
    }
  };

  function buildDecodableOptions(){
    decOptionsRow.innerHTML = "";
    const opts = decodableOptionsByGrade[grade] || [{ key:"mix", label:"Mix" }];
    decOption = opts.find(o=>o.key==="mix") ? "mix" : opts[0].key;

    opts.forEach(o=>{
      const b = document.createElement("button");
      b.className = "pill";
      b.textContent = o.label;
      b.dataset.key = o.key;
      if (o.key === decOption) b.classList.add("active");
      b.onclick = ()=>{
        decOption = o.key;
        document.querySelectorAll("#decOptionsRow .pill").forEach(p=>p.classList.toggle("active", p.dataset.key === decOption));
        resetDecodable();
      };
      decOptionsRow.appendChild(b);
    });
  }

  function resetDecodable(){
    currentStory = null;
    decTitle.textContent = "Press â€œPick a Storyâ€";
    decFocus.textContent = "";
    decText.textContent = "";
    decQ.textContent = "Question:";
    decChoices.innerHTML = "";
    decResult.textContent = "";
  }

  function renderDecChoices(){
    decChoices.innerHTML = "";
    const options = shuffle(currentStory.choices);
    options.forEach(opt=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.textAlign = "center";
      card.innerHTML = `<h3 style="font-size:22px; margin-bottom:6px;">${opt}</h3><p class="small">Tap!</p>`;
      card.onclick = ()=>{
        if (decResult.textContent) return;
        if (opt === currentStory.correct) {
          decResult.textContent = "Correct! â­";
          addPhonicsStar();
        } else {
          decResult.textContent = "Try again ğŸ™‚";
        }
      };
      decChoices.appendChild(card);
    });
  }

  function pickStory(){
    const bank = decodables[grade] || decodables["K"];
    const list = bank[decOption] || bank["mix"] || [];
    if (!list.length) return;

    currentStory = list[Math.floor(Math.random()*list.length)];
    decTitle.textContent = currentStory.title;
    decFocus.textContent = currentStory.focus;
    decText.textContent = currentStory.text;
    decQ.textContent = `Question: ${currentStory.q}`;
    decResult.textContent = "";
    renderDecChoices();
  }

  document.getElementById("decPickBtn").onclick = pickStory;
  document.getElementById("decReadBtn").onclick = ()=>{ if (currentStory) speakText(currentStory.text); };
  document.getElementById("decStopBtn").onclick = stopSpeak;

  // =========================
  // Reset helpers
  // =========================
  function resetPanelsText(){
    // Diagnostics
    diagQEl.textContent = "Press â€œTake Diagnosticâ€ to begin.";
    diagHintEl.textContent = "";
    diagChoicesEl.innerHTML = "";
    diagResultEl.textContent = "";

    // Recommended game
    gamePlanEl.textContent = "Your game is based on your diagnostic.";
    gameQEl.textContent = "Game question loads hereâ€¦";
    gameHintEl.textContent = "";
    gameChoicesEl.innerHTML = "";
    gameResultEl.textContent = "";

    // STL/LTS/LP
    stlQ.textContent = "Press Play to start!";
    stlHint.textContent = "";
    stlChoices.innerHTML = "";
    stlResult.textContent = "";

    ltsQ.textContent = "Press Play to start!";
    ltsHint.textContent = "";
    ltsChoices.innerHTML = "";
    ltsResult.textContent = "";

    lpQ.textContent = "Press Play to start!";
    lpHint.textContent = "";
    lpChoices.innerHTML = "";
    lpResult.textContent = "";

    // Nonsense
    nwWord.textContent = "Press â€œMake a Wordâ€!";
    nwRealCheck.textContent = "";

    // Decodable
    resetDecodable();
  }

  function resetAllGameState(){
    // diag state
    diagQs = [];
    diagIndex = 0;
    diagCorrect = 0;
    diagMissed = [];
    lastDiagQ = null;

    // recommended game
    gameQs = [];
    gameIndex = 0;
    lastGameQ = null;

    // other games
    stlLoad();
    ltsLoad();
    lpLoad();

    // nonsense
    nw = { c1:"m", v:"a", c2:"t" };

    // decodable options
    buildDecodableOptions();
    resetPanelsText();
  }

  // =========================
  // Initialize
  // =========================
  renderGradeButtons();
  resetAllGameState();
  hideAllPanels();

</script>

</body>
</html>
